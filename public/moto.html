<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>重機停車地圖 - 空之箱</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root {
            --suisei-cyan: #3bc6e4;
            --suisei-dark: #225a76;
            --bg-deep: #0b1021;
        }

        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; font-family: 'Segoe UI', sans-serif; }
        
        /* 導航列 */
        .nav-bar {
            background: var(--bg-deep); color: white; padding: 15px 20px; 
            display: flex; align-items: center; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .back-link { color: white; text-decoration: none; font-size: 1.1rem; margin-right: 15px; }
        .title { font-weight: bold; letter-spacing: 1px; }

        /* 地圖容器 */
        #map { flex-grow: 1; width: 100%; z-index: 1; }

        /* 搜尋框與結果列表容器 */
        .search-wrapper {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; z-index: 1100;
        }

        /* 搜尋框本體 */
        .search-container {
            display: flex; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border-radius: 50px;
            background: white;
        }
        .search-input {
            flex: 1; padding: 12px 20px; border: none; border-radius: 50px 0 0 50px; outline: none; font-size: 1rem;
        }
        .search-btn {
            background: var(--suisei-cyan); color: white; border: none; padding: 0 20px;
            border-radius: 0 50px 50px 0; cursor: pointer; font-size: 1.1rem;
        }

        /* 搜尋結果下拉選單 */
        .search-results {
            background: white; margin-top: 10px; border-radius: 15px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); overflow: hidden;
            max-height: 250px; overflow-y: auto; display: none; /* 預設隱藏 */
        }
        .result-item {
            padding: 12px 20px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s;
            font-size: 0.95rem; color: #333;
        }
        .result-item:last-child { border-bottom: none; }
        .result-item:hover { background: #f0fbff; color: var(--suisei-dark); }
        .result-name { font-weight: bold; display: block; }
        .result-addr { font-size: 0.8rem; color: #666; }

        /* 懸浮按鈕 */
        .fab-container {
            position: absolute; bottom: 30px; right: 20px; z-index: 900;
            display: flex; flex-direction: column; gap: 15px;
        }
        .fab {
            width: 56px; height: 56px; border-radius: 50%; border: none;
            color: white; font-size: 1.5rem; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        .fab:hover { transform: scale(1.1); }
        .fab-add { background: var(--suisei-cyan); }
        .fab-locate { background: white; color: #333; }

        /* Modal (彈窗) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000; display: none;
            align-items: center; justify-content: center;
        }
        .modal {
            background: white; width: 90%; max-width: 400px; padding: 25px;
            border-radius: 20px; position: relative; animation: slideUp 0.3s ease;
            max-height: 90vh; overflow-y: auto;
        }
        @keyframes slideUp { from {transform: translateY(20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        
        .modal h3 { margin-top: 0; color: var(--suisei-dark); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666; font-weight: bold; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-submit { background: var(--suisei-dark); color: white; width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; }
        .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.2rem; cursor: pointer; }

        /* Popup 樣式 */
        .custom-popup .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; }
        .custom-popup .leaflet-popup-content { margin: 0; width: 260px !important; }
        .popup-header { background: var(--suisei-dark); color: white; padding: 10px 15px; font-weight: bold; }
        .popup-body { padding: 15px; font-size: 0.9rem; line-height: 1.6; }
        .popup-footer { padding: 10px; background: #f9f9f9; text-align: center; }
        .nav-btn {
            background: var(--suisei-cyan); color: white; text-decoration: none;
            padding: 8px 20px; border-radius: 20px; display: inline-block; font-size: 0.9rem;
        }
        .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-right: 5px; color: white; }
        .tag-yes { background: #28a745; }
        .tag-no { background: #dc3545; }
    </style>
</head>
<body>

    <div class="nav-bar">
        <a href="index.html" class="back-link"><i class="fa-solid fa-arrow-left"></i></a>
        <span class="title">重機停車地圖</span>
    </div>

    <div class="search-wrapper">
        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="搜尋台灣地址或關鍵字..." onkeypress="if(event.key === 'Enter') searchLocation()">
            <button class="search-btn" onclick="searchLocation()"><i class="fa-solid fa-magnifying-glass"></i></button>
        </div>
        <div id="searchResults" class="search-results"></div>
    </div>

    <div id="map"></div>

    <div class="fab-container">
        <button class="fab fab-locate" onclick="getMyLocation()" title="定位我的位置">
            <i class="fa-solid fa-crosshairs"></i>
        </button>
        <button class="fab fab-add" onclick="openModal()" title="新增停車點">
            <i class="fa-solid fa-plus"></i>
        </button>
    </div>

    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <button class="close-modal" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
            <h3><i class="fa-solid fa-square-parking"></i> 新增停車點</h3>
            
            <div class="form-group">
                <label>停車場名稱</label>
                <input type="text" id="pName" class="form-control" placeholder="例如：市民大道復興段">
            </div>
            
            <div class="form-group">
                <label>停車場地址</label>
                <input type="text" id="pAddress" class="form-control" placeholder="請輸入地址或描述位置">
            </div>

            <div class="form-group">
                <label>重機友善程度</label>
                <select id="pFriendly" class="form-control">
                    <option value="友善 (專用格)">友善 (有專用格)</option>
                    <option value="普通 (一般格)">普通 (停一般格)</option>
                    <option value="不友善 (易被趕)">不友善 (易被趕)</option>
                </select>
            </div>

            <div class="form-group">
                <label>車牌辨識方式</label>
                <select id="pPlate" class="form-control">
                    <option value="後牌辨識 (直接進)">後牌辨識 (直接進)</option>
                    <option value="前牌辨識 (需喬車)">前牌辨識 (需喬車)</option>
                    <option value="無辨識 (取票/感應)">無辨識 (取票/感應)</option>
                </select>
            </div>

            <div class="form-group">
                <label>停車費率</label>
                <input type="text" id="pRate" class="form-control" placeholder="例如：30元/小時，上限150">
            </div>

            <button class="btn-submit" onclick="submitSpot()">提交資料</button>
        </div>
    </div>

    <script>
        // 1. 初始化地圖
        var map = L.map('map', { zoomControl: false }).setView([25.0330, 121.5654], 13);
        L.control.zoom({ position: 'bottomleft' }).addTo(map);

        // 使用 CartoDB Positron 簡潔圖資
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '© OSM © CARTO',
            maxZoom: 20
        }).addTo(map);

        // 重機圖標
        var motoIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/198/198308.png',
            iconSize: [36, 36],
            iconAnchor: [18, 36],
            popupAnchor: [0, -32]
        });

        // 搜尋結果標記
        var searchMarker = null;

        // 資料庫 (模擬)
        let parkingSpots = [
            {lat: 25.0330, lng: 121.5654, name: "台北101重機停車區", address: "台北市信義區信義路五段7號", friendly: "友善 (專用格)", plate: "後牌辨識", rate: "免費/前3小時"},
            {lat: 25.0478, lng: 121.5170, name: "台北車站地下停車場", address: "台北市中正區", friendly: "普通 (一般格)", plate: "前牌辨識", rate: "40元/次"}
        ];

        // 讀取本地暫存
        const savedSpots = JSON.parse(localStorage.getItem('myMotoSpots')) || [];
        parkingSpots = parkingSpots.concat(savedSpots);

        // 渲染地圖上的標記
        function renderMarkers() {
            parkingSpots.forEach(spot => {
                const isFriendly = spot.friendly.includes("友善");
                const tagClass = isFriendly ? "tag-yes" : "tag-no";
                
                // 導航連結
                const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${spot.lat},${spot.lng}`;
                const addressDisplay = spot.address ? `<div style="font-size:0.8rem; color:#666; margin-bottom:5px;"><i class="fa-solid fa-location-dot"></i> ${spot.address}</div>` : '';

                const popupContent = `
                    <div class="popup-header">${spot.name}</div>
                    <div class="popup-body">
                        ${addressDisplay}
                        <div><span class="tag ${tagClass}">${spot.friendly}</span></div>
                        <div style="margin-top:5px"><i class="fa-solid fa-camera"></i> ${spot.plate}</div>
                        <div style="margin-top:5px"><i class="fa-solid fa-coins"></i> ${spot.rate}</div>
                    </div>
                    <div class="popup-footer">
                        <a href="${navUrl}" target="_blank" class="nav-btn"><i class="fa-solid fa-location-arrow"></i> 導航前往</a>
                    </div>
                `;

                L.marker([spot.lat, spot.lng], {icon: motoIcon})
                 .addTo(map)
                 .bindPopup(popupContent, {className: 'custom-popup'});
            });
        }
        renderMarkers();

        // --- 搜尋功能 (更新版) ---
        function searchLocation() {
            const query = document.getElementById('searchInput').value;
            const resultsDiv = document.getElementById('searchResults');
            
            if(!query) return;

            resultsDiv.style.display = 'none';
            resultsDiv.innerHTML = '';

            // 限制 countrycodes=tw (只搜尋台灣)
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=5&countrycodes=tw`)
                .then(response => response.json())
                .then(data => {
                    if(data.length > 0) {
                        resultsDiv.style.display = 'block';
                        
                        // 產生結果列表
                        data.forEach(place => {
                            const div = document.createElement('div');
                            div.className = 'result-item';
                            // 簡化顯示名稱
                            const displayName = place.display_name.split(',')[0]; 
                            div.innerHTML = `
                                <span class="result-name">${displayName}</span>
                                <span class="result-addr">${place.display_name}</span>
                            `;
                            
                            // 點擊結果
                            div.onclick = () => {
                                const lat = parseFloat(place.lat);
                                const lon = parseFloat(place.lon);
                                
                                map.setView([lat, lon], 16);
                                
                                // 清除舊的搜尋標記
                                if(searchMarker) map.removeLayer(searchMarker);
                                
                                // 新增紅色圓圈標記
                                searchMarker = L.circleMarker([lat, lon], {
                                    color: '#ff4444', fillColor: '#ff4444', fillOpacity: 0.5, radius: 15
                                }).addTo(map).bindPopup(`<b>搜尋：${displayName}</b>`).openPopup();

                                resultsDiv.style.display = 'none'; // 隱藏列表
                            };
                            
                            resultsDiv.appendChild(div);
                        });

                    } else {
                        alert("找不到該地點，請確認關鍵字 (限台灣地區)");
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("搜尋發生錯誤");
                });
        }

        // --- 定位功能 ---
        function getMyLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], 16);
                    L.circle([lat, lng], {color: '#3bc6e4', fillColor: '#3bc6e4', fillOpacity: 0.5, radius: 20}).addTo(map);
                });
            } else { alert("瀏覽器不支援定位"); }
        }

        // --- 新增地點邏輯 (更新版) ---
        let tempClickLat = 0;
        let tempClickLng = 0;

        map.on('click', function(e) {
            tempClickLat = e.latlng.lat;
            tempClickLng = e.latlng.lng;
        });

        function openModal() {
            if(tempClickLat === 0) {
                const center = map.getCenter();
                tempClickLat = center.lat;
                tempClickLng = center.lng;
            }
            document.getElementById('addModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('addModal').style.display = 'none';
        }

        function submitSpot() {
            // 獲取欄位
            const name = document.getElementById('pName').value;
            const address = document.getElementById('pAddress').value; // 新增地址欄位
            const friendly = document.getElementById('pFriendly').value;
            const plate = document.getElementById('pPlate').value;
            const rate = document.getElementById('pRate').value;

            if(!name || !address) { alert("請填寫名稱與地址！"); return; }

            // 二次確認
            const confirmMsg = `請確認以下資料是否正確？\n\n名稱：${name}\n地址：${address}\n友善度：${friendly}\n辨識：${plate}\n費率：${rate}`;
            
            if(confirm(confirmMsg)) {
                // 使用者按了「確定」
                const newSpot = {
                    lat: tempClickLat,
                    lng: tempClickLng,
                    name: name,
                    address: address,
                    friendly: friendly,
                    plate: plate,
                    rate: rate
                };

                parkingSpots.push(newSpot);
                
                const currentSaved = JSON.parse(localStorage.getItem('myMotoSpots')) || [];
                currentSaved.push(newSpot);
                localStorage.setItem('myMotoSpots', JSON.stringify(currentSaved));

                renderMarkers();
                closeModal();
                
                map.setView([tempClickLat, tempClickLng], 16);
                
                // 清空表單
                document.getElementById('pName').value = '';
                document.getElementById('pAddress').value = '';
                document.getElementById('pRate').value = '';
            }
        }
    </script>
</body>
</html>