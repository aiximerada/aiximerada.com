<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿå“¡æª”æ¡ˆåº« - ç‰éœ²å¯¶åº«</title>
    
    <script src="theme.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* ğŸ¨ æ˜Ÿéš›å¥¢è¯é…è‰² (åŒæ­¥æ˜Ÿç¶­åŠ æ–¯) */
            --main-gold: #FFD700;
            --accent-amber: #FDB931;
            --deep-space: #0f172a;
            --nebula-blue: #00f3ff;
            --danger-red: #ff4757;
            --success-green: #10b981;
            
            /* ç»ç’ƒæ“¬æ…‹ */
            --glass-bg: rgba(15, 23, 42, 0.85); 
            --glass-border: rgba(255, 255, 255, 0.1);
            --card-hover-bg: rgba(30, 41, 59, 0.9);
        }

        body {
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            color: #e2e8f0; font-family: 'Microsoft JhengHei', sans-serif;
            min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden; padding-bottom: 80px;
        }

        /* --- âœ¨ æ˜Ÿç©ºèƒŒæ™¯ç‰¹æ•ˆ --- */
        .space-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .star-field { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background-repeat: repeat; opacity: 0.5; animation-timing-function: linear; animation-iteration-count: infinite; }
        
        .stars-distant {
            background-image: radial-gradient(1px 1px at 10% 15%, #fff, transparent), radial-gradient(1px 1px at 30% 60%, #ddd, transparent), radial-gradient(1px 1px at 70% 20%, #eee, transparent);
            background-size: 300px 300px; animation-name: rotateSpace; animation-duration: 240s;
        }
        
        .stars-mid {
            background-image: radial-gradient(1.5px 1.5px at 25% 10%, #fff, transparent), radial-gradient(1.5px 1.5px at 60% 35%, #eef, transparent);
            background-size: 400px 400px; opacity: 0.6; animation-name: rotateSpace; animation-duration: 180s; animation-direction: reverse;
        }
        
        .gold-twinklers {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(2px 2px at 20% 30%, var(--main-gold), transparent), radial-gradient(3px 3px at 65% 25%, #fff59d, transparent);
            background-size: 100% 100%; opacity: 0; animation: occasionalFlash 12s ease-in-out infinite;
        }

        @keyframes rotateSpace { from { transform: rotate(0deg) translateZ(0); } to { transform: rotate(360deg) translateZ(0); } }
        @keyframes occasionalFlash { 0%, 40%, 100% { opacity: 0; } 55% { opacity: 1; filter: brightness(2) blur(1px); } 85% { opacity: 0; } }

        /* --- Header --- */
        .header {
            width: 100%; padding: 15px 20px; background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px); border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center; box-sizing: border-box;
            position: sticky; top: 0; z-index: 10;
        }
        .back-btn { color: #94a3b8; text-decoration: none; font-size: 1rem; display: flex; align-items: center; gap: 5px; transition:0.3s; }
        .back-btn:hover { color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.5); }

        .page-title { text-align: center; margin: 40px 0 30px 0; }
        .page-title h1 {
            margin: 0; font-size: 2.5rem; letter-spacing: 5px; font-weight: 900;
            background: linear-gradient(to bottom, #fff 0%, var(--main-gold) 100%);
            -webkit-background-clip: text; color: transparent;
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.4));
        }
        .page-title p { color: #64748b; margin-top: 5px; letter-spacing: 3px; text-transform: uppercase; font-size: 0.9rem; }

        /* --- æœå°‹æ¬„ --- */
        .search-container { width: 90%; max-width: 800px; margin-bottom: 30px; position: relative; }
        .search-input {
            width: 100%; padding: 16px 20px 16px 55px; background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--glass-border); border-radius: 50px; color: #fff; font-size: 1.1rem;
            box-sizing: border-box; outline: none; transition: 0.3s; backdrop-filter: blur(5px);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
        }
        .search-input:focus { border-color: var(--main-gold); box-shadow: 0 0 20px rgba(255, 215, 0, 0.2); background: rgba(15, 23, 42, 0.8); }
        .search-icon { position: absolute; left: 25px; top: 50%; transform: translateY(-50%); color: var(--main-gold); font-size: 1.2rem; }

        /* --- æœƒå“¡åˆ—è¡¨ --- */
        .member-list { width: 90%; max-width: 800px; display: flex; flex-direction: column; gap: 15px; }
        
        .member-card {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            padding: 20px; border-radius: 20px; display: flex; align-items: center; justify-content: space-between;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            backdrop-filter: blur(12px); box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .member-card:hover { 
            transform: translateY(-5px) scale(1.01); 
            border-color: var(--main-gold); 
            background: var(--card-hover-bg);
            box-shadow: 0 15px 40px rgba(0,0,0,0.5), inset 0 0 20px rgba(255, 215, 0, 0.05); 
        }

        .member-info { display: flex; align-items: center; gap: 20px; flex: 1; overflow: hidden; }
        .avatar { 
            width: 55px; height: 55px; border-radius: 50%; object-fit: cover; 
            border: 2px solid var(--glass-border); box-shadow: 0 0 15px rgba(0,0,0,0.3);
        }
        
        .details { display: flex; flex-direction: column; overflow: hidden; gap: 4px; }
        .name { font-weight: bold; color: #fff; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        
        .role-tag { 
            font-size: 0.7rem; padding: 3px 8px; border-radius: 6px; 
            background: rgba(255,255,255,0.1); color: #94a3b8; 
            text-transform: uppercase; letter-spacing: 1px; font-weight: bold;
        }
        .role-tag.admin { 
            background: linear-gradient(135deg, var(--main-gold), #f59e0b); 
            color: #000; box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); 
        }
        
        .email { font-size: 0.9rem; color: #64748b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .stars-display { 
            font-family: 'Courier New', monospace; font-size: 1.3rem; 
            color: var(--main-gold); font-weight: bold; margin-right: 20px;
            display: flex; align-items: center; gap: 8px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .action-btn {
            width: 45px; height: 45px; border-radius: 50%; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
            transition: 0.3s; background: rgba(0, 243, 255, 0.1); color: var(--nebula-blue); 
            border: 1px solid rgba(0, 243, 255, 0.3);
        }
        .action-btn:hover { 
            background: var(--nebula-blue); color: #000; 
            box-shadow: 0 0 20px var(--nebula-blue); transform: rotate(15deg);
        }

        /* --- Modal (æ·±ç©ºé¢¨æ ¼) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 1000;
            backdrop-filter: blur(8px);
        }
        .modal-box {
            background: #0f172a; border: 1px solid var(--main-gold); padding: 35px;
            border-radius: 24px; width: 90%; max-width: 450px; color: #fff;
            box-shadow: 0 0 60px rgba(255, 215, 0, 0.15); 
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative; overflow: hidden;
        }
        /* Modal èƒŒæ™¯å…‰æšˆ */
        .modal-box::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.05), transparent 60%);
            pointer-events: none;
        }

        @keyframes popIn { from{transform:scale(0.8); opacity:0;} to{transform:scale(1); opacity:1;} }

        .modal-header { 
            font-size: 1.5rem; font-weight: 900; color: var(--main-gold); 
            margin-bottom: 25px; text-align: center; letter-spacing: 2px;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }
        
        .form-group { margin-bottom: 20px; position: relative; z-index: 1; }
        .form-label { display: block; margin-bottom: 8px; color: #94a3b8; font-size: 0.9rem; font-weight: bold; }
        .form-input { 
            width: 100%; padding: 14px; background: rgba(0,0,0,0.4); border: 1px solid #334155; 
            color: #fff; border-radius: 12px; box-sizing: border-box; font-size: 1.1rem;
            transition: 0.3s;
        }
        .form-input:focus { border-color: var(--main-gold); outline: none; box-shadow: 0 0 15px rgba(255, 215, 0, 0.1); }

        /* åˆ‡æ›æŒ‰éˆ•æ¨£å¼ */
        .adjust-toggle { display: flex; gap: 15px; margin-bottom: 15px; }
        .toggle-btn {
            flex: 1; padding: 14px; border-radius: 12px; border: 1px solid #334155;
            background: rgba(0,0,0,0.3); color: #64748b; font-weight: bold; cursor: pointer; transition: 0.3s;
            font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .toggle-btn.active-add { 
            background: linear-gradient(135deg, var(--success-green), #059669); 
            color: #000; border-color: transparent; 
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4); 
        }
        .toggle-btn.active-sub { 
            background: linear-gradient(135deg, var(--danger-red), #b91c1c); 
            color: #fff; border-color: transparent; 
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.4); 
        }

        .current-stars { 
            font-size: 2rem; color: var(--main-gold); font-weight: bold; 
            margin-bottom: 5px; font-family: monospace; 
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        .modal-btns { display: flex; gap: 15px; justify-content: flex-end; margin-top: 35px; position: relative; z-index: 1; }
        .btn-modal { padding: 12px 30px; border-radius: 50px; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 1rem; }
        .btn-confirm { 
            background: linear-gradient(135deg, var(--main-gold), var(--accent-amber)); 
            color: #000; font-weight: 900;
        }
        .btn-confirm:hover { transform: translateY(-2px); box-shadow: 0 0 25px rgba(255, 215, 0, 0.4); }
        .btn-cancel { background: transparent; border: 1px solid #64748b; color: #94a3b8; }
        .btn-cancel:hover { border-color: #fff; color: #fff; }

        .loading-state { text-align: center; color: #64748b; padding: 50px; font-size: 1.2rem; }
        
        .role-select {
            width: 100%; padding: 14px; background: rgba(0,0,0,0.4); border: 1px solid #334155;
            color: #fff; border-radius: 12px; font-size: 1rem; outline: none; appearance: none;
        }
        .role-select option { background: #0f172a; color: #fff; }

    </style>
</head>
<body>

    <div class="space-container">
        <div class="star-field stars-distant"></div>
        <div class="star-field stars-mid"></div>
        <div class="gold-twinklers"></div>
    </div>

    <div class="header">
        <a href="vip_area.html" class="back-btn"><i class="fa-solid fa-chevron-left"></i> è¿”å›æ˜Ÿå“¡å€</a>
    </div>

    <div class="page-title">
        <h1>æ˜Ÿå“¡æª”æ¡ˆåº«</h1>
        <p>MEMBER DATABASE</p>
    </div>

    <div class="search-container">
        <i class="fa-solid fa-search search-icon"></i>
        <input type="text" class="search-input" id="searchInput" placeholder="æœå°‹åç¨±æˆ– Email..." onkeyup="filterMembers()">
    </div>

    <div class="member-list" id="memberList">
        <div class="loading-state"><i class="fa-solid fa-spinner fa-spin"></i> æ­£åœ¨è®€å–æ˜Ÿå“¡è³‡æ–™...</div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal-box">
            <div class="modal-header"><i class="fa-solid fa-user-gear"></i> ç·¨è¼¯æ˜Ÿå“¡è³‡æ–™</div>
            
            <input type="hidden" id="editUid">
            
            <div class="form-group">
                <label class="form-label">ç›®å‰æ˜Ÿéš›èƒ½æº</label>
                <div id="currentStarsDisplay" class="current-stars">0</div>
            </div>

            <div class="form-group">
                <label class="form-label">èª¿æ•´æ–¹å¼</label>
                <div class="adjust-toggle">
                    <button type="button" class="toggle-btn active-add" id="btnTypeAdd" onclick="setAdjustType('add')"><i class="fa-solid fa-plus"></i> å¢åŠ  (Add)</button>
                    <button type="button" class="toggle-btn" id="btnTypeSub" onclick="setAdjustType('sub')"><i class="fa-solid fa-minus"></i> æ‰£é™¤ (Sub)</button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">è®Šå‹•æ•¸é‡</label>
                <input type="number" id="adjustAmount" class="form-input" placeholder="è¼¸å…¥æ•¸é‡ (æ­£æ•´æ•¸)" min="1">
            </div>

            <div class="form-group">
                <label class="form-label" style="color:var(--main-gold);">èª¿æ•´åŸå›  (å¿…å¡«)</label>
                <input type="text" id="adjustReason" class="form-input" placeholder="ä¾‹å¦‚ï¼šæ´»å‹•çå‹µã€é•è¦æ‰£é™¤ã€ç³»çµ±è£œå„Ÿ...">
            </div>

            <div class="form-group">
                <label class="form-label">æ¬Šé™è¨­å®š</label>
                <select id="editRole" class="role-select">
                    <option value="member">ä¸€èˆ¬æ˜Ÿå“¡ (Member)</option>
                    <option value="admin">æŒ‡æ®å®˜ (Admin)</option>
                </select>
            </div>

            <div class="modal-btns">
                <button class="btn-modal btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn-modal btn-confirm" onclick="saveChanges()">ç¢ºèªè®Šæ›´</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, serverTimestamp, addDoc, getDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAo6on0f2QUbPaRfxpIEb2uvhKxDvPUvs",
            authDomain: "yulubox.firebaseapp.com",
            projectId: "yulubox",
            storageBucket: "yulubox.firebasestorage.app",
            messagingSenderId: "256466567852",
            appId: "1:256466567852:web:233b74668908ffcb9b9509",
            measurementId: "G-YPCY41EKWX"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allMembers = [];
        let currentAdminUid = null;
        let currentAdjustType = 'add'; // é è¨­å¢åŠ 

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentAdminUid = user.uid;
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    loadMembers();
                } else {
                    alert("æ¬Šé™ä¸è¶³ï¼šæ‚¨ä¸æ˜¯æŒ‡æ®å®˜");
                    window.location.href = "vip_area.html";
                }
            } else {
                window.location.href = "login.html";
            }
        });

        async function loadMembers() {
            const list = document.getElementById('memberList');
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                allMembers = [];
                querySnapshot.forEach((doc) => {
                    allMembers.push({ id: doc.id, ...doc.data() });
                });
                renderList(allMembers);
            } catch (e) {
                console.error(e);
                list.innerHTML = '<div class="loading-state">è®€å–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</div>';
            }
        }

        function renderList(data) {
            const list = document.getElementById('memberList');
            list.innerHTML = '';
            
            data.sort((a, b) => {
                if (a.role === 'admin' && b.role !== 'admin') return -1;
                if (a.role !== 'admin' && b.role === 'admin') return 1;
                return (b.stars || 0) - (a.stars || 0);
            });

            data.forEach(user => {
                const avatar = user.photoURL || 'https://cdn-icons-png.flaticon.com/512/1828/1828884.png';
                const roleBadge = user.role === 'admin' ? '<span class="role-tag admin"><i class="fa-solid fa-crown"></i> ADMIN</span>' : '<span class="role-tag">MEMBER</span>';
                
                const html = `
                    <div class="member-card">
                        <div class="member-info">
                            <img src="${avatar}" class="avatar">
                            <div class="details">
                                <div class="name">
                                    ${user.displayName || 'æœªå‘½å'} ${roleBadge}
                                </div>
                                <div class="email">${user.email}</div>
                            </div>
                        </div>
                        <div class="stars-display">
                            <i class="fa-solid fa-star"></i> ${user.stars !== undefined ? user.stars : 0}
                        </div>
                        <button class="action-btn btn-edit" onclick="openEditModal('${user.id}')">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                    </div>
                `;
                list.innerHTML += html;
            });
        }

        window.filterMembers = () => {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allMembers.filter(m => 
                (m.displayName && m.displayName.toLowerCase().includes(term)) || 
                (m.email && m.email.toLowerCase().includes(term))
            );
            renderList(filtered);
        };

        // --- ç·¨è¼¯é‚è¼¯ ---
        window.setAdjustType = (type) => {
            currentAdjustType = type;
            const btnAdd = document.getElementById('btnTypeAdd');
            const btnSub = document.getElementById('btnTypeSub');
            
            if(type === 'add') {
                btnAdd.classList.add('active-add');
                btnSub.classList.remove('active-sub');
            } else {
                btnAdd.classList.remove('active-add');
                btnSub.classList.add('active-sub');
            }
        };

        window.openEditModal = (uid) => {
            const user = allMembers.find(m => m.id === uid);
            if (!user) return;

            document.getElementById('editUid').value = user.id;
            document.getElementById('currentStarsDisplay').innerText = user.stars !== undefined ? user.stars : 0;
            
            // é‡ç½®è¡¨å–®
            document.getElementById('adjustAmount').value = '';
            document.getElementById('adjustReason').value = '';
            setAdjustType('add'); // é è¨­åŠ åˆ†

            document.getElementById('editRole').value = user.role || 'member';
            const roleSelect = document.getElementById('editRole');
            if (user.id === currentAdminUid) roleSelect.disabled = true;
            else roleSelect.disabled = false;

            document.getElementById('editModal').style.display = 'flex';
        };

        window.closeModal = () => {
            document.getElementById('editModal').style.display = 'none';
        };

        window.saveChanges = async () => {
            const uid = document.getElementById('editUid').value;
            const amountInput = document.getElementById('adjustAmount').value;
            const reason = document.getElementById('adjustReason').value.trim();
            const newRole = document.getElementById('editRole').value;

            // é©—è­‰
            if (!amountInput || parseInt(amountInput) < 0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸é‡ (æ­£æ•´æ•¸)");
            if (!reason) return alert("è«‹è¼¸å…¥èª¿æ•´åŸå›  (å¿…å¡«)");

            const amount = parseInt(amountInput);
            const delta = currentAdjustType === 'add' ? amount : -amount;

            const btn = document.querySelector('.btn-confirm');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> è™•ç†ä¸­...';
            btn.disabled = true;

            try {
                // 1. æ›´æ–°ä½¿ç”¨è€…è³‡æ–™ (ä½¿ç”¨ increment ç¢ºä¿åŸå­æ€§)
                const userRef = doc(db, "users", uid);
                await updateDoc(userRef, {
                    stars: increment(delta),
                    role: newRole
                });

                // 2. å¯«å…¥äº¤æ˜“ç´€éŒ„ (å«åŸå› )
                await addDoc(collection(db, "transactions"), {
                    userId: uid,
                    action: "admin_adjust",
                    itemName: "ç®¡ç†å“¡èª¿æ•´",
                    amount: delta,
                    note: reason, // ğŸ”¥ è¨˜éŒ„åŸå› 
                    adminId: currentAdminUid,
                    timestamp: serverTimestamp()
                });

                alert("è®Šæ›´æˆåŠŸï¼");
                closeModal();
                loadMembers(); // é‡æ–°æ•´ç†åˆ—è¡¨

            } catch (e) {
                console.error(e);
                alert("æ›´æ–°å¤±æ•—ï¼š" + e.message);
            } finally {
                btn.innerHTML = "ç¢ºèªè®Šæ›´";
                btn.disabled = false;
            }
        };

    </script>
</body>
</html>