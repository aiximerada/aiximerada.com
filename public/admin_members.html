<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿå“¡æª”æ¡ˆåº« - æŒ‡æ®å®˜å¾Œå°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* ğŸ¨ æ˜Ÿéš›é…è‰² */
            --main-gold: #FFD700;       
            --silver-starlight: #C0C0C0; /* æ–°å¢ï¼šéŠ€è‰²æ˜Ÿå…‰ */
            --accent-amber: #FDB931;    
            --deep-space: #0f172a;      
            --nebula-blue: #00f3ff;     
            
            /* ç»ç’ƒæ“¬æ…‹ */
            --glass-bg: rgba(15, 23, 42, 0.75); 
            --glass-border: rgba(255, 255, 255, 0.1);
            --card-radius: 16px;
        }

        body {
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            color: #e2e8f0; font-family: 'Microsoft JhengHei', sans-serif;
            min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden; padding-bottom: 80px; position: relative;
        }

        /* --- èƒŒæ™¯æ˜Ÿç©º --- */
        .space-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .star-field { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background-repeat: repeat; opacity: 0.5; animation-timing-function: linear; animation-iteration-count: infinite; }
        .stars-distant {
            background-image: radial-gradient(1px 1px at 10% 15%, #fff, transparent);
            background-size: 300px 300px; animation: rotateSpace 240s linear infinite;
        }
        .gold-twinklers {
            position: absolute; width: 100%; height: 100%;
            background-image: radial-gradient(2px 2px at 20% 30%, var(--main-gold), transparent);
            opacity: 0; animation: occasionalFlash 12s ease-in-out infinite;
        }
        @keyframes rotateSpace { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes occasionalFlash { 0%, 40%, 100% { opacity: 0; } 55% { opacity: 1; filter: brightness(2); } 85% { opacity: 0; } }

        /* --- UI å…ƒä»¶ --- */
        .header {
            width: 100%; padding: 15px 20px; 
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
            box-sizing: border-box; position: sticky; top: 0; z-index: 100;
        }
        .back-btn { color: #94a3b8; text-decoration: none; display: flex; align-items: center; gap: 5px; transition:0.3s; }
        .back-btn:hover { color: #fff; }

        .page-title { text-align: center; margin: 40px 0 30px 0; }
        .page-title h1 {
            margin: 0; font-size: 2.5rem; letter-spacing: 5px; font-weight: 900;
            background: linear-gradient(to bottom, #fff 0%, var(--main-gold) 100%);
            -webkit-background-clip: text; color: transparent;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
        }
        .page-title p { color: #64748b; margin-top: 5px; font-size: 1rem; letter-spacing: 3px; text-transform: uppercase; }

        .toolbar { width: 90%; max-width: 1000px; display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; justify-content: center; }
        .search-box { flex: 1; position: relative; min-width: 250px; }
        .search-input {
            width: 100%; padding: 15px 20px 15px 50px; background: var(--glass-bg);
            border: 1px solid var(--glass-border); border-radius: 50px; color: #fff;
            font-size: 1rem; box-sizing: border-box; transition: 0.3s;
        }
        .search-input:focus { border-color: var(--main-gold); outline: none; box-shadow: 0 0 15px rgba(255, 215, 0, 0.2); }
        .search-icon { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #64748b; }

        /* --- äººå“¡åˆ—è¡¨ (Grid) --- */
        .member-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px; width: 90%; max-width: 1000px;
        }

        /* äººå“¡å¡ç‰‡ */
        .member-card {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: var(--card-radius); padding: 25px;
            position: relative; overflow: hidden; transition: 0.3s;
            backdrop-filter: blur(12px); display: flex; align-items: center; gap: 20px;
        }
        .member-card::before {
            content: ''; position: absolute; left: 0; top: 0; width: 4px; height: 100%;
            background: #444; /* é è¨­ä¸€èˆ¬æœƒå“¡ */
        }
        
        /* æŒ‡æ®å®˜ (Gold) */
        .member-card.is-admin { border-color: rgba(255, 215, 0, 0.3); background: rgba(255, 215, 0, 0.05); }
        .member-card.is-admin::before { background: var(--main-gold); box-shadow: 0 0 15px var(--main-gold); }
        
        /* éŠ€æ˜Ÿæœƒå“¡ (Silver) */
        .member-card.is-silver { border-color: rgba(192, 192, 192, 0.3); background: rgba(192, 192, 192, 0.05); }
        .member-card.is-silver::before { background: var(--silver-starlight); box-shadow: 0 0 15px var(--silver-starlight); }
        
        .member-card:hover { transform: translateY(-5px); background: rgba(30, 41, 59, 0.8); }

        .avatar {
            width: 70px; height: 70px; border-radius: 50%; object-fit: cover;
            border: 2px solid var(--glass-border); box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .member-info { flex: 1; overflow: hidden; }
        .member-name { font-weight: bold; font-size: 1.1rem; color: #fff; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 5px; }
        
        .role-badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 900; }
        .badge-gold { background: var(--main-gold); color: #000; }
        .badge-silver { background: var(--silver-starlight); color: #000; }
        
        .member-email { font-size: 0.85rem; color: #94a3b8; margin-bottom: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .stars-tag { color: var(--main-gold); font-size: 0.9rem; font-weight: bold; }

        .btn-manage {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: #fff; padding: 8px 15px; border-radius: 10px; cursor: pointer;
            transition: 0.2s; white-space: nowrap;
        }
        .btn-manage:hover { background: #fff; color: #000; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-box {
            background: #1e293b; border: 1px solid var(--main-gold);
            padding: 30px; border-radius: 20px; width: 90%; max-width: 450px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.15); color: #fff;
        }

        .modal-header { font-size: 1.3rem; font-weight: bold; color: var(--main-gold); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; color: #94a3b8; font-size: 0.9rem; }
        .form-input, select {
            width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid #475569;
            color: #fff; border-radius: 8px; box-sizing: border-box; font-size: 1rem;
        }
        .form-input:focus { border-color: var(--main-gold); outline: none; }

        .modal-footer { margin-top: 25px; text-align: right; display: flex; gap: 10px; justify-content: flex-end; }
        .btn-submit { background: var(--main-gold); color: #000; padding: 10px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-cancel { background: transparent; color: #aaa; border: 1px solid #555; padding: 10px 20px; border-radius: 8px; cursor: pointer; }

        .loading-text { color: #64748b; text-align: center; grid-column: 1/-1; padding: 30px; }

    </style>
</head>
<body>

    <div class="space-container">
        <div class="star-field stars-distant"></div>
        <div class="gold-twinklers"></div>
    </div>

    <div class="header">
        <a href="vip_area.html" class="back-btn"><i class="fa-solid fa-chevron-left"></i> è¿”å›æ˜Ÿå“¡å€</a>
    </div>

    <div class="page-title">
        <h1>æ˜Ÿå“¡æª”æ¡ˆåº«</h1>
        <p>STAR MEMBER ARCHIVES</p>
    </div>

    <div class="toolbar">
        <div class="search-box">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
            <input type="text" class="search-input" id="searchInput" placeholder="æœå°‹æš±ç¨±ã€ä¿¡ç®±..." onkeyup="filterMembers()">
        </div>
        </div>

    <div class="member-grid" id="memberGrid">
        <div class="loading-text"><i class="fa-solid fa-spinner fa-spin"></i> æ­£åœ¨è®€å–æª”æ¡ˆ...</div>
    </div>

    <div class="modal-overlay" id="manageModal">
        <div class="modal-box">
            <div class="modal-header"><i class="fa-solid fa-user-gear"></i> ç®¡ç†æ˜Ÿå“¡</div>
            <input type="hidden" id="editUserId">
            
            <div class="form-group">
                <label class="form-label">æš±ç¨±</label>
                <input type="text" id="editName" class="form-input" disabled>
            </div>
            
            <div class="form-group">
                <label class="form-label">æ˜Ÿæ˜Ÿæ•¸é‡</label>
                <input type="number" id="editStars" class="form-input">
            </div>

            <div class="form-group">
                <label class="form-label">èº«ä»½æ¬Šé™</label>
                <select id="editRole" class="form-input">
                    <option value="member">ä¸€èˆ¬æ˜Ÿå“¡ (Member)</option>
                    <option value="silver">éŠ€æ˜Ÿæœƒå“¡ (Silver)</option>
                    <option value="admin">æŒ‡æ®å®˜ (Gold/Admin)</option>
                </select>
            </div>

            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn-submit" onclick="saveMemberChanges()">å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAo6on0f2QUbPaRfxpIEb2uvhKxDvPUvs",
            authDomain: "yulubox.firebaseapp.com",
            projectId: "yulubox",
            storageBucket: "yulubox.firebasestorage.app",
            messagingSenderId: "256466567852",
            appId: "1:256466567852:web:233b74668908ffcb9b9509",
            measurementId: "G-YPCY41EKWX"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allMembers = [];

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadMembers();
            } else {
                window.location.href = "login.html";
            }
        });

        // è¼‰å…¥èˆ‡æ’åº (Admin > Silver > Member)
        async function loadMembers() {
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                allMembers = [];
                querySnapshot.forEach((doc) => {
                    allMembers.push({ id: doc.id, ...doc.data() });
                });

                // ğŸ”¥ æ’åºé‚è¼¯æ›´æ–°
                allMembers.sort((a, b) => {
                    // å®šç¾©æ¬Šé‡ï¼šAdmin=3, Silver=2, Member=1
                    const getRoleWeight = (role) => {
                        if (role === 'admin') return 3;
                        if (role === 'silver') return 2;
                        return 1;
                    };
                    
                    const weightA = getRoleWeight(a.role);
                    const weightB = getRoleWeight(b.role);

                    if (weightA !== weightB) return weightB - weightA; // æ¬Šé‡é«˜è€…æ’å‰
                    return (b.stars || 0) - (a.stars || 0); // åŒæ¬Šé‡æ¯”æ˜Ÿæ˜Ÿ
                });

                renderMembers(allMembers);
            } catch (e) {
                console.error(e);
                document.getElementById('memberGrid').innerHTML = '<div class="loading-text">è®€å–å¤±æ•—</div>';
            }
        }

        window.renderMembers = (members) => {
            const grid = document.getElementById('memberGrid');
            grid.innerHTML = '';

            if (members.length === 0) {
                grid.innerHTML = '<div class="loading-text">æ²’æœ‰ç¬¦åˆçš„è³‡æ–™</div>';
                return;
            }

            members.forEach(m => {
                const role = m.role || 'member';
                let cardClass = '';
                let badgeHtml = '';

                // åˆ¤æ–·è§’è‰²æ¨£å¼
                if (role === 'admin') {
                    cardClass = 'is-admin';
                    badgeHtml = '<span class="role-badge badge-gold">GOLD</span>';
                } else if (role === 'silver') {
                    cardClass = 'is-silver';
                    badgeHtml = '<span class="role-badge badge-silver">SILVER</span>';
                }

                const avatar = m.photoURL || 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
                const name = m.displayName || 'æœªå‘½åæ˜Ÿå“¡';
                const stars = m.stars !== undefined ? m.stars : 0;

                grid.innerHTML += `
                    <div class="member-card ${cardClass}">
                        <img src="${avatar}" class="avatar">
                        <div class="member-info">
                            <div class="member-name">${name} ${badgeHtml}</div>
                            <div class="member-email">${m.email}</div>
                            <div class="stars-tag">
                                <i class="fa-solid fa-star"></i> ${stars}
                            </div>
                        </div>
                        <button class="btn-manage" onclick="openManageModal('${m.id}')">ç®¡ç†</button>
                    </div>
                `;
            });
        };

        window.filterMembers = () => {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allMembers.filter(m => 
                (m.displayName && m.displayName.toLowerCase().includes(term)) || 
                (m.email && m.email.toLowerCase().includes(term))
            );
            renderMembers(filtered);
        };

        // --- ç·¨è¼¯åŠŸèƒ½ ---
        window.openManageModal = (id) => {
            const member = allMembers.find(m => m.id === id);
            if(!member) return;

            document.getElementById('editUserId').value = id;
            document.getElementById('editName').value = member.displayName || 'ç„¡';
            document.getElementById('editStars').value = member.stars || 0;
            // è¨­å®šç›®å‰çš„é¸å–®å€¼
            document.getElementById('editRole').value = member.role || 'member';
            
            document.getElementById('manageModal').style.display = 'flex';
        };

        window.saveMemberChanges = async () => {
            const id = document.getElementById('editUserId').value;
            const newStars = parseInt(document.getElementById('editStars').value);
            const newRole = document.getElementById('editRole').value;

            try {
                await updateDoc(doc(db, "users", id), {
                    stars: newStars,
                    role: newRole
                });
                alert("æ›´æ–°æˆåŠŸ");
                closeModal();
                loadMembers();
            } catch(e) { alert("æ›´æ–°å¤±æ•—: " + e.message); }
        };

        window.closeModal = () => document.getElementById('manageModal').style.display = 'none';

        // é»æ“ŠèƒŒæ™¯é—œé–‰
        window.onclick = function(event) {
            const modal = document.getElementById('manageModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
</body>
</html>