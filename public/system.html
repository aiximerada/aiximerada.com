<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>心流呼吸燈 - 玉露寶庫</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #050510;
            --zen-cyan: #00f3ff;
            --zen-purple: #bc13fe;
            --zen-gold: #f2c94c;
        }
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            color: #fff;
            font-family: 'Microsoft JhengHei', sans-serif;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; overflow: hidden;
            user-select: none; touch-action: none;
        }

        /* --- ✨ 星空背景 --- */
        .stars-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; background-image: radial-gradient(2px 2px at 20px 30px, #fff, rgba(0,0,0,0)), radial-gradient(2px 2px at 40px 70px, #fff, rgba(0,0,0,0)); background-size: 200px 200px; opacity: 0.2; animation: moveStars 100s linear infinite; z-index: -2; }
        @keyframes moveStars { from {transform: translateY(0);} to {transform: translateY(-1000px);} }
        #twinkling-stars-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }
        .t-star { position: absolute; background-color: white; border-radius: 50%; opacity: 0; box-shadow: 0 0 4px rgba(255,255,255,0.8); animation-name: twinkle; animation-iteration-count: infinite; animation-timing-function: ease-in-out; }
        @keyframes twinkle { 0% { opacity: 0; transform: scale(0.3); } 50% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0.3); } }

        /* --- 頂部資訊 --- */
        .header { width: 90%; max-width: 600px; margin-top: 30px; position: relative; z-index: 10; display: flex; align-items: center; justify-content: space-between; }
        .back-btn { 
            color: var(--zen-cyan); text-decoration: none; border: 1px solid var(--zen-cyan); 
            padding: 8px 20px; border-radius: 20px; background: rgba(0,0,0,0.5); 
            display: flex; align-items: center; gap: 8px; font-weight: bold; transition: 0.3s;
        }
        .back-btn:hover { background: var(--zen-cyan); color: #000; box-shadow: 0 0 15px var(--zen-cyan); }

        /* --- 呼吸燈核心區域 --- */
        .zen-wrapper {
            flex-grow: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            width: 100%; position: relative;
        }

        .node-container {
            width: 320px; height: 320px;
            position: relative;
            display: flex; justify-content: center; align-items: center;
        }

        .zen-node {
            width: 80px; height: 80px;
            background: #fff;
            border-radius: 50%;
            position: relative;
            z-index: 5;
            /* 平滑流體動畫關鍵 */
            transition: all 4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.8), 0 0 100px var(--zen-cyan);
        }

        .nebula {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, var(--zen-cyan) 0%, transparent 75%);
            opacity: 0.4;
            filter: blur(30px);
            transition: all 4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .nebula-1 { width: 180px; height: 180px; z-index: 3; }
        .nebula-2 { width: 280px; height: 280px; z-index: 2; opacity: 0.15; }

        /* 提示文字 */
        .instruction {
            margin-top: 60px;
            text-align: center;
            min-height: 120px;
        }
        .action-text {
            font-size: 2.8rem; font-weight: 900; letter-spacing: 8px;
            margin-bottom: 15px; text-shadow: 0 0 20px var(--zen-cyan);
            transition: 0.8s;
        }
        .timer-text {
            font-size: 1.5rem; color: #fff; font-family: 'Courier New', monospace; opacity: 0.5;
        }

        /* 憋氣震動特效 */
        @keyframes micro-vibrate {
            0% { transform: scale(1.8) translate(0,0); }
            50% { transform: scale(1.81) translate(1px, 1px); }
            100% { transform: scale(1.8) translate(0,0); }
        }
        .vibrate { animation: micro-vibrate 0.15s infinite linear; }

        /* --- 下方按鈕 --- */
        .controls { margin-bottom: 80px; z-index: 10; }
        .zen-btn {
            background: transparent; color: var(--zen-cyan); border: 2px solid var(--zen-cyan);
            padding: 18px 50px; border-radius: 50px; font-size: 1.3rem; font-weight: bold;
            cursor: pointer; transition: 0.3s; box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
        }
        .zen-btn:hover { background: var(--zen-cyan); color: #000; box-shadow: 0 0 40px var(--zen-cyan); }
        .hidden { opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

    <div class="stars-bg"></div>
    <div id="twinkling-stars-container"></div>

    <div class="header">
        <a href="tools.html" class="back-btn"><i class="fa-solid fa-arrow-left"></i> 結束練習</a>
        <div style="font-size: 1rem; color: #555; letter-spacing: 2px; font-weight: bold;">4-7-8 METHOD</div>
    </div>

    <div class="zen-wrapper">
        <div class="node-container">
            <div class="nebula nebula-2" id="neb2"></div>
            <div class="nebula nebula-1" id="neb1"></div>
            <div class="zen-node" id="main-node"></div>
        </div>

        <div class="instruction">
            <div class="action-text" id="action">準備。</div>
            <div class="timer-text" id="timer">點擊按鈕開啟靜心之旅</div>
        </div>
    </div>

    <div class="controls">
        <button class="zen-btn" id="start-btn" onclick="startZen()">開啟心流</button>
    </div>

    <script>
        const mainNode = document.getElementById('main-node');
        const neb1 = document.getElementById('neb1');
        const neb2 = document.getElementById('neb2');
        const actionText = document.getElementById('action');
        const timerText = document.getElementById('timer');
        const startBtn = document.getElementById('start-btn');

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let isRunning = false;

        // 播放「磬」音 (Singing Bowl)
        function playBowl(freq, dur) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + dur);
        }

        async function startZen() {
            if (isRunning) return;
            isRunning = true;
            startBtn.classList.add('hidden');

            while (isRunning) {
                // 1. 吸氣 (4秒) - 升音
                playBowl(440, 4);
                await breatheCycle("吸氣", 4, 1.8, 1.0, "var(--zen-cyan)", "4s");
                
                // 2. 憋氣 (7秒) - 穩定
                mainNode.classList.add('vibrate');
                await breatheCycle("憋氣", 7, 1.8, 0.9, "var(--zen-purple)", "1s"); // 憋氣時視覺不動
                mainNode.classList.remove('vibrate');

                // 3. 吐氣 (8秒) - 降音
                playBowl(220, 8);
                await breatheCycle("吐氣", 8, 0.7, 0.2, "var(--zen-cyan)", "8s");
            }
        }

        function breatheCycle(label, seconds, scale, brightness, color, animDur) {
            return new Promise(resolve => {
                let count = seconds;
                actionText.innerText = label;
                actionText.style.color = color;
                actionText.style.textShadow = `0 0 30px ${color}`;
                
                // 更新 CSS 動畫時間，確保與呼吸同步
                mainNode.style.transitionDuration = animDur;
                neb1.style.transitionDuration = animDur;
                neb2.style.transitionDuration = animDur;

                // 視覺變化
                mainNode.style.transform = `scale(${scale})`;
                mainNode.style.boxShadow = `0 0 ${60 * scale}px rgba(255,255,255,${brightness}), 0 0 ${120 * scale}px ${color}`;
                neb1.style.transform = `scale(${scale * 1.5})`;
                neb1.style.background = `radial-gradient(circle, ${color} 0%, transparent 75%)`;
                neb2.style.transform = `scale(${scale * 2})`;

                const countdown = setInterval(() => {
                    timerText.innerText = `${count}`;
                    count--;
                    if (count < 0) {
                        clearInterval(countdown);
                        resolve();
                    }
                }, 1000);
            });
        }

        // --- 星空特效 ---
        function createTwinklingStars() {
            const container = document.getElementById('twinkling-stars-container');
            if(!container) return;
            for (let i = 0; i < 60; i++) {
                const star = document.createElement('div');
                star.className = 't-star';
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.width = `${Math.random() * 2 + 1}px`;
                star.style.height = star.style.width;
                star.style.animationDuration = `${Math.random() * 4 + 2}s`;
                star.style.animationDelay = `${Math.random() * 5}s`;
                if (Math.random() > 0.7) {
                    star.style.backgroundColor = 'var(--zen-cyan)';
                    star.style.boxShadow = '0 0 5px var(--zen-cyan)';
                }
                container.appendChild(star);
            }
        }
        window.addEventListener('load', createTwinklingStars);
    </script>
</body>
</html>