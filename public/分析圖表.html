<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>課程分析圖表 - STEAM 學習歷程分析</title>
    <!-- 引入 Tailwind CSS 用於快速且響應式的排版 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Chart.js 用於繪製圖表 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 300px; 
            transition: all 0.3s ease;
        }
        
        @media (min-width: 768px) {
            .chart-container { height: 350px; }
            .line-chart-container { height: 450px; }
        }

        /* 隱藏原生 Checkbox，客製化膠囊按鈕樣式 */
        .filter-toggle { display: none; }
        
        .filter-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-width: 2px;
            opacity: 0.5;
            filter: grayscale(0.8);
            background-color: white;
            user-select: none;
        }

        .filter-toggle:checked + .filter-btn {
            opacity: 1;
            filter: grayscale(0);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateY(-1px);
        }

        .filter-btn:hover {
            opacity: 0.8;
            filter: grayscale(0.4);
        }
        .filter-toggle:checked + .filter-btn:hover {
            opacity: 1;
        }

        .chart-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .chart-card:hover {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
        }
    </style>
</head>
<body class="text-slate-700 antialiased p-4 md:p-8 min-h-screen">

    <div class="max-w-7xl mx-auto space-y-8">
        
        <!-- 頁面標題區塊 -->
        <header class="text-center mb-12 pt-4">
            <div class="inline-block bg-indigo-50 text-indigo-600 px-4 py-1.5 rounded-full text-sm font-semibold tracking-wide mb-4 shadow-sm border border-indigo-100">
                STEAM 學習歷程分析
            </div>
            <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-slate-800 to-slate-500 mb-3 tracking-tight">
                課程分析圖表
            </h1>
            <p class="text-slate-500 text-lg md:text-xl font-light">能力分佈與操作時間紀錄儀表板</p>
        </header>

        <!-- 上半部：STEAM 圖表分析區 -->
        <section class="bg-white rounded-[2rem] shadow-lg shadow-slate-200/50 border border-slate-100 overflow-hidden">
            <div class="bg-gradient-to-r from-slate-50 to-white border-b border-slate-100 px-8 py-5 flex items-center justify-between">
                <div class="flex items-center">
                    <div class="bg-indigo-100 p-2 rounded-xl mr-4 shadow-sm">
                        <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 tracking-wide">能力分佈指標</h2>
                </div>
                <div class="text-sm text-slate-500 font-medium">
                    基準對比實際表現
                </div>
            </div>
            
            <div class="p-6 md:p-8">
                <!-- 雙圖表並排排版 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                    
                    <!-- 學生表現比例 (雙環圓餅圖區塊) -->
                    <div class="chart-card bg-slate-50/50 rounded-3xl p-6 border border-slate-100/50 relative">
                        <div class="absolute top-4 left-6 flex items-center space-x-2 z-10">
                            <span class="w-2 h-2 rounded-full bg-emerald-400"></span>
                            <h3 class="text-sm font-bold text-slate-600 uppercase tracking-wider">能力組成對比 (雙環圓餅圖)</h3>
                        </div>
                        <div class="text-xs text-slate-400 absolute top-4 right-6 text-right z-10">
                            實心外環：實際<br>虛線內環：基準
                        </div>
                        <div class="chart-container mt-6">
                            <canvas id="pieAreaChart"></canvas>
                        </div>
                    </div>

                    <!-- 學生 vs 課程對比雷達 -->
                    <div class="chart-card bg-slate-50/50 rounded-3xl p-6 border border-slate-100/50 relative">
                         <div class="absolute top-4 left-6 flex items-center space-x-2 z-10">
                            <span class="w-2 h-2 rounded-full bg-emerald-400"></span>
                            <h3 class="text-sm font-bold text-slate-600 uppercase tracking-wider">能力形狀差異</h3>
                        </div>
                        <div class="chart-container mt-6">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>

                </div>
            </div>
        </section>

        <!-- 下半部：時間紀錄區 -->
        <section class="bg-white rounded-[2rem] shadow-lg shadow-slate-200/50 border border-slate-100 overflow-hidden">
            <div class="bg-gradient-to-r from-slate-50 to-white border-b border-slate-100 px-8 py-5 flex items-center justify-between">
                <div class="flex items-center">
                    <div class="bg-emerald-100 p-2 rounded-xl mr-4 shadow-sm">
                        <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 tracking-wide">操作時間紀錄</h2>
                </div>
                
                <button id="showAllBtn" class="px-5 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-full shadow-md hover:shadow-lg transition-all text-sm font-semibold flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    重置顯示
                </button>
            </div>
            
            <div class="p-8">
                <!-- 階段區域顯示控制項 (點選會自動縮放視圖) -->
                <div class="mb-6 flex flex-wrap items-center justify-center gap-3 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                    <span class="text-sm font-bold text-slate-500 mr-2 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                        聚焦區域：
                    </span>
                    
                    <label class="cursor-pointer relative">
                        <input type="checkbox" class="zone-toggle filter-toggle" value="zone1" checked>
                        <div class="filter-btn px-4 py-1.5 rounded-full flex items-center gap-2 text-sm font-medium text-slate-600 border-slate-200 bg-slate-100/50 hover:bg-slate-200/50">
                            教材區
                        </div>
                    </label>

                    <label class="cursor-pointer relative">
                        <input type="checkbox" class="zone-toggle filter-toggle" value="zone2" checked>
                        <div class="filter-btn px-4 py-1.5 rounded-full flex items-center gap-2 text-sm font-medium text-slate-600 border-slate-200 bg-slate-100/50 hover:bg-slate-200/50">
                            進階一
                        </div>
                    </label>

                    <label class="cursor-pointer relative">
                        <input type="checkbox" class="zone-toggle filter-toggle" value="zone3" checked>
                        <div class="filter-btn px-4 py-1.5 rounded-full flex items-center gap-2 text-sm font-medium text-slate-600 border-slate-200 bg-slate-100/50 hover:bg-slate-200/50">
                            進階二
                        </div>
                    </label>

                    <label class="cursor-pointer relative">
                        <input type="checkbox" class="zone-toggle filter-toggle" value="zone4" checked>
                        <div class="filter-btn px-4 py-1.5 rounded-full flex items-center gap-2 text-sm font-medium text-slate-600 border-slate-200 bg-slate-100/50 hover:bg-slate-200/50">
                            進階三
                        </div>
                    </label>
                </div>

                <!-- 自訂圖例與過濾控制項 -->
                <div class="mb-4 flex flex-wrap items-center justify-center gap-3">
                    <label class="cursor-pointer relative">
                        <input type="checkbox" class="filter-toggle dataset-toggle" value="0" checked>
                        <div class="filter-btn px-4 py-2 rounded-full flex items-center gap-2 font-medium text-slate-700" style="border-color: #A9D0F5; background-color: #f0f7ff;">
                            <span class="w-3 h-3 rounded-full shadow-sm" style="background-color: #A9D0F5;"></span>黃郁俊
                        </div>
                    </label>

                    <label class="cursor-pointer relative">
                        <input type="checkbox" class="filter-toggle dataset-toggle" value="1" checked>
                        <div class="filter-btn px-4 py-2 rounded-full flex items-center gap-2 font-medium text-slate-700" style="border-color: #fca5a5; background-color: #fef2f2;">
                            <span class="w-3 h-3 rounded-full shadow-sm" style="background-color: #fca5a5;"></span>王xx
                        </div>
                    </label>

                    <label class="cursor-pointer relative">
                        <input type="checkbox" class="filter-toggle dataset-toggle" value="2" checked>
                        <div class="filter-btn px-4 py-2 rounded-full flex items-center gap-2 font-medium text-slate-700" style="border-color: #84cc16; background-color: #f7fee7;">
                            <span class="w-3 h-3 rounded-full shadow-sm" style="background-color: #84cc16;"></span>高xx
                        </div>
                    </label>

                    <label class="cursor-pointer relative">
                        <input type="checkbox" class="filter-toggle dataset-toggle" value="3" checked>
                        <div class="filter-btn px-4 py-2 rounded-full flex items-center gap-2 font-medium text-slate-700" style="border-color: #c084fc; background-color: #faf5ff;">
                            <span class="w-3 h-3 rounded-full shadow-sm" style="background-color: #c084fc;"></span>陳xx
                        </div>
                    </label>

                     <label class="cursor-pointer relative">
                        <input type="checkbox" class="filter-toggle dataset-toggle" value="4" checked>
                        <div class="filter-btn px-4 py-2 rounded-full flex items-center gap-2 font-medium text-slate-700" style="border-color: #fde047; background-color: #fefce8;">
                            <span class="w-3 h-3 rounded-full shadow-sm" style="background-color: #fde047;"></span>林xx
                        </div>
                    </label>
                </div>
                
                <div class="text-center text-xs text-slate-400 mb-6 flex items-center justify-center">
                    <span class="inline-block text-[10px] mr-1">⭐️</span> 實心星星代表該學生在該階段達成的「最高完成點」(忽略中途掉落)
                </div>

                <!-- 折線圖容器 -->
                <div class="chart-container line-chart-container w-full">
                    <canvas id="timeLineChart"></canvas>
                </div>
            </div>
        </section>

    </div>

    <script>
        /**
         * ==========================================
         * 系統自動生成資料區塊 (後端只需修改此處 JSON)
         * ==========================================
         */
        const chartData = {
            labels: ['科學', '技術', '工程', '藝術', '數學'],
            colors: {
                science: '#fca5a5', 
                tech: '#fde047',    
                eng: '#93c5fd',     
                art: '#c084fc',     
                math: '#94a3b8'     
            },
            baseData: [2, 4.5, 3, 2, 2.5],
            studentData: [1.5, 3, 4, 1.5, 2],
            timeLineXMax: 6000,
            timeLineDatasets: [
                {
                    label: '黃郁俊', 
                    borderColor: '#93c5fd',
                    backgroundColor: 'rgba(147, 197, 253, 0.2)',
                    borderDash: [], 
                    data: [ {x:0, y:0}, {x:50, y:10}, {x:100, y:2}, {x:800, y:5}, {x:1000, y:10}, {x:1500, y:2} ]
                },
                {
                    label: '王xx',
                    borderColor: '#fca5a5',
                    backgroundColor: 'rgba(252, 165, 165, 0.2)',
                    borderDash: [5, 5], 
                    data: [ {x:0, y:0}, {x:1500, y:10}, {x:1800, y:0}, {x:2200, y:50}, {x:2800, y:55}, {x:3100, y:100}, {x:3300, y:150}, {x:3500, y:152}, {x:3500, y:0} ]
                },
                {
                    label: '高xx',
                    borderColor: '#84cc16', 
                    backgroundColor: 'rgba(132, 204, 22, 0.2)',
                    borderDash: [5, 5],
                    data: [ {x:0, y:0}, {x:800, y:3}, {x:1200, y:5}, {x:2000, y:0}, {x:2100, y:50}, {x:2500, y:52}, {x:3000, y:58}, {x:3100, y:105}, {x:3700, y:110}, {x:3800, y:0} ]
                },
                {
                    label: '陳xx',
                    borderColor: '#c084fc', 
                    backgroundColor: 'rgba(192, 132, 252, 0.2)',
                    borderDash: [5, 5],
                    data: [ {x:2300, y:0}, {x:2350, y:52}, {x:2800, y:56}, {x:3100, y:110}, {x:3600, y:105}, {x:3700, y:150}, {x:4500, y:150}, {x:4800, y:152}, {x:4850, y:108}, {x:5100, y:105}, {x:5100, y:0} ]
                },
                {
                    label: '林xx',
                    borderColor: '#fde047', 
                    backgroundColor: 'rgba(253, 224, 71, 0.2)',
                    borderDash: [5, 5],
                    data: [ {x:2000, y:0}, {x:2200, y:50}, {x:3000, y:51}, {x:3100, y:50}, {x:3800, y:53}, {x:4000, y:55}, {x:4700, y:58}, {x:4750, y:0}, {x:4800, y:53}, {x:5400, y:51}, {x:5500, y:55}, {x:5500, y:0} ]
                }
            ]
        };
        /** ================= 系統自動生成資料區塊結束 ================= */

        // 共用設定
        const bgColors = [chartData.colors.science, chartData.colors.tech, chartData.colors.eng, chartData.colors.art, chartData.colors.math];
        Chart.defaults.font.family = "'Noto Sans TC', sans-serif";
        Chart.defaults.color = '#94a3b8'; 
        Chart.defaults.scale.grid.color = '#f1f5f9'; 

        const tooltipOptions = {
            backgroundColor: 'rgba(15, 23, 42, 0.95)', 
            titleFont: { size: 14, family: "'Noto Sans TC', sans-serif", weight: 'bold' },
            bodyFont: { size: 13, family: "'Noto Sans TC', sans-serif" },
            padding: 12,
            cornerRadius: 8,
            boxPadding: 6
        };

        // ==========================================
        // 1. 雙環圓餅圖 (Doughnut) - 基準為虛線內環
        // ==========================================
        new Chart(document.getElementById('pieAreaChart'), {
            type: 'doughnut',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: '實際表現',
                        data: chartData.studentData,
                        backgroundColor: bgColors,
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        weight: 2, // 實心外環，寬度比例 2
                        hoverOffset: 4
                    },
                    {
                        label: '基準設定',
                        data: chartData.baseData,
                        backgroundColor: 'transparent', // 內部全透明
                        borderColor: bgColors,          // 彩色虛線邊框，對應各領域
                        borderWidth: 2,
                        borderDash: [5, 5],             // 虛線樣式
                        weight: 1,                      // 虛線內環，寬度比例 1
                        hoverOffset: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '40%', // 中心留白比例
                plugins: { 
                    legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } },
                    tooltip: tooltipOptions
                }
            }
        });

        // ==========================================
        // 2. 雷達對比圖
        // ==========================================
        new Chart(document.getElementById('radarChart'), {
            type: 'radar',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: '實際表現',
                        data: chartData.studentData,
                        backgroundColor: 'rgba(52, 211, 153, 0.2)', 
                        borderColor: '#34d399',
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#34d399',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        borderWidth: 2.5
                    },
                    {
                        label: '基準設定',
                        data: chartData.baseData,
                        backgroundColor: 'transparent',
                        borderColor: '#cbd5e1', 
                        borderDash: [5, 5],
                        pointBackgroundColor: '#cbd5e1',
                        pointRadius: 2,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8 } },
                    tooltip: tooltipOptions
                },
                scales: {
                    r: { 
                        min: 0, max: 5, 
                        ticks: { stepSize: 1, backdropColor: 'transparent', display: false }, 
                        grid: { color: '#f1f5f9' },
                        angleLines: { color: '#f1f5f9' },
                        pointLabels: { font: { size: 13, weight: '500' }, color: '#64748b' }
                    }
                }
            }
        });

        // ==========================================
        // 3. 階段區域與折線圖 (星星與自動縮放邏輯)
        // ==========================================
        const activeZones = { zone1: true, zone2: true, zone3: true, zone4: true };
        const zoneConfig = [
            { id: 'zone1', min: 0, max: 50, label: '教材區', color: 'rgba(241, 245, 249, 0.7)', textColor: '#94a3b8' },
            { id: 'zone2', min: 50, max: 100, label: '進階一', color: 'rgba(224, 242, 254, 0.6)', textColor: '#38bdf8' },
            { id: 'zone3', min: 100, max: 150, label: '進階二', color: 'rgba(220, 252, 231, 0.6)', textColor: '#34d399' },
            { id: 'zone4', min: 150, max: 200, label: '進階三', color: 'rgba(254, 226, 226, 0.6)', textColor: '#fb7185' }
        ];

        // 【重構星號邏輯】：嚴格限制每階段最多 1 個星星，且忽視往回掉落的無效點
        chartData.timeLineDatasets.forEach(ds => {
            ds.lastPoints = [];
            for (let z = 1; z <= 4; z++) {
                let min = (z === 1) ? 0 : (z - 1) * 50 + 1;
                let max = z * 50;
                
                let crossIndex = ds.data.findIndex(pt => pt.y > max);
                let limit = crossIndex !== -1 ? crossIndex : ds.data.length;
                
                let bestIdx = -1;
                let bestY = -1;
                
                for (let i = 0; i < limit; i++) {
                    let pt = ds.data[i];
                    if (pt.y >= min && pt.y <= max) {
                        if (pt.y >= bestY) {
                            bestY = pt.y;
                            bestIdx = i;
                        }
                    }
                }
                
                if (bestIdx !== -1 && bestY > 0) {
                    ds.lastPoints.push(bestIdx);
                }
            }
        });

        // 背景畫色塊的 Plugin
        const horizontalZonePlugin = {
            id: 'horizontalZones',
            beforeDraw: (chart) => {
                const { ctx, chartArea: { top, bottom, left, right }, scales: { y } } = chart;
                ctx.save();
                
                zoneConfig.forEach(zone => {
                    const yTop = y.getPixelForValue(zone.max);
                    const yBottom = y.getPixelForValue(zone.min);
                    
                    const drawTop = Math.max(top, yTop);
                    const drawBottom = Math.min(bottom, yBottom);
                    
                    if (drawBottom > drawTop) {
                        ctx.fillStyle = zone.color;
                        ctx.fillRect(left, drawTop, right - left, drawBottom - drawTop);
                        
                        ctx.fillStyle = zone.textColor;
                        ctx.font = 'bold 13px "Noto Sans TC"';
                        ctx.textAlign = 'right';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(zone.label, right - 15, (drawTop + drawBottom) / 2);
                    }
                });
                ctx.restore();
            }
        };

        const lineDatasets = chartData.timeLineDatasets.map((ds) => ({
            label: ds.label,
            data: ds.data,
            borderColor: ds.borderColor,
            borderDash: ds.borderDash,
            borderWidth: 2.5,
            tension: 0, 
            stepped: false,
            // 關鍵優化：關閉強制裁切，確保畫布邊緣的星星完整呈現不被切掉
            clip: false, 
            
            pointRadius: (ctx) => {
                if(ctx.dataIndex === undefined) return 2;
                return ds.lastPoints.includes(ctx.dataIndex) ? 8 : 2;
            },
            pointStyle: (ctx) => {
                if(ctx.dataIndex === undefined) return 'circle';
                return ds.lastPoints.includes(ctx.dataIndex) ? 'star' : 'circle';
            },
            pointBackgroundColor: (ctx) => {
                if(ctx.dataIndex === undefined) return '#fff';
                return ds.lastPoints.includes(ctx.dataIndex) ? ds.borderColor : '#fff';
            },
            pointBorderColor: (ctx) => {
                return ds.borderColor;
            },
            pointBorderWidth: 2
        }));

        const timeLineChart = new Chart(document.getElementById('timeLineChart'), {
            type: 'line',
            data: { datasets: lineDatasets },
            plugins: [horizontalZonePlugin],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    // 為了配合 clip: false，給圖表內部預留一點點呼吸空間
                    padding: { top: 10, bottom: 10 }
                },
                interaction: {
                    mode: 'nearest', 
                    intersect: false
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        ...tooltipOptions,
                        callbacks: {
                            title: (items) => `時間: ${items[0].parsed.x}`,
                            label: (context) => {
                                const ds = chartData.timeLineDatasets[context.datasetIndex];
                                const isLast = ds.lastPoints.includes(context.dataIndex);
                                const mark = isLast ? ' ⭐ (最高完成點)' : '';
                                return ` ${context.dataset.label}: ${context.parsed.y}${mark}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'linear',
                        min: 0,
                        max: chartData.timeLineXMax,
                        ticks: { stepSize: 1000, color: '#94a3b8', font: {family: "'Noto Sans TC', sans-serif"} },
                        grid: { color: '#f8fafc', drawBorder: false },
                        title: { display: true, text: '操作時間軸 (ms/s)', color: '#cbd5e1', font: {size: 13} }
                    },
                    y: {
                        min: 0,
                        max: 210, // 初始最大值加 10 的 Padding
                        ticks: { stepSize: 50, color: '#94a3b8', font: {family: "'Noto Sans TC', sans-serif"} },
                        grid: { color: '#f1f5f9', drawBorder: false },
                    }
                }
            }
        });

        // ==========================================
        // 4. UI 互動與智慧縮放邏輯
        // ==========================================
        const zoneCheckboxes = document.querySelectorAll('.zone-toggle');
        const datasetCheckboxes = document.querySelectorAll('.dataset-toggle');
        const showAllBtn = document.getElementById('showAllBtn');

        function updateYAxisZoom() {
            let activeMins = [];
            let activeMaxs = [];
            zoneConfig.forEach(zone => {
                if (activeZones[zone.id]) {
                    activeMins.push(zone.min);
                    activeMaxs.push(zone.max);
                }
            });
            
            // 依照選取的區域放大 Y 軸視野，並加上 10 的 Padding 防切點
            if (activeMins.length > 0) {
                let minVal = Math.min(...activeMins);
                let maxVal = Math.max(...activeMaxs);
                timeLineChart.options.scales.y.min = minVal === 0 ? 0 : minVal - 10;
                timeLineChart.options.scales.y.max = maxVal + 10;
            } else {
                timeLineChart.options.scales.y.min = 0;
                timeLineChart.options.scales.y.max = 210;
            }
            timeLineChart.update();
        }

        // 【智慧點選邏輯】
        zoneCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('click', function(e) {
                e.preventDefault();
                
                const clickedVal = this.value;
                const checkedCount = Object.values(activeZones).filter(v => v).length;
                
                if (checkedCount === 4) {
                    Object.keys(activeZones).forEach(k => activeZones[k] = false);
                    activeZones[clickedVal] = true;
                } else {
                    activeZones[clickedVal] = !activeZones[clickedVal];
                }
                
                if (Object.values(activeZones).filter(v => v).length === 0) {
                    Object.keys(activeZones).forEach(k => activeZones[k] = true);
                }
                
                zoneCheckboxes.forEach(cb => cb.checked = activeZones[cb.value]);
                updateYAxisZoom();
            });
        });

        datasetCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const datasetIndex = parseInt(this.value);
                timeLineChart.setDatasetVisibility(datasetIndex, this.checked);
                timeLineChart.update();
            });
        });

        showAllBtn.addEventListener('click', () => {
            datasetCheckboxes.forEach(cb => { cb.checked = true; });
            chartData.timeLineDatasets.forEach((_, index) => {
                timeLineChart.setDatasetVisibility(index, true);
            });
            
            zoneCheckboxes.forEach(cb => { 
                cb.checked = true; 
                activeZones[cb.value] = true;
            });
            updateYAxisZoom();
        });

    </script>
</body>
</html>