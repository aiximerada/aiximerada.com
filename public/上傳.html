<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ å¯†å‚³è¼¸è‰™ - ç‰éœ²å¯¶åº«</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-red: #ff4757;
            --neon-green: #00ff9d;
            --glass-bg: rgba(20, 30, 50, 0.7);
            --glass-border: rgba(0, 243, 255, 0.3);
        }
        body {
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            color: #fff; font-family: 'Microsoft JhengHei', sans-serif;
            min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden;
        }

        /* ğŸŒŒ å‹•æ…‹æ˜Ÿç©ºèƒŒæ™¯ */
        #star-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; pointer-events: none; overflow: hidden;
        }
        .star {
            position: absolute; background: white; border-radius: 50%;
            animation: twinkle var(--duration) ease-in-out infinite;
            opacity: var(--opacity);
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); box-shadow: 0 0 10px white; }
        }

        /* é ‚éƒ¨ */
        .header {
            width: 100%; padding: 20px; box-sizing: border-box;
            background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--glass-border);
            display: flex; align-items: center; gap: 15px; backdrop-filter: blur(10px);
            z-index: 10;
        }
        .back-btn { color: #fff; text-decoration: none; font-size: 1.2rem; transition: 0.3s; }
        .back-btn:hover { color: var(--neon-blue); }
        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 1px; color: var(--neon-blue); display: flex; align-items: center; gap: 10px; }
        .user-status { margin-left: auto; font-size: 0.8rem; padding: 4px 10px; border-radius: 10px; background: rgba(255,255,255,0.1); color: #aaa; }

        /* ä¸»å®¹å™¨ */
        .container {
            width: 90%; max-width: 550px; margin-top: 30px;
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 30px; margin-bottom: 50px;
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.15);
            backdrop-filter: blur(10px); z-index: 5;
        }

        /* åˆ†é åˆ‡æ› */
        .tabs { display: flex; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; color: #888; transition: 0.3s; position: relative; }
        .tab.active { color: var(--neon-blue); font-weight: bold; }
        .tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px; background: var(--neon-blue); box-shadow: 0 0 10px var(--neon-blue); }

        /* è¡¨å–®èˆ‡æŒ‰éˆ• */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: #aaa; font-size: 0.9rem; }
        .form-input, .form-select, textarea { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 8px; color: #fff; box-sizing: border-box; }
        .form-input:focus { border-color: var(--neon-blue); outline: none; }

        .drop-zone { border: 2px dashed #444; border-radius: 10px; padding: 30px; text-align: center; cursor: pointer; transition: 0.3s; color: #888; background: rgba(0,0,0,0.2); }
        .drop-zone:hover { border-color: var(--neon-blue); color: #fff; background: rgba(0, 243, 255, 0.05); }
        .file-list { margin-top: 10px; font-size: 0.85rem; color: var(--neon-blue); text-align: left; }

        .progress-container { width: 100%; background: #333; border-radius: 10px; height: 10px; margin-top: 15px; overflow: hidden; display: none; }
        .progress-bar { width: 0%; height: 100%; background: var(--neon-blue); transition: width 0.3s; box-shadow: 0 0 10px var(--neon-blue); }
        .progress-text { text-align: center; font-size: 0.8rem; margin-top: 5px; color: #aaa; display: none; }

        .btn-action { width: 100%; padding: 12px; border: none; border-radius: 50px; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 10px; background: var(--neon-blue); color: #000; transition: 0.3s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-action:hover { box-shadow: 0 0 20px var(--neon-blue); transform: translateY(-2px); }
        .btn-action:disabled { background: #555; color: #888; cursor: not-allowed; box-shadow: none; transform: none; }
        .download-btn { background: var(--neon-green); }

        /* çµæœé¡¯ç¤º */
        #resultArea { display: none; margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.5); border-radius: 10px; text-align: center; }
        .code-display { font-size: 2.5rem; font-family: monospace; color: var(--neon-green); margin: 15px 0; letter-spacing: 5px; text-shadow: 0 0 10px var(--neon-green); }
        .copy-btn { background: none; border: 1px solid #fff; padding: 5px 15px; border-radius: 20px; color: #fff; cursor: pointer; margin-top: 10px; }
        .copy-btn:hover { background: #fff; color: #000; }

        /* æ­·å²ç´€éŒ„ */
        .history-section { margin-top: 40px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; }
        .history-title { font-size: 1rem; color: #aaa; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .history-list { display: flex; flex-direction: column; gap: 10px; }
        .history-item { 
            background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 10px; padding: 15px; 
            display: flex; justify-content: space-between; align-items: center; transition: 0.3s;
        }
        .history-item:hover { border-color: var(--neon-blue); background: rgba(0, 243, 255, 0.05); }
        .h-info { display: flex; flex-direction: column; gap: 3px; }
        .h-code { font-family: monospace; font-size: 1.2rem; color: var(--neon-green); font-weight: bold; }
        .h-date { font-size: 0.8rem; color: #888; }
        .h-expire { font-size: 0.8rem; color: var(--neon-red); }
        .btn-delete { 
            background: rgba(255, 71, 87, 0.1); border: 1px solid var(--neon-red); color: var(--neon-red); 
            width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            transition: 0.2s;
        }
        .btn-delete:hover { background: var(--neon-red); color: #fff; box-shadow: 0 0 10px var(--neon-red); }

        /* ä¸‹è¼‰åˆ—è¡¨ */
        .download-item { background: rgba(255,255,255,0.1); padding: 10px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .dl-link { color: var(--neon-green); text-decoration: none; font-weight: bold; border:1px solid var(--neon-green); padding:5px 10px; border-radius:5px; transition:0.3s;}
        .dl-link:hover { background: var(--neon-green); color:#000; }
        .file-icon { margin-right: 8px; color: var(--neon-blue); }
    </style>
</head>
<body>

    <div id="star-container"></div>

    <div class="header">
        <a href="upload_zone.html" class="back-btn"><i class="fa-solid fa-toolbox"></i> è¿”å›å·¥å…·å€</a>
        <h1><i class="fa-solid fa-file-shield"></i> åŠ å¯†å‚³è¼¸è‰™</h1>
        <div class="user-status" id="userStatus">åµæ¸¬ä¸­...</div>
    </div>

    <div class="container">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('upload')">ç™¼é€æª”æ¡ˆ</div>
            <div class="tab" onclick="switchTab('download')">æ¥æ”¶æª”æ¡ˆ</div>
        </div>

        <div id="uploadSection">
            <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
                <i class="fa-solid fa-cloud-arrow-up" style="font-size: 2.5rem; margin-bottom: 10px;"></i>
                <div>é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆè‡³æ­¤</div>
                <input type="file" id="fileInput" multiple style="display:none" onchange="handleFileSelect(this)">
            </div>
            <div class="file-list" id="fileList"></div>

            <div class="form-group" style="margin-top:20px;">
                <label class="form-label">é™„åŠ åŠ å¯†è¨Šæ¯ (å¯é¸)</label>
                <textarea id="secretMsg" rows="2" placeholder="è¼¸å…¥æ–‡å­—..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">è¨­å®šæå–å¯†ç¢¼</label>
                <input type="text" id="uploadPwd" class="form-input" placeholder="ä¾‹å¦‚ï¼š1234">
            </div>

            <div class="form-group">
                <label class="form-label">æœ‰æ•ˆæœŸé™ (éæœŸè‡ªå‹•éŠ·æ¯€)</label>
                <select id="expiryTime" class="form-select">
                    <option value="10">10 åˆ†é˜å¾ŒéŠ·æ¯€</option>
                    <option value="60">1 å°æ™‚å¾ŒéŠ·æ¯€</option>
                    <option value="1440">24 å°æ™‚å¾ŒéŠ·æ¯€ (1å¤©)</option>
                    <option value="4320">72 å°æ™‚å¾ŒéŠ·æ¯€ (3å¤©)</option>
                </select>
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText">æº–å‚™ä¸­...</div>

            <button class="btn-action" id="uploadBtn" onclick="window.executeUpload()">
                <i class="fa-solid fa-rocket"></i> åŠ å¯†ä¸Šå‚³
            </button>

            <div class="history-section">
                <div class="history-title">
                    <span><i class="fa-solid fa-clock-rotate-left"></i> æœ¬æ©Ÿå‚³è¼¸æ—¥èªŒ</span>
                    <span style="font-size:0.8rem; cursor:pointer;" onclick="clearHistory()">æ¸…ç©ºç´€éŒ„</span>
                </div>
                <div class="history-list" id="historyList">
                    <div style="text-align:center; color:#555;">æš«ç„¡ç´€éŒ„</div>
                </div>
            </div>
        </div>

        <div id="downloadSection" style="display:none;">
            <div class="form-group">
                <label class="form-label">è¼¸å…¥å‚³è¼¸ä»£ç¢¼ (Share Code)</label>
                <input type="text" id="shareCode" class="form-input" placeholder="è«‹è¼¸å…¥6ä½ä»£ç¢¼" style="text-transform: uppercase;">
            </div>
            <div class="form-group">
                <label class="form-label">è¼¸å…¥æå–å¯†ç¢¼</label>
                <input type="password" id="accessPwd" class="form-input" placeholder="å¯†ç¢¼">
            </div>
            
            <button class="btn-action download-btn" id="downloadBtn" onclick="window.executeDownload()">
                <i class="fa-solid fa-unlock"></i> è§£é–æª”æ¡ˆ
            </button>

            <div id="downloadArea" style="display:none; margin-top:20px;">
                <h4 style="color:var(--neon-green); margin:0 0 10px 0;">æª”æ¡ˆåˆ—è¡¨ (é»æ“Šä¸‹è¼‰)</h4>
                <div id="downloadList"></div>
                <div style="background:rgba(255,255,255,0.1); padding:10px; margin-top:10px; border-radius:5px; display:none;" id="msgArea">
                    <div style="color:#aaa; font-size:0.8rem;">é™„åŠ è¨Šæ¯ï¼š</div>
                    <div id="msgContent" style="white-space: pre-wrap;"></div>
                </div>
            </div>
        </div>

        <div id="resultArea">
            <div style="color:#aaa; font-size:0.9rem;">å‚³è¼¸å»ºç«‹æˆåŠŸï¼è«‹å°‡ä»£ç¢¼äº¤çµ¦å°æ–¹ï¼š</div>
            <div class="code-display" id="resultCode">------</div>
            <button class="copy-btn" onclick="copyCode()"><i class="fa-regular fa-copy"></i> è¤‡è£½ä»£ç¢¼</button>
            <div class="timer-badge" id="expiryDisplay" style="margin-top:15px; display:block; color:#ffaa00;"></div>
            <button class="btn-action" onclick="location.reload()" style="margin-top:20px; background:transparent; border:1px solid #555; color:#fff;">è¿”å›</button>
        </div>

        <div id="statusMsg" style="text-align:center; margin-top:15px; font-weight:bold;"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, deleteDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAo6on0f2QUbPaRfxpIEb2uvhKxDvPUvs",
            authDomain: "yulubox.firebaseapp.com",
            projectId: "yulubox",
            storageBucket: "yulubox.firebasestorage.app",
            messagingSenderId: "256466567852",
            appId: "1:256466567852:web:233b74668908ffcb9b9509",
            measurementId: "G-YPCY41EKWX"
        };

        let app, auth, db, storage, currentUser;
        let selectedFiles = [];

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);

            onAuthStateChanged(auth, user => {
                if(user) {
                    currentUser = user;
                    document.getElementById('userStatus').innerText = `æŒ‡æ®å®˜: ${user.displayName || 'User'}`;
                    document.getElementById('userStatus').style.color = "#00ff9d";
                } else {
                    currentUser = null;
                    document.getElementById('userStatus').innerText = "åŒ¿åè¨ªå®¢";
                }
            });
            
            loadHistory();

        } catch (e) { alert("ç³»çµ±åˆå§‹åŒ–éŒ¯èª¤: " + e.message); }

        // --- æ˜Ÿç©ºç‰¹æ•ˆ ---
        function createStars() {
            const container = document.getElementById('star-container');
            const starCount = 80;
            for(let i=0; i<starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                const size = Math.random() * 2.5;
                const duration = 2 + Math.random() * 3;
                star.style.left = `${x}%`;
                star.style.top = `${y}%`;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.setProperty('--duration', `${duration}s`);
                star.style.setProperty('--opacity', Math.random());
                container.appendChild(star);
            }
        }
        createStars();

        // --- å…¨åŸŸè®Šæ•¸ç¶å®š ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab')[tab==='upload'?0:1].classList.add('active');
            document.getElementById('uploadSection').style.display = tab==='upload'?'block':'none';
            document.getElementById('downloadSection').style.display = tab==='download'?'block':'none';
            document.getElementById('resultArea').style.display = 'none';
        };

        window.handleFileSelect = (input) => {
            selectedFiles = Array.from(input.files);
            const list = document.getElementById('fileList');
            if(selectedFiles.length === 0) { list.innerText = ''; return; }
            list.innerHTML = selectedFiles.map(f => `<div><i class="fa-solid fa-file"></i> ${f.name} (${(f.size/1024).toFixed(1)}KB)</div>`).join('');
        };

        window.copyCode = () => {
            navigator.clipboard.writeText(document.getElementById('resultCode').innerText);
            alert("å·²è¤‡è£½");
        };

        // --- ğŸš€ ä¸Šå‚³é‚è¼¯ (ä¿®å¾©é¡å‹å•é¡Œ) ---
        window.executeUpload = async () => {
            const pwd = document.getElementById('uploadPwd').value;
            const msg = document.getElementById('secretMsg').value;
            const expiryMins = parseInt(document.getElementById('expiryTime').value);

            if(!pwd) return alert("è«‹è¨­å®šå¯†ç¢¼");
            if(selectedFiles.length === 0 && !msg) return alert("è«‹é¸æ“‡æª”æ¡ˆæˆ–è¼¸å…¥è¨Šæ¯");

            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('progressText').style.display = 'block';

            try {
                const shareCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                const uploadedFiles = [];
                
                // 1. ä¸Šå‚³æª”æ¡ˆ
                if(selectedFiles.length > 0) {
                    for (let i = 0; i < selectedFiles.length; i++) {
                        const file = selectedFiles[i];
                        updateProgress((i / selectedFiles.length) * 100, `ä¸Šå‚³: ${file.name}`);
                        
                        const storageRef = ref(storage, `temp_shares/${shareCode}/${file.name}`);
                        
                        // ğŸ”¥ é—œéµä¿®æ­£ï¼šåŠ å…¥ metadata è®“ç€è¦½å™¨çŸ¥é“å®ƒæ˜¯ä»€éº¼æª”æ¡ˆ (Word, PDF...)
                        const metadata = {
                            contentType: file.type || 'application/octet-stream'
                        };
                        
                        await uploadBytesResumable(storageRef, file, metadata);
                        const url = await getDownloadURL(storageRef);
                        
                        uploadedFiles.push({ 
                            name: file.name, 
                            url: url, 
                            path: `temp_shares/${shareCode}/${file.name}`,
                            type: file.type // ç´€éŒ„é¡å‹
                        });
                    }
                }
                
                // 2. è™•ç†æ–‡å­—è¨Šæ¯ (å­˜æˆç¨ç«‹æª”æ¡ˆ)
                if(msg) {
                    // ä¸éœ€è¦ä¸Šå‚³åˆ° Storageï¼Œç›´æ¥å­˜å…¥ Firestore å³å¯ï¼Œä¸‹è¼‰æ™‚é¡¯ç¤ºåœ¨ä»‹é¢ä¸Š
                }

                updateProgress(100, "å¯«å…¥è³‡æ–™åº«...");
                const expiryDate = new Date(Date.now() + expiryMins * 60000);
                
                // 3. å¯«å…¥ Firestore
                const docRef = await addDoc(collection(db, "temp_shares"), {
                    shareCode: shareCode,
                    password: pwd,
                    files: uploadedFiles,
                    message: msg || "",
                    expiresAt: expiryDate,
                    uploader: currentUser ? currentUser.uid : "anonymous",
                    createdAt: serverTimestamp()
                });

                // 4. å„²å­˜æ­·å²ç´€éŒ„
                saveHistory({
                    code: shareCode,
                    expiry: expiryDate.getTime(),
                    docId: docRef.id,
                    files: uploadedFiles
                });

                updateProgress(100, "å®Œæˆï¼");
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('resultArea').style.display = 'block';
                document.getElementById('resultCode').innerText = shareCode;
                document.getElementById('expiryDisplay').innerText = `æœ‰æ•ˆè‡³: ${expiryDate.toLocaleString()}`;

                // é‡ç½®
                selectedFiles = [];
                document.getElementById('fileInput').value = '';
                btn.disabled = false;

            } catch (e) {
                console.error(e);
                alert("ä¸Šå‚³å¤±æ•—: " + e.message);
                btn.disabled = false;
            }
        };

        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressText').innerText = `${Math.round(percent)}% - ${text}`;
        }

        // --- ğŸ“œ æ­·å²ç´€éŒ„åŠŸèƒ½ ---
        function saveHistory(item) {
            const history = JSON.parse(localStorage.getItem('yulu_transfer_history') || '[]');
            history.unshift(item); 
            localStorage.setItem('yulu_transfer_history', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const list = document.getElementById('historyList');
            const history = JSON.parse(localStorage.getItem('yulu_transfer_history') || '[]');
            
            if(history.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#555;">æš«ç„¡ç´€éŒ„</div>';
                return;
            }

            list.innerHTML = history.map(item => {
                const isExpired = Date.now() > item.expiry;
                const dateStr = new Date(item.expiry).toLocaleString();
                const statusColor = isExpired ? '#ff4757' : '#00ff9d';
                const statusText = isExpired ? 'å·²éæœŸ' : 'æœ‰æ•ˆ';
                
                return `
                    <div class="history-item">
                        <div class="h-info">
                            <div class="h-code">${item.code}</div>
                            <div class="h-date">æˆªæ­¢: ${dateStr}</div>
                            <div class="h-expire" style="color:${statusColor}">ç‹€æ…‹: ${statusText}</div>
                        </div>
                        <button class="btn-delete" onclick="window.deleteItem('${item.docId}', '${item.code}')" title="åˆªé™¤æª”æ¡ˆ">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        window.clearHistory = () => {
            if(confirm("ç¢ºå®šæ¸…ç©ºæœ¬æ©Ÿç´€éŒ„ï¼Ÿ(ä¸æœƒåˆªé™¤é›²ç«¯æª”æ¡ˆ)")) {
                localStorage.removeItem('yulu_transfer_history');
                loadHistory();
            }
        };

        // --- ğŸ—‘ï¸ åˆªé™¤åŠŸèƒ½ ---
        window.deleteItem = async (docId, code) => {
            if(!confirm(`ç¢ºå®šè¦åˆªé™¤ä»£ç¢¼ ${code} çš„æ‰€æœ‰æª”æ¡ˆå—ï¼Ÿ`)) return;

            const history = JSON.parse(localStorage.getItem('yulu_transfer_history') || '[]');
            const item = history.find(h => h.docId === docId);

            if(!item) { alert("æ‰¾ä¸åˆ°æœ¬æ©Ÿç´€éŒ„"); return; }
            const btn = event.target.closest('button');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            try {
                if (item.files && item.files.length > 0) {
                    for (const file of item.files) {
                        const fileRef = ref(storage, file.path);
                        await deleteObject(fileRef).catch(err => console.warn("File already deleted"));
                    }
                }
                await deleteDoc(doc(db, "temp_shares", docId));
                
                const newHistory = history.filter(h => h.docId !== docId);
                localStorage.setItem('yulu_transfer_history', JSON.stringify(newHistory));
                
                alert("åˆªé™¤æˆåŠŸï¼");
                loadHistory();

            } catch (e) {
                console.error(e);
                alert("åˆªé™¤å¤±æ•—: " + e.message);
                loadHistory();
            }
        };

        // --- ğŸ“¥ ä¸‹è¼‰é‚è¼¯ ---
        window.executeDownload = async () => {
            const code = document.getElementById('shareCode').value.toUpperCase();
            const pwd = document.getElementById('accessPwd').value;
            const btn = document.getElementById('downloadBtn');

            if(!code || !pwd) return alert("è«‹è¼¸å…¥ä»£ç¢¼èˆ‡å¯†ç¢¼");

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> æœå°‹ä¸­...';

            try {
                const snapshot = await getDocs(collection(db, "temp_shares"));
                let targetDoc = null;
                snapshot.forEach(docSnap => {
                    if(docSnap.data().shareCode === code) targetDoc = { id: docSnap.id, ...docSnap.data() };
                });

                if(!targetDoc) {
                    btn.disabled = false; btn.innerText = "è§£é–æª”æ¡ˆ";
                    return alert("æ‰¾ä¸åˆ°æ­¤ä»£ç¢¼");
                }

                if (new Date() > targetDoc.expiresAt.toDate()) {
                    btn.disabled = false; btn.innerText = "è§£é–æª”æ¡ˆ";
                    return alert("æª”æ¡ˆå·²éæœŸã€‚");
                }

                if (targetDoc.password !== pwd) {
                    btn.disabled = false; btn.innerText = "è§£é–æª”æ¡ˆ";
                    return alert("å¯†ç¢¼éŒ¯èª¤");
                }

                // é¡¯ç¤ºåˆ—è¡¨
                document.getElementById('downloadArea').style.display = 'block';
                const list = document.getElementById('downloadList');
                list.innerHTML = '';

                // ğŸ”¥ é—œéµä¿®å¾©ï¼šä¸‹è¼‰é€£çµä¸ä½¿ç”¨ download å±¬æ€§ï¼ˆè·¨åŸŸç„¡æ•ˆï¼‰ï¼Œè€Œæ˜¯ç›´æ¥é–‹å•Ÿé€£çµ
                if (targetDoc.files && targetDoc.files.length > 0) {
                    targetDoc.files.forEach(f => {
                        let icon = 'fa-file';
                        if(f.name.includes('.doc')) icon = 'fa-file-word';
                        if(f.name.includes('.pdf')) icon = 'fa-file-pdf';
                        if(f.name.includes('.jpg') || f.name.includes('.png')) icon = 'fa-file-image';

                        list.innerHTML += `
                            <div class="download-item">
                                <span><i class="fa-solid ${icon} file-icon"></i> ${f.name}</span>
                                <a href="${f.url}" target="_blank" class="dl-link">ä¸‹è¼‰</a>
                            </div>`;
                    });
                } else if (targetDoc.downloadUrl) { // èˆŠç‰ˆç›¸å®¹
                    list.innerHTML = `<div class="download-item"><span>å£“ç¸®æª”.zip</span><a href="${targetDoc.downloadUrl}" target="_blank" class="dl-link">ä¸‹è¼‰</a></div>`;
                }

                const msgArea = document.getElementById('msgArea');
                if(targetDoc.message) {
                    msgArea.style.display = 'block';
                    document.getElementById('msgContent').innerText = targetDoc.message;
                } else { msgArea.style.display = 'none'; }

                btn.style.display = 'none'; 

            } catch (e) {
                console.error(e);
                btn.disabled = false; btn.innerText = "è§£é–æª”æ¡ˆ";
                alert("è®€å–å¤±æ•—: " + e.message);
            }
        };
    </script>
</body>
</html>