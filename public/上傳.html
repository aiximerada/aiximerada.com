<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ å¯†å‚³è¼¸è‰™ - ç‰éœ²å¯¶åº«</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-red: #ff4757;
            --neon-green: #00ff9d;
            --glass-bg: rgba(20, 30, 50, 0.6);
            --glass-border: rgba(0, 243, 255, 0.2);
        }
        body {
            /* ğŸŒŒ æ·±ç©ºæ˜Ÿéš›èƒŒæ™¯ (èˆ‡é¦–é çµ±ä¸€) */
            background: linear-gradient(135deg, #0a0a0a 0%, #1a2c4e 50%, #0b1021 100%);
            color: #fff; font-family: 'Microsoft JhengHei', sans-serif;
            min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center;
            background-attachment: fixed;
        }

        /* é ‚éƒ¨ */
        .header {
            width: 100%; padding: 20px; box-sizing: border-box;
            background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--glass-border);
            display: flex; align-items: center; gap: 15px; backdrop-filter: blur(10px);
        }
        .back-btn { color: #fff; text-decoration: none; font-size: 1.2rem; transition: 0.3s; }
        .back-btn:hover { color: var(--neon-blue); }
        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 1px; color: var(--neon-blue); display: flex; align-items: center; gap: 10px; }

        /* èº«ä»½æ¨™ç±¤ */
        .user-status {
            margin-left: auto; font-size: 0.8rem; padding: 4px 10px;
            border-radius: 10px; background: rgba(255,255,255,0.1); color: #aaa;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            width: 90%; max-width: 500px; margin-top: 30px;
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 30px;
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.1);
            backdrop-filter: blur(10px); margin-bottom: 50px;
        }

        /* åˆ†é åˆ‡æ› */
        .tabs { display: flex; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .tab {
            flex: 1; padding: 15px; text-align: center; cursor: pointer;
            color: #888; transition: 0.3s; position: relative;
        }
        .tab.active { color: var(--neon-blue); font-weight: bold; }
        .tab.active::after {
            content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px;
            background: var(--neon-blue); box-shadow: 0 0 10px var(--neon-blue);
        }

        /* è¡¨å–®æ¨£å¼ */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: #aaa; font-size: 0.9rem; }
        .form-input, .form-select, textarea {
            width: 100%; padding: 12px; background: rgba(0,0,0,0.3);
            border: 1px solid #444; border-radius: 8px; color: #fff; box-sizing: border-box;
        }
        .form-input:focus { border-color: var(--neon-blue); outline: none; }

        /* æª”æ¡ˆä¸Šå‚³å€ */
        .drop-zone {
            border: 2px dashed #444; border-radius: 10px; padding: 30px;
            text-align: center; cursor: pointer; transition: 0.3s;
            color: #888; background: rgba(0,0,0,0.2);
        }
        .drop-zone:hover, .drop-zone.dragover { border-color: var(--neon-blue); color: #fff; background: rgba(0, 243, 255, 0.05); }
        .file-list { margin-top: 10px; font-size: 0.85rem; color: var(--neon-blue); text-align: left; }

        /* é€²åº¦æ¢æ¨£å¼ (æ–°å¢) */
        .progress-container {
            width: 100%; background: #333; border-radius: 10px; height: 10px;
            margin-top: 15px; overflow: hidden; display: none;
        }
        .progress-bar {
            width: 0%; height: 100%; background: var(--neon-blue);
            transition: width 0.3s; box-shadow: 0 0 10px var(--neon-blue);
        }
        .progress-text { text-align: center; font-size: 0.8rem; margin-top: 5px; color: #aaa; display: none; }

        /* æŒ‰éˆ• */
        .btn-action {
            width: 100%; padding: 12px; border: none; border-radius: 50px;
            font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 10px;
            background: var(--neon-blue); color: #000; transition: 0.3s;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-action:hover { box-shadow: 0 0 20px var(--neon-blue); }
        .btn-action:disabled { background: #555; color: #888; cursor: not-allowed; box-shadow: none; }
        .download-btn { background: var(--neon-green); }

        /* çµæœé¡¯ç¤ºå€ */
        #resultArea { display: none; margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.5); border-radius: 10px; text-align: center; }
        .code-display { 
            font-size: 2rem; font-family: monospace; color: var(--neon-green); margin: 10px 0; 
            letter-spacing: 5px; border: 1px dashed var(--neon-green); padding: 10px;
        }
        .copy-btn { background: none; border: none; color: #fff; cursor: pointer; text-decoration: underline; }
        .timer-badge {
            display: inline-block; background: #333; padding: 5px 10px; 
            border-radius: 5px; font-size: 0.8rem; margin-top: 5px; color: #ffaa00;
        }
        
        /* ä¸‹è¼‰åˆ—è¡¨ */
        .download-list { margin-top: 15px; text-align: left; }
        .download-item {
            background: rgba(255,255,255,0.1); padding: 10px; margin-bottom: 8px;
            border-radius: 8px; display: flex; justify-content: space-between; align-items: center;
        }
        .dl-link { color: var(--neon-green); text-decoration: none; font-weight: bold; border:1px solid var(--neon-green); padding:5px 10px; border-radius:5px;}
        .dl-link:hover { background: var(--neon-green); color:#000; }
    </style>
</head>
<body>

    <div class="header">
        <a href="index.html" class="back-btn"><i class="fa-solid fa-house"></i> è¿”å›å¤§å»³</a>
        <h1><i class="fa-solid fa-file-shield"></i> å…¬é–‹å‚³è¼¸è‰™</h1>
        <div class="user-status" id="userStatus">åµæ¸¬ä¸­...</div>
    </div>

    <div class="container">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('upload')">ç™¼é€æª”æ¡ˆ</div>
            <div class="tab" onclick="switchTab('download')">æ¥æ”¶æª”æ¡ˆ</div>
        </div>

        <div id="uploadSection">
            <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
                <i class="fa-solid fa-cloud-arrow-up" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <div>é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆè‡³æ­¤ (å¤šæª”è‡ªå‹•åˆ—è¡¨)</div>
                <input type="file" id="fileInput" multiple style="display:none" onchange="handleFileSelect(this)">
            </div>
            <div class="file-list" id="fileList"></div>

            <div class="form-group" style="margin-top:20px;">
                <label class="form-label">é™„åŠ åŠ å¯†è¨Šæ¯ (å¯é¸)</label>
                <textarea id="secretMsg" rows="2" placeholder="è¼¸å…¥æ–‡å­—..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">è¨­å®šæå–å¯†ç¢¼</label>
                <input type="text" id="uploadPwd" class="form-input" placeholder="ä¾‹å¦‚ï¼š1234">
            </div>

            <div class="form-group">
                <label class="form-label">æœ‰æ•ˆæœŸé™ (éæœŸè‡ªå‹•éŠ·æ¯€)</label>
                <select id="expiryTime" class="form-select">
                    <option value="10">10 åˆ†é˜å¾ŒéŠ·æ¯€</option>
                    <option value="60">1 å°æ™‚å¾ŒéŠ·æ¯€</option>
                    <option value="1440">24 å°æ™‚å¾ŒéŠ·æ¯€</option>
                </select>
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText">æº–å‚™ä¸­...</div>

            <button class="btn-action" id="uploadBtn" onclick="window.executeUpload()">
                <i class="fa-solid fa-rocket"></i> åŠ å¯†ä¸Šå‚³
            </button>
        </div>

        <div id="downloadSection" style="display:none;">
            <div class="form-group">
                <label class="form-label">è¼¸å…¥å‚³è¼¸ä»£ç¢¼ (Share Code)</label>
                <input type="text" id="shareCode" class="form-input" placeholder="è«‹è¼¸å…¥6ä½ä»£ç¢¼" style="text-transform: uppercase;">
            </div>
            <div class="form-group">
                <label class="form-label">è¼¸å…¥æå–å¯†ç¢¼</label>
                <input type="password" id="accessPwd" class="form-input" placeholder="å¯†ç¢¼">
            </div>
            
            <button class="btn-action download-btn" id="downloadBtn" onclick="window.executeDownload()">
                <i class="fa-solid fa-unlock"></i> è§£é–æª”æ¡ˆ
            </button>

            <div id="downloadArea" style="display:none; margin-top:20px;">
                <h4 style="color:var(--neon-green); margin:0 0 10px 0;">æª”æ¡ˆåˆ—è¡¨</h4>
                <div class="download-list" id="downloadList"></div>
                <div style="background:rgba(255,255,255,0.1); padding:10px; margin-top:10px; border-radius:5px;" id="msgArea">
                    <div style="color:#aaa; font-size:0.8rem;">é™„åŠ è¨Šæ¯ï¼š</div>
                    <div id="msgContent" style="white-space: pre-wrap;"></div>
                </div>
            </div>
        </div>

        <div id="resultArea">
            <div style="color:#aaa; font-size:0.9rem;">å‚³è¼¸å»ºç«‹æˆåŠŸï¼è«‹å°‡ä»£ç¢¼äº¤çµ¦å°æ–¹ï¼š</div>
            <div class="code-display" id="resultCode">------</div>
            <button class="copy-btn" onclick="copyCode()"><i class="fa-regular fa-copy"></i> è¤‡è£½ä»£ç¢¼</button>
            <div class="timer-badge" id="expiryDisplay"></div>
        </div>

        <div id="statusMsg" style="text-align:center; margin-top:15px; font-weight:bold;"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, deleteDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAo6on0f2QUbPaRfxpIEb2uvhKxDvPUvs",
            authDomain: "yulubox.firebaseapp.com",
            projectId: "yulubox",
            storageBucket: "yulubox.firebasestorage.app",
            messagingSenderId: "256466567852",
            appId: "1:256466567852:web:233b74668908ffcb9b9509",
            measurementId: "G-YPCY41EKWX"
        };

        // å…¨åŸŸè®Šæ•¸
        let app, auth, db, storage, currentUser;
        let selectedFiles = [];

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
            console.log("Firebase Ready");

            onAuthStateChanged(auth, user => {
                if(user) {
                    currentUser = user;
                    const statusEl = document.getElementById('userStatus');
                    if(statusEl) {
                        statusEl.innerText = `æŒ‡æ®å®˜: ${user.displayName || 'User'}`;
                        statusEl.style.color = "#00ff9d";
                    }
                } else {
                    currentUser = null;
                    const statusEl = document.getElementById('userStatus');
                    if(statusEl) statusEl.innerText = "åŒ¿åè¨ªå®¢";
                }
            });

        } catch (e) {
            alert("Firebase åˆå§‹åŒ–å¤±æ•—: " + e.message);
        }

        // ç¶å®š UI å‡½å¼åˆ° window (è§£æ±ºæŒ‰éˆ•ç„¡æ•ˆå•é¡Œ)
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab')[tab==='upload'?0:1].classList.add('active');
            document.getElementById('uploadSection').style.display = tab==='upload'?'block':'none';
            document.getElementById('downloadSection').style.display = tab==='download'?'block':'none';
            document.getElementById('resultArea').style.display = 'none';
            document.getElementById('statusMsg').innerText = '';
        };

        window.handleFileSelect = (input) => {
            selectedFiles = Array.from(input.files);
            const list = document.getElementById('fileList');
            if(selectedFiles.length === 0) {
                list.innerText = ''; return;
            }
            list.innerHTML = selectedFiles.map(f => `<div><i class="fa-solid fa-file"></i> ${f.name} (${(f.size/1024).toFixed(1)}KB)</div>`).join('');
        };

        window.copyCode = () => {
            const code = document.getElementById('resultCode').innerText;
            navigator.clipboard.writeText(code);
            alert("ä»£ç¢¼å·²è¤‡è£½ï¼");
        };

        // --- ğŸš€ ä¸Šå‚³é‚è¼¯ (ç„¡å£“ç¸® + é€²åº¦æ¢) ---
        window.executeUpload = async () => {
            console.log("Upload started..."); // Debug
            
            const pwd = document.getElementById('uploadPwd').value;
            const msg = document.getElementById('secretMsg').value;
            const expiryMins = parseInt(document.getElementById('expiryTime').value);

            if(!pwd) return alert("è«‹è¨­å®šå¯†ç¢¼ï¼");
            if(selectedFiles.length === 0 && !msg) return alert("è«‹è‡³å°‘é¸æ“‡æª”æ¡ˆæˆ–è¼¸å…¥æ–‡å­—è¨Šæ¯");

            // é–å®šæŒ‰éˆ•èˆ‡é¡¯ç¤ºé€²åº¦æ¢
            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('progressText').style.display = 'block';
            updateProgress(0, "åˆå§‹åŒ–ä¸Šå‚³ä»»å‹™...");

            try {
                const shareCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                const uploadedFiles = []; // å­˜ URL

                // 1. é€ä¸€ä¸Šå‚³æª”æ¡ˆ (ä¸å£“ç¸®)
                let completedCount = 0;
                const totalFiles = selectedFiles.length;

                // å¦‚æœæœ‰æ–‡å­—è¨Šæ¯ï¼Œä¹Ÿç•¶ä½œä¸€å€‹æª”æ¡ˆä¸Šå‚³
                if(msg) {
                    const msgBlob = new Blob([`From: ${currentUser?.displayName || 'Anonymous'}\n\n${msg}`], {type: 'text/plain'});
                    const msgFile = new File([msgBlob], "message.txt");
                    selectedFiles.push(msgFile);
                }

                if(selectedFiles.length > 0) {
                    for (let i = 0; i < selectedFiles.length; i++) {
                        const file = selectedFiles[i];
                        updateProgress((i / selectedFiles.length) * 100, `ä¸Šå‚³ä¸­: ${file.name}`);
                        
                        // ä¸Šå‚³åˆ° temp_shares/ä»£ç¢¼/æª”å
                        const storageRef = ref(storage, `temp_shares/${shareCode}/${file.name}`);
                        // ä½¿ç”¨ uploadBytesResumable (é›–ç„¶é€™è£¡æ²’ç”¨ç›£è½å™¨ï¼Œä½†å®ƒæ¯” uploadBytes ç©©å®š)
                        await uploadBytesResumable(storageRef, file);
                        const url = await getDownloadURL(storageRef);
                        
                        uploadedFiles.push({ name: file.name, url: url, path: `temp_shares/${shareCode}/${file.name}` });
                    }
                }

                updateProgress(100, "æ­£åœ¨å¯«å…¥è³‡æ–™åº«...");

                // 2. å¯«å…¥ Firestore
                const expiryDate = new Date(Date.now() + expiryMins * 60000);
                await addDoc(collection(db, "temp_shares"), {
                    shareCode: shareCode,
                    password: pwd,
                    files: uploadedFiles, // å­˜å…¥æª”æ¡ˆåˆ—è¡¨ (å« URL)
                    message: msg || "",   // ä¹Ÿå¯ä»¥ç›´æ¥å­˜æ–‡å­—
                    expiresAt: expiryDate,
                    uploader: currentUser ? currentUser.uid : "anonymous",
                    createdAt: serverTimestamp()
                });

                // 3. å®Œæˆ
                updateProgress(100, "å®Œæˆï¼");
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('resultArea').style.display = 'block';
                document.getElementById('resultCode').innerText = shareCode;
                document.getElementById('expiryDisplay').innerText = `æœ‰æ•ˆè‡³: ${expiryDate.toLocaleString()}`;

                // é‡ç½®
                selectedFiles = [];
                document.getElementById('fileInput').value = '';
                document.getElementById('secretMsg').value = '';
                btn.disabled = false;

            } catch (e) {
                console.error(e);
                alert("ä¸Šå‚³å¤±æ•—: " + e.message);
                btn.disabled = false;
                document.getElementById('progressText').innerText = "éŒ¯èª¤";
            }
        };

        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressText').innerText = `${Math.round(percent)}% - ${text}`;
        }


        // --- ğŸ“¥ ä¸‹è¼‰é‚è¼¯ (é¡¯ç¤ºåˆ—è¡¨) ---
        window.executeDownload = async () => {
            const code = document.getElementById('shareCode').value.toUpperCase();
            const pwd = document.getElementById('accessPwd').value;
            const btn = document.getElementById('downloadBtn');
            const status = document.getElementById('statusMsg');

            if(!code || !pwd) return alert("è«‹è¼¸å…¥ä»£ç¢¼èˆ‡å¯†ç¢¼");

            btn.disabled = true;
            status.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> æœå°‹ä¸­...`;

            try {
                const snapshot = await getDocs(collection(db, "temp_shares"));
                let targetDoc = null;
                snapshot.forEach(docSnap => {
                    if(docSnap.data().shareCode === code) targetDoc = { id: docSnap.id, ...docSnap.data() };
                });

                if(!targetDoc) {
                    btn.disabled = false; status.innerText = "";
                    return alert("æ‰¾ä¸åˆ°æ­¤ä»£ç¢¼");
                }

                // é©—è­‰
                if (new Date() > targetDoc.expiresAt.toDate()) {
                    // ç°¡æ˜“éŠ·æ¯€é‚è¼¯ (ä¸ç­‰å¾…)
                    deleteDoc(doc(db, "temp_shares", targetDoc.id));
                    btn.disabled = false; status.innerText = "";
                    return alert("æª”æ¡ˆå·²éæœŸä¸¦éŠ·æ¯€ã€‚");
                }

                if (targetDoc.password !== pwd) {
                    btn.disabled = false; status.innerText = "";
                    return alert("å¯†ç¢¼éŒ¯èª¤");
                }

                // é¡¯ç¤ºæª”æ¡ˆåˆ—è¡¨
                status.innerText = "";
                document.getElementById('downloadArea').style.display = 'block';
                const list = document.getElementById('downloadList');
                list.innerHTML = '';

                // ç›¸å®¹èˆŠç‰ˆè³‡æ–™ (å¦‚æœåªæœ‰ single downloadUrl)
                if (targetDoc.downloadUrl && !targetDoc.files) {
                     list.innerHTML = `<div class="download-item"><span>å£“ç¸®æª”.zip</span><a href="${targetDoc.downloadUrl}" target="_blank" class="dl-link">ä¸‹è¼‰</a></div>`;
                } 
                // æ–°ç‰ˆåˆ—è¡¨
                else if (targetDoc.files && targetDoc.files.length > 0) {
                    targetDoc.files.forEach(f => {
                        list.innerHTML += `
                            <div class="download-item">
                                <span><i class="fa-solid fa-file"></i> ${f.name}</span>
                                <a href="${f.url}" target="_blank" class="dl-link">ä¸‹è¼‰</a>
                            </div>`;
                    });
                }

                // é¡¯ç¤ºè¨Šæ¯
                const msgArea = document.getElementById('msgArea');
                if(targetDoc.message) {
                    msgArea.style.display = 'block';
                    document.getElementById('msgContent').innerText = targetDoc.message;
                } else {
                    msgArea.style.display = 'none';
                }

                btn.style.display = 'none'; // éš±è—è§£é–æŒ‰éˆ•

            } catch (e) {
                console.error(e);
                btn.disabled = false;
                alert("è®€å–å¤±æ•—: " + e.message);
            }
        };
    </script>
</body>
</html>