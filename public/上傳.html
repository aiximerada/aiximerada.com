<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ å¯†å‚³è¼¸è‰™ - ç‰éœ²å¯¶åº«</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-red: #ff4757;
            --neon-green: #00ff9d;
            --glass-bg: rgba(20, 30, 50, 0.8);
            --glass-border: rgba(0, 243, 255, 0.2);
        }
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a2c4e 100%);
            color: #fff; font-family: 'Microsoft JhengHei', sans-serif;
            min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center;
        }

        /* é ‚éƒ¨ */
        .header {
            width: 100%; padding: 20px; box-sizing: border-box;
            background: rgba(0,0,0,0.5); border-bottom: 1px solid var(--glass-border);
            display: flex; align-items: center; gap: 15px;
        }
        .back-btn { color: #fff; text-decoration: none; font-size: 1.2rem; transition: 0.3s; }
        .back-btn:hover { color: var(--neon-blue); }
        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 1px; color: var(--neon-blue); display: flex; align-items: center; gap: 10px; }

        /* èº«ä»½æ¨™ç±¤ */
        .user-status {
            margin-left: auto; font-size: 0.8rem; padding: 4px 10px;
            border-radius: 10px; background: rgba(255,255,255,0.1); color: #aaa;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            width: 90%; max-width: 500px; margin-top: 30px;
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 30px;
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        /* åˆ†é åˆ‡æ› */
        .tabs { display: flex; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .tab {
            flex: 1; padding: 15px; text-align: center; cursor: pointer;
            color: #888; transition: 0.3s; position: relative;
        }
        .tab.active { color: var(--neon-blue); font-weight: bold; }
        .tab.active::after {
            content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px;
            background: var(--neon-blue); box-shadow: 0 0 10px var(--neon-blue);
        }

        /* è¡¨å–®æ¨£å¼ */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: #aaa; font-size: 0.9rem; }
        .form-input, .form-select, textarea {
            width: 100%; padding: 12px; background: rgba(0,0,0,0.3);
            border: 1px solid #444; border-radius: 8px; color: #fff; box-sizing: border-box;
        }
        .form-input:focus { border-color: var(--neon-blue); outline: none; }

        /* æª”æ¡ˆä¸Šå‚³å€ */
        .drop-zone {
            border: 2px dashed #444; border-radius: 10px; padding: 30px;
            text-align: center; cursor: pointer; transition: 0.3s;
            color: #888;
        }
        .drop-zone:hover, .drop-zone.dragover { border-color: var(--neon-blue); color: #fff; background: rgba(0, 243, 255, 0.05); }
        .file-list { margin-top: 10px; font-size: 0.85rem; color: var(--neon-blue); text-align: left; }

        /* æŒ‰éˆ• */
        .btn-action {
            width: 100%; padding: 12px; border: none; border-radius: 50px;
            font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 10px;
            background: var(--neon-blue); color: #000; transition: 0.3s;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-action:hover { box-shadow: 0 0 20px var(--neon-blue); }
        .btn-action:disabled { background: #555; color: #888; cursor: not-allowed; box-shadow: none; }
        .download-btn { background: var(--neon-green); }

        /* çµæœé¡¯ç¤ºå€ */
        #resultArea { display: none; margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.5); border-radius: 10px; text-align: center; }
        .code-display { 
            font-size: 2rem; font-family: monospace; color: var(--neon-green); margin: 10px 0; 
            letter-spacing: 5px; border: 1px dashed var(--neon-green); padding: 10px;
        }
        .copy-btn { background: none; border: none; color: #fff; cursor: pointer; text-decoration: underline; }
        .timer-badge {
            display: inline-block; background: #333; padding: 5px 10px; 
            border-radius: 5px; font-size: 0.8rem; margin-top: 5px; color: #ffaa00;
        }
    </style>
</head>
<body>

    <div class="header">
        <a href="index.html" class="back-btn"><i class="fa-solid fa-house"></i> è¿”å›å¤§å»³</a>
        <h1><i class="fa-solid fa-file-shield"></i> å…¬é–‹å‚³è¼¸è‰™</h1>
        <div class="user-status" id="userStatus">åµæ¸¬ä¸­...</div>
    </div>

    <div class="container">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('upload')">ç™¼é€æª”æ¡ˆ</div>
            <div class="tab" onclick="switchTab('download')">æ¥æ”¶æª”æ¡ˆ</div>
        </div>

        <div id="uploadSection">
            <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
                <i class="fa-solid fa-cloud-arrow-up" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <div>é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆè‡³æ­¤ (æ”¯æ´æ‰¹é‡)</div>
                <input type="file" id="fileInput" multiple style="display:none" onchange="handleFileSelect(this)">
            </div>
            <div class="file-list" id="fileList"></div>

            <div class="form-group" style="margin-top:20px;">
                <label class="form-label">é™„åŠ åŠ å¯†è¨Šæ¯ (å¯é¸)</label>
                <textarea id="secretMsg" rows="2" placeholder="è¼¸å…¥æ–‡å­—ï¼Œé€™å°‡æœƒè¢«è½‰å­˜ç‚º message.txt..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">è¨­å®šæå–å¯†ç¢¼</label>
                <input type="text" id="uploadPwd" class="form-input" placeholder="ä¾‹å¦‚ï¼š1234">
            </div>

            <div class="form-group">
                <label class="form-label">æœ‰æ•ˆæœŸé™ (éæœŸè‡ªå‹•éŠ·æ¯€)</label>
                <select id="expiryTime" class="form-select">
                    <option value="10">10 åˆ†é˜å¾ŒéŠ·æ¯€</option>
                    <option value="60">1 å°æ™‚å¾ŒéŠ·æ¯€</option>
                    <option value="1440">24 å°æ™‚å¾ŒéŠ·æ¯€</option>
                </select>
            </div>

            <button class="btn-action" id="uploadBtn" onclick="executeUpload()">
                <i class="fa-solid fa-rocket"></i> å£“ç¸®ä¸¦åŠ å¯†å‚³é€
            </button>
        </div>

        <div id="downloadSection" style="display:none;">
            <div class="form-group">
                <label class="form-label">è¼¸å…¥å‚³è¼¸ä»£ç¢¼ (Share Code)</label>
                <input type="text" id="shareCode" class="form-input" placeholder="è«‹è¼¸å…¥6ä½ä»£ç¢¼" style="text-transform: uppercase;">
            </div>
            <div class="form-group">
                <label class="form-label">è¼¸å…¥æå–å¯†ç¢¼</label>
                <input type="password" id="accessPwd" class="form-input" placeholder="å¯†ç¢¼">
            </div>
            <button class="btn-action download-btn" id="downloadBtn" onclick="executeDownload()">
                <i class="fa-solid fa-unlock"></i> è§£å¯†ä¸¦ä¸‹è¼‰
            </button>
        </div>

        <div id="resultArea">
            <div style="color:#aaa; font-size:0.9rem;">å‚³è¼¸å»ºç«‹æˆåŠŸï¼è«‹å°‡ä»£ç¢¼äº¤çµ¦å°æ–¹ï¼š</div>
            <div class="code-display" id="resultCode">------</div>
            <button class="copy-btn" onclick="copyCode()"><i class="fa-regular fa-copy"></i> è¤‡è£½ä»£ç¢¼</button>
            <div class="timer-badge" id="expiryDisplay"></div>
        </div>

        <div id="statusMsg" style="text-align:center; margin-top:15px; font-weight:bold;"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, deleteDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // ğŸ”¥ Config (è«‹ç¢ºèªé€™è£¡çš„è¨­å®šæ˜¯å¦æ­£ç¢º)
        const firebaseConfig = {
            apiKey: "AIzaSyAAo6on0f2QUbPaRfxpIEb2uvhKxDvPUvs",
            authDomain: "yulubox.firebaseapp.com",
            projectId: "yulubox",
            storageBucket: "yulubox.firebasestorage.app",
            messagingSenderId: "256466567852",
            appId: "1:256466567852:web:233b74668908ffcb9b9509",
            measurementId: "G-YPCY41EKWX"
        };

        // å…¨åŸŸè®Šæ•¸
        let currentUser = null;
        let selectedFiles = [];
        let app, auth, db, storage;

        // --- åˆå§‹åŒ–æª¢æŸ¥ ---
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
            console.log("Firebase åˆå§‹åŒ–æˆåŠŸ");

            // ç›£è½ç™»å…¥ç‹€æ…‹
            onAuthStateChanged(auth, user => {
                if(user) {
                    currentUser = user;
                    const statusEl = document.getElementById('userStatus');
                    if(statusEl) {
                        statusEl.innerText = `æŒ‡æ®å®˜: ${user.displayName || 'User'}`;
                        statusEl.style.color = "#00ff9d";
                    }
                } else {
                    currentUser = null;
                    const statusEl = document.getElementById('userStatus');
                    if(statusEl) statusEl.innerText = "åŒ¿åè¨ªå®¢";
                }
            });

        } catch (e) {
            alert("ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼è«‹æª¢æŸ¥ F12 Consoleã€‚\néŒ¯èª¤åŸå› : " + e.message);
        }

        // --- ä»‹é¢åˆ‡æ› ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab')[tab==='upload'?0:1].classList.add('active');
            document.getElementById('uploadSection').style.display = tab==='upload'?'block':'none';
            document.getElementById('downloadSection').style.display = tab==='download'?'block':'none';
            document.getElementById('resultArea').style.display = 'none';
            document.getElementById('statusMsg').innerText = '';
        }

        // --- æª”æ¡ˆé¸æ“‡ ---
        window.handleFileSelect = (input) => {
            const files = Array.from(input.files);
            selectedFiles = [...selectedFiles, ...files];
            renderFileList();
        }

        function renderFileList() {
            const list = document.getElementById('fileList');
            if(selectedFiles.length === 0) {
                list.innerText = ''; return;
            }
            list.innerHTML = selectedFiles.map(f => `<div><i class="fa-solid fa-file"></i> ${f.name} (${(f.size/1024).toFixed(1)}KB)</div>`).join('');
        }

        // --- ğŸš€ ä¿®æ­£å¾Œçš„ä¸Šå‚³é‚è¼¯ ---
        window.executeUpload = async () => {
            console.log("æŒ‰éˆ•è¢«é»æ“Šäº†"); // Debug ç”¨

            // 1. æª¢æŸ¥ JSZip æ˜¯å¦å­˜åœ¨
            if (typeof JSZip === 'undefined') {
                alert("éŒ¯èª¤ï¼šå£“ç¸®å…ƒä»¶ (JSZip) æœªè¼‰å…¥ã€‚\nè«‹ç¢ºèªç¶²è·¯é€£ç·šæ­£å¸¸ï¼Œä¸¦é‡æ–°æ•´ç†é é¢ã€‚");
                return;
            }

            // 2. ç²å–è¡¨å–®è³‡æ–™
            const pwd = document.getElementById('uploadPwd').value;
            const msg = document.getElementById('secretMsg').value;
            const expiryMins = parseInt(document.getElementById('expiryTime').value);

            if(!pwd) return alert("è«‹è¨­å®šå¯†ç¢¼ï¼");
            if(selectedFiles.length === 0 && !msg) return alert("è«‹è‡³å°‘é¸æ“‡æª”æ¡ˆæˆ–è¼¸å…¥æ–‡å­—è¨Šæ¯");

            setLoading(true, "æ­£åœ¨å£“ç¸®å°è£...");

            try {
                // 3. åŸ·è¡Œå£“ç¸®
                const zip = new JSZip();
                selectedFiles.forEach(file => zip.file(file.name, file));
                
                const senderName = currentUser ? (currentUser.displayName || 'Commander') : 'Anonymous Rogue';
                if(msg) zip.file("secret_message.txt", `From: ${senderName}\n\n${msg}`);

                const zipBlob = await zip.generateAsync({type: "blob"});
                console.log("å£“ç¸®å®Œæˆï¼Œå¤§å°:", zipBlob.size);

                // 4. ä¸Šå‚³ Firebase
                setLoading(true, "ä¸Šå‚³è‡³è¡›æ˜Ÿ...");
                const shareCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                
                // é€™è£¡åŠ å…¥ try-catch æ•æ‰ä¸Šå‚³éŒ¯èª¤
                const storageRef = ref(storage, `temp_shares/${shareCode}.zip`);
                await uploadBytes(storageRef, zipBlob);
                const downloadUrl = await getDownloadURL(storageRef);
                console.log("ä¸Šå‚³æˆåŠŸï¼ŒURL:", downloadUrl);

                // 5. å¯«å…¥è³‡æ–™åº«
                setLoading(true, "å¯«å…¥åŠ å¯†å”è­°...");
                const expiryDate = new Date(Date.now() + expiryMins * 60000);

                await addDoc(collection(db, "temp_shares"), {
                    shareCode: shareCode,
                    password: pwd,
                    downloadUrl: downloadUrl,
                    storagePath: `temp_shares/${shareCode}.zip`,
                    expiresAt: expiryDate,
                    uploader: currentUser ? currentUser.uid : "anonymous_guest",
                    createdAt: serverTimestamp()
                });

                // 6. UI æ›´æ–°
                setLoading(false);
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('resultArea').style.display = 'block';
                document.getElementById('resultCode').innerText = shareCode;
                document.getElementById('expiryDisplay').innerText = `æœ‰æ•ˆè‡³: ${expiryDate.toLocaleString()}`;

                // é‡ç½®
                selectedFiles = [];
                document.getElementById('fileInput').value = '';
                document.getElementById('secretMsg').value = '';

            } catch (e) {
                console.error("åŸ·è¡ŒéŒ¯èª¤:", e);
                setLoading(false);
                alert("åŸ·è¡Œå¤±æ•—ï¼\néŒ¯èª¤è¨Šæ¯: " + e.message + "\n(è«‹ç¢ºèª Storage Rules æ˜¯å¦å·²é–‹å•Ÿ)");
            }
        };

        // --- ğŸ“¥ ä¸‹è¼‰é‚è¼¯ ---
        window.executeDownload = async () => {
            const code = document.getElementById('shareCode').value.toUpperCase();
            const pwd = document.getElementById('accessPwd').value;

            if(!code || !pwd) return alert("è«‹è¼¸å…¥ä»£ç¢¼èˆ‡å¯†ç¢¼");

            setLoading(true, "æœå°‹ä¿¡è™Ÿä¾†æº...");

            try {
                // æŸ¥è©¢è³‡æ–™
                const snapshot = await getDocs(collection(db, "temp_shares"));
                let targetDoc = null;
                snapshot.forEach(docSnap => {
                    if(docSnap.data().shareCode === code) targetDoc = { id: docSnap.id, ...docSnap.data() };
                });

                if(!targetDoc) {
                    setLoading(false); return alert("æ‰¾ä¸åˆ°æ­¤å‚³è¼¸ä»£ç¢¼");
                }

                const now = new Date();
                const expiry = targetDoc.expiresAt.toDate();

                // éæœŸæª¢æŸ¥
                if (now > expiry) {
                    setLoading(true, "æª”æ¡ˆéæœŸï¼Œæ­£åœ¨éŠ·æ¯€...");
                    const fileRef = ref(storage, targetDoc.storagePath);
                    await deleteObject(fileRef).catch(err => console.log("File already gone"));
                    await deleteDoc(doc(db, "temp_shares", targetDoc.id));
                    setLoading(false);
                    return alert("æª”æ¡ˆå·²éæœŸä¸¦éŠ·æ¯€ã€‚");
                }

                // å¯†ç¢¼æª¢æŸ¥
                if (targetDoc.password !== pwd) {
                    setLoading(false); return alert("å¯†ç¢¼éŒ¯èª¤ï¼Œæ‹’çµ•å­˜å–");
                }

                // ä¸‹è¼‰
                setLoading(false);
                const a = document.createElement('a');
                a.href = targetDoc.downloadUrl;
                // å˜—è©¦å¼·åˆ¶ç€è¦½å™¨ä¸‹è¼‰
                a.setAttribute('download', `Secure_Data_${code}.zip`);
                a.setAttribute('target', '_blank');
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                document.getElementById('statusMsg').innerHTML = `<span style="color:#00ff9d">é©—è­‰é€šéï¼ä¸‹è¼‰å·²å•Ÿå‹•ã€‚</span>`;

            } catch (e) {
                console.error(e);
                setLoading(false);
                alert("ä¸‹è¼‰å¤±æ•—ï¼š" + e.message);
            }
        };

        // --- è¼”åŠ©åŠŸèƒ½ ---
        function setLoading(isLoading, text) {
            const btn = document.querySelector('.btn-action:visible') || document.getElementById('uploadBtn');
            const status = document.getElementById('statusMsg');
            
            if(isLoading) {
                if(btn) btn.disabled = true;
                status.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ${text}`;
                status.style.color = "var(--neon-blue)";
            } else {
                if(btn) btn.disabled = false;
                status.innerText = "";
            }
        }

        window.copyCode = () => {
            const code = document.getElementById('resultCode').innerText;
            navigator.clipboard.writeText(code);
            alert("ä»£ç¢¼å·²è¤‡è£½ï¼");
        }
    </script>
</body>
</html>