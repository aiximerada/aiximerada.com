<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡å‚³é€é–€ - ç‰éœ²å¯¶åº«</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg-dark: #050510; --neon-cyan: #00f3ff; --neon-green: #00ff9d; --glass: rgba(255, 255, 255, 0.05); }
        body { background-color: var(--bg-dark); color: #fff; font-family: 'Microsoft JhengHei', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; opacity: 0; transition: opacity 0.5s; }
        .stars-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: radial-gradient(2px 2px at 20px 30px, #fff, transparent); background-size: 200px 200px; opacity: 0.2; z-index: -1; }
        
        .container { width: 90%; max-width: 600px; margin-top: 50px; background: var(--glass); backdrop-filter: blur(10px); padding: 40px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); text-align: center; margin-bottom: 50px; }
        h1 { margin-bottom: 30px; text-shadow: 0 0 10px var(--neon-cyan); }
        
        /* ä¸Šå‚³å€å¡Š */
        .upload-area { 
            border: 2px dashed #555; padding: 40px; border-radius: 15px; cursor: pointer; transition: 0.3s; position: relative;
        }
        .upload-area:hover { border-color: var(--neon-cyan); background: rgba(0, 243, 255, 0.05); }
        .upload-area input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        
        /* æª”æ¡ˆåˆ—è¡¨ */
        .file-list { margin-top: 20px; text-align: left; max-height: 300px; overflow-y: auto; }
        .file-item { 
            background: rgba(0,0,0,0.3); padding: 10px 15px; margin-bottom: 8px; border-radius: 8px; 
            display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;
            border-left: 3px solid #555; transition: 0.3s;
        }
        .file-item.success { border-left-color: var(--neon-green); background: rgba(0, 255, 157, 0.1); }
        .file-item.uploading { border-left-color: var(--neon-cyan); background: rgba(0, 243, 255, 0.1); }
        .file-item.fail { border-left-color: #ff4757; }

        .status-icon { font-size: 1.1rem; }

        .btn { 
            background: var(--neon-cyan); color: #000; border: none; padding: 12px 30px; 
            border-radius: 50px; font-weight: bold; margin-top: 20px; cursor: pointer; 
            font-size: 1rem; transition: 0.3s; width: 100%;
        }
        .btn:disabled { background: #555; cursor: not-allowed; }
        .btn:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 0 15px var(--neon-cyan); }
        
        /* ç¸½é€²åº¦æ¢ */
        .progress-container { margin-top: 20px; display: none; }
        .progress-bar { width: 100%; height: 8px; background: #333; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--neon-cyan); width: 0%; transition: 0.3s; }
        .progress-text { margin-top: 5px; font-size: 0.8rem; color: #aaa; }
    </style>
</head>
<body>
    <div class="stars-bg"></div>
    <div class="container">
        <h1><i class="fa-solid fa-layer-group"></i> æ‰¹é‡å‚³é€é–€</h1>
        <p style="color:#aaa; font-size:0.9rem;">æ”¯æ´å¤šæª”é¸å– (Ctrl/Shift)ï¼Œå»ºç«‹æ‚¨çš„æ˜Ÿéš›åœ–åº«</p>
        
        <div class="upload-area" id="drop-area">
            <i class="fa-solid fa-images" style="font-size: 3rem; color: #ccc;"></i>
            <p>é»æ“Š æˆ– æ‹–æ”¾å¤šå¼µåœ–ç‰‡è‡³æ­¤</p>
            <input type="file" id="fileInput" accept="image/*" multiple>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar"><div class="progress-fill" id="totalProgress"></div></div>
            <div class="progress-text" id="progressText">æº–å‚™å‚³è¼¸...</div>
        </div>
        
        <div class="file-list" id="fileList">
            </div>
        
        <button class="btn" id="uploadBtn" onclick="startBatchUpload()" disabled>é–‹å§‹æ‰¹é‡ä¸Šå‚³</button>
        <a href="vip_area.html" style="display:block; margin-top:20px; color:#888; text-decoration:none;">è¿”å›æœƒå“¡å€</a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ğŸ”¥ è¨­å®šå€
        const firebaseConfig = {
            apiKey: "AIzaSyAAo6on0f2QUbPaRfxpIEb2uvhKxDvPUvs",
            authDomain: "yulubox.firebaseapp.com",
            projectId: "yulubox",
            storageBucket: "yulubox.firebasestorage.app",
            messagingSenderId: "256466567852",
            appId: "1:256466567852:web:233b74668908ffcb9b9509",
            measurementId: "G-YPCY41EKWX"
        };

        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUser = null;

        // ğŸ”’ å®‰å…¨é©—è­‰ï¼šæ²’ç™»å…¥å°±è¸¢å‡ºå»
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.body.style.opacity = "1"; // é©—è­‰é€šéæ‰é¡¯ç¤ºç•«é¢
            } else {
                window.location.href = 'login.html';
            }
        });

        const fileInput = document.getElementById('fileInput');
        const fileListDiv = document.getElementById('fileList');
        const uploadBtn = document.getElementById('uploadBtn');
        let selectedFiles = [];

        // ç›£è½æª”æ¡ˆé¸æ“‡
        fileInput.addEventListener('change', function(e) {
            selectedFiles = Array.from(e.target.files); // è½‰ç‚ºé™£åˆ—
            renderFileList();
            if(selectedFiles.length > 0) uploadBtn.disabled = false;
        });

        function renderFileList() {
            fileListDiv.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.id = `file-${index}`;
                // é™åˆ¶æª”åé¡¯ç¤ºé•·åº¦
                const displayName = file.name.length > 20 ? file.name.substring(0,20)+'...' : file.name;
                item.innerHTML = `
                    <span>${displayName} <small style="color:#888">(${(file.size/1024).toFixed(1)} KB)</small></span>
                    <span class="status"><i class="fa-regular fa-clock"></i> å¾…æ©Ÿ</span>
                `;
                fileListDiv.appendChild(item);
            });
        }

        // ğŸš€ æ ¸å¿ƒï¼šæ‰¹é‡ä¸Šå‚³é‚è¼¯
        window.startBatchUpload = async function() {
            if(selectedFiles.length === 0) return;

            uploadBtn.disabled = true;
            document.getElementById('progressContainer').style.display = 'block';
            let completedCount = 0;

            // é€ä¸€è™•ç†æ¯å€‹æª”æ¡ˆ
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const itemEl = document.getElementById(`file-${i}`);
                const statusSpan = itemEl.querySelector('.status');
                
                // 1. æ›´æ–°ç‹€æ…‹ï¼šä¸Šå‚³ä¸­
                itemEl.classList.add('uploading');
                statusSpan.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ä¸Šå‚³ä¸­...';

                try {
                    // 2. ä¸Šå‚³ Storage (æª”ååŠ ä¸Šæ™‚é–“æˆ³è¨˜é¿å…é‡è¤‡)
                    const fileName = `user_uploads/${Date.now()}_${i}_${file.name}`;
                    const storageRef = ref(storage, fileName);
                    
                    // ç­‰å¾…ä¸Šå‚³å®Œæˆ
                    const uploadTask = await uploadBytesResumable(storageRef, file);
                    const downloadURL = await getDownloadURL(uploadTask.ref);

                    // 3. å¯«å…¥ Firestore è³‡æ–™åº«
                    await addDoc(collection(db, "gallery"), {
                        imageUrl: downloadURL,
                        fileName: file.name,
                        uploadedBy: currentUser.email,
                        timestamp: serverTimestamp()
                    });

                    // 4. æ›´æ–°ç‹€æ…‹ï¼šæˆåŠŸ
                    itemEl.classList.remove('uploading');
                    itemEl.classList.add('success');
                    statusSpan.innerHTML = '<i class="fa-solid fa-check"></i> å®Œæˆ';

                } catch (error) {
                    console.error(error);
                    itemEl.classList.remove('uploading');
                    itemEl.classList.add('fail');
                    statusSpan.innerHTML = '<i class="fa-solid fa-xmark"></i> å¤±æ•—';
                }

                // 5. æ›´æ–°ç¸½é€²åº¦æ¢
                completedCount++;
                const percent = (completedCount / selectedFiles.length) * 100;
                document.getElementById('totalProgress').style.width = percent + '%';
                document.getElementById('progressText').innerText = `é€²åº¦ï¼š${completedCount} / ${selectedFiles.length}`;
            }

            alert('ä½‡åˆ—è™•ç†å®Œç•¢ï¼');
            setTimeout(() => {
                // ä¸Šå‚³å®Œå¾Œæ¸…ç©ºåˆ—è¡¨æˆ–é‡æ•´ï¼Œé€™è£¡é¸æ“‡ä¿ç•™ç•«é¢è®“ä½¿ç”¨è€…çœ‹çµæœ
                uploadBtn.innerText = "ä¸Šå‚³å®Œæˆ (é»æ“Šé‡æ•´)";
                uploadBtn.disabled = false;
                uploadBtn.onclick = () => window.location.reload();
            }, 500);
        }
    </script>
</body>
</html>