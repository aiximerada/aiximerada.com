<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥µé€Ÿå‚³é€é–€ - ç‰éœ²å¯¶åº«</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg-dark: #050510; --neon-cyan: #00f3ff; --neon-green: #00ff9d; --neon-red: #ff4757; --glass: rgba(255, 255, 255, 0.05); --star-gold: #f2c94c; }
        body { background-color: var(--bg-dark); color: #fff; font-family: 'Microsoft JhengHei', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; opacity: 0; transition: opacity 0.5s; }

        /* èƒŒæ™¯ç‰¹æ•ˆ */
        .stars-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; background-image: radial-gradient(2px 2px at 20px 30px, #fff, rgba(0,0,0,0)), radial-gradient(2px 2px at 40px 70px, #fff, rgba(0,0,0,0)); background-size: 200px 200px; opacity: 0.2; animation: moveStars 100s linear infinite; z-index: -2; }
        @keyframes moveStars { from {transform: translateY(0);} to {transform: translateY(-1000px);} }
        #twinkling-stars-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }
        .t-star { position: absolute; background-color: white; border-radius: 50%; opacity: 0; box-shadow: 0 0 4px rgba(255,255,255,0.8); animation-name: twinkle; animation-iteration-count: infinite; animation-timing-function: ease-in-out; }
        @keyframes twinkle { 0% { opacity: 0; transform: scale(0.3); } 50% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0.3); } }

        .container { width: 90%; max-width: 600px; margin-top: 50px; background: var(--glass); backdrop-filter: blur(10px); padding: 40px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); text-align: center; margin-bottom: 50px; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        h1 { margin-bottom: 20px; text-shadow: 0 0 10px var(--neon-cyan); }
        
        .upload-area { border: 2px dashed #555; padding: 40px; border-radius: 15px; cursor: pointer; transition: 0.3s; position: relative; }
        .upload-area:hover { border-color: var(--neon-cyan); background: rgba(0, 243, 255, 0.05); }
        .upload-area input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        
        .file-list { margin-top: 20px; text-align: left; max-height: 300px; overflow-y: auto; }
        .file-item { background: rgba(0,0,0,0.3); padding: 10px 15px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; border-left: 3px solid #555; transition: 0.3s; }
        .file-item.success { border-left-color: var(--neon-green); background: rgba(0, 255, 157, 0.1); }
        .file-item.uploading { border-left-color: var(--neon-cyan); background: rgba(0, 243, 255, 0.1); }
        .file-item.fail { border-left-color: var(--neon-red); }
        .file-item.cancelled { border-left-color: #888; color: #888; }

        .btn-group { display: flex; gap: 15px; margin-top: 20px; }
        .btn { flex: 1; border: none; padding: 12px; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.3s; }
        .btn-start { background: var(--neon-cyan); color: #000; }
        .btn-start:disabled { background: #555; cursor: not-allowed; }
        .btn-start:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 0 15px var(--neon-cyan); }
        .btn-stop { background: var(--neon-red); color: #fff; display: none; }
        .btn-stop:hover { transform: scale(1.02); box-shadow: 0 0 15px var(--neon-red); }
        
        .progress-container { margin-top: 20px; display: none; }
        .progress-bar { width: 100%; height: 8px; background: #333; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--neon-cyan); width: 0%; transition: 0.3s; }
        .progress-text { margin-top: 5px; font-size: 0.8rem; color: #aaa; }

        /* å„ªåŒ–é¸é … */
        .options-panel { margin-top: 20px; display: flex; justify-content: center; gap: 20px; font-size: 0.9rem; color: #aaa; }
        .switch-label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .switch-label input { accent-color: var(--neon-cyan); width: 18px; height: 18px; }
    </style>
</head>
<body>
    <div class="stars-bg"></div>
    <div id="twinkling-stars-container"></div>

    <div class="container">
        <h1><i class="fa-solid fa-bolt"></i> æ¥µé€Ÿå‚³é€é–€</h1>
        <p style="color:#aaa; font-size:0.9rem;">æ”¯æ´ä¸¦è¡Œå‚³è¼¸æŠ€è¡“ (Parallel Upload)</p>
        
        <div class="upload-area" id="drop-area">
            <i class="fa-solid fa-images" style="font-size: 3rem; color: #ccc;"></i>
            <p>é»æ“Š æˆ– æ‹–æ”¾å¤šå¼µåœ–ç‰‡è‡³æ­¤</p>
            <input type="file" id="fileInput" accept="image/*" multiple>
        </div>

        <div class="options-panel">
            <label class="switch-label" title="å…ˆå£“ç¸®å†ä¸Šå‚³ï¼Œé€Ÿåº¦æå‡ 5 å€ä»¥ä¸Šï¼Œé©åˆéé«˜ç•«è³ªéœ€æ±‚">
                <input type="checkbox" id="compressSwitch" checked> 
                <span>å•Ÿç”¨æ¥µé€Ÿå£“ç¸® (æ¨è–¦)</span>
            </label>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar"><div class="progress-fill" id="totalProgress"></div></div>
            <div class="progress-text" id="progressText">æº–å‚™å‚³è¼¸...</div>
        </div>
        
        <div class="file-list" id="fileList"></div>
        
        <div class="btn-group">
            <button class="btn btn-start" id="uploadBtn" onclick="startBatchUpload()" disabled>é–‹å§‹ä¸¦è¡Œä¸Šå‚³</button>
            <button class="btn btn-stop" id="stopBtn" onclick="stopUpload()">ğŸ›‘ çµ‚æ­¢ä¸Šå‚³</button>
        </div>

        <a href="vip_area.html" style="display:block; margin-top:20px; color:#888; text-decoration:none;">è¿”å›æœƒå“¡å€</a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ğŸ”¥ Config
        const firebaseConfig = {
            apiKey: "AIzaSyAAo6on0f2QUbPaRfxpIEb2uvhKxDvPUvs",
            authDomain: "yulubox.firebaseapp.com",
            projectId: "yulubox",
            storageBucket: "yulubox.firebasestorage.app",
            messagingSenderId: "256466567852",
            appId: "1:256466567852:web:233b74668908ffcb9b9509",
            measurementId: "G-YPCY41EKWX"
        };

        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (user) { currentUser = user; document.body.style.opacity = "1"; } 
            else window.location.href = 'login.html';
        });

        const fileInput = document.getElementById('fileInput');
        const fileListDiv = document.getElementById('fileList');
        const uploadBtn = document.getElementById('uploadBtn');
        const stopBtn = document.getElementById('stopBtn');
        let selectedFiles = [];
        let uploadTasks = []; // å„²å­˜æ‰€æœ‰ä»»å‹™ä»¥ä¾¿å–æ¶ˆ
        let stopRequested = false;

        // æ˜Ÿç©ºç‰¹æ•ˆ
        function createTwinklingStars() {
            const container = document.getElementById('twinkling-stars-container');
            if(!container) return;
            for (let i = 0; i < 60; i++) {
                const star = document.createElement('div');
                star.className = 't-star';
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.width = `${Math.random() * 2 + 1}px`;
                star.style.height = star.style.width;
                star.style.animationDuration = `${Math.random() * 4 + 2}s`;
                star.style.animationDelay = `${Math.random() * 5}s`;
                container.appendChild(star);
            }
        }
        window.addEventListener('load', createTwinklingStars);

        fileInput.addEventListener('change', function(e) {
            selectedFiles = Array.from(e.target.files);
            renderFileList();
            if(selectedFiles.length > 0) uploadBtn.disabled = false;
        });

        function renderFileList() {
            fileListDiv.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.id = `file-${index}`;
                const displayName = file.name.length > 20 ? file.name.substring(0,20)+'...' : file.name;
                item.innerHTML = `
                    <span>${displayName} <small style="color:#888">(${(file.size/1024).toFixed(1)} KB)</small></span>
                    <span class="status"><i class="fa-regular fa-clock"></i> å¾…æ©Ÿ</span>
                `;
                fileListDiv.appendChild(item);
            });
        }

        window.stopUpload = function() {
            if(confirm('ç¢ºå®šè¦çµ‚æ­¢æ‰€æœ‰ä¸Šå‚³å—ï¼Ÿ')) {
                stopRequested = true;
                uploadTasks.forEach(task => task.cancel()); // ğŸ›‘ ä¸€æ¬¡å–æ¶ˆæ‰€æœ‰ä»»å‹™
                stopBtn.innerText = "æ­£åœ¨åœæ­¢...";
                stopBtn.disabled = true;
            }
        }

        // âš¡ æ ¸å¿ƒï¼šä¸¦è¡Œä¸Šå‚³é‚è¼¯
        window.startBatchUpload = async function() {
            if(selectedFiles.length === 0) return;

            // UI ç‹€æ…‹åˆ‡æ›
            stopRequested = false;
            uploadTasks = [];
            uploadBtn.style.display = 'none';
            stopBtn.style.display = 'block';
            stopBtn.disabled = false;
            stopBtn.innerText = "ğŸ›‘ çµ‚æ­¢ä¸Šå‚³";
            document.getElementById('progressContainer').style.display = 'block';

            let completedCount = 0;
            const useCompression = document.getElementById('compressSwitch').checked;

            // âš¡ å»ºç«‹æ‰€æœ‰ Promise ä»»å‹™ (ä¸¦ç™¼è«‹æ±‚)
            const promises = selectedFiles.map(async (file, index) => {
                const itemEl = document.getElementById(`file-${index}`);
                const statusSpan = itemEl.querySelector('.status');

                if (stopRequested) return;

                itemEl.classList.add('uploading');
                statusSpan.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ä¸Šå‚³ä¸­...';

                try {
                    let fileToUpload = file;

                    // ğŸ› ï¸ å£“ç¸®è™•ç† (å¦‚æœåœ¨æœ¬åœ°å…ˆç¸®å°ï¼Œä¸Šå‚³å°±æœƒé£›å¿«)
                    if (useCompression) {
                        statusSpan.innerHTML = '<i class="fa-solid fa-compress"></i> å£“ç¸®ä¸­...';
                        fileToUpload = await compressImage(file, 0.7); // 70% å“è³ª
                        statusSpan.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ä¸Šå‚³ä¸­...';
                    }

                    const fileName = `user_uploads/${Date.now()}_${index}_${file.name}`;
                    const storageRef = ref(storage, fileName);
                    
                    const uploadTask = uploadBytesResumable(storageRef, fileToUpload);
                    uploadTasks.push(uploadTask); // åŠ å…¥ä»»å‹™æ¸…å–®

                    await uploadTask; // ç­‰å¾…é€™å€‹ä»»å‹™å®Œæˆ

                    const downloadURL = await getDownloadURL(storageRef);
                    await addDoc(collection(db, "gallery"), {
                        imageUrl: downloadURL,
                        fileName: file.name,
                        uploadedBy: currentUser.email,
                        timestamp: serverTimestamp()
                    });

                    itemEl.classList.remove('uploading');
                    itemEl.classList.add('success');
                    statusSpan.innerHTML = '<i class="fa-solid fa-check"></i> å®Œæˆ';

                } catch (error) {
                    itemEl.classList.remove('uploading');
                    if (error.code === 'storage/canceled' || stopRequested) {
                        itemEl.classList.add('cancelled');
                        statusSpan.innerText = 'å·²å–æ¶ˆ';
                    } else {
                        console.error(error);
                        itemEl.classList.add('fail');
                        statusSpan.innerHTML = '<i class="fa-solid fa-xmark"></i> å¤±æ•—';
                    }
                } finally {
                    completedCount++;
                    const percent = (completedCount / selectedFiles.length) * 100;
                    document.getElementById('totalProgress').style.width = percent + '%';
                    document.getElementById('progressText').innerText = `è™•ç†é€²åº¦ï¼š${completedCount} / ${selectedFiles.length}`;
                }
            });

            // ç­‰å¾…æ‰€æœ‰ä»»å‹™å…¨éƒ¨è·‘å®Œ
            await Promise.all(promises);

            uploadBtn.style.display = 'block';
            stopBtn.style.display = 'none';
            if(!stopRequested) {
                uploadBtn.innerText = "ä¸Šå‚³å®Œæˆ (é»æ“Šé‡æ•´)";
                uploadBtn.onclick = () => window.location.reload();
                alert('æ‰€æœ‰ä»»å‹™è™•ç†å®Œç•¢ï¼');
            } else {
                uploadBtn.innerText = "å·²çµ‚æ­¢ (é»æ“Šé‡æ•´)";
                uploadBtn.onclick = () => window.location.reload();
            }
        }

        // ğŸ–¼ï¸ æœ¬åœ°å£“ç¸®å‡½å¼ (Canvas API)
        function compressImage(file, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        // ç°¡å–®ç¸®åœ–é‚è¼¯ï¼šæœ€å¤§å¯¬åº¦ 1920
                        const maxWidth = 1920;
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = error => reject(error);
                };
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>