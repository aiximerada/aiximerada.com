<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¸«è³‡åŸ¹è¨“ä¸­å¿ƒ - ç‰éœ²å¯¶åº«</title>
    
    <!-- å¼•å…¥ä¸»é¡Œè¨­å®š -->
    <script src="theme.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // å•Ÿç”¨æ‰‹å‹•åˆ‡æ›å¤œé–“æ¨¡å¼
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- XLSX Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; transition: background-color 0.3s, color 0.3s; }
        /* æ»¾å‹•æ¢ç¾åŒ– (æ”¯æ´ Dark Mode) */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .selected-card { border-color: #3b82f6; background-color: #eff6ff; }
        .dark .selected-card { border-color: #3b82f6; background-color: #1e3a8a; }

        .level-header { transition: background-color 0.2s; }
        .level-header:hover { background-color: #f1f5f9; }
        .dark .level-header:hover { background-color: #334155; }
        
        /* å‹•ç•«éæ¸¡ */
        .fade-enter { opacity: 0; transform: translateY(10px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); transition: opacity 300ms, transform 300ms; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect } = React;
        const { createRoot } = ReactDOM;

        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”¥ Firebase Config
        let firebaseConfig;
        let appId = 'trainer-resource-hub';

        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            if (typeof __app_id !== 'undefined') appId = __app_id;
        } else {
            firebaseConfig = {
                apiKey: "AIzaSyAAo6on0f2QUbPaRfxpIEb2uvhKxDvPUvs",
                authDomain: "yulubox.firebaseapp.com",
                projectId: "yulubox",
                storageBucket: "yulubox.firebasestorage.app",
                messagingSenderId: "256466567852",
                appId: "1:256466567852:web:233b74668908ffcb9b9509",
                measurementId: "G-YPCY41EKWX"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- Constants ---
        const PRESET_MATERIALS = ['ä¹’ä¹“çƒ', 'å……é›»é¦¬é”', 'å‹•åŠ›é¦¬é”', 'ä¸»æ©Ÿ', '15mmå¡‘è† çƒ', 'æ©¡çš®ç­‹', 'æ£‰ç·š', 'æ°´æ€§ç­†', 'A4ç´™'];
        const LEVEL_OPTIONS = Array.from({length: 16}, (_, i) => `ç¬¬${i+1}ç´š`);
        const PRESET_PRINCIPLES = ['æ§“æ¡¿åŸç†', 'æ»‘è¼ªæ‡‰ç”¨', 'é½’è¼ªå‚³å‹•', 'æ‘©æ“¦åŠ›', 'é‡å¿ƒèˆ‡å¹³è¡¡', 'é›»è·¯ä¸²ä¸¦è¯', 'ç´…å¤–ç·šæ„Ÿæ¸¬', 'è¶…éŸ³æ³¢åŸç†', 'é‚è¼¯åˆ¤æ–·', 'è¿´åœˆçµæ§‹', 'è®Šæ•¸æ‡‰ç”¨', 'å»£æ’­é€šè¨Š'];

        // --- Helper: Image Compression (å„ªåŒ–ç‰ˆæœ¬) ---
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        // é€²ä¸€æ­¥é™ä½æœ€å¤§è§£æåº¦ä»¥ç¢ºä¿åœ–ç‰‡å®¹é‡æ¥µå°ï¼Œæå‡ä¸Šå‚³æˆåŠŸç‡
                        const MAX_WIDTH = 600;
                        const MAX_HEIGHT = 600;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // é¦–æ¬¡å˜—è©¦å£“ç¸® (å“è³ª 0.6)
                        let dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                        
                        // æª¢æŸ¥ Base64 é•·åº¦ä¼°ç®—å¤§å°ï¼Œè‹¥è¶…éç´„ 250KBï¼Œé€²è¡ŒäºŒæ¬¡å¼·åŠ›å£“ç¸®
                        // (Firestore æ–‡ä»¶ä¸Šé™ 1MBï¼Œä¸‰å¼µåœ–ç‰‡åŠ èµ·ä¾†éœ€ä¿æŒåœ¨å®‰å…¨ç¯„åœ)
                        const sizeInKB = (dataUrl.length * 0.75) / 1024;
                        if (sizeInKB > 250) {
                            dataUrl = canvas.toDataURL('image/jpeg', 0.3);
                        }
                        
                        resolve(dataUrl);
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        };

        // --- Components ---
        const ImageUploader = ({ label, currentImage, onImageChange, id, height = "h-40" }) => {
            const [isDragging, setIsDragging] = useState(false);
            const [isProcessing, setIsProcessing] = useState(false); // æ–°å¢è™•ç†ä¸­ç‹€æ…‹

            const handleFile = async (file, inputElement = null) => {
                if (!file) {
                    if(inputElement) inputElement.value = '';
                    return;
                }
                if (!file.type.startsWith('image/')) {
                    alert("è«‹ä¸Šå‚³åœ–ç‰‡æª”æ¡ˆ (JPG/PNGç­‰)");
                    if(inputElement) inputElement.value = '';
                    return;
                }
                
                setIsProcessing(true);
                try {
                    const compressed = await compressImage(file);
                    onImageChange(compressed);
                } catch (err) { 
                    alert("åœ–ç‰‡è™•ç†å¤±æ•—ï¼Œè«‹å˜—è©¦å¦ä¸€å¼µåœ–ç‰‡"); 
                } finally {
                    setIsProcessing(false);
                    // æ¸…ç©º input è®“ä¸‹æ¬¡å¯ä»¥é¸å–åŒä¸€å¼µåœ–ç‰‡
                    if(inputElement) inputElement.value = ''; 
                }
            };

            return (
                <div className="mb-4">
                    <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">{label}</label>
                    {currentImage ? (
                        <div className="relative group rounded-lg overflow-hidden border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 inline-block max-w-full">
                            <img src={currentImage} alt="Preview" className={`${height} object-contain`} />
                            <button type="button" onClick={() => onImageChange('')} className="absolute top-2 right-2 bg-red-500 text-white w-6 h-6 flex items-center justify-center rounded-full shadow-md opacity-0 group-hover:opacity-100 transition-opacity">
                                <i className="fa-solid fa-xmark text-sm"></i>
                            </button>
                        </div>
                    ) : (
                        <div
                            onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}
                            onDragLeave={() => setIsDragging(false)}
                            onDrop={(e) => { e.preventDefault(); setIsDragging(false); handleFile(e.dataTransfer.files[0]); }}
                            className={`relative border-2 border-dashed rounded-xl p-6 text-center cursor-pointer transition-colors ${isDragging ? 'border-blue-500 bg-blue-50 dark:bg-slate-800' : 'border-slate-300 dark:border-slate-600 hover:border-blue-400 hover:bg-slate-50 dark:hover:bg-slate-800'}`}
                        >
                            <input type="file" id={id} className="hidden" accept="image/*" onChange={(e) => handleFile(e.target.files[0], e.target)} />
                            <label htmlFor={id} className="cursor-pointer flex flex-col items-center gap-2">
                                {isProcessing ? (
                                    <i className="fa-solid fa-circle-notch fa-spin text-2xl text-blue-500"></i>
                                ) : (
                                    <i className={`fa-solid fa-cloud-arrow-up text-2xl ${isDragging ? 'text-blue-500' : 'text-slate-400 dark:text-slate-500'}`}></i>
                                )}
                                <span className="text-sm font-medium text-slate-600 dark:text-slate-400">
                                    {isProcessing ? 'åœ–ç‰‡è™•ç†ä¸­...' : 'é»æ“Šæˆ–æ‹–æ›³ä¸Šå‚³'}
                                </span>
                            </label>
                        </div>
                    )}
                </div>
            );
        };

        const SectionCard = ({ title, iconClass, content, image, videoUrl, colorClass, isCode = false }) => {
            if (!content && !image && !videoUrl) return null;
            return (
                <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden mb-6 transition-colors">
                    <div className="px-5 py-4 border-b border-slate-50 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/50 flex items-center gap-3">
                        <div className={`p-2 rounded-lg ${colorClass} text-white`}><i className={`${iconClass} text-lg`}></i></div>
                        <h3 className="text-lg font-bold text-slate-800 dark:text-slate-100">{title}</h3>
                    </div>
                    <div className="p-5">
                        {image && <div className="mb-4"><img src={image} className="max-w-full max-h-80 rounded-lg border border-slate-100 dark:border-slate-600 shadow-sm object-contain bg-white" /></div>}
                        {content && (isCode ? 
                            <pre className="bg-slate-900 text-slate-50 p-4 rounded-lg overflow-x-auto text-sm font-mono leading-relaxed mb-4"><code>{content}</code></pre> : 
                            <div className="text-slate-600 dark:text-slate-300 whitespace-pre-wrap leading-relaxed text-base mb-4">{content}</div>
                        )}
                        {videoUrl && <div className="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700"><a href={videoUrl} target="_blank" className="w-full sm:w-auto inline-flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-bold transition-colors"><i className="fa-solid fa-video"></i> è§€çœ‹æ•™å­¸å½±ç‰‡</a></div>}
                    </div>
                </div>
            );
        };

        // --- Main App ---
        function App() {
            const [user, setUser] = useState(null);
            const [lessons, setLessons] = useState([]);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('list');
            const [formMode, setFormMode] = useState('add');
            const [currentLesson, setCurrentLesson] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [showMobileMenu, setShowMobileMenu] = useState(false);
            const [xlsxReady, setXlsxReady] = useState(false);
            const [isBatchMode, setIsBatchMode] = useState(false);
            const [selectedItems, setSelectedItems] = useState(new Set());
            const [expandedLevels, setExpandedLevels] = useState({});
            
            // Dark Mode State
            const [darkMode, setDarkMode] = useState(localStorage.getItem('theme') === 'dark');

            // Form Data (Added principle & origin)
            const [formData, setFormData] = useState({
                title: '', level: 'ç¬¬1ç´š', 
                principle: '', // åŸç†
                origin: '',    // å…¸æ•…
                adaptation: '', adaptationImage: '',
                activities: '', activityImage: '', activityVideo: '',
                materials: '', precautions: '', 
                codeSnippet: '', codeImage: ''
            });

            // Dark Mode Effect
            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            }, [darkMode]);

            // Check XLSX
            useEffect(() => {
                if (window.XLSX) setXlsxReady(true);
                else {
                    const i = setInterval(() => { if (window.XLSX) { setXlsxReady(true); clearInterval(i); } }, 500);
                }
            }, []);

            // Auth
            useEffect(() => {
                const initAuth = async () => { 
                    try { 
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                        else await signInAnonymously(auth); 
                    } catch(e) { console.error("Auth failed:", e); }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            // Data Sync & æ™ºæ…§æ’åºé‚è¼¯
            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'lessons'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    data.sort((a, b) => {
                        // 1. å…ˆæ¯”è¼ƒç´šåˆ¥å¤§å°
                        const la = parseInt((a.level||'').replace(/\D/g,'')) || 0;
                        const lb = parseInt((b.level||'').replace(/\D/g,'')) || 0;
                        if(la !== lb) return la - lb;
                        
                        // 2. ç´šåˆ¥ç›¸åŒæ™‚ï¼Œæ ¹æ“šåç¨± (é¦–å­—ç­†ç•« æˆ– æ•¸å­—) å›ºå®šç”±å°åˆ°å¤§æ’åˆ—
                        // ä½¿ç”¨ zh-TW-u-co-stroke åƒæ•¸å¯ä»¥ç²¾æº–æŒ‰ç…§ç¹é«”ä¸­æ–‡ç­†ç•«æ’åº
                        // numeric: true ç¢ºä¿ä¾‹å¦‚ "2" æœƒæ’åœ¨ "10" çš„å‰é¢
                        return (a.title || '').localeCompare((b.title || ''), 'zh-TW-u-co-stroke', { numeric: true });
                    });
                    
                    setLessons(data);
                    setLoading(false);
                    if (currentLesson) {
                        const updated = data.find(l => l.id === currentLesson.id);
                        if (updated) setCurrentLesson(updated); else setView('list');
                    }
                }, (error) => { console.error("Data fetch error:", error); setLoading(false); });
                return () => unsubscribe();
            }, [user, currentLesson]);

            // Auto-expand levels on search
            useEffect(() => {
                if (searchTerm) {
                    const newExpanded = {};
                    LEVEL_OPTIONS.forEach(level => {
                        if (lessons.some(l => l.level === level && l.title.toLowerCase().includes(searchTerm.toLowerCase()))) newExpanded[level] = true;
                    });
                    if (lessons.some(l => !LEVEL_OPTIONS.includes(l.level) && l.title.toLowerCase().includes(searchTerm.toLowerCase()))) newExpanded['Uncategorized'] = true;
                    setExpandedLevels(newExpanded);
                }
            }, [searchTerm, lessons]);

            // Excel Export
            const handleDownloadTemplate = () => {
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([
                    ['èª²ç¨‹åç¨±', 'ç´šåˆ¥', 'ç§‘å­¸åŸç†', 'å…¸æ•…ç”±ä¾†', 'æ”¹é€ æ–¹å‘', 'äº’å‹•ç©æ³•', 'æ”œå¸¶ç‰©å“', 'æ³¨æ„äº‹é …', 'ç¨‹å¼ç¢¼', 'å½±ç‰‡é€£çµ'],
                    ['ç¯„ä¾‹èª²ç¨‹', 'ç¬¬1ç´š', 'æ§“æ¡¿åŸç†', 'æºè‡ªå¤å¸Œè‡˜...', 'é©åˆæ–°æ‰‹', 'åˆ†çµ„ç«¶è³½', 'é›»è…¦', 'æ³¨æ„å®‰å…¨', 'print("Hello")', 'https://youtube.com']
                ]);
                ws['!cols'] = [{wch:25}, {wch:10}, {wch:15}, {wch:25}, {wch:30}, {wch:30}, {wch:20}, {wch:20}, {wch:30}, {wch:30}];
                XLSX.utils.book_append_sheet(wb, ws, "ç¯„æœ¬");
                XLSX.writeFile(wb, "èª²ç¨‹åŒ¯å…¥ç¯„æœ¬_v2.xlsx");
            };

            const handleExcelImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    
                    if(confirm(`ç¢ºèªåŒ¯å…¥ ${jsonData.length} ç­†è³‡æ–™ï¼Ÿ`)) {
                        setLoading(true);
                        const ref = collection(db, 'artifacts', appId, 'public', 'data', 'lessons');
                        const batch = writeBatch(db); 
                        for (const row of jsonData) {
                            const newDocRef = doc(ref);
                            batch.set(newDocRef, {
                                title: row['èª²ç¨‹åç¨±'] || 'æœªå‘½å',
                                level: row['ç´šåˆ¥'] || 'ç¬¬1ç´š',
                                principle: row['ç§‘å­¸åŸç†'] || row['Principle'] || '', 
                                origin: row['å…¸æ•…ç”±ä¾†'] || row['Origin'] || '',     
                                adaptation: row['æ”¹é€ æ–¹å‘'] || '',
                                activities: row['äº’å‹•ç©æ³•'] || '',
                                materials: row['æ”œå¸¶ç‰©å“'] || '',
                                precautions: row['æ³¨æ„äº‹é …'] || '',
                                codeSnippet: row['ç¨‹å¼ç¢¼'] || '',
                                activityVideo: row['å½±ç‰‡é€£çµ'] || '',
                                createdAt: new Date().toISOString(),
                                authorId: user.uid,
                                adaptationImage: '', activityImage: '', codeImage: ''
                            });
                        }
                        await batch.commit();
                        setLoading(false);
                        alert("åŒ¯å…¥æˆåŠŸï¼");
                    }
                    e.target.value = null; 
                };
                reader.readAsArrayBuffer(file);
            };

            const handleFormSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    const ref = collection(db, 'artifacts', appId, 'public', 'data', 'lessons');
                    const dataToSave = { ...formData, updatedAt: new Date().toISOString() };
                    if (!dataToSave.createdAt) dataToSave.createdAt = new Date().toISOString();
                    if (!dataToSave.authorId && user) dataToSave.authorId = user.uid;

                    if (formMode === 'edit' && currentLesson) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'lessons', currentLesson.id), dataToSave);
                        alert("æ›´æ–°æˆåŠŸï¼");
                        setView('detail');
                    } else {
                        await addDoc(ref, dataToSave);
                        alert("æ–°å¢æˆåŠŸï¼");
                        setView('list'); 
                        resetForm();
                    }
                } catch(e) { console.error(e); alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¢ºèªåœ–ç‰‡æœªè¶…éä¸Šé™ã€‚"); }
                setLoading(false);
            };

            const resetForm = () => {
                setFormData({ title: '', level: 'ç¬¬1ç´š', principle: '', origin: '', adaptation: '', adaptationImage: '', activities: '', activityImage: '', activityVideo: '', materials: '', precautions: '', codeSnippet: '', codeImage: '' });
            };

            const startEdit = (lesson) => {
                setFormData({
                    title: lesson.title || '', level: lesson.level || 'ç¬¬1ç´š',
                    principle: lesson.principle || '', origin: lesson.origin || '',
                    adaptation: lesson.adaptation || '', adaptationImage: lesson.adaptationImage || '',
                    activities: lesson.activities || '', activityImage: lesson.activityImage || '', activityVideo: lesson.activityVideo || '',
                    materials: lesson.materials || '', precautions: lesson.precautions || '',
                    codeSnippet: lesson.codeSnippet || '', codeImage: lesson.codeImage || ''
                });
                setFormMode('edit'); setView('form');
            };

            const startAdd = () => { resetForm(); setFormMode('add'); setView('form'); };

            const handleDelete = async (id) => {
                if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'lessons', id));
                    if(currentLesson?.id === id) setView('list');
                }
            };

            const toggleSelection = (id) => {
                const newSet = new Set(selectedItems);
                if (newSet.has(id)) newSet.delete(id); else newSet.add(id);
                setSelectedItems(newSet);
            };

            const toggleSelectAll = (targetLessons) => {
                if (selectedItems.size === targetLessons.length) setSelectedItems(new Set());
                else setSelectedItems(new Set(targetLessons.map(l => l.id)));
            };

            const handleBatchDelete = async () => {
                if (selectedItems.size === 0) return alert("è«‹å…ˆé¸å–èª²ç¨‹");
                if (confirm(`ç¢ºå®šè¦åˆªé™¤é¸å–çš„ ${selectedItems.size} å ‚èª²ç¨‹å—ï¼Ÿ`)) {
                    setLoading(true);
                    const batch = writeBatch(db);
                    selectedItems.forEach(id => batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'lessons', id)));
                    await batch.commit();
                    setSelectedItems(new Set()); setIsBatchMode(false); setLoading(false);
                    alert("æ‰¹é‡åˆªé™¤å®Œæˆ");
                }
            };

            const handleBatchUpdateLevel = async (level) => {
                if (selectedItems.size === 0) return alert("è«‹å…ˆé¸å–èª²ç¨‹");
                if (confirm(`ç¢ºå®šå°‡ ${selectedItems.size} å ‚èª²ç¨‹è¨­ç‚º ${level} å—ï¼Ÿ`)) {
                    setLoading(true);
                    const batch = writeBatch(db);
                    selectedItems.forEach(id => batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'lessons', id), { level: level }));
                    await batch.commit();
                    setSelectedItems(new Set()); setIsBatchMode(false); setLoading(false);
                    alert("æ‰¹é‡ä¿®æ”¹å®Œæˆ");
                }
            };

            const addPresetText = (field, item) => {
                setFormData(prev => {
                    const current = prev[field] || '';
                    if (current.includes(item)) return prev; 
                    const newValue = current ? `${current}ã€${item}` : item;
                    return { ...prev, [field]: newValue };
                });
            };
            
            const filteredLessons = lessons.filter(l => l.title.toLowerCase().includes(searchTerm.toLowerCase()));

            if (loading) return <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 dark:bg-slate-950 text-slate-500 dark:text-slate-400"><i className="fa-solid fa-spinner fa-spin text-3xl mb-4"></i><p>è¼‰å…¥ä¸­...</p></div>;

            return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-950 font-sans text-slate-900 dark:text-slate-100 pb-20 transition-colors duration-300">
                    {/* Navigation */}
                    <nav className="bg-white dark:bg-slate-900 shadow-sm sticky top-0 z-30 border-b border-slate-200 dark:border-slate-800 transition-colors duration-300">
                        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2 cursor-pointer hover:opacity-80" onClick={() => { setView('list'); setSearchTerm(''); setIsBatchMode(false); }}>
                                <div className="bg-blue-600 p-2 rounded-lg text-white"><i className="fa-solid fa-book-open"></i></div>
                                <div><div className="font-bold text-lg text-slate-800 dark:text-slate-100">è¦“è¬çˆ¾</div><div className="text-xs text-slate-500 dark:text-slate-400">å¸«è³‡åŸ¹è¨“ä¸­å¿ƒ</div></div>
                            </div>
                            
                            <div className="hidden md:flex items-center gap-3">
                                <button onClick={() => setDarkMode(!darkMode)} className="p-2 rounded-lg text-slate-500 dark:text-yellow-400 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors mr-2">
                                    <i className={`fa-solid ${darkMode ? 'fa-sun' : 'fa-moon'}`}></i>
                                </button>
                                
                                {view === 'list' ? (
                                    <>
                                        <button onClick={() => setIsBatchMode(!isBatchMode)} className={`px-3 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors ${isBatchMode ? 'bg-orange-100 text-orange-700' : 'text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800'}`}>
                                            <i className="fa-solid fa-list-check"></i> {isBatchMode ? 'é€€å‡ºç®¡ç†' : 'æ‰¹é‡ç®¡ç†'}
                                        </button>
                                        <button onClick={handleDownloadTemplate} className="text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 px-3 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><i className="fa-solid fa-download"></i> ä¸‹è¼‰ç¯„æœ¬</button>
                                        <label className={`cursor-pointer bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 hover:bg-emerald-100 dark:hover:bg-emerald-900/50 px-3 py-2 rounded-lg text-sm font-bold flex items-center gap-2 ${!xlsxReady ? 'opacity-50 cursor-not-allowed' : ''}`}>
                                            <i className="fa-solid fa-file-excel"></i> åŒ¯å…¥ Excel
                                            <input type="file" accept=".xlsx,.xls" className="hidden" onChange={handleExcelImport} disabled={!xlsxReady} />
                                        </label>
                                        <button onClick={startAdd} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 flex items-center gap-2"><i className="fa-solid fa-plus"></i> æ–°å¢èª²ç¨‹</button>
                                    </>
                                ) : (
                                    <button onClick={() => setView('list')} className="text-slate-500 dark:text-slate-300 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-3 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-slate-100 dark:hover:bg-slate-700"><i className="fa-solid fa-arrow-left"></i> è¿”å›åˆ—è¡¨</button>
                                )}
                                <a href="vip_area.html" className="text-slate-400 dark:text-slate-500 hover:text-slate-800 dark:hover:text-slate-200 ml-4"><i className="fa-solid fa-right-from-bracket"></i></a>
                            </div>

                            <div className="md:hidden flex gap-3 items-center">
                                <button onClick={() => setDarkMode(!darkMode)} className="p-2 text-slate-500 dark:text-yellow-400"><i className={`fa-solid ${darkMode ? 'fa-sun' : 'fa-moon'}`}></i></button>
                                {view !== 'list' && <button onClick={() => setView('list')}><i className="fa-solid fa-arrow-left text-xl text-slate-600 dark:text-slate-300"></i></button>}
                                {view === 'list' && <button onClick={() => setShowMobileMenu(!showMobileMenu)}><i className="fa-solid fa-bars text-xl text-slate-600 dark:text-slate-300"></i></button>}
                            </div>
                        </div>
                        {showMobileMenu && view === 'list' && (
                            <div className="md:hidden border-t dark:border-slate-800 bg-white dark:bg-slate-900 absolute w-full shadow-lg p-4 flex flex-col gap-3 z-40">
                                <button onClick={() => { startAdd(); setShowMobileMenu(false); }} className="bg-blue-600 text-white w-full py-3 rounded-xl font-bold flex items-center justify-center gap-2"><i className="fa-solid fa-plus"></i> æ–°å¢èª²ç¨‹</button>
                                <button onClick={() => { setIsBatchMode(!isBatchMode); setShowMobileMenu(false); }} className="bg-orange-50 text-orange-700 w-full py-3 rounded-xl font-bold flex items-center justify-center gap-2"><i className="fa-solid fa-list-check"></i> {isBatchMode ? 'é€€å‡ºæ‰¹é‡ç®¡ç†' : 'æ‰¹é‡ç®¡ç†'}</button>
                                <div className="flex gap-2">
                                    <button onClick={handleDownloadTemplate} className="flex-1 bg-slate-100 dark:bg-slate-800 py-3 rounded-xl flex items-center justify-center gap-2 text-slate-600 dark:text-slate-300 font-bold"><i className="fa-solid fa-download"></i> ä¸‹è¼‰ç¯„æœ¬</button>
                                    <label className={`flex-1 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 py-3 rounded-xl text-center font-bold flex items-center justify-center gap-2 ${!xlsxReady ? 'opacity-50' : ''}`}>
                                        <i className="fa-solid fa-file-excel"></i> åŒ¯å…¥ Excel <input type="file" className="hidden" onChange={handleExcelImport} disabled={!xlsxReady} />
                                    </label>
                                </div>
                            </div>
                        )}
                    </nav>

                    <main className="max-w-6xl mx-auto px-4 py-8 relative">
                        {/* LIST VIEW */}
                        {view === 'list' && (
                            <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                                <header className="mb-6 flex flex-col md:flex-row md:items-end justify-between gap-4">
                                    <div>
                                        <h1 className="text-3xl font-extrabold text-slate-900 dark:text-white">èª²ç¨‹åŸ¹è¨“</h1>
                                        <p className="text-slate-500 dark:text-slate-400">å…± {lessons.length} å ‚èª²ç¨‹</p>
                                    </div>
                                    <div className="relative w-full md:w-80">
                                        <i className="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                        <input type="text" placeholder="æœå°‹èª²ç¨‹..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-3 border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white rounded-xl outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                </header>

                                {/* Batch Actions */}
                                {isBatchMode && (
                                    <div className="mb-6 p-4 bg-orange-50 dark:bg-orange-900/30 border border-orange-200 dark:border-orange-800 rounded-xl flex flex-wrap items-center gap-4 animate-pulse sticky top-20 z-20 shadow-md backdrop-blur-sm">
                                        <span className="font-bold text-orange-800 dark:text-orange-300"><i className="fa-solid fa-check-double"></i> å·²é¸å– {selectedItems.size} é …</span>
                                        <button onClick={() => toggleSelectAll(filteredLessons)} className="text-sm bg-white dark:bg-slate-800 border border-orange-200 dark:border-slate-600 px-3 py-1 rounded-lg hover:bg-orange-100 dark:hover:bg-slate-700 dark:text-slate-200">
                                            {selectedItems.size === filteredLessons.length ? 'å–æ¶ˆå…¨é¸' : 'å…¨é¸'}
                                        </button>
                                        <div className="flex-1"></div>
                                        <div className="flex gap-2">
                                            <select onChange={(e) => { if(e.target.value) handleBatchUpdateLevel(e.target.value); e.target.value=''; }} className="text-sm border border-orange-200 dark:border-slate-600 rounded-lg px-2 py-1 bg-white dark:bg-slate-800 dark:text-slate-200 outline-none">
                                                <option value="">æ‰¹é‡ä¿®æ”¹ç´šåˆ¥...</option>
                                                {LEVEL_OPTIONS.map(level => <option key={level} value={level}>{level}</option>)}
                                            </select>
                                            <button onClick={handleBatchDelete} className="bg-red-500 text-white text-sm px-4 py-2 rounded-lg hover:bg-red-600 font-bold"><i className="fa-solid fa-trash"></i> åˆªé™¤é¸å–</button>
                                        </div>
                                    </div>
                                )}

                                {filteredLessons.length === 0 ? (
                                    <div className="bg-white dark:bg-slate-800 rounded-2xl p-12 text-center border-2 border-dashed border-slate-300 dark:border-slate-700">
                                        <i className="fa-solid fa-box-open text-4xl text-slate-300 dark:text-slate-600 mb-4"></i>
                                        <h3 className="text-lg font-bold text-slate-700 dark:text-slate-300">æ‰¾ä¸åˆ°ç¬¦åˆçš„èª²ç¨‹</h3>
                                        <p className="text-slate-500 dark:text-slate-400">è©¦è©¦å…¶ä»–é—œéµå­—ï¼Œæˆ–æ–°å¢èª²ç¨‹ã€‚</p>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        {/* Accordion Grouping */}
                                        {LEVEL_OPTIONS.map(level => {
                                            const levelLessons = filteredLessons.filter(l => l.level === level);
                                            if (levelLessons.length === 0) return null;
                                            const isExpanded = expandedLevels[level];

                                            return (
                                                <div key={level} className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden transition-colors">
                                                    <button onClick={() => setExpandedLevels(prev => ({...prev, [level]: !prev[level]}))} className="w-full px-6 py-4 flex items-center justify-between level-header text-left outline-none cursor-pointer">
                                                        <div className="flex items-center gap-3">
                                                            <div className="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold shadow-sm">{level.replace('ç¬¬','').replace('ç´š','')}</div>
                                                            <span className="font-bold text-lg text-slate-800 dark:text-slate-100">{level}</span>
                                                            <span className="text-xs font-medium text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded-full border border-slate-200 dark:border-slate-600">{levelLessons.length} å ‚èª²</span>
                                                        </div>
                                                        <i className={`fa-solid fa-chevron-down text-slate-400 transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}`}></i>
                                                    </button>
                                                    
                                                    {isExpanded && (
                                                        <div className="p-6 border-t border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50">
                                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                                                {levelLessons.map(lesson => (
                                                                    <div key={lesson.id} className="relative group">
                                                                        {isBatchMode && (
                                                                            <div className="absolute top-3 right-3 z-20">
                                                                                <input type="checkbox" checked={selectedItems.has(lesson.id)} onChange={() => toggleSelection(lesson.id)} className="w-6 h-6 accent-blue-600 cursor-pointer shadow-sm" />
                                                                            </div>
                                                                        )}
                                                                        <article onClick={() => { if(isBatchMode) toggleSelection(lesson.id); else { setCurrentLesson(lesson); setView('detail'); } }} className={`bg-white dark:bg-slate-800 rounded-2xl shadow-sm border overflow-hidden cursor-pointer hover:shadow-lg transition-all flex flex-col h-full relative ${isBatchMode && selectedItems.has(lesson.id) ? 'selected-card ring-2 ring-blue-500' : 'border-slate-200 dark:border-slate-700'}`}>
                                                                            <div className="h-40 bg-slate-100 dark:bg-slate-700 relative overflow-hidden flex items-center justify-center">
                                                                                {(lesson.adaptationImage || lesson.activityImage || lesson.codeImage) ? (
                                                                                    <img src={lesson.adaptationImage || lesson.activityImage || lesson.codeImage} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" onError={(e) => { e.target.style.display='none'; }} />
                                                                                ) : (
                                                                                    <div className="flex flex-col items-center gap-2 text-slate-300 dark:text-slate-500"><i className="fa-regular fa-image text-3xl"></i><span className="text-xs">ç„¡åœ–ç‰‡</span></div>
                                                                                )}
                                                                            </div>
                                                                            <div className="p-4 flex-1 flex flex-col">
                                                                                <h2 className="text-lg font-bold mb-2 text-slate-800 dark:text-slate-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors line-clamp-1">{lesson.title}</h2>
                                                                                <p className="text-slate-600 dark:text-slate-400 text-sm line-clamp-2 mb-3 flex-1">{lesson.adaptation || "æš«ç„¡èªªæ˜"}</p>
                                                                                <div className="flex items-center justify-between pt-3 border-t border-slate-100 dark:border-slate-700 mt-auto">
                                                                                    <div className="flex gap-2">
                                                                                        {lesson.activityVideo && <span className="text-xs text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/30 px-2 py-1 rounded"><i className="fa-solid fa-video"></i></span>}
                                                                                        {(lesson.codeSnippet || lesson.codeImage) && <span className="text-xs text-slate-600 dark:text-slate-300 bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded"><i className="fa-solid fa-code"></i></span>}
                                                                                    </div>
                                                                                    <span className="text-blue-500 dark:text-blue-400 text-xs font-bold">è©³æƒ… <i className="fa-solid fa-arrow-right"></i></span>
                                                                                </div>
                                                                            </div>
                                                                        </article>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                        
                                        {/* Uncategorized section */}
                                        {(() => {
                                            const otherLessons = filteredLessons.filter(l => !LEVEL_OPTIONS.includes(l.level));
                                            if (otherLessons.length === 0) return null;
                                            const isExpanded = expandedLevels['Uncategorized'];
                                            return (
                                                <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden transition-colors">
                                                    <button onClick={() => setExpandedLevels(prev => ({...prev, 'Uncategorized': !prev['Uncategorized']}))} className="w-full px-6 py-4 flex items-center justify-between level-header text-left outline-none cursor-pointer">
                                                        <div className="flex items-center gap-3">
                                                            <div className="bg-slate-400 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold shadow-sm">?</div>
                                                            <span className="font-bold text-lg text-slate-800 dark:text-slate-100">æœªåˆ†é¡ / å…¶ä»–</span>
                                                            <span className="text-xs font-medium text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded-full border border-slate-200 dark:border-slate-600">{otherLessons.length} å ‚èª²</span>
                                                        </div>
                                                        <i className={`fa-solid fa-chevron-down text-slate-400 transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}`}></i>
                                                    </button>
                                                    
                                                    {isExpanded && (
                                                        <div className="p-6 border-t border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50">
                                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                                                {otherLessons.map(lesson => (
                                                                    <div key={lesson.id} className="relative group">
                                                                        {isBatchMode && (
                                                                            <div className="absolute top-3 right-3 z-20">
                                                                                <input type="checkbox" checked={selectedItems.has(lesson.id)} onChange={() => toggleSelection(lesson.id)} className="w-6 h-6 accent-blue-600 cursor-pointer shadow-sm" />
                                                                            </div>
                                                                        )}
                                                                        <article onClick={() => { if(isBatchMode) toggleSelection(lesson.id); else { setCurrentLesson(lesson); setView('detail'); } }} className={`bg-white dark:bg-slate-800 rounded-2xl shadow-sm border overflow-hidden cursor-pointer hover:shadow-lg transition-all flex flex-col h-full relative ${isBatchMode && selectedItems.has(lesson.id) ? 'selected-card ring-2 ring-blue-500' : 'border-slate-200 dark:border-slate-700'}`}>
                                                                            <div className="h-40 bg-slate-100 dark:bg-slate-700 relative overflow-hidden flex items-center justify-center">
                                                                                {(lesson.adaptationImage || lesson.activityImage || lesson.codeImage) ? (
                                                                                    <img src={lesson.adaptationImage || lesson.activityImage || lesson.codeImage} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" onError={(e) => { e.target.style.display='none'; }} />
                                                                                ) : (
                                                                                    <div className="flex flex-col items-center gap-2 text-slate-300 dark:text-slate-500"><i className="fa-regular fa-image text-3xl"></i><span className="text-xs">ç„¡åœ–ç‰‡</span></div>
                                                                                )}
                                                                            </div>
                                                                            <div className="p-4 flex-1 flex flex-col">
                                                                                <h2 className="text-lg font-bold mb-2 text-slate-800 dark:text-slate-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors line-clamp-1">{lesson.title}</h2>
                                                                                <p className="text-slate-600 dark:text-slate-400 text-sm line-clamp-2 mb-3 flex-1">{lesson.adaptation || "æš«ç„¡èªªæ˜"}</p>
                                                                                <div className="flex items-center justify-between pt-3 border-t border-slate-100 dark:border-slate-700 mt-auto">
                                                                                    <div className="flex gap-2">
                                                                                        {lesson.activityVideo && <span className="text-xs text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/30 px-2 py-1 rounded"><i className="fa-solid fa-video"></i></span>}
                                                                                        {(lesson.codeSnippet || lesson.codeImage) && <span className="text-xs text-slate-600 dark:text-slate-300 bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded"><i className="fa-solid fa-code"></i></span>}
                                                                                    </div>
                                                                                    <span className="text-blue-500 dark:text-blue-400 text-xs font-bold">è©³æƒ… <i className="fa-solid fa-arrow-right"></i></span>
                                                                                </div>
                                                                            </div>
                                                                        </article>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })()}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* DETAIL VIEW */}
                        {view === 'detail' && currentLesson && (
                            <div className="max-w-4xl mx-auto animate-in fade-in zoom-in-95 duration-300">
                                <div className="flex justify-between items-start mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">
                                    <div>
                                        <div className="flex items-center gap-3 mb-3">
                                            <span className="bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center gap-1"><i className="fa-solid fa-tag"></i> {currentLesson.level}</span>
                                            <span className="text-slate-400 dark:text-slate-500 text-sm">{currentLesson.createdAt?.split('T')[0]}</span>
                                        </div>
                                        <h1 className="text-3xl md:text-4xl font-extrabold text-slate-900 dark:text-white leading-tight">{currentLesson.title}</h1>
                                        {currentLesson.principle && <div className="mt-2 text-emerald-600 dark:text-emerald-400 font-bold"><i className="fa-solid fa-lightbulb"></i> åŸç†ï¼š{currentLesson.principle}</div>}
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => startEdit(currentLesson)} className="text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-4 py-2 rounded-full font-bold hover:bg-blue-100 dark:hover:bg-blue-900/50 flex items-center gap-2 transition-colors border border-blue-100 dark:border-blue-900"><i className="fa-solid fa-pen-to-square"></i> ç·¨è¼¯</button>
                                        <button onClick={() => handleDelete(currentLesson.id)} className="text-red-500 dark:text-red-400 bg-red-50 dark:bg-red-900/30 px-4 py-2 rounded-full font-bold hover:bg-red-100 dark:hover:bg-red-900/50 flex items-center gap-2 transition-colors border border-red-100 dark:border-red-900"><i className="fa-solid fa-trash"></i> åˆªé™¤</button>
                                    </div>
                                </div>
                                <div className="space-y-6">
                                    {/* New Sections */}
                                    <SectionCard title="å…¸æ•…ç”±ä¾†" iconClass="fa-solid fa-book-bookmark" content={currentLesson.origin} colorClass="bg-purple-500" />
                                    <SectionCard title="ç§‘å­¸/ç¨‹å¼åŸç†" iconClass="fa-solid fa-microchip" content={currentLesson.principle} colorClass="bg-indigo-500" />
                                    
                                    <SectionCard title="èª²ç¨‹æ”¹é€ " iconClass="fa-solid fa-wrench" content={currentLesson.adaptation} image={currentLesson.adaptationImage} colorClass="bg-emerald-500" />
                                    <SectionCard title="äº’å‹•ç©æ³•" iconClass="fa-solid fa-gamepad" content={currentLesson.activities} image={currentLesson.activityImage} videoUrl={currentLesson.activityVideo} colorClass="bg-blue-500" />
                                    <SectionCard title="ç‰©è³‡æ¸…å–®" iconClass="fa-solid fa-box" content={currentLesson.materials} colorClass="bg-amber-500" />
                                    <SectionCard title="æ³¨æ„äº‹é …" iconClass="fa-solid fa-triangle-exclamation" content={currentLesson.precautions} colorClass="bg-rose-500" />
                                    <SectionCard title="ç¨‹å¼ç¯„ä¾‹" iconClass="fa-solid fa-code" content={currentLesson.codeSnippet} image={currentLesson.codeImage} colorClass="bg-slate-700" isCode={true} />
                                </div>
                            </div>
                        )}

                        {/* FORM VIEW */}
                        {view === 'form' && (
                            <div className="max-w-3xl mx-auto bg-white dark:bg-slate-800 p-6 md:p-8 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 animate-in fade-in slide-in-from-bottom-8">
                                <h2 className="text-2xl font-bold mb-6 text-slate-800 dark:text-white flex items-center gap-2">
                                    <i className={`fa-solid ${formMode === 'add' ? 'fa-plus' : 'fa-pen-to-square'} text-blue-600`}></i> 
                                    {formMode === 'add' ? 'æ–°å¢åŸ¹è¨“èª²ç¨‹' : 'ç·¨è¼¯èª²ç¨‹å…§å®¹'}
                                </h2>
                                <form onSubmit={handleFormSubmit} className="space-y-8">
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                        <div className="md:col-span-3">
                                            <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">èª²ç¨‹åç¨± <span className="text-red-500">*</span></label>
                                            <input required className="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all bg-white dark:bg-slate-700 dark:text-white" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} placeholder="ä¾‹å¦‚ï¼šmicro:bit é«”æ„ŸéŠæˆ²å¯¦ä½œ" />
                                        </div>
                                        <div className="md:col-span-1">
                                            <label className="block font-bold text-sm text-slate-700 dark:text-slate-300 mb-2">ç´šåˆ¥</label>
                                            <select className="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white dark:bg-slate-700 dark:text-white" value={formData.level} onChange={e => setFormData({...formData, level: e.target.value})}>
                                                {LEVEL_OPTIONS.map(level => <option key={level} value={level}>{level}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    
                                    {/* æ–°å¢ï¼šåŸç†èˆ‡å…¸æ•…å€å¡Š */}
                                    <div className="bg-indigo-50 dark:bg-indigo-900/20 p-5 rounded-xl border border-indigo-100 dark:border-indigo-900">
                                        <h3 className="font-bold text-indigo-800 dark:text-indigo-300 mb-4 flex items-center gap-2"><i className="fa-solid fa-brain"></i> æ ¸å¿ƒçŸ¥è­˜</h3>
                                        
                                        <div className="mb-4">
                                            <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ç§‘å­¸/ç¨‹å¼åŸç† (å¯å¤šé¸æˆ–è‡ªå¡«)</label>
                                            <div className="flex flex-wrap gap-2 mb-3">
                                                {PRESET_PRINCIPLES.map(p => (
                                                    <button type="button" key={p} onClick={() => addPresetText('principle', p)} className="px-3 py-1 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-full text-xs text-slate-600 dark:text-slate-300 hover:bg-indigo-100 dark:hover:bg-indigo-900 hover:border-indigo-300 transition-colors">
                                                        + {p}
                                                    </button>
                                                ))}
                                            </div>
                                            <input className="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white dark:bg-slate-700 dark:text-white" value={formData.principle} onChange={e => setFormData({...formData, principle: e.target.value})} placeholder="ä¾‹å¦‚ï¼šç´…å¤–ç·šæ„Ÿæ¸¬ã€æ§“æ¡¿åŸç†..." />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">å…¸æ•…/ç”±ä¾†</label>
                                            <textarea className="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white dark:bg-slate-700 dark:text-white" rows="2" value={formData.origin} onChange={e => setFormData({...formData, origin: e.target.value})} placeholder="é€™å ‚èª²çš„æ­·å²èƒŒæ™¯æˆ–å°æ•…äº‹..."></textarea>
                                        </div>
                                    </div>

                                    <div className="bg-emerald-50 dark:bg-emerald-900/20 p-5 rounded-xl border border-emerald-100 dark:border-emerald-900">
                                        <h3 className="font-bold text-emerald-800 dark:text-emerald-300 mb-4 flex items-center gap-2"><i className="fa-solid fa-wrench"></i> èª²ç¨‹æ”¹é€ </h3>
                                        <textarea className="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white dark:bg-slate-700 dark:text-white mb-4" rows="3" value={formData.adaptation} onChange={e => setFormData({...formData, adaptation: e.target.value})} placeholder="é€™å ‚èª²å¯ä»¥æ€éº¼è®ŠåŒ–ï¼Ÿé©åˆä»€éº¼æ¨£çš„å°è±¡èª¿æ•´ï¼Ÿ"></textarea>
                                        <ImageUploader id="adaptationImage" label="ä¸Šå‚³æ”¹é€ ç¤ºæ„åœ– (é¸å¡«)" currentImage={formData.adaptationImage} onImageChange={d => setFormData({...formData, adaptationImage: d})} />
                                    </div>
                                    
                                    <div className="bg-blue-50 dark:bg-blue-900/20 p-5 rounded-xl border border-blue-100 dark:border-blue-900">
                                        <h3 className="font-bold text-blue-800 dark:text-blue-300 mb-4 flex items-center gap-2"><i className="fa-solid fa-gamepad"></i> äº’å‹•ç©æ³•</h3>
                                        <textarea className="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white dark:bg-slate-700 dark:text-white mb-4" rows="4" value={formData.activities} onChange={e => setFormData({...formData, activities: e.target.value})} placeholder="è©³ç´°æè¿°éŠæˆ²è¦å‰‡æˆ–äº’å‹•æ–¹å¼..."></textarea>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <ImageUploader id="activityImage" label="ä¸Šå‚³ç©æ³•ç¤ºæ„åœ– (é¸å¡«)" currentImage={formData.activityImage} onImageChange={d => setFormData({...formData, activityImage: d})} height="h-32" />
                                            <div>
                                                <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2 flex items-center gap-2"><i className="fa-solid fa-video text-slate-600 dark:text-slate-400"></i> åƒè€ƒå½±ç‰‡é€£çµ</label>
                                                <input type="url" placeholder="https://youtube.com/..." className="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white dark:bg-slate-700 dark:text-white" value={formData.activityVideo} onChange={e => setFormData({...formData, activityVideo: e.target.value})} />
                                            </div>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label className="block font-bold text-sm text-slate-700 dark:text-slate-300 mb-2 flex items-center gap-2"><i className="fa-solid fa-box text-amber-600"></i> æ”œå¸¶ç‰©å“</label>
                                            <div className="flex flex-wrap gap-2 mb-3">
                                                {PRESET_MATERIALS.map(item => (
                                                    <button type="button" key={item} onClick={() => addPresetText('materials', item)} className="px-3 py-1 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-full text-xs text-slate-600 dark:text-slate-300 hover:bg-amber-50 dark:hover:bg-amber-900/50 hover:border-amber-300 transition-colors">
                                                        + {item}
                                                    </button>
                                                ))}
                                            </div>
                                            <textarea className="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white dark:bg-slate-700 dark:text-white" rows="3" value={formData.materials} onChange={e => setFormData({...formData, materials: e.target.value})} placeholder="- é›»è…¦ x1&#10;- æ“´å……æ¿ x1"></textarea>
                                        </div>
                                        <div>
                                            <label className="block font-bold text-sm text-slate-700 dark:text-slate-300 mb-2 flex items-center gap-2"><i className="fa-solid fa-triangle-exclamation text-rose-600"></i> æ³¨æ„äº‹é …</label>
                                            <textarea className="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white dark:bg-slate-700 dark:text-white" rows="3" value={formData.precautions} onChange={e => setFormData({...formData, precautions: e.target.value})} placeholder="å ´åœ°éœ€è¦æ’åº§..."></textarea>
                                        </div>
                                    </div>

                                    <div className="bg-slate-50 dark:bg-slate-700/50 p-5 rounded-xl border border-slate-200 dark:border-slate-600">
                                        <h3 className="font-bold text-slate-800 dark:text-slate-200 mb-4 flex items-center gap-2"><i className="fa-solid fa-code"></i> ç¨‹å¼ç¯„ä¾‹</h3>
                                        <ImageUploader id="codeImage" label="ä¸Šå‚³ç¨‹å¼ç©æœ¨/æˆªåœ– (æ¨è–¦)" currentImage={formData.codeImage} onImageChange={d => setFormData({...formData, codeImage: d})} />
                                        <div className="mt-4">
                                            <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2 flex items-center gap-2"><i className="fa-solid fa-file-lines text-slate-400"></i> ç¨‹å¼ç¢¼å‚™è¨» (é¸å¡«)</label>
                                            <textarea className="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg font-mono text-sm bg-white dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none" rows="3" value={formData.codeSnippet} onChange={e => setFormData({...formData, codeSnippet: e.target.value})} placeholder="è£œå……èªªæ˜æˆ–è²¼ä¸Šé—œéµç¨‹å¼ç¢¼æ–‡å­—..."></textarea>
                                        </div>
                                    </div>

                                    <div className="flex gap-4 pt-4">
                                        <button type="button" onClick={() => { setView(formMode === 'add' ? 'list' : 'detail'); }} className="flex-1 py-3 px-6 rounded-lg border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 font-bold hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">å–æ¶ˆ</button>
                                        <button type="submit" className="flex-[2] py-3 px-6 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-md hover:shadow-lg transition-all active:scale-95">ç¢ºèªå„²å­˜</button>
                                    </div>
                                </form>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>