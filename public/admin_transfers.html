<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‚³è¼¸ç›£æ§å° - ç‰éœ²å¯¶åº«</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --admin-accent: #ff00ff; /* ç®¡ç†å“¡å°ˆå±¬ç´«ç´…è‰² */
            --admin-danger: #ff4757;
            --glass-bg: rgba(30, 20, 40, 0.8);
            --glass-border: rgba(255, 0, 255, 0.3);
        }
        body {
            /* ğŸŒŒ æ·±ç©ºæ˜Ÿéš›èƒŒæ™¯ (å¸¶ç´«è‰²èª¿) */
            background: linear-gradient(135deg, #0a0510 0%, #1a0b2e 50%, #0b1021 100%);
            color: #fff; font-family: 'Microsoft JhengHei', monospace;
            min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box;
        }

        /* å°èˆªåˆ— */
        .nav {
            display: flex; gap: 15px; margin-bottom: 30px; align-items: center;
            background: rgba(0,0,0,0.4); padding: 15px; border-radius: 50px;
            backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1);
            width: fit-content;
        }
        .nav a { 
            color: #ccc; text-decoration: none; font-size: 0.9rem; 
            padding: 5px 15px; border-radius: 20px; transition: 0.3s;
            display: flex; align-items: center; gap: 5px;
        }
        .nav a:hover { background: rgba(255,255,255,0.2); color: #fff; }
        .nav a.active { background: var(--admin-accent); color: #000; font-weight: bold; }

        h1 { 
            color: var(--admin-accent); border-bottom: 2px solid var(--admin-accent); 
            padding-bottom: 10px; display: inline-block; margin-top: 0;
            text-shadow: 0 0 15px var(--admin-accent);
        }

        /* çµ±è¨ˆæ•¸æ“šæ¢ */
        .stats-bar {
            display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .stat-item {
            background: rgba(255,255,255,0.05); padding: 10px 20px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1); font-size: 0.9rem;
        }
        .stat-val { font-weight: bold; font-size: 1.2rem; margin-left: 5px; color: var(--admin-accent); }

        /* å¡ç‰‡ç¶²æ ¼ */
        .grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 20px; 
        }
        
        .card {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: 15px; padding: 20px; position: relative; transition: 0.3s;
            backdrop-filter: blur(10px);
        }
        .card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.2); 
            border-color: var(--admin-accent);
        }
        
        /* éæœŸå¡ç‰‡æ¨£å¼ */
        .card.expired { opacity: 0.7; border-color: #555; background: rgba(0,0,0,0.5); }
        .card.expired .code { color: #888; text-decoration: line-through; }

        /* æ¨™ç±¤ */
        .tag { position: absolute; top: 15px; right: 15px; padding: 4px 10px; border-radius: 5px; font-size: 0.75rem; font-weight: bold; }
        .tag.active { color: #000; background: #00ff9d; box-shadow: 0 0 10px #00ff9d; }
        .tag.expired { color: #fff; background: #ff4757; }

        /* å…§å®¹ç´°ç¯€ */
        .code-row { display: flex; align-items: baseline; gap: 10px; margin-bottom: 15px; }
        .code { font-size: 1.8rem; color: #fff; font-weight: bold; letter-spacing: 2px; }
        .uploader { font-size: 0.8rem; color: #aaa; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; }

        .info-row { margin-bottom: 8px; font-size: 0.9rem; color: #ccc; display: flex; align-items: center; gap: 8px; }
        .info-row i { width: 20px; text-align: center; color: var(--admin-accent); }
        
        /* æª”æ¡ˆåˆ—è¡¨é è¦½ */
        .file-preview {
            background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin: 10px 0;
            font-size: 0.8rem; color: #888; max-height: 80px; overflow-y: auto;
        }

        /* æŒ‰éˆ• */
        .btn-del {
            width: 100%; background: var(--admin-danger); color: #fff; border: none; padding: 12px;
            margin-top: 10px; cursor: pointer; border-radius: 8px; font-weight: bold; font-size: 1rem;
            transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-del:hover { background: #ff2e40; box-shadow: 0 0 15px rgba(255, 71, 87, 0.4); }

        #loading { text-align: center; margin-top: 50px; color: var(--admin-accent); font-size: 1.2rem; }
    </style>
</head>
<body>

    <div class="nav">
        <a href="index.html"><i class="fa-solid fa-house"></i> é¦–é </a>
        <a href="vip_area.html"><i class="fa-solid fa-user-astronaut"></i> æœƒå“¡ç¸½éƒ¨</a>
        <a href="admin_gallery.html"><i class="fa-solid fa-images"></i> åœ–åº«ç®¡ç†</a>
        <a href="#" class="active"><i class="fa-solid fa-network-wired"></i> å‚³è¼¸ç›£æ§</a>
    </div>

    <h1><i class="fa-solid fa-shield-halved"></i> å‚³è¼¸å”è­°ç›£æ§å° (ADMIN)</h1>
    
    <div class="stats-bar">
        <div class="stat-item">ç¸½ä»»å‹™æ•¸: <span class="stat-val" id="totalCount">0</span></div>
        <div class="stat-item">æœ‰æ•ˆä»»å‹™: <span class="stat-val" id="activeCount" style="color:#00ff9d">0</span></div>
        <div class="stat-item">å·²éæœŸ: <span class="stat-val" id="expiredCount" style="color:#ff4757">0</span></div>
        <button onclick="loadData()" style="margin-left:auto; background:none; border:1px solid #fff; color:#fff; padding:5px 15px; cursor:pointer; border-radius:20px;">
            <i class="fa-solid fa-rotate-right"></i> é‡æ–°æ•´ç†
        </button>
    </div>

    <div id="loading"><i class="fa-solid fa-spinner fa-spin"></i> æ­£åœ¨æƒæè¡›æ˜Ÿè¨Šè™Ÿ...</div>
    <div class="grid" id="grid"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, deleteDoc, doc, orderBy, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // ğŸ”¥ Config
        const firebaseConfig = {
            apiKey: "AIzaSyAAo6on0f2QUbPaRfxpIEb2uvhKxDvPUvs",
            authDomain: "yulubox.firebaseapp.com",
            projectId: "yulubox",
            storageBucket: "yulubox.firebasestorage.app",
            messagingSenderId: "256466567852",
            appId: "1:256466567852:web:233b74668908ffcb9b9509",
            measurementId: "G-YPCY41EKWX"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // ç¶å®šåˆ° window ä»¥ä¾¿ HTML onclick å‘¼å«
        window.loadData = loadData;
        window.deleteTransfer = deleteTransfer;

        // ğŸš€ è¼‰å…¥è³‡æ–™
        async function loadData() {
            const grid = document.getElementById('grid');
            const loading = document.getElementById('loading');
            grid.innerHTML = '';
            loading.style.display = 'block';
            
            try {
                // ä¾å»ºç«‹æ™‚é–“æ’åº
                const q = query(collection(db, "temp_shares"), orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);
                
                if(snapshot.empty) {
                    loading.innerText = "ç›®å‰æ²’æœ‰ä»»ä½•å‚³è¼¸ä»»å‹™";
                    updateStats(0, 0, 0);
                    return;
                }
                loading.style.display = 'none';

                let total = 0, active = 0, expired = 0;

                snapshot.forEach(docSnap => {
                    total++;
                    const data = docSnap.data();
                    const now = new Date();
                    const expiry = data.expiresAt ? data.expiresAt.toDate() : new Date(); // é˜²å‘†
                    const isExpired = now > expiry;
                    
                    if(isExpired) expired++; else active++;

                    // è¨ˆç®—æª”æ¡ˆæ•¸é‡
                    let fileCount = 0;
                    let fileNamePreview = "ç„¡æª”æ¡ˆ";
                    if (data.files && data.files.length > 0) {
                        fileCount = data.files.length;
                        fileNamePreview = data.files.map(f => f.name).join(', ');
                    } else if (data.storagePath) {
                        fileCount = 1;
                        fileNamePreview = "å–®ä¸€å£“ç¸®æª”.zip";
                    }

                    // å»ºç«‹å¡ç‰‡
                    const card = document.createElement('div');
                    card.className = `card ${isExpired ? 'expired' : ''}`;
                    
                    card.innerHTML = `
                        <span class="tag ${isExpired ? 'expired' : 'active'}">${isExpired ? 'å·²éæœŸ' : 'å‚³è¼¸ä¸­'}</span>
                        
                        <div class="code-row">
                            <span class="code">${data.shareCode}</span>
                        </div>

                        <div class="info-row"><i class="fa-solid fa-user-secret"></i> ä¾†æº: ${data.uploader === 'anonymous' ? 'åŒ¿åè¨ªå®¢' : 'ID: ' + data.uploader.substring(0,6)}</div>
                        <div class="info-row"><i class="fa-solid fa-key"></i> å¯†ç¢¼: <span style="color:#fff; font-weight:bold;">${data.password}</span></div>
                        <div class="info-row"><i class="fa-regular fa-clock"></i> æœŸé™: ${expiry.toLocaleString()}</div>
                        
                        <div class="file-preview">
                            <i class="fa-solid fa-paperclip"></i> ${fileNamePreview}
                        </div>
                        
                        <div class="info-row" style="color:#666; font-size:0.75rem;">DOC ID: ${docSnap.id}</div>
                        
                        <button class="btn-del" onclick="deleteTransfer('${docSnap.id}')">
                            <i class="fa-solid fa-trash-can"></i> å¼·åˆ¶éŠ·æ¯€
                        </button>
                    `;
                    grid.appendChild(card);
                    
                    // æš«å­˜è³‡æ–™åˆ° window ä»¥ä¾¿åˆªé™¤æ™‚ä½¿ç”¨ (é¿å… delete æ‰¾ä¸åˆ° storage path)
                    window[`data_${docSnap.id}`] = data;
                });

                updateStats(total, active, expired);

            } catch(e) {
                console.error(e);
                loading.innerText = "è®€å–å¤±æ•—: " + e.message;
            }
        }

        function updateStats(t, a, e) {
            document.getElementById('totalCount').innerText = t;
            document.getElementById('activeCount').innerText = a;
            document.getElementById('expiredCount').innerText = e;
        }

        // ğŸ—‘ï¸ å¼·åˆ¶åˆªé™¤é‚è¼¯
        async function deleteTransfer(id) {
            if(!confirm("âš ï¸ è­¦å‘Šï¼šç¢ºå®šè¦å¼·åˆ¶åˆªé™¤æ­¤å‚³è¼¸ç´€éŒ„ï¼Ÿ\né›²ç«¯ä¸Šçš„æ‰€æœ‰æª”æ¡ˆå°‡è¢«æ°¸ä¹…ç§»é™¤ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚")) return;
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> éŠ·æ¯€ä¸­...';
            btn.disabled = true;

            const data = window[`data_${id}`];
            if(!data) {
                alert("è³‡æ–™è®€å–éŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
                return;
            }

            try {
                // 1. åˆªé™¤ Storage æª”æ¡ˆ
                if(data.files && data.files.length > 0) {
                    // æ–°ç‰ˆå¤šæª”çµæ§‹
                    for(const f of data.files) {
                        const r = ref(storage, f.path);
                        await deleteObject(r).catch(e => console.warn("File gone or path error", e));
                    }
                } else if (data.storagePath) { 
                    // èˆŠç‰ˆå–®æª”çµæ§‹
                    const r = ref(storage, data.storagePath);
                    await deleteObject(r).catch(e => console.warn("File gone", e));
                }

                // 2. åˆªé™¤ Firestore æ–‡ä»¶
                await deleteDoc(doc(db, "temp_shares", id));
                
                alert("ç›®æ¨™å·²ç¢ºèªéŠ·æ¯€ã€‚");
                loadData(); // é‡æ–°æ•´ç†åˆ—è¡¨

            } catch(e) {
                console.error(e);
                alert("åˆªé™¤å¤±æ•—: " + e.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // å•Ÿå‹•
        loadData();
    </script>
</body>
</html>