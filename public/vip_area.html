<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿå“¡å€ - ç‰éœ²å¯¶åº«</title>
    
    <script src="theme.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        :root {
            /* ğŸ¨ æ˜Ÿéš›å¥¢è¯é…è‰² */
            --main-gold: #FFD700;       
            --accent-amber: #FDB931;    
            --deep-space: #0f172a;      
            --nebula-blue: #00f3ff;     
            --danger-red: #ff4757;      
            --neon-green: #00ff9d;
            
            /* ç»ç’ƒæ“¬æ…‹ */
            --glass-bg: rgba(15, 23, 42, 0.65); 
            --glass-border: rgba(255, 255, 255, 0.1);
            --card-hover-bg: rgba(30, 41, 59, 0.8);
        }

        body {
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            color: #e2e8f0;
            font-family: 'Microsoft JhengHei', sans-serif;
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            margin: 0; opacity: 0; transition: opacity 0.5s;
            padding-bottom: 80px;
            position: relative;
            overflow-x: hidden;
            cursor: default;
        }

        /* --- èƒŒæ™¯ç‰¹æ•ˆ --- */
        .space-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .star-field { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background-repeat: repeat; opacity: 0.5; animation-timing-function: linear; animation-iteration-count: infinite; }
        .stars-distant { background-image: radial-gradient(1px 1px at 10% 15%, #fff, transparent), radial-gradient(1px 1px at 30% 60%, #ddd, transparent), radial-gradient(1px 1px at 70% 20%, #eee, transparent); background-size: 300px 300px; animation-name: rotateSpace; animation-duration: 240s; }
        .stars-mid { background-image: radial-gradient(1.5px 1.5px at 25% 10%, #fff, transparent), radial-gradient(1.5px 1.5px at 60% 35%, #eef, transparent); background-size: 400px 400px; opacity: 0.6; animation-name: rotateSpace; animation-duration: 180s; animation-direction: reverse; }
        .gold-twinklers { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: radial-gradient(2px 2px at 20% 30%, var(--main-gold), transparent), radial-gradient(3px 3px at 65% 25%, #fff59d, transparent); background-size: 100% 100%; opacity: 0; animation: occasionalFlash 12s ease-in-out infinite; }
        @keyframes rotateSpace { from { transform: rotate(0deg) translateZ(0); } to { transform: rotate(360deg) translateZ(0); } }
        @keyframes occasionalFlash { 0%, 40%, 100% { opacity: 0; } 55% { opacity: 1; filter: brightness(2) blur(1px); } 85% { opacity: 0; } }

        /* æµæ˜Ÿ */
        .meteor { position: absolute; top: 50%; left: 50%; height: 2px; background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,1) 50%, rgba(255,215,0,1) 100%); opacity: 0; transform: rotate(-45deg); animation: meteor-fall 3s linear infinite; filter: drop-shadow(0 0 5px var(--main-gold)); pointer-events: none; z-index: -1; }
        .meteor::before { content: ''; position: absolute; top: 50%; transform: translateY(-50%); width: 4px; height: 4px; border-radius: 50%; background: #fff; box-shadow: 0 0 10px #fff, 0 0 20px var(--main-gold); }
        @keyframes meteor-fall { 0% { opacity: 0; transform: rotate(-45deg) translateX(200px); } 10% { opacity: 1; } 20% { opacity: 0; transform: rotate(-45deg) translateX(-800px); } 100% { opacity: 0; } }

        /* æ»‘é¼ æ‹–å°¾ */
        .trail-particle { position: absolute; width: 6px; height: 6px; background: var(--main-gold); border-radius: 50%; pointer-events: none; transform: translate(-50%, -50%); z-index: 9999; box-shadow: 0 0 10px var(--main-gold); animation: particle-fade 0.8s ease-out forwards; }
        @keyframes particle-fade { 0% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(0) translateY(20px); } }

        /* --- é ‚éƒ¨å€åŸŸ --- */
        .logout-btn { position: absolute; top: 20px; right: 20px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255,255,255,0.2); color: #94a3b8; padding: 8px 15px; border-radius: 20px; cursor: pointer; transition: 0.3s; z-index: 20; display: flex; align-items: center; gap: 8px; backdrop-filter: blur(5px); font-size: 0.9rem; }
        .logout-btn:hover { background: var(--danger-red); border-color: var(--danger-red); color: #fff; box-shadow: 0 0 15px rgba(255, 71, 87, 0.4); }

        .header { text-align: center; margin-top: 60px; margin-bottom: 40px; position: relative; z-index: 2; }
        h1 { font-size: 3.5rem; margin: 0 0 15px 0; letter-spacing: 5px; font-weight: 900; background: linear-gradient(to bottom, #fff 0%, var(--main-gold) 100%); -webkit-background-clip: text; color: transparent; filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.4)); }
        
        .user-greeting { color: #94a3b8; font-size: 1.1rem; letter-spacing: 2px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--main-gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); background: #000; }
        .user-id { color: var(--main-gold); font-weight: bold; font-size: 1.3rem; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }

        .stars-badge { background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(253, 185, 49, 0.1)); border: 1px solid var(--accent-amber); color: var(--main-gold); padding: 8px 20px; border-radius: 30px; margin-top: 20px; display: inline-flex; align-items: center; gap: 10px; font-weight: bold; font-size: 1.2rem; box-shadow: 0 0 20px rgba(255, 215, 0, 0.15); cursor: pointer; transition: 0.3s; text-decoration: none; }
        .stars-badge:hover { transform: translateY(-2px); box-shadow: 0 0 30px rgba(255, 215, 0, 0.3); background: rgba(255, 215, 0, 0.2); }
        .stars-badge i { animation: rotateStar 4s infinite linear; }
        @keyframes rotateStar { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }

        /* --- ç¶²æ ¼ä½ˆå±€ --- */
        .secret-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; width: 90%; max-width: 1100px; position: relative; z-index: 2; }

        /* --- å¡ç‰‡æ¨£å¼ --- */
        .secret-card { background: var(--glass-bg); border: 1px solid var(--glass-border); padding: 30px; border-radius: 20px; text-decoration: none; color: #fff; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; text-align: center; backdrop-filter: blur(12px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .secret-card:hover { transform: translateY(-8px); background: var(--card-hover-bg); border-color: var(--main-gold); box-shadow: 0 15px 40px rgba(0,0,0,0.5), inset 0 0 20px rgba(255, 215, 0, 0.05); }
        .secret-card i { font-size: 3rem; margin-bottom: 20px; transition: 0.4s; filter: drop-shadow(0 0 10px rgba(255,255,255,0.1)); color: #cbd5e1; }
        .secret-card:hover i { transform: scale(1.1) rotate(5deg); color: var(--main-gold) !important; filter: drop-shadow(0 0 15px var(--main-gold)); }
        .secret-card h3 { margin: 0 0 10px 0; font-size: 1.4rem; letter-spacing: 1px; color: #fff; transition: 0.3s; }
        .secret-card:hover h3 { color: var(--main-gold); }
        .secret-card p { color: #94a3b8; font-size: 0.95rem; margin: 0; line-height: 1.6; }
        .tag { position: absolute; top: 15px; right: 15px; font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; font-weight: bold; color: #000; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }

        .card-vegas { border-bottom: 3px solid var(--main-gold); }
        .card-vegas i { color: var(--main-gold); }
        .card-admin { border-bottom: 3px solid var(--danger-red); }
        .card-shop { border-bottom: 3px solid var(--accent-amber); }
        .card-files { border-bottom: 3px solid var(--nebula-blue); }
        .card-checkin { border-bottom: 3px solid var(--neon-green); }
        .card-checkin i { color: var(--neon-green); }
        
        /* ğŸ”¥ 3D æ¨¡å‹å¡ç‰‡é¡è‰² */
        .card-3d { border-bottom: 3px solid #d946ef; } 
        .card-3d i { color: #d946ef; }

        .admin-divider { grid-column: 1 / -1; margin-top: 40px; margin-bottom: 20px; display: flex; align-items: center; gap: 20px; color: var(--danger-red); font-weight: bold; letter-spacing: 3px; font-size: 1.2rem; text-shadow: 0 0 10px rgba(255, 71, 87, 0.3); }
        .admin-divider::before, .admin-divider::after { content: ''; flex: 1; height: 1px; background: linear-gradient(90deg, transparent, var(--danger-red), transparent); opacity: 0.5; }
        .admin-hidden { display: none !important; }

        /* --- ğŸ“… ç°½åˆ° Modal --- */
        .checkin-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(10px);
        }
        .checkin-box {
            background: #0f172a; border: 1px solid var(--main-gold); padding: 30px;
            border-radius: 24px; width: 90%; max-width: 500px; color: #fff;
            box-shadow: 0 0 60px rgba(255, 215, 0, 0.2); text-align: center;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }
        @keyframes popIn { from{transform:scale(0.8); opacity:0;} to{transform:scale(1); opacity:1;} }

        .checkin-steps {
            display: flex; justify-content: space-between; gap: 5px; margin: 25px 0;
            position: relative;
        }
        /* é€²åº¦æ¢é€£ç·š */
        .checkin-steps::before {
            content: ''; position: absolute; top: 35%; left: 0; width: 100%; height: 2px;
            background: rgba(255,255,255,0.1); z-index: 0;
        }

        .step-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; z-index: 1;
            opacity: 0.5; transition: 0.3s;
        }
        .step-circle {
            width: 35px; height: 35px; border-radius: 50%; background: #1e293b; border: 2px solid #64748b;
            display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem;
            color: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .step-reward { font-size: 0.7rem; color: var(--main-gold); }
        .step-label { font-size: 0.7rem; color: #94a3b8; }
        
        /* å·²ç°½åˆ°æ¨£å¼ */
        .step-item.active { opacity: 1; }
        .step-item.active .step-circle { background: var(--main-gold); border-color: #fff; color: #000; box-shadow: 0 0 15px var(--main-gold); }
        
        /* å·¨å¤§çå‹µ */
        .step-item.grand .step-circle { width: 45px; height: 45px; border-color: var(--nebula-purple); }
        .step-item.grand.active .step-circle { background: var(--nebula-purple); box-shadow: 0 0 20px var(--nebula-purple); color: #fff; }

        .btn-checkin {
            background: linear-gradient(135deg, var(--neon-green), #059669);
            color: #000; border: none; padding: 12px 40px; border-radius: 50px;
            font-size: 1.1rem; font-weight: 900; cursor: pointer; margin-top: 15px;
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.4); width: 100%;
        }
        .btn-checkin:disabled { background: #334155; color: #64748b; cursor: not-allowed; box-shadow: none; }

    </style>
</head>
<body>

    <div id="meteorContainer" class="space-container"></div>
    <div class="space-container">
        <div class="star-field stars-distant"></div>
        <div class="star-field stars-mid"></div>
        <div class="gold-twinklers"></div>
    </div>

    <button class="logout-btn" onclick="handleLogout()">
        <i class="fa-solid fa-right-from-bracket"></i> ç™»å‡ºç³»çµ±
    </button>

    <div class="header">
        <h1>æ˜Ÿå“¡å€</h1>
        <div class="user-greeting">
            <img src="" id="header-avatar" class="user-avatar" style="display:none">
            <span id="current-user" class="user-id">---</span>
        </div>
        <a href="point_history.html" class="stars-badge">
            <i class="fa-solid fa-star"></i>
            <span id="star-count">...</span> 
        </a>
    </div>

    <div class="secret-grid">
        
        <div onclick="openCheckIn()" class="secret-card card-checkin" style="cursor:pointer;">
            <i class="fa-solid fa-calendar-check"></i>
            <h3>æ¯æ—¥ç°½åˆ°</h3>
            <p>ç´¯ç©ç™»å…¥é ˜å–æ›´å¤šæ˜Ÿæ˜Ÿ</p>
        </div>

        <a href="profile.html" class="secret-card">
            <i class="fa-solid fa-user-pen"></i>
            <h3>å€‹äººè¨­å®š</h3>
            <p>æ›´æ”¹ç”¨æˆ¶åç¨±åŠé ­åƒ</p>
        </a>

        <a href="shop.html" class="secret-card card-shop">
            <i class="fa-solid fa-gift" style="color: var(--accent-amber);"></i>
            <h3>æ˜Ÿæ˜Ÿå…Œæ›</h3>
            <p>åˆ©ç”¨æ˜Ÿæ˜Ÿå…Œæ›çå“</p>
        </a>

        <a href="point_history.html" class="secret-card">
            <i class="fa-solid fa-file-invoice-dollar" style="color: #4ade80;"></i>
            <h3>æ˜Ÿå­˜æ‘º</h3>
            <p>æŸ¥çœ‹é»æ•¸é…ç™¼èˆ‡æ¶ˆè€—ç´€éŒ„ã€‚</p>
        </a>

        <a href="casino.html" class="secret-card card-vegas">
            <i class="fa-solid fa-dice" style="text-shadow: 0 0 15px var(--main-gold);"></i>
            <h3>æ˜Ÿç¶­åŠ æ–¯</h3>
            <p>ä»¥å°åšå¤§ï¼Œè·é›¢ç™¼è²¡åªæœ‰ä¸€æ­¥</p>
        </a>

        <a href="stl_gallery.html" class="secret-card card-3d">
            <span class="tag" style="background: #d946ef; color:#fff;">3D</span>
            <i class="fa-solid fa-cubes"></i>
            <h3>3Dæ¨¡å‹åº«</h3>
            <p>ä¸Šå‚³ã€åˆ†äº«èˆ‡é è¦½ STL æ¨¡å‹</p>
        </a>

        <a href="temp_share.html" class="secret-card card-files">
            <i class="fa-solid fa-cloud-arrow-up" style="color: var(--nebula-blue);"></i>
            <h3>è³‡æ–™å‚³è¼¸</h3>
            <p>é™æ™‚åŠ å¯†è³‡æ–™å‚³è¼¸åŠŸèƒ½</p>
        </a>

        <a href="whiteboard_lobby.html" class="secret-card">
            <span class="tag" style="background: var(--nebula-blue);">LIVE</span>
            <i class="fa-solid fa-paintbrush"></i>
            <h3>æ˜Ÿç©ºç¹ªåœ–æ¿</h3>
            <p>å¤šäººå¯¦æ™‚æœƒç•«åŠŸèƒ½</p>
        </a>

        <a href="upload_zone.html" class="secret-card">
            <i class="fa-solid fa-image"></i>
            <h3>åœ–ç‰‡å‚³è¼¸å™¨</h3>
            <p>å£“ç¸®åœ–ç‰‡ï¼Œæä¾›æš«å­˜èˆ‡åœ–åº«åŠŸèƒ½</p>
        </a>

        <a href="chat.html" class="secret-card">
            <i class="fa-solid fa-satellite-dish" style="color: #60a5fa;"></i>
            <h3>æ˜Ÿå“¡é€šè¨Šå®¤</h3>
            <p>åŠ å¯†é€£ç·šèˆ‡ç¾¤çµ„é€šè¨Š</p>
        </a>

        <a href="bulletin.html" class="secret-card">
            <i class="fa-solid fa-scroll" style="color: #FDB931;"></i>
            <h3>æ˜Ÿå“¡å…¬å‘Šæ¬„</h3>
            <p>ç³»çµ±å…¬å‘Šèˆ‡è¨±é¡˜æ± </p>
        </a>
        
        <div class="admin-divider admin-hidden"><i class="fa-solid fa-user-shield"></i> ç®¡ç†å“¡å¾Œå°</div>

        <a href="admin_members.html" class="secret-card card-admin admin-hidden">
            <span class="tag" style="background: var(--main-gold);">ADMIN</span>
            <i class="fa-solid fa-users-gear"></i>
            <h3>æ˜Ÿå“¡æª”æ¡ˆåº«</h3>
            <p>æŸ¥çœ‹æœƒå“¡åˆ—è¡¨èˆ‡èª¿æ•´é»æ•¸ã€‚</p>
        </a>

        <a href="admin_shop.html" class="secret-card card-admin admin-hidden">
            <span class="tag" style="background: var(--main-gold);">ADMIN</span>
            <i class="fa-solid fa-warehouse"></i>
            <h3>æ˜Ÿæ˜Ÿå…Œæ›å€‰åº«</h3>
            <p>ä¸Šæ¶çå“èˆ‡æŸ¥çœ‹å…Œæ›ç´€éŒ„ã€‚</p>
        </a>

        <a href="admin_invite.html" class="secret-card card-admin admin-hidden">
            <span class="tag" style="background: var(--nebula-blue);">ADMIN</span>
            <i class="fa-solid fa-ticket"></i>
            <h3>é‚€è«‹ä¸­å¿ƒ</h3>
            <p>ç”Ÿæˆèˆ‡ç®¡ç†å…¥éšŠé‚€è«‹ç¢¼ã€‚</p>
        </a>

        <a href="admin_transfers.html" class="secret-card card-admin admin-hidden">
            <span class="tag" style="background: var(--danger-red);">ADMIN</span>
            <i class="fa-solid fa-network-wired"></i>
            <h3>æ–‡ä»¶å‚³è¼¸ç®¡ç†å“¡</h3>
            <p>å¼·åˆ¶ç®¡ç†èˆ‡éŠ·æ¯€æ‰€æœ‰å‚³è¼¸æª”æ¡ˆã€‚</p>
        </a>

        <a href="admin_system.html" class="secret-card card-admin admin-hidden">
            <span class="tag" style="background: #a855f7;">ADMIN</span>
            <i class="fa-solid fa-sliders"></i>
            <h3>æ˜Ÿéš›ç³»çµ±ä¸­æ¨</h3>
            <p>å…¨ç«™åŠŸèƒ½é–‹é—œèˆ‡ç³»çµ±ç¶­è­·è¨­å®šã€‚</p>
        </a>

        <a href="index.html" class="secret-card" style="border-color: rgba(255,255,255,0.1);">
            <i class="fa-solid fa-house" style="color: #64748b;"></i>
            <h3>è¿”å›è¡¨å±¤</h3>
            <p>å›åˆ°ä¸€èˆ¬ä½¿ç”¨è€…çš„é¦–é ã€‚</p>
        </a>
    </div>

    <div id="checkinModal" class="checkin-overlay" onclick="closeCheckIn(event)">
        <div class="checkin-box">
            <h2 style="color:var(--main-gold); margin:0 0 10px 0;">æ¯æ—¥ç°½åˆ°ç°¿</h2>
            <p style="color:#94a3b8; font-size:0.9rem;">é€£çºŒç™»å…¥ 7 å¤©å¯ç²å¾—å¤§çï¼</p>
            
            <div class="checkin-steps" id="checkinSteps">
                </div>

            <button id="btnCheckIn" class="btn-checkin" onclick="performCheckIn()">ç«‹å³ç°½åˆ°</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, runTransaction, serverTimestamp, collection } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAo6on0f2QUbPaRfxpIEb2uvhKxDvPUvs",
            authDomain: "yulubox.firebaseapp.com",
            projectId: "yulubox",
            storageBucket: "yulubox.firebasestorage.app",
            messagingSenderId: "256466567852",
            appId: "1:256466567852:web:233b74668908ffcb9b9509",
            measurementId: "G-YPCY41EKWX"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        const DEFAULT_STAR_AVATAR = "https://cdn-icons-png.flaticon.com/512/1828/1828884.png";
        
        // ç°½åˆ°çå‹µè¨­å®š
        const CHECKIN_REWARDS = [10, 20, 30, 40, 50, 60, 100];

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.body.style.opacity = "1";
                const name = user.displayName || user.email.split('@')[0];
                document.getElementById('current-user').innerText = name;

                const avatar = document.getElementById('header-avatar');
                avatar.src = user.photoURL || DEFAULT_STAR_AVATAR;
                avatar.style.display = 'block';

                await loadUserData();
                checkAutoPopUp(); // ğŸ”¥ æª¢æŸ¥æ˜¯å¦è‡ªå‹•å½ˆå‡ºç°½åˆ°
            } else {
                window.location.href = "login.html";
            }
        });

        async function loadUserData() {
            try {
                const docSnap = await getDoc(doc(db, "users", currentUser.uid));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('star-count').innerText = data.stars !== undefined ? data.stars : 0;

                    if (data.themeColor) {
                        const userIdEl = document.querySelector('.user-id');
                        const userAvatarEl = document.querySelector('.user-avatar');
                        userIdEl.style.color = data.themeColor;
                        userIdEl.style.textShadow = `0 0 10px ${data.themeColor}`;
                        userAvatarEl.style.borderColor = data.themeColor;
                        userAvatarEl.style.boxShadow = `0 0 10px ${data.themeColor}`;
                    }
                    if (data.role === 'admin') {
                        document.querySelectorAll('.admin-hidden').forEach(el => el.classList.remove('admin-hidden'));
                    }
                }
            } catch(e) { console.log("Profile load error", e); }
        }

        // --- ğŸ“… ç°½åˆ°é‚è¼¯ (ç¶å®šåˆ° window ä»¥ä¾› onclick å‘¼å«) ---
        window.openCheckIn = async () => {
            const modal = document.getElementById('checkinModal');
            modal.style.display = 'flex';
            await renderCheckInUI();
        };

        window.closeCheckIn = (e) => {
            if(e.target.id === 'checkinModal') {
                document.getElementById('checkinModal').style.display = 'none';
            }
        };

        async function checkAutoPopUp() {
            const docSnap = await getDoc(doc(db, "users", currentUser.uid));
            if(!docSnap.exists()) return;
            const data = docSnap.data();
            const lastDate = data.lastCheckInDate || ""; // "YYYY-MM-DD"
            const today = new Date().toISOString().split('T')[0];
            
            if (lastDate !== today) {
                openCheckIn();
            }
        }

        async function renderCheckInUI() {
            const stepsContainer = document.getElementById('checkinSteps');
            const btn = document.getElementById('btnCheckIn');
            stepsContainer.innerHTML = '<div style="color:#aaa;">è®€å–ä¸­...</div>';
            
            const docSnap = await getDoc(doc(db, "users", currentUser.uid));
            if (!docSnap.exists()) return;
            const data = docSnap.data();

            const today = new Date().toISOString().split('T')[0];
            const lastDate = data.lastCheckInDate || "";
            let streak = data.checkInStreak || 0;

            // åˆ¤æ–·æ˜¯å¦æ–·ç°½ (æ˜¨å¤©çš„æ—¥æœŸ)
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            if (lastDate !== today && lastDate !== yesterdayStr) {
                streak = 0; // æ–·ç°½é‡ç½®
            }

            const isSignedToday = (lastDate === today);
            
            // ç”¢ç”Ÿ UI
            stepsContainer.innerHTML = '';
            for(let i=0; i<7; i++) {
                const dayNum = i + 1;
                let isActive = false;
                if (isSignedToday) {
                    if (i < streak) isActive = true;
                } else {
                    if (i < streak) isActive = true; 
                }

                let isPending = (!isSignedToday && i === streak);
                const isGrand = (i === 6);
                const reward = CHECKIN_REWARDS[i];
                
                const html = `
                    <div class="step-item ${isActive ? 'active' : ''} ${isGrand ? 'grand' : ''}" style="${isPending ? 'opacity:1; transform:scale(1.1);' : ''}">
                        <div class="step-circle">${isGrand ? '<i class="fa-solid fa-gift"></i>' : `+${reward}`}</div>
                        <div class="step-label">Day ${dayNum}</div>
                    </div>
                `;
                stepsContainer.innerHTML += html;
            }

            if (isSignedToday) {
                btn.innerText = "ä»Šæ—¥å·²ç°½åˆ°";
                btn.disabled = true;
            } else {
                btn.innerText = `é ˜å– Day ${streak + 1} çå‹µ`;
                btn.disabled = false;
            }
        }

        window.performCheckIn = async () => {
            const btn = document.getElementById('btnCheckIn');
            btn.disabled = true;
            btn.innerText = "è™•ç†ä¸­...";

            try {
                const userRef = doc(db, "users", currentUser.uid);
                const today = new Date().toISOString().split('T')[0];
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];

                await runTransaction(db, async (t) => {
                    const docSnap = await t.get(userRef);
                    if (!docSnap.exists()) throw "User not found";
                    const data = docSnap.data();
                    
                    const lastDate = data.lastCheckInDate || "";
                    if (lastDate === today) throw "Checked In";

                    let streak = data.checkInStreak || 0;
                    if (lastDate !== yesterdayStr) {
                        streak = 0;
                    }

                    const currentReward = CHECKIN_REWARDS[streak % 7];
                    const newStars = (data.stars || 0) + currentReward;
                    let nextStreak = streak + 1;
                    if (nextStreak > 7) nextStreak = 1; // æ»¿7å¤©å¾Œé‡ç½®å› Day 1

                    t.update(userRef, {
                        stars: newStars,
                        lastCheckInDate: today,
                        checkInStreak: nextStreak
                    });

                    t.set(doc(collection(db, "transactions")), {
                        userId: currentUser.uid,
                        action: "daily_checkin",
                        amount: currentReward,
                        desc: `Day ${streak + 1} ç°½åˆ°çå‹µ`,
                        timestamp: serverTimestamp()
                    });
                });

                alert("ç°½åˆ°æˆåŠŸï¼");
                await loadUserData();
                renderCheckInUI();
                
            } catch (e) {
                console.error(e);
                if (e === "Checked In") {
                    alert("ä»Šæ—¥å·²ç°½åˆ°é");
                    renderCheckInUI();
                } else {
                    alert("ç°½åˆ°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
                    btn.disabled = false;
                    btn.innerText = "ç«‹å³ç°½åˆ°";
                }
            }
        };

        // ğŸ”¥ æµæ˜Ÿç”¢ç”Ÿ
        function initMeteors() {
            setInterval(() => {
                const meteor = document.createElement('div');
                meteor.className = 'meteor';
                meteor.style.top = Math.random() * 50 + '%';
                meteor.style.left = Math.random() * 80 + 20 + '%';
                meteor.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(meteor);
                setTimeout(() => meteor.remove(), 4000);
            }, 3000);
        }
        initMeteors();

        // ğŸ”¥ æ»‘é¼ æ‹–å°¾
        document.addEventListener('mousemove', (e) => {
            if(Math.random() > 0.5) return;
            const star = document.createElement('div');
            star.className = 'trail-particle';
            star.style.left = e.pageX + 'px';
            star.style.top = e.pageY + 'px';
            document.body.appendChild(star);
            setTimeout(() => star.remove(), 800);
        });

        window.handleLogout = function() {
            signOut(auth).then(() => {
                window.location.href = 'index.html';
            }).catch((error) => { console.error(error); });
        }
    </script>
</body>
</html>