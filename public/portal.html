<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>網址傳送門</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --main-gold: #FFD700;
            --nebula-blue: #00f3ff;
            --bg-dark: #050510;
            --glass-panel: rgba(20, 20, 35, 0.7);
            --border-light: rgba(255, 255, 255, 0.1);
            --neon-purple: #bc13fe;
        }

        body {
            background-color: var(--bg-dark);
            color: #fff;
            font-family: 'Microsoft JhengHei', sans-serif;
            min-height: 100vh; margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden;
        }

        /* --- ✨ 星空背景 --- */
        .stars-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; pointer-events: none; background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%); }
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0.8; animation: twinkle 3s infinite ease-in-out; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }

        /* --- UI 元件 --- */
        .header {
            width: 100%; padding: 15px 20px;
            background: rgba(5, 5, 16, 0.8); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-light);
            display: flex; justify-content: space-between; align-items: center;
            box-sizing: border-box; position: sticky; top: 0; z-index: 50;
        }
        .back-btn { color: var(--nebula-blue); text-decoration: none; font-weight: bold; display: flex; align-items: center; gap: 8px; transition: 0.3s; }
        
        .container { width: 90%; max-width: 800px; margin: 40px 0 60px; display: flex; flex-direction: column; gap: 40px; }
        
        .page-title { text-align: center; }
        .page-title h1 { margin: 0; font-size: 2.5rem; background: linear-gradient(to right, #fff, var(--nebula-blue)); -webkit-background-clip: text; color: transparent; text-shadow: 0 0 20px rgba(0, 243, 255, 0.3); }

        .glass-card {
            background: var(--glass-panel); border: 1px solid var(--border-light);
            border-radius: 20px; padding: 30px; backdrop-filter: blur(12px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* --- 接收端 (User) --- */
        .access-zone { text-align: center; }
        .input-group { position: relative; max-width: 400px; margin: 0 auto; }
        .code-input {
            width: 100%; padding: 15px 20px; font-size: 1.2rem; text-align: center;
            background: rgba(0,0,0,0.3); border: 2px solid var(--border-light); border-radius: 50px;
            color: #fff; outline: none; transition: 0.3s;
        }
        .code-input:focus { border-color: var(--nebula-blue); box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); }

        .btn-retrieve {
            margin-top: 20px; padding: 12px 40px; border-radius: 50px; border: none;
            background: linear-gradient(135deg, var(--nebula-blue), var(--neon-purple));
            color: #fff; font-size: 1.1rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 5px 15px rgba(188, 19, 254, 0.3); transition: 0.3s;
        }
        .btn-retrieve:hover { transform: translateY(-3px); }

        /* 結果列表 */
        #result-list { display: none; margin-top: 30px; flex-direction: column; gap: 15px; animation: slideDown 0.5s ease; }
        @keyframes slideDown { from {opacity:0; transform:translateY(-20px);} to {opacity:1; transform:translateY(0);} }

        .result-item {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px; padding: 20px; text-align: left;
            display: flex; flex-direction: column; gap: 10px;
        }
        .item-note { font-size: 1.1rem; font-weight: bold; color: var(--main-gold); display: flex; align-items: center; gap: 8px; }
        .item-url { font-size: 0.9rem; color: #aaa; word-break: break-all; font-family: monospace; }
        
        .item-actions { display: flex; gap: 10px; margin-top: 5px; }
        .action-btn {
            flex: 1; padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);
            background: transparent; color: #fff; cursor: pointer; text-decoration: none;
            display: flex; justify-content: center; align-items: center; gap: 5px; font-size: 0.9rem; transition: 0.2s;
        }
        .action-btn:hover { background: rgba(255,255,255,0.1); }
        .btn-go { background: var(--nebula-blue); color: #000; border-color: var(--nebula-blue); font-weight: bold; }
        .btn-go:hover { background: #fff; }

        .qr-area { display: none; justify-content: center; padding: 15px; background: #fff; border-radius: 10px; margin-top: 10px; width: fit-content; align-self: center; }

        /* --- 管理端 (Admin) --- */
        #admin-panel { display: none; border: 1px solid var(--main-gold); }
        .admin-header { display: flex; align-items: center; gap: 10px; color: var(--main-gold); margin-bottom: 20px; font-size: 1.2rem; font-weight: bold; }

        .creation-area { display: flex; flex-direction: column; gap: 15px; background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; }
        .form-row { display: flex; gap: 10px; }
        .admin-input { flex: 1; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid #444; color: #fff; border-radius: 5px; }
        
        .btn-add-item { background: var(--nebula-blue); color: #000; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-final-upload { width: 100%; background: var(--main-gold); color: #000; border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1rem; margin-top: 10px; }

        .pending-list { margin-top: 15px; display: flex; flex-direction: column; gap: 5px; }
        .pending-item { background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }

        /* 現有列表 */
        .portal-list { max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; margin-top: 20px; border-top: 1px solid #444; padding-top: 20px; }
        .portal-item-admin { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; position: relative; }
        .portal-pw-tag { display: inline-block; background: var(--main-gold); color: #000; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; margin-bottom: 5px; }

        @media (max-width: 600px) {
            .form-row { flex-direction: column; }
        }
    </style>
</head>
<body>

    <div class="stars-bg" id="starsBg"></div>

    <div class="header">
        <a href="index.html" class="back-btn"><i class="fa-solid fa-chevron-left"></i> 返回大廳</a>
        <div style="font-size:0.9rem; color:#aaa;">SYSTEM: ONLINE</div>
    </div>

    <div class="container">
        
        <div class="page-title">
            <h1>網址傳送門</h1>
            <p>SECURE MULTI-LINK PORTAL</p>
        </div>

        <div class="glass-card access-zone">
            <h3 style="color:var(--nebula-blue); margin-bottom:20px;"><i class="fa-solid fa-key"></i> 提取資源</h3>
            <p style="color:#aaa; margin-bottom:30px;">請輸入傳送密碼 (通關密語)</p>
            
            <div class="input-group">
                <input type="text" id="accessCode" class="code-input" placeholder="例如：領取簡報" autocomplete="off">
            </div>
            
            <button class="btn-retrieve" onclick="retrievePortal()">
                <i class="fa-solid fa-rocket"></i> 開啟傳送門
            </button>

            <div id="result-list"></div>
        </div>

        <div class="glass-card" id="admin-panel">
            <div class="admin-header">
                <i class="fa-solid fa-user-shield"></i> 指揮官控制台
            </div>

            <div class="creation-area">
                <h4 style="margin:0 0 10px 0; color:#ddd;">1. 設定傳送密碼</h4>
                <input type="text" id="newPassword" class="admin-input" placeholder="密碼可以是中文、英文或數字 (例如: 秘密計畫A)">

                <h4 style="margin:15px 0 10px 0; color:#ddd;">2. 添加網址項目</h4>
                <div class="form-row">
                    <input type="text" id="itemNote" class="admin-input" placeholder="文字註記 (例如: 下載連結)">
                    <input type="text" id="itemUrl" class="admin-input" placeholder="https://..." style="flex:2;">
                    <button class="btn-add-item" onclick="addPendingItem()"><i class="fa-solid fa-plus"></i></button>
                </div>

                <div id="pendingList" class="pending-list"></div>

                <button class="btn-final-upload" onclick="uploadPortal()">
                    <i class="fa-solid fa-cloud-arrow-up"></i> 建立傳送門
                </button>
            </div>

            <h4 style="color:#888; margin-top:30px;">現有運作中的傳送門</h4>
            <div class="portal-list" id="portalList">
                <div style="text-align:center; padding:20px; color:#666;">載入中...</div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAAo6on0f2QUbPaRfxpIEb2uvhKxDvPUvs",
            authDomain: "yulubox.firebaseapp.com",
            projectId: "yulubox",
            storageBucket: "yulubox.firebasestorage.app",
            messagingSenderId: "256466567852",
            appId: "1:256466567852:web:233b74668908ffcb9b9509",
            measurementId: "G-YPCY41EKWX"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const portalsRef = collection(db, "portals");

        // 本地暫存的待上傳項目
        let pendingItems = [];

        // 1. 權限檢查
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDocs(query(collection(db, "users"), where("email", "==", user.email)));
                let isAdmin = false;
                userDoc.forEach(d => { if(d.data().role === 'admin') isAdmin = true; });
                if (isAdmin) {
                    document.getElementById('admin-panel').style.display = 'block';
                    loadAdminPortals();
                }
            }
        });

        // ================= 使用者邏輯 =================

        window.retrievePortal = async () => {
            const code = document.getElementById('accessCode').value.trim();
            const listDiv = document.getElementById('result-list');
            
            if (!code) { alert("請輸入密碼！"); return; }
            listDiv.style.display = 'none';
            listDiv.innerHTML = '';

            try {
                const q = query(portalsRef, where("password", "==", code));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    alert("找不到此密碼的傳送門，請確認輸入是否正確。");
                    return;
                }

                listDiv.style.display = 'flex';
                let found = false;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    // 相容性處理：如果舊資料只有單一 url，轉為陣列顯示
                    let items = data.items || [];
                    if(!data.items && data.url) {
                        items.push({ note: "連結", url: data.url });
                    }

                    items.forEach((item, index) => {
                        const uniqueId = `qr-${doc.id}-${index}`;
                        const div = document.createElement('div');
                        div.className = 'result-item';
                        div.innerHTML = `
                            <div class="item-note">
                                <i class="fa-solid fa-quote-left" style="font-size:0.8rem; opacity:0.5;"></i> 
                                ${item.note || '未命名連結'}
                            </div>
                            <div class="item-url">${item.url}</div>
                            <div class="item-actions">
                                <a href="${item.url}" target="_blank" class="action-btn btn-go">
                                    <i class="fa-solid fa-arrow-up-right-from-square"></i> 開啟
                                </a>
                                <button class="action-btn" onclick="navigator.clipboard.writeText('${item.url}').then(()=>alert('已複製'))">
                                    <i class="fa-regular fa-copy"></i>
                                </button>
                                <button class="action-btn" onclick="toggleQR('${uniqueId}', '${item.url}')">
                                    <i class="fa-solid fa-qrcode"></i> QR
                                </button>
                            </div>
                            <div id="${uniqueId}" class="qr-area"></div>
                        `;
                        listDiv.appendChild(div);
                    });
                    found = true;
                });

            } catch (error) {
                console.error(error);
                alert("讀取失敗，請重試");
            }
        };

        window.toggleQR = (elementId, url) => {
            const el = document.getElementById(elementId);
            if (el.style.display === 'flex') {
                el.style.display = 'none';
            } else {
                el.style.display = 'flex';
                el.innerHTML = ''; // 清空避免重複
                new QRCode(el, {
                    text: url,
                    width: 150, height: 150,
                    colorDark : "#000000", colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
            }
        };

        // ================= 管理員邏輯 =================

        // 暫存清單操作
        window.addPendingItem = () => {
            const note = document.getElementById('itemNote').value.trim();
            const url = document.getElementById('itemUrl').value.trim();
            if(!url) return alert("請至少輸入網址");

            pendingItems.push({ note, url });
            renderPendingList();
            
            // 清空輸入框
            document.getElementById('itemNote').value = '';
            document.getElementById('itemUrl').value = '';
        };

        function renderPendingList() {
            const container = document.getElementById('pendingList');
            container.innerHTML = '';
            pendingItems.forEach((item, idx) => {
                container.innerHTML += `
                    <div class="pending-item">
                        <span><b>${item.note}</b> - ${item.url}</span>
                        <i class="fa-solid fa-xmark" style="cursor:pointer; color:#ff4757;" onclick="removePending(${idx})"></i>
                    </div>
                `;
            });
        }

        window.removePending = (idx) => {
            pendingItems.splice(idx, 1);
            renderPendingList();
        };

        // 上傳到 Firestore
        window.uploadPortal = async () => {
            const pw = document.getElementById('newPassword').value.trim();
            if(!pw) return alert("請設定傳送密碼");
            if(pendingItems.length === 0) return alert("清單中沒有任何項目");

            // 檢查密碼重複
            const check = await getDocs(query(portalsRef, where("password", "==", pw)));
            if(!check.empty) return alert("此密碼已被使用！");

            try {
                await addDoc(portalsRef, {
                    password: pw,
                    items: pendingItems, // 存入陣列
                    createdAt: new Date()
                });
                alert("傳送門建立成功！");
                // 重置
                pendingItems = [];
                renderPendingList();
                document.getElementById('newPassword').value = '';
            } catch(e) {
                alert("上傳失敗: " + e.message);
            }
        };

        // 監聽並顯示現有傳送門
        function loadAdminPortals() {
            onSnapshot(query(portalsRef, orderBy("createdAt", "desc")), (snapshot) => {
                const div = document.getElementById('portalList');
                div.innerHTML = '';
                if(snapshot.empty) { div.innerHTML = '<div style="text-align:center; color:#666;">無資料</div>'; return; }

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const itemsCount = data.items ? data.items.length : 1;
                    
                    div.innerHTML += `
                        <div class="portal-item-admin">
                            <div style="display:flex; justify-content:space-between; align-items:start;">
                                <div>
                                    <span class="portal-pw-tag">${data.password}</span>
                                    <span style="font-size:0.8rem; color:#888; margin-left:10px;">包含 ${itemsCount} 個連結</span>
                                </div>
                                <button onclick="deletePortal('${docSnap.id}')" style="background:none; border:none; color:#ff4757; cursor:pointer;">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                            <div style="margin-top:5px; font-size:0.85rem; color:#aaa;">
                                ${(data.items || []).map(i => `<div>• ${i.note}: ${i.url}</div>`).join('')}
                            </div>
                        </div>
                    `;
                });
            });
        }

        window.deletePortal = async (id) => {
            if(confirm("確定要刪除此傳送門嗎？")) {
                await deleteDoc(doc(db, "portals", id));
            }
        };

        // 星空特效
        (function createStars() {
            const container = document.getElementById('starsBg');
            for(let i=0; i<50; i++) {
                const s = document.createElement('div');
                s.className = 'star';
                s.style.left = Math.random()*100 + '%';
                s.style.top = Math.random()*100 + '%';
                const size = Math.random()*3 + 1;
                s.style.width = size + 'px';
                s.style.height = size + 'px';
                s.style.animationDelay = Math.random()*3 + 's';
                container.appendChild(s);
            }
        })();

    </script>
</body>
</html>