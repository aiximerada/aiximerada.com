<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡æ–™å‚³è¼¸ - ç‰éœ²å¯¶åº«</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* ğŸ¨ æ˜Ÿéš›å¥¢è¯é…è‰² */
            --main-gold: #FFD700;       
            --accent-amber: #FDB931;    
            --deep-space: #0f172a;      
            --nebula-blue: #00f3ff;     
            --danger-red: #ff4757;      
            --success-green: #10b981;
            
            /* ç»ç’ƒæ“¬æ…‹ */
            --glass-bg: rgba(15, 23, 42, 0.75); 
            --glass-border: rgba(255, 255, 255, 0.1);
            --card-radius: 20px;
        }

        body {
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            color: #e2e8f0;
            font-family: 'Microsoft JhengHei', sans-serif;
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            margin: 0; padding-bottom: 50px;
            position: relative; overflow-x: hidden;
        }

        /* --- èƒŒæ™¯æ˜Ÿç©ºå‹•ç•« --- */
        .space-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .star-field { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background-repeat: repeat; opacity: 0.5; animation-timing-function: linear; animation-iteration-count: infinite; }
        .stars-distant {
            background-image: radial-gradient(1px 1px at 10% 15%, #fff, transparent), radial-gradient(1px 1px at 30% 60%, #ddd, transparent), radial-gradient(1px 1px at 70% 20%, #eee, transparent);
            background-size: 300px 300px; animation-name: rotateSpace; animation-duration: 240s;
        }
        .stars-mid {
            background-image: radial-gradient(1.5px 1.5px at 25% 10%, #fff, transparent), radial-gradient(1.5px 1.5px at 60% 35%, #eef, transparent);
            background-size: 400px 400px; opacity: 0.6; animation-name: rotateSpace; animation-duration: 180s; animation-direction: reverse;
        }
        .gold-twinklers {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(2px 2px at 20% 30%, var(--main-gold), transparent), radial-gradient(3px 3px at 65% 25%, #fff59d, transparent);
            background-size: 100% 100%; opacity: 0; animation: occasionalFlash 12s ease-in-out infinite;
        }
        @keyframes rotateSpace { from { transform: rotate(0deg) translateZ(0); } to { transform: rotate(360deg) translateZ(0); } }
        @keyframes occasionalFlash { 0%, 40%, 100% { opacity: 0; } 55% { opacity: 1; filter: brightness(2) blur(1px); } 85% { opacity: 0; } }

        /* --- é ‚éƒ¨å°èˆª --- */
        .header {
            width: 100%; padding: 15px 20px; 
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
            box-sizing: border-box; position: sticky; top: 0; z-index: 100;
        }
        .back-btn { color: #94a3b8; text-decoration: none; font-size: 1rem; display: flex; align-items: center; gap: 5px; transition:0.3s; }
        .back-btn:hover { color: #fff; }
        
        .user-status { 
            font-size: 0.9rem; padding: 5px 12px; border-radius: 20px; 
            background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border);
            color: var(--main-gold); text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        /* --- æ¨™é¡Œ --- */
        .page-title { text-align: center; margin: 40px 0 30px 0; }
        .page-title h1 {
            margin: 0; font-size: 2.8rem; letter-spacing: 5px; font-weight: 900;
            background: linear-gradient(to bottom, #fff 0%, var(--main-gold) 100%);
            -webkit-background-clip: text; color: transparent;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
        }
        .page-title p { color: #64748b; margin-top: 5px; font-size: 1rem; letter-spacing: 3px; text-transform: uppercase; }

        /* --- ä¸»å¡ç‰‡ --- */
        .transfer-card {
            width: 90%; max-width: 600px;
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: var(--card-radius); padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            backdrop-filter: blur(16px);
            animation: slideUp 0.6s cubic-bezier(0.19, 1, 0.22, 1);
            margin-bottom: 50px;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        /* åˆ†é  Tabs */
        .tabs { display: flex; gap: 15px; margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
        .tab { 
            flex: 1; text-align: center; padding: 12px; cursor: pointer; color: #64748b; 
            border-radius: 12px; transition: 0.3s; font-weight: bold; letter-spacing: 1px;
        }
        .tab:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .tab.active { 
            background: linear-gradient(135deg, var(--main-gold), var(--accent-amber)); 
            color: #0f172a; box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
        }

        /* è¡¨å–®å…ƒç´  */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: #94a3b8; font-size: 0.9rem; }
        .form-input, .form-select, textarea { 
            width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.6); 
            border: 1px solid #475569; border-radius: 12px; color: #fff; box-sizing: border-box; 
            font-size: 1rem; transition: 0.3s;
        }
        .form-input:focus, textarea:focus { outline: none; border-color: var(--main-gold); box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); }

        /* æ‹–æ›³å€ */
        .drop-zone { 
            border: 2px dashed #475569; border-radius: 16px; padding: 40px 20px; 
            text-align: center; cursor: pointer; transition: 0.3s; color: #64748b; 
            background: rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .drop-zone:hover { border-color: var(--main-gold); color: #fff; background: rgba(255, 215, 0, 0.05); }
        .drop-zone i { font-size: 2.5rem; margin-bottom: 5px; color: var(--main-gold); }
        
        .file-list { margin-top: 15px; font-size: 0.9rem; color: var(--nebula-blue); text-align: left; background: rgba(0, 243, 255, 0.05); padding: 10px; border-radius: 8px; display: none; }
        .file-list.show { display: block; }

        /* é€²åº¦æ¢ */
        .progress-container { width: 100%; background: #1e293b; border-radius: 10px; height: 8px; margin-top: 20px; overflow: hidden; display: none; }
        .progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--main-gold), var(--accent-amber)); transition: width 0.3s; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        .progress-text { text-align: center; font-size: 0.85rem; margin-top: 8px; color: var(--main-gold); display: none; }

        /* æŒ‰éˆ• */
        .btn-action { 
            width: 100%; padding: 15px; border: none; border-radius: 50px; 
            font-weight: 900; font-size: 1.1rem; cursor: pointer; margin-top: 10px; 
            background: linear-gradient(135deg, var(--main-gold), var(--accent-amber)); 
            color: #0f172a; transition: 0.3s; box-shadow: 0 5px 20px rgba(255, 215, 0, 0.2);
            display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn-action:hover { box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4); transform: translateY(-2px); }
        .btn-action:disabled { background: #475569; color: #94a3b8; cursor: not-allowed; box-shadow: none; transform: none; }
        
        .download-btn { background: linear-gradient(135deg, #10b981, #059669); color: #fff; box-shadow: 0 5px 20px rgba(16, 185, 129, 0.3); }
        .download-btn:hover { box-shadow: 0 10px 30px rgba(16, 185, 129, 0.5); }

        /* çµæœå€ */
        #resultArea { display: none; margin-top: 30px; padding: 30px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 16px; text-align: center; }
        .code-display { font-size: 3rem; font-family: monospace; color: var(--main-gold); margin: 20px 0; letter-spacing: 8px; text-shadow: 0 0 20px rgba(255, 215, 0, 0.5); font-weight: bold; }
        .copy-btn { background: transparent; border: 1px solid var(--main-gold); padding: 8px 20px; border-radius: 30px; color: var(--main-gold); cursor: pointer; transition: 0.3s; }
        .copy-btn:hover { background: var(--main-gold); color: #000; }

        /* æ­·å²ç´€éŒ„ */
        .history-section { margin-top: 40px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 25px; }
        .history-title { font-size: 1rem; color: #94a3b8; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .history-list { display: flex; flex-direction: column; gap: 12px; }
        .history-item { 
            background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(255,255,255,0.05); 
            border-radius: 12px; padding: 15px; display: flex; justify-content: space-between; align-items: center; 
            transition: 0.3s;
        }
        .history-item:hover { border-color: var(--nebula-blue); background: rgba(0, 243, 255, 0.05); }
        
        .h-info { display: flex; flex-direction: column; gap: 4px; }
        .h-code { font-family: monospace; font-size: 1.2rem; color: var(--main-gold); font-weight: bold; }
        .h-date { font-size: 0.85rem; color: #64748b; }
        .h-expire { font-size: 0.85rem; }
        
        .btn-delete { 
            background: rgba(255, 71, 87, 0.1); border: 1px solid var(--danger-red); color: var(--danger-red); 
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            transition: 0.2s;
        }
        .btn-delete:hover { background: var(--danger-red); color: #fff; box-shadow: 0 0 15px rgba(255, 71, 87, 0.4); }

        /* ä¸‹è¼‰åˆ—è¡¨ */
        .download-item { background: rgba(255,255,255,0.05); padding: 12px; margin-bottom: 10px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.1); }
        .dl-link { color: var(--success-green); text-decoration: none; font-weight: bold; border:1px solid var(--success-green); padding:6px 15px; border-radius: 20px; font-size: 0.9rem; transition: 0.3s; }
        .dl-link:hover { background: var(--success-green); color:#000; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }

    </style>
</head>
<body>

    <div class="space-container">
        <div class="star-field stars-distant"></div>
        <div class="star-field stars-mid"></div>
        <div class="gold-twinklers"></div>
    </div>

    <div class="header">
        <a href="vip_area.html" class="back-btn"><i class="fa-solid fa-chevron-left"></i> è¿”å›ç¸½éƒ¨</a>
        <div class="user-status" id="userStatus">é€£ç·šä¸­...</div>
    </div>

    <div class="page-title">
        <h1>è³‡æ–™å‚³è¼¸</h1>
        <p>SECURE DATA LINK</p>
    </div>

    <div class="transfer-card">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('upload')"><i class="fa-solid fa-paper-plane"></i> ç™¼é€æª”æ¡ˆ</div>
            <div class="tab" onclick="switchTab('download')"><i class="fa-solid fa-download"></i> æ¥æ”¶æª”æ¡ˆ</div>
        </div>

        <div id="uploadSection">
            <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
                <i class="fa-solid fa-cloud-arrow-up"></i>
                <div>é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆè‡³æ­¤</div>
                <div style="font-size:0.8rem; color:#64748b;">æ”¯æ´å¤šæª”ä¸Šå‚³ / è‡ªå‹•åŠ å¯†</div>
                <input type="file" id="fileInput" multiple style="display:none" onchange="handleFileSelect(this)">
            </div>
            <div class="file-list" id="fileList"></div>

            <div class="form-group" style="margin-top:20px;">
                <label class="form-label">é™„åŠ åŠ å¯†è¨Šæ¯ (å¯é¸)</label>
                <textarea id="secretMsg" rows="2" placeholder="è¼¸å…¥æ–‡å­—å‚™è¨»..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">è¨­å®šæå–å¯†ç¢¼ (å¿…å¡«)</label>
                <input type="text" id="uploadPwd" class="form-input" placeholder="ä¾‹å¦‚ï¼š1234">
            </div>

            <div class="form-group">
                <label class="form-label">æœ‰æ•ˆæœŸé™ (éæœŸè‡ªå‹•éŠ·æ¯€)</label>
                <select id="expiryTime" class="form-select">
                    <option value="10">10 åˆ†é˜å¾ŒéŠ·æ¯€</option>
                    <option value="60">1 å°æ™‚å¾ŒéŠ·æ¯€</option>
                    <option value="1440">24 å°æ™‚å¾ŒéŠ·æ¯€ (1å¤©)</option>
                    <option value="4320">72 å°æ™‚å¾ŒéŠ·æ¯€ (3å¤©)</option>
                </select>
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText">æº–å‚™ä¸­...</div>

            <button class="btn-action" id="uploadBtn" onclick="window.executeUpload()">
                <i class="fa-solid fa-rocket"></i> å•Ÿå‹•åŠ å¯†å‚³è¼¸
            </button>

            <div class="history-section">
                <div class="history-title">
                    <span><i class="fa-solid fa-clock-rotate-left"></i> æœ¬æ©Ÿå‚³è¼¸æ—¥èªŒ</span>
                    <span style="font-size:0.85rem; cursor:pointer; color:#64748b;" onclick="clearHistory()">æ¸…ç©º</span>
                </div>
                <div class="history-list" id="historyList">
                    <div style="text-align:center; color:#64748b;">æš«ç„¡ç´€éŒ„</div>
                </div>
            </div>
        </div>

        <div id="downloadSection" style="display:none;">
            <div class="form-group">
                <label class="form-label">è¼¸å…¥å‚³è¼¸ä»£ç¢¼ (Share Code)</label>
                <input type="text" id="shareCode" class="form-input" placeholder="6ä½è‹±æ•¸ä»£ç¢¼" style="text-transform: uppercase; font-family:monospace; letter-spacing:2px; font-size:1.2rem; text-align:center;">
            </div>
            <div class="form-group">
                <label class="form-label">è¼¸å…¥æå–å¯†ç¢¼</label>
                <input type="password" id="accessPwd" class="form-input" placeholder="å¯†ç¢¼" style="text-align:center;">
            </div>
            
            <button class="btn-action download-btn" id="downloadBtn" onclick="window.executeDownload()">
                <i class="fa-solid fa-unlock-keyhole"></i> è§£é–ä¸¦æå–
            </button>

            <div id="downloadArea" style="display:none; margin-top:30px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
                <h4 style="color:var(--success-green); margin:0 0 15px 0;"><i class="fa-solid fa-folder-open"></i> æª”æ¡ˆåˆ—è¡¨</h4>
                <div id="downloadList"></div>
                <div style="background:rgba(255,255,255,0.05); padding:15px; margin-top:15px; border-radius:10px; display:none; border:1px dashed #64748b;" id="msgArea">
                    <div style="color:var(--main-gold); font-size:0.9rem; margin-bottom:5px;"><i class="fa-solid fa-message"></i> é™„åŠ è¨Šæ¯ï¼š</div>
                    <div id="msgContent" style="white-space: pre-wrap; color:#e2e8f0;"></div>
                </div>
            </div>
        </div>

        <div id="resultArea">
            <div style="color:#94a3b8; font-size:1rem;">å‚³è¼¸å»ºç«‹æˆåŠŸï¼è«‹å°‡ä»£ç¢¼äº¤çµ¦å°æ–¹ï¼š</div>
            <div class="code-display" id="resultCode">------</div>
            <button class="copy-btn" onclick="copyCode()"><i class="fa-regular fa-copy"></i> è¤‡è£½ä»£ç¢¼</button>
            <div class="timer-badge" id="expiryDisplay" style="margin-top:20px; display:block; color:var(--danger-red); font-size:0.9rem;"></div>
            <button class="btn-action" onclick="location.reload()" style="margin-top:25px; background:rgba(255,255,255,0.1); border:1px solid #64748b; color:#fff; box-shadow:none;">è¿”å›</button>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, deleteDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAo6on0f2QUbPaRfxpIEb2uvhKxDvPUvs",
            authDomain: "yulubox.firebaseapp.com",
            projectId: "yulubox",
            storageBucket: "yulubox.firebasestorage.app",
            messagingSenderId: "256466567852",
            appId: "1:256466567852:web:233b74668908ffcb9b9509",
            measurementId: "G-YPCY41EKWX"
        };

        let app, auth, db, storage, currentUser;
        let selectedFiles = [];

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);

            onAuthStateChanged(auth, user => {
                if(user) {
                    currentUser = user;
                    document.getElementById('userStatus').innerText = `${user.displayName || 'æŒ‡æ®å®˜'}`;
                    document.getElementById('userStatus').style.color = "#FFD700";
                    document.getElementById('userStatus').style.borderColor = "#FFD700";
                } else {
                    currentUser = null;
                    document.getElementById('userStatus').innerText = "è¨ªå®¢æ¨¡å¼";
                }
            });
            
            loadHistory();

        } catch (e) { alert("ç³»çµ±åˆå§‹åŒ–éŒ¯èª¤: " + e.message); }

        // --- æ˜Ÿç©ºç‰¹æ•ˆ ---
        function createStars() { /* å·²æ”¹ç”¨ CSS å‹•æ…‹èƒŒæ™¯ï¼Œæ­¤è™•ä¿ç•™ç©ºå‡½å¼å…¼å®¹èˆŠçµæ§‹ */ }

        // --- å…¨åŸŸç¶å®š ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab')[tab==='upload'?0:1].classList.add('active');
            document.getElementById('uploadSection').style.display = tab==='upload'?'block':'none';
            document.getElementById('downloadSection').style.display = tab==='download'?'block':'none';
            document.getElementById('resultArea').style.display = 'none';
        };

        window.handleFileSelect = (input) => {
            selectedFiles = Array.from(input.files);
            const list = document.getElementById('fileList');
            if(selectedFiles.length === 0) { list.style.display='none'; return; }
            list.style.display = 'block';
            list.innerHTML = selectedFiles.map(f => `<div><i class="fa-solid fa-file-circle-check"></i> ${f.name} <span style="color:#64748b; font-size:0.8rem;">(${(f.size/1024).toFixed(1)}KB)</span></div>`).join('');
        };

        window.copyCode = () => {
            navigator.clipboard.writeText(document.getElementById('resultCode').innerText);
            alert("ä»£ç¢¼å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿");
        };

        // --- ğŸš€ ä¸Šå‚³é‚è¼¯ ---
        window.executeUpload = async () => {
            const pwd = document.getElementById('uploadPwd').value;
            const msg = document.getElementById('secretMsg').value;
            const expiryMins = parseInt(document.getElementById('expiryTime').value);

            if(!pwd) return alert("è«‹è¨­å®šæå–å¯†ç¢¼");
            if(selectedFiles.length === 0 && !msg) return alert("è«‹é¸æ“‡æª”æ¡ˆæˆ–è¼¸å…¥è¨Šæ¯");

            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('progressText').style.display = 'block';

            try {
                const shareCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                const uploadedFiles = [];
                
                if(selectedFiles.length > 0) {
                    for (let i = 0; i < selectedFiles.length; i++) {
                        const file = selectedFiles[i];
                        updateProgress((i / selectedFiles.length) * 100, `åŠ å¯†ä¸Šå‚³: ${file.name}`);
                        const storageRef = ref(storage, `temp_shares/${shareCode}/${file.name}`);
                        await uploadBytesResumable(storageRef, file);
                        const url = await getDownloadURL(storageRef);
                        uploadedFiles.push({ name: file.name, url: url, path: `temp_shares/${shareCode}/${file.name}` });
                    }
                }

                updateProgress(100, "å»ºç«‹åŠ å¯†é€£çµ...");
                const expiryDate = new Date(Date.now() + expiryMins * 60000);
                
                const docRef = await addDoc(collection(db, "temp_shares"), {
                    shareCode: shareCode,
                    password: pwd,
                    files: uploadedFiles,
                    message: msg || "",
                    expiresAt: expiryDate,
                    uploader: currentUser ? currentUser.uid : "anonymous",
                    createdAt: serverTimestamp()
                });

                saveHistory({
                    code: shareCode,
                    expiry: expiryDate.getTime(),
                    docId: docRef.id,
                    files: uploadedFiles
                });

                updateProgress(100, "å‚³è¼¸å»ºç«‹å®Œæˆï¼");
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('resultArea').style.display = 'block';
                document.getElementById('resultCode').innerText = shareCode;
                document.getElementById('expiryDisplay').innerText = `è‡ªå‹•éŠ·æ¯€æ™‚é–“: ${expiryDate.toLocaleString()}`;

                selectedFiles = [];
                document.getElementById('fileInput').value = '';
                btn.disabled = false;

            } catch (e) {
                console.error(e);
                alert("ä¸Šå‚³å¤±æ•—: " + e.message);
                btn.disabled = false;
            }
        };

        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressText').innerText = `${Math.round(percent)}% - ${text}`;
        }

        // --- ğŸ“œ æ­·å²ç´€éŒ„ ---
        function saveHistory(item) {
            const history = JSON.parse(localStorage.getItem('yulu_transfer_history') || '[]');
            history.unshift(item);
            localStorage.setItem('yulu_transfer_history', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const list = document.getElementById('historyList');
            const history = JSON.parse(localStorage.getItem('yulu_transfer_history') || '[]');
            
            if(history.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#64748b;">æš«ç„¡ç´€éŒ„</div>';
                return;
            }

            list.innerHTML = history.map(item => {
                const isExpired = Date.now() > item.expiry;
                const dateStr = new Date(item.expiry).toLocaleString();
                const statusColor = isExpired ? '#ff4757' : '#10b981';
                const statusText = isExpired ? 'å·²éæœŸ' : 'æœ‰æ•ˆä¸­';
                
                return `
                    <div class="history-item">
                        <div class="h-info">
                            <div class="h-code">${item.code}</div>
                            <div class="h-date">éŠ·æ¯€: ${dateStr}</div>
                            <div class="h-expire" style="color:${statusColor}">â— ${statusText}</div>
                        </div>
                        <button class="btn-delete" onclick="window.deleteItem('${item.docId}', '${item.code}')" title="åˆªé™¤æª”æ¡ˆ">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        window.clearHistory = () => {
            if(confirm("ç¢ºå®šæ¸…ç©ºæœ¬æ©Ÿç´€éŒ„ï¼Ÿ(ä¸æœƒåˆªé™¤é›²ç«¯æª”æ¡ˆ)")) {
                localStorage.removeItem('yulu_transfer_history');
                loadHistory();
            }
        };

        window.deleteItem = async (docId, code) => {
            if(!confirm(`ç¢ºå®šè¦åˆªé™¤ä»£ç¢¼ ${code} çš„æ‰€æœ‰æª”æ¡ˆå—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)) return;
            const history = JSON.parse(localStorage.getItem('yulu_transfer_history') || '[]');
            const item = history.find(h => h.docId === docId);

            if(!item) return alert("æ‰¾ä¸åˆ°ç´€éŒ„");
            
            const btn = event.target.closest('button');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            try {
                if (item.files && item.files.length > 0) {
                    for (const file of item.files) {
                        const fileRef = ref(storage, file.path);
                        await deleteObject(fileRef).catch(err => console.warn("File gone", err));
                    }
                }
                await deleteDoc(doc(db, "temp_shares", docId));
                const newHistory = history.filter(h => h.docId !== docId);
                localStorage.setItem('yulu_transfer_history', JSON.stringify(newHistory));
                alert("åˆªé™¤æˆåŠŸï¼");
                loadHistory();
            } catch (e) {
                alert("åˆªé™¤å¤±æ•— (å¯èƒ½å·²éæœŸæˆ–ç„¡æ¬Šé™)");
                loadHistory();
            }
        };

        // --- ğŸ“¥ ä¸‹è¼‰é‚è¼¯ ---
        window.executeDownload = async () => {
            const code = document.getElementById('shareCode').value.toUpperCase();
            const pwd = document.getElementById('accessPwd').value;
            const btn = document.getElementById('downloadBtn');

            if(!code || !pwd) return alert("è«‹è¼¸å…¥ä»£ç¢¼èˆ‡å¯†ç¢¼");

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-satellite-dish fa-spin"></i> æœå°‹è¨Šè™Ÿä¸­...';

            try {
                const snapshot = await getDocs(collection(db, "temp_shares"));
                let targetDoc = null;
                snapshot.forEach(docSnap => {
                    if(docSnap.data().shareCode === code) targetDoc = { id: docSnap.id, ...docSnap.data() };
                });

                if(!targetDoc) {
                    btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-unlock-keyhole"></i> è§£é–ä¸¦æå–';
                    return alert("ç„¡æ•ˆçš„ä»£ç¢¼");
                }

                if (new Date() > targetDoc.expiresAt.toDate()) {
                    btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-unlock-keyhole"></i> è§£é–ä¸¦æå–';
                    return alert("æª”æ¡ˆå·²éæœŸä¸¦éŠ·æ¯€ã€‚");
                }

                if (targetDoc.password !== pwd) {
                    btn.disabled = false; btn.innerText = "å¯†ç¢¼éŒ¯èª¤";
                    setTimeout(() => btn.innerHTML = '<i class="fa-solid fa-unlock-keyhole"></i> è§£é–ä¸¦æå–', 2000);
                    return;
                }

                document.getElementById('downloadArea').style.display = 'block';
                const list = document.getElementById('downloadList');
                list.innerHTML = '';

                if (targetDoc.files && targetDoc.files.length > 0) {
                    targetDoc.files.forEach(f => {
                        list.innerHTML += `
                            <div class="download-item">
                                <span><i class="fa-solid fa-file"></i> ${f.name}</span>
                                <a href="${f.url}" target="_blank" class="dl-link">ä¸‹è¼‰</a>
                            </div>`;
                    });
                } else if (targetDoc.downloadUrl) {
                    list.innerHTML = `<div class="download-item"><span>å£“ç¸®æª”.zip</span><a href="${targetDoc.downloadUrl}" target="_blank" class="dl-link">ä¸‹è¼‰</a></div>`;
                }

                const msgArea = document.getElementById('msgArea');
                if(targetDoc.message) {
                    msgArea.style.display = 'block';
                    document.getElementById('msgContent').innerText = targetDoc.message;
                } else { msgArea.style.display = 'none'; }

                btn.style.display = 'none';

            } catch (e) {
                console.error(e);
                btn.disabled = false; btn.innerText = "é‡è©¦";
                alert("è®€å–å¤±æ•—");
            }
        };
    </script>
</body>
</html>