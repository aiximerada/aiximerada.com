<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ˜Ÿç¶­åŠ æ–¯ - ç‰éœ²å¯¶åº«</title>
    
    <script src="theme.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --main-gold: #FFD700;       
            --accent-amber: #FDB931;    
            --danger-red: #ff4757;      
            --nebula-purple: #d946ef; 
            --glass-bg: rgba(15, 23, 42, 0.85); 
            --card-radius: 16px;
        }
        
        body {
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            color: #e2e8f0;
            font-family: 'Microsoft JhengHei', sans-serif;
            min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden; touch-action: manipulation; padding-bottom: 160px;
            position: relative;
        }

        /* --- æ˜Ÿç©ºèƒŒæ™¯ --- */
        .space-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .star-field { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background-repeat: repeat; opacity: 0.5; animation-timing-function: linear; animation-iteration-count: infinite; }
        .stars-distant {
            background-image: radial-gradient(1px 1px at 10% 15%, #fff, transparent), radial-gradient(1px 1px at 30% 60%, #ddd, transparent), radial-gradient(1px 1px at 70% 20%, #eee, transparent);
            background-size: 300px 300px; animation-name: rotateSpace; animation-duration: 240s;
        }
        .stars-mid {
            background-image: radial-gradient(1.5px 1.5px at 25% 10%, #fff, transparent), radial-gradient(1.5px 1.5px at 60% 35%, #eef, transparent);
            background-size: 400px 400px; opacity: 0.6; animation-name: rotateSpace; animation-duration: 180s; animation-direction: reverse;
        }
        .gold-twinklers {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(2px 2px at 20% 30%, var(--main-gold), transparent), radial-gradient(3px 3px at 65% 25%, #fff59d, transparent);
            background-size: 100% 100%; opacity: 0; animation: occasionalFlash 12s ease-in-out infinite;
        }
        @keyframes rotateSpace { from { transform: rotate(0deg) translateZ(0); } to { transform: rotate(360deg) translateZ(0); } }
        @keyframes occasionalFlash { 0%, 40%, 100% { opacity: 0; } 55% { opacity: 1; filter: brightness(2) blur(1px); } 85% { opacity: 0; } }

        #fxCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }

        /* --- ç¶­è­·é®ç½© --- */
        .maintenance-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.98); z-index: 10000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(25px); text-align: center;
        }
        .maintenance-overlay.active { display: flex; animation: fadeIn 0.5s; }
        .m-icon { font-size: 6rem; color: var(--danger-red); margin-bottom: 25px; animation: pulse 1.5s infinite; filter: drop-shadow(0 0 20px rgba(255, 71, 87, 0.5)); }
        .m-title { font-size: 2.5rem; color: #fff; font-weight: 900; margin-bottom: 10px; letter-spacing: 5px; }
        .m-desc { color: #94a3b8; margin-bottom: 40px; font-size: 1.2rem; letter-spacing: 2px; }
        .btn-home { 
            padding: 16px 50px; border-radius: 50px; background: linear-gradient(135deg, var(--main-gold), var(--accent-amber)); 
            color: #000; text-decoration: none; font-weight: 900; font-size: 1.2rem;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3); transition: 0.3s;
        }
        @keyframes pulse { 0%{opacity:0.6; transform:scale(0.95);} 50%{opacity:1; transform:scale(1.05);} 100%{opacity:0.6; transform:scale(0.95);} }

        /* --- é ‚éƒ¨å°èˆª --- */
        .header {
            width: 100%; padding: 15px 20px; background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center;
            box-sizing: border-box; position: sticky; top: 0; z-index: 100;
        }
        .back-btn { color: #94a3b8; text-decoration: none; font-size: 1rem; display: flex; align-items: center; gap: 5px; }
        .balance-badge {
            background: rgba(255, 215, 0, 0.1); border: 1px solid var(--accent-amber);
            color: var(--main-gold); padding: 6px 15px; border-radius: 20px; font-weight: bold;
            display: flex; align-items: center; gap: 8px; font-size: 1rem;
        }

        .vegas-title { text-align: center; margin: 30px 0 20px 0; }
        .vegas-title h1 {
            margin: 0; font-size: 3rem; letter-spacing: 5px; font-weight: 900;
            background: linear-gradient(to bottom, #fff 0%, var(--main-gold) 100%);
            -webkit-background-clip: text; color: transparent;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
        }
        .vegas-title p { color: #64748b; margin-top: 5px; font-size: 0.95rem; letter-spacing: 3px; text-transform: uppercase; }

        /* --- ğŸ¡ è¼ªç›¤å€åŸŸ --- */
        .wheel-container { position: relative; width: 300px; height: 300px; margin: 20px auto; }
        #wheelCanvas { width: 100%; height: 100%; transform-origin: 50% 50%; transition: transform 4s cubic-bezier(0.1, 0.99, 0.1, 0.99); }
        .wheel-pointer { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); width: 0; height: 0; z-index: 10; border-left: 18px solid transparent; border-right: 18px solid transparent; border-top: 35px solid var(--main-gold); filter: drop-shadow(0 4px 4px rgba(0,0,0,0.6)); }
        
        .wheel-center {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 60px; height: 60px; background: radial-gradient(circle, #fff, var(--main-gold));
            border-radius: 50%; box-shadow: 0 0 20px var(--main-gold);
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; color: #000; font-size: 1.2rem; cursor: pointer; z-index: 5;
            border: 4px solid #fff; transition: 0.3s;
        }
        .wheel-center:disabled { filter: grayscale(1); opacity: 0.8; cursor: not-allowed; }

        .cooldown-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95); border-radius: 50%;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 20; backdrop-filter: blur(5px); color: var(--main-gold);
        }
        .timer-text { font-size: 1.5rem; font-family: monospace; font-weight: bold; margin-top: 10px; }

        /* --- å…§å®¹èˆ‡æŒ‰éˆ• --- */
        .stage { width: 95%; max-width: 800px; background: var(--glass-bg); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 30px 20px; text-align: center; position: relative; min-height: 460px; box-shadow: 0 20px 60px rgba(0,0,0,0.6); backdrop-filter: blur(16px); }
        .game-tabs { display: flex; gap: 10px; margin-bottom: 25px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 50px; flex-wrap: wrap; justify-content: center; }
        .tab-btn { background: transparent; border: none; color: #64748b; padding: 10px 20px; border-radius: 40px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .tab-btn.active { background: linear-gradient(135deg, var(--main-gold), var(--accent-amber)); color: #0f172a; }
        
        .card-area { display: flex; justify-content: center; gap: 15px; margin: 15px 0; perspective: 1000px; flex-wrap: wrap; min-height: 150px; align-items: center; }
        .poker-card { width: 100px; height: 145px; border-radius: var(--card-radius); position: relative; font-family: 'Courier New', monospace; font-weight: bold; }
        .poker-card.card-red, .poker-card.card-black { background-color: #fff; box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 1px solid #ccc; }
        .card-corner { position: absolute; display: flex; flex-direction: column; align-items: center; line-height: 1; font-size: 1.3rem; }
        .top-left { top: 6px; left: 6px; }
        .bottom-right { bottom: 6px; right: 6px; transform: rotate(180deg); }
        .card-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3.5rem; }
        .card-red .card-corner, .card-red .card-center { color: #c0392b !important; }
        .card-black .card-corner, .card-black .card-center { color: #2c3e50 !important; }
        .card-back { background-color: #1e293b; border: 3px solid #fff; display: flex; align-items: center; justify-content: center; }
        .card-back::after { content: 'âœ¦'; color: var(--main-gold); font-size: 3.5rem; }
        
        .dice-display { font-size: 8rem; color: #fff; text-shadow: 0 0 40px rgba(217, 70, 239, 0.8); transition: 0.2s; }
        .dice-rolling { animation: rollShake 0.3s infinite linear; color: var(--nebula-purple); }
        @keyframes rollShake { 0%{transform:rotate(0deg);} 50%{transform:rotate(15deg);} 100%{transform:rotate(0deg);} }

        /* éª°å­é¸æ“‡å™¨ */
        .dice-control-panel { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .dice-selector { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
        .dice-btn { width: 50px; height: 50px; border-radius: 12px; border: 2px solid var(--nebula-purple); background: rgba(0,0,0,0.3); color: var(--nebula-purple); font-size: 1.5rem; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .dice-btn.selected { background: var(--nebula-purple); color: #fff; border-color: #fff; transform: scale(1.1); box-shadow: 0 0 20px var(--nebula-purple); }

        .btn-action { background: linear-gradient(135deg, var(--main-gold), var(--accent-amber)); color: #0f172a; border: none; padding: 16px 50px; border-radius: 50px; font-size: 1.3rem; cursor: pointer; margin-top: 25px; font-weight: 900; width: 85%; max-width: 350px; }
        .btn-action:disabled { background: #334155; color:#64748b; cursor: not-allowed; }

        .result-msg { font-size: 1.6rem; margin-top: 25px; font-weight: bold; min-height: 40px; opacity: 0; transition: 0.5s; }
        .result-msg.show { opacity: 1; transform: scale(1.1); }
        .win { color: var(--main-gold); } .lose { color: var(--danger-red); }

        .bottom-float-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; z-index: 500; display: flex; flex-direction: column; gap: 15px; }
        #btnReset { width: 100%; background: rgba(30, 41, 59, 0.95); color:#fff; border:1px solid rgba(255,255,255,0.3); padding:16px; border-radius: 50px; font-size:1.1rem; font-weight:bold; display: none; }
        .double-up-panel { display: none; gap: 15px; width: 100%; }
        .btn-collect { background: linear-gradient(90deg, #10b981, #059669); flex: 1; padding: 15px; border-radius: 15px; font-weight:bold; border:none; color:#fff; }
        .btn-double { background: linear-gradient(90deg, var(--main-gold), #e17055); flex: 1; padding: 15px; border-radius: 15px; font-weight:bold; border:none; color:#fff; }

        .terms-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(20px); }
        .terms-box { background: #0f172a; border: 1px solid var(--main-gold); padding: 30px; border-radius: 24px; width: 85%; max-width: 450px; text-align: center; }
        .btn-agree { background: linear-gradient(90deg, #FFD700, #FDB931) !important; color: #000 !important; border: 2px solid #fff; padding: 15px 40px; border-radius: 50px; font-weight: 900; cursor: pointer; width: 100%; }
    </style>
</head>
<body>

    <div id="maintenanceOverlay" class="maintenance-overlay">
        <i class="fa-solid fa-screwdriver-wrench m-icon"></i>
        <div class="m-title">ç¶­ä¿®ä¸­</div>
        <div class="m-desc">è«‹ç¨å¾Œå†è©¦</div>
        <a href="vip_area.html" class="btn-home">è¿”å›å¤§å»³</a>
    </div>

    <div class="space-container">
        <div class="star-field stars-distant"></div>
        <div class="star-field stars-mid"></div>
        <div class="gold-twinklers"></div>
    </div>
    <canvas id="fxCanvas"></canvas>

    <div class="terms-overlay" id="termsOverlay">
        <div class="terms-box">
            <h2 style="color:var(--main-gold)">æ˜Ÿæ˜Ÿå…¬ç´„</h2>
            <p style="color:#94a3b8; line-height:1.8; margin-bottom:30px;">ä¸‹æ³¨å³ä»£è¡¨åŒæ„è¦å‰‡ï¼Œé»æ•¸æ¦‚ä¸é€€é‚„ã€‚</p>
            <button class="btn-agree" onclick="document.getElementById('termsOverlay').style.display='none'">å·²çŸ¥æ‚‰</button>
        </div>
    </div>

    <div class="header">
        <a href="vip_area.html" class="back-btn"><i class="fa-solid fa-chevron-left"></i> å¤§å»³</a>
        <div class="balance-badge"><i class="fa-solid fa-star"></i> <span id="userStars">--</span></div>
    </div>

    <div class="vegas-title">
        <h1>æ˜Ÿç¶­åŠ æ–¯</h1>
        <p>STAR VEGAS CASINO</p>
    </div>

    <div class="game-tabs">
        <button class="tab-btn active" onclick="switchGame('wheel')">æ˜Ÿä¹‹è¼ªç›¤</button>
        <button class="tab-btn" onclick="switchGame('highcard')">æ¯”å¤§å°</button>
        <button class="tab-btn" onclick="switchGame('blackjack')">21é»</button>
        <button class="tab-btn" onclick="switchGame('dice')">æ˜Ÿé‹éª°</button>
    </div>

    <div class="stage" id="gameStage">
        
        <div class="bet-panel" id="betPanel" style="display:none;">
            <div class="bet-input-group">
                <input type="number" id="betAmount" class="bet-input" value="100">
                <button class="btn-all-in" onclick="document.getElementById('betAmount').value = currentBalance">å…¨æŠ¼</button>
            </div>
            
            <div id="diceSelector" class="dice-control-panel" style="display:none;">
                <div style="color:#d946ef; font-weight:bold;">é¸æ“‡æ‚¨çš„å¹¸é‹æ˜Ÿæ•¸</div>
                <div class="dice-selector">
                    <button class="dice-btn" onclick="selectDiceNumber(1)">1</button>
                    <button class="dice-btn" onclick="selectDiceNumber(2)">2</button>
                    <button class="dice-btn" onclick="selectDiceNumber(3)">3</button>
                    <button class="dice-btn" onclick="selectDiceNumber(4)">4</button>
                    <button class="dice-btn" onclick="selectDiceNumber(5)">5</button>
                    <button class="dice-btn" onclick="selectDiceNumber(6)">6</button>
                </div>
            </div>

            <button class="btn-action" id="btnStart" onclick="startGame()">é–‹å§‹</button>
        </div>

        <div id="gameWheel" style="display:block;">
            <div style="text-align:center; color:#94a3b8; margin-bottom:20px;">æ¯æ—¥ä¹é»åˆ·æ–°èƒ½æº</div>
            <div class="wheel-container">
                <div class="wheel-pointer"></div>
                <canvas id="wheelCanvas" width="300" height="300"></canvas>
                <button class="wheel-center" id="wheelBtn" onclick="spinWheel()" disabled>
                    <i class="fa-solid fa-spinner fa-spin"></i>
                </button>
                <div id="wheelCooldown" class="cooldown-overlay">
                    <i class="fa-solid fa-hourglass-half" style="font-size:3rem;"></i>
                    <div class="timer-text" id="cooldownTimer">--:--:--</div>
                </div>
            </div>
        </div>

        <div id="gameHighCard" style="display:none;">
            <div class="card-area" id="hcHouseCard"><div class="poker-card card-back"></div></div>
            <div class="card-area" id="hcPlayerCard"><div class="poker-card card-back" style="opacity:0.5;"></div></div>
            <div class="double-up-panel" id="hcChoices" style="display:none; justify-content:center; gap:20px;">
                <button class="btn-collect" style="background:var(--main-gold); color:#000" onclick="guessHighCard('big')">å¤§</button>
                <button class="btn-collect" style="background:var(--nebula-purple); color:#fff" onclick="guessHighCard('small')">å°</button>
            </div>
        </div>

        <div id="gameBlackjack" style="display:none;">
            <div style="margin-bottom:20px; color:#94a3b8;">èŠå®¶ <span id="bjHouseScore">?</span></div>
            <div class="card-area" id="bjHouseArea"></div>
            <div style="margin-bottom:20px; color:var(--main-gold);">æ‚¨ <span id="bjPlayerScore">0</span></div>
            <div class="card-area" id="bjPlayerArea"></div>
            <div class="double-up-panel" id="bjControls" style="display:none; justify-content:center; gap:20px;">
                <button class="btn-double" onclick="bjHit()">å«ç‰Œ</button>
                <button class="btn-collect" onclick="bjStand()">åœç‰Œ</button>
            </div>
        </div>

        <div id="gameDice" style="display:none;">
            <div class="dice-display"><i class="fa-solid fa-dice-d6" id="diceIcon"></i></div>
            <div id="diceStatus" style="margin-top:20px; color:var(--nebula-purple);">ç­‰å¾…æ˜Ÿé‹...</div>
        </div>

        <div id="resultMsg" class="result-msg"></div>
    </div>

    <div class="bottom-float-bar">
        <div class="double-up-panel" id="doubleUpPanel">
            <button class="btn-collect" onclick="collectWinnings()">æ”¶ä¸‹</button>
            <button class="btn-double" onclick="doubleUp()">åŠ å€</button>
        </div>
        <button id="btnReset" onclick="resetTable()">å†ä¾†ä¸€å±€</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, runTransaction, collection, serverTimestamp, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAo6on0f2QUbPaRfxpIEb2uvhKxDvPUvs",
            authDomain: "yulubox.firebaseapp.com",
            projectId: "yulubox",
            storageBucket: "yulubox.firebasestorage.app",
            messagingSenderId: "256466567852",
            appId: "1:256466567852:web:233b74668908ffcb9b9509",
            measurementId: "G-YPCY41EKWX"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentBalance = 0;
        let currentGame = 'wheel'; 
        let isWheelSpinning = true; 
        let selectedDice = null;
        let gameState = { bet: 0, pendingWinnings: 0 };
        
        // ğŸ”¥ å‹•æ…‹é›£åº¦è®Šæ•¸
        // 0: Normal (Fair)
        // 1: Hard (Slightly Rigged)
        // 2: Hell (Heavy Rigged)
        let roundDifficulty = 0; 

        onAuthStateChanged(auth, async (user) => {
            if (user) { 
                currentUser = user; 
                updateBalanceDisplay();
                initWheel(); 
                checkDailyStatus();
                listenCasinoStatus();
            } else { window.location.href = "login.html"; }
        });

        function listenCasinoStatus() {
            onSnapshot(doc(db, "system_settings", "global_config"), (docSnap) => {
                const overlay = document.getElementById('maintenanceOverlay');
                if(docSnap.exists() && docSnap.data().isCasinoOpen === false) overlay.classList.add('active');
                else overlay.classList.remove('active');
            });
        }

        async function updateBalanceDisplay() {
            const docSnap = await getDoc(doc(db, "users", currentUser.uid));
            if(docSnap.exists()) {
                currentBalance = docSnap.data().stars || 0;
                document.getElementById('userStars').innerText = currentBalance;
            }
        }

        // --- è¼ªç›¤ (ç¶­æŒä¸è®Š) ---
        const prizes = [
            { text: "+100", value: 100, color: "#eab308" },
            { text: "éŠ˜è¬", value: 0, color: "#64748b" },
            { text: "+1", value: 1, color: "#0ea5e9" },
            { text: "+10", value: 10, color: "#10b981" },
            { text: "+5", value: 5, color: "#0ea5e9" },
            { text: "å†è½‰", value: "spin", color: "#f97316" },
            { text: "+50", value: 50, color: "#eab308" },
            { text: "+1", value: 1, color: "#0ea5e9" },
            { text: "+5", value: 5, color: "#10b981" },
            { text: "-10", value: -10, color: "#ef4444" },
            { text: "+20", value: 20, color: "#10b981" },
            { text: "+200", value: 200, color: "#8b5cf6" }
        ];
        
        let wheelCtx;
        function initWheel() {
            const canvas = document.getElementById('wheelCanvas');
            wheelCtx = canvas.getContext('2d');
            drawWheel(0);
        }

        function drawWheel(angle) {
            const centerX = 150, centerY = 150, radius = 145, step = (2 * Math.PI) / 12;
            wheelCtx.clearRect(0,0,300,300);
            for (let i = 0; i < 12; i++) {
                const a = i * step + angle - (Math.PI / 2);
                wheelCtx.beginPath(); wheelCtx.moveTo(centerX, centerY);
                wheelCtx.arc(centerX, centerY, radius, a, a + step);
                wheelCtx.fillStyle = prizes[i].color; wheelCtx.fill();
                wheelCtx.save(); wheelCtx.translate(centerX, centerY); wheelCtx.rotate(a + step / 2);
                wheelCtx.textAlign = "right"; wheelCtx.fillStyle = "#fff"; wheelCtx.font = "bold 13px Arial";
                wheelCtx.fillText(prizes[i].text, radius - 15, 5); wheelCtx.restore();
            }
        }

        async function checkDailyStatus() {
            const docSnap = await getDoc(doc(db, "users", currentUser.uid));
            const btn = document.getElementById('wheelBtn');
            if(docSnap.exists()) {
                const lastSpin = docSnap.data().lastDailySpin ? docSnap.data().lastDailySpin.toDate().getTime() : 0;
                const now = new Date();
                let lastReset = new Date(now);
                lastReset.setHours(9, 0, 0, 0);
                if (now < lastReset) lastReset.setDate(lastReset.getDate() - 1);

                if (lastSpin > lastReset.getTime()) {
                    let nextReset = new Date(now);
                    nextReset.setHours(9, 0, 0, 0);
                    if (now >= nextReset) nextReset.setDate(nextReset.getDate() + 1);
                    lockWheelUI(nextReset.getTime());
                } else {
                    isWheelSpinning = false;
                    btn.disabled = false;
                    btn.innerHTML = "GO";
                }
            }
        }

        function lockWheelUI(targetTime) {
            const overlay = document.getElementById('wheelCooldown');
            const timer = document.getElementById('cooldownTimer');
            const btn = document.getElementById('wheelBtn');
            overlay.style.display = 'flex';
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-lock"></i>';
            const itv = setInterval(() => {
                const diff = targetTime - Date.now();
                if (diff <= 0) {
                    clearInterval(itv); overlay.style.display = 'none';
                    isWheelSpinning = false; btn.disabled = false; btn.innerHTML = "GO";
                    return;
                }
                const h = Math.floor(diff / 3600000), m = Math.floor((diff % 3600000) / 60000), s = Math.floor((diff % 60000) / 1000);
                timer.innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }, 1000);
        }

        window.spinWheel = async () => {
            if (isWheelSpinning) return;
            isWheelSpinning = true;
            const btn = document.getElementById('wheelBtn');
            btn.disabled = true;
            const resIdx = Math.floor(Math.random() * 12);
            const targetAngle = (360 * 5) + (360 - (resIdx * 30)) - 15;
            let start = null;
            function anim(time) {
                if (!start) start = time;
                const prog = (time - start) / 4500;
                if (prog < 1) {
                    drawWheel(((targetAngle * (1 - Math.pow(1 - prog, 3))) * Math.PI) / 180);
                    requestAnimationFrame(anim);
                } else {
                    drawWheel((targetAngle * Math.PI) / 180);
                    setTimeout(() => finishSpin(prizes[resIdx]), 300);
                }
            }
            requestAnimationFrame(anim);
        };

        async function finishSpin(prize) {
            if (prize.value === "spin") {
                alert("å¹¸é‹ï¼ç²å¾—ã€Œå†è½‰ä¸€æ¬¡ã€ï¼");
                isWheelSpinning = false; document.getElementById('wheelBtn').disabled = false;
                return;
            }
            const amount = prize.value;
            alert(amount > 0 ? `æ­å–œç²å¾— ${amount} æ˜Ÿæ˜Ÿï¼` : (amount < 0 ? `å“å‘€ï¼æ‰£é™¤ ${Math.abs(amount)} æ˜Ÿæ˜Ÿ` : "éŠ˜è¬æƒ é¡§"));
            try {
                const userRef = doc(db, "users", currentUser.uid);
                await runTransaction(db, async (t) => {
                    const snap = await t.get(userRef);
                    const lastSpin = snap.data().lastDailySpin ? snap.data().lastDailySpin.toDate().getTime() : 0;
                    const now = new Date();
                    let lastReset = new Date(now);
                    lastReset.setHours(9, 0, 0, 0);
                    if (now < lastReset) lastReset.setDate(lastReset.getDate() - 1);
                    if (lastSpin > lastReset.getTime()) throw "å·²é ˜å–";
                    t.update(userRef, { stars: (snap.data().stars || 0) + amount, lastDailySpin: serverTimestamp() });
                });
                updateBalanceDisplay();
                checkDailyStatus();
            } catch(e) { location.reload(); }
        }

        // --- æ ¸å¿ƒéŠæˆ²åˆ‡æ›é‚è¼¯ ---
        window.switchGame = (game) => {
            currentGame = game;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('gameHighCard').style.display = game === 'highcard' ? 'block' : 'none';
            document.getElementById('gameBlackjack').style.display = game === 'blackjack' ? 'block' : 'none';
            document.getElementById('gameDice').style.display = game === 'dice' ? 'block' : 'none';
            document.getElementById('gameWheel').style.display = game === 'wheel' ? 'block' : 'none';
            document.getElementById('betPanel').style.display = game === 'wheel' ? 'none' : 'block';
            document.getElementById('diceSelector').style.display = game === 'dice' ? 'block' : 'none';
            resetTable();
        };

        window.selectDiceNumber = (num) => {
            selectedDice = num;
            document.querySelectorAll('.dice-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.dice-btn')[num-1].classList.add('selected');
        }

        window.resetTable = () => {
            document.getElementById('betPanel').style.display = currentGame === 'wheel' ? 'none' : 'block';
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnReset').style.display = 'none';
            document.getElementById('doubleUpPanel').style.display = 'none';
            document.getElementById('resultMsg').innerText = '';
            document.getElementById('resultMsg').className = 'result-msg';
            document.getElementById('gameStage').classList.remove('winner-glow', 'loser-shake');
            document.getElementById('hcChoices').style.display = 'none';
            document.getElementById('diceIcon').className = 'fa-solid fa-dice-d6';
            document.getElementById('diceStatus').innerText = 'ç­‰å¾…æ˜Ÿé‹...';
            document.getElementById('bjControls').style.display = 'none';
            
            // æ¸…ç©º Blackjack ç‰Œé¢
            document.getElementById('bjPlayerArea').innerHTML = '';
            document.getElementById('bjHouseArea').innerHTML = '';
            document.getElementById('bjPlayerScore').innerText = '0';
            document.getElementById('bjHouseScore').innerText = '?';
            
            // æ¸…ç©º HighCard ç‰Œé¢
            document.getElementById('hcPlayerCard').innerHTML = '<div class="poker-card card-back" style="opacity:0.5;"></div>';
            document.getElementById('hcHouseCard').innerHTML = '<div class="poker-card card-back"></div>';

            gameState.pendingWinnings = 0;
        };

        // --- ğŸ”¥ éŠæˆ²é–‹å§‹ (æ±ºå®šæœ¬å±€å‘½é‹) ---
        window.startGame = async (isDoubleUp = false) => {
            let bet = 0;
            if(!isDoubleUp) {
                bet = parseInt(document.getElementById('betAmount').value);
                if(isNaN(bet) || bet <= 0 || bet > currentBalance) return alert("é‡‘é¡ç„¡æ•ˆæˆ–ä¸è¶³");
                if(currentGame === 'dice' && !selectedDice) return alert("è«‹å…ˆé¸æ“‡å¹¸é‹æ•¸å­—");

                // ğŸ”¥ æ±ºå®šæœ¬å±€é›£åº¦ (Dynamic Difficulty)
                // 20% Normal, 50% Hard, 30% Hell
                const rand = Math.random();
                if (rand < 0.2) roundDifficulty = 0; // Normal
                else if (rand < 0.7) roundDifficulty = 1; // Hard
                else roundDifficulty = 2; // Hell
                
                // æ‰£æ¬¾
                try {
                    await runTransaction(db, async (t) => {
                        const ref = doc(db, "users", currentUser.uid);
                        const snap = await t.get(ref);
                        t.update(ref, { stars: snap.data().stars - bet });
                    });
                    updateBalanceDisplay();
                } catch(e) { return; }
                gameState.bet = bet;
            } else {
                // åŠ å€æ™‚å»¶çºŒä¸Šä¸€å±€çš„é›£åº¦ï¼Œæˆ–è€…è®Šå¾—æ›´é›£
                if(roundDifficulty < 2) roundDifficulty++;
            }

            document.getElementById('betPanel').style.display = 'none';
            document.getElementById('doubleUpPanel').style.display = 'none';
            document.getElementById('btnReset').style.display = 'none';
            
            if(currentGame === 'highcard') startHighCard();
            else if(currentGame === 'blackjack') startBlackjack();
            else startDice();
        };

        // --- ğŸƒ æ’²å…‹ç‰Œé‚è¼¯ ---
        const SUITS = ['â™ ', 'â™¥', 'â™¦', 'â™£'], VALUES = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
        
        // æ ¹æ“šé›£åº¦ç”¢ç”Ÿç‰Œå †
        function createDeck() { 
            let d = []; 
            for(let s of SUITS) for(let i=0; i<13; i++) d.push({suit:s, text:VALUES[i], value:i+2, bjValue:(i>=8 && i<=11)?10:(i===12?11:i+2)});
            d.sort(() => Math.random() - 0.5);

            // ğŸ”¥ é›£åº¦ä»‹å…¥ï¼šåœ°ç„æ¨¡å¼ä¸‹ç§»é™¤ 2 å¼µ Ace (å¢åŠ çˆ†ç‰Œç‡æˆ–é™ä½ BJ ç‡)
            if (roundDifficulty === 2 && currentGame === 'blackjack') {
                d = d.filter(c => c.text !== 'A'); // ç§»é™¤æ‰€æœ‰ A
            }
            return d;
        }

        function createCardElement(c) {
            const red = (c.suit === 'â™¥' || c.suit === 'â™¦') ? 'card-red' : 'card-black';
            const div = document.createElement('div'); div.className = `poker-card ${red}`;
            div.innerHTML = `<div class="card-corner top-left"><div>${c.text}</div><div>${c.suit}</div></div><div class="card-center">${c.suit}</div><div class="card-corner bottom-right"><div>${c.text}</div><div>${c.suit}</div></div>`;
            return div;
        }
        function createCardBack() { const d = document.createElement('div'); d.className = 'poker-card card-back'; return d; }

        // --- ğŸ® æ¯”å¤§å° (High Card) ---
        function startHighCard() {
            const deck = createDeck(); gameState.deck = deck;
            const house = deck.pop(); gameState.house = house;
            document.getElementById('hcHouseCard').innerHTML = '';
            document.getElementById('hcHouseCard').appendChild(createCardElement(house));
            document.getElementById('hcChoices').style.display = 'flex';
        }

        window.guessHighCard = (choice) => {
            document.getElementById('hcChoices').style.display = 'none';
            let player = gameState.deck.pop();

            // ğŸ”¥ é›£åº¦ä»‹å…¥ï¼šæ›´æ›çµæœ
            // å¦‚æœç©å®¶è´äº†ï¼Œä½†ç³»çµ±è™•æ–¼å›°é›£æ¨¡å¼ï¼Œæœ‰æ©Ÿæœƒæ›æˆè¼¸çš„ç‰Œ
            const playerWins = (choice==='big' && player.value > gameState.house.value) || (choice==='small' && player.value < gameState.house.value);
            
            if (playerWins) {
                let rerollChance = roundDifficulty === 1 ? 0.4 : (roundDifficulty === 2 ? 0.7 : 0);
                if (Math.random() < rerollChance) {
                    // å˜—è©¦æŠ½ä¸€å¼µè¼¸çš„ç‰Œ
                    let badCard = null;
                    for(let i=0; i<10; i++) {
                        let temp = gameState.deck.pop();
                        const wins = (choice==='big' && temp.value > gameState.house.value) || (choice==='small' && temp.value < gameState.house.value);
                        if (!wins) { badCard = temp; break; }
                    }
                    if(badCard) player = badCard;
                }
            }

            document.getElementById('hcPlayerCard').innerHTML = '';
            document.getElementById('hcPlayerCard').appendChild(createCardElement(player));
            setTimeout(() => {
                const win = (choice==='big' && player.value > gameState.house.value) || (choice==='small' && player.value < gameState.house.value);
                if(win) handleWin(2, "çŒœå°äº†ï¼"); else if(player.value === gameState.house.value) handleWin(1, "å¹³æ‰‹"); else handleLose();
            }, 600);
        };

        // --- ğŸƒ 21é» (Blackjack) ---
        function startBlackjack() {
            gameState.deck = createDeck(); 
            // ğŸ”¥ é›£åº¦ä»‹å…¥ï¼šèŠå®¶èµ·å§‹ç‰Œå„ªåŒ–
            if (roundDifficulty > 0 && Math.random() < 0.5) {
                // èŠå®¶ç¬¬ä¸€å¼µçµ¦ 10 é»
                gameState.hCards = [{suit:'â™ ', text:'K', value:10, bjValue:10}, gameState.deck.pop()];
            } else {
                gameState.hCards = [gameState.deck.pop(), gameState.deck.pop()]; 
            }
            gameState.pCards = [gameState.deck.pop(), gameState.deck.pop()];
            renderBJ(); document.getElementById('bjControls').style.display = 'flex';
        }

        function renderBJ(reveal=false) {
            const pArea = document.getElementById('bjPlayerArea'), hArea = document.getElementById('bjHouseArea');
            pArea.innerHTML = ''; gameState.pCards.forEach(c => pArea.appendChild(createCardElement(c)));
            hArea.innerHTML = ''; gameState.hCards.forEach((c,i) => hArea.appendChild(!reveal && i===1 ? createCardBack() : createCardElement(c)));
            document.getElementById('bjPlayerScore').innerText = getBJScore(gameState.pCards);
            document.getElementById('bjHouseScore').innerText = reveal ? getBJScore(gameState.hCards) : "?";
        }
        function getBJScore(cards) {
            let s = 0, a = 0; for(let c of cards) { s+=c.bjValue; if(c.text==='A') a++; }
            while(s > 21 && a > 0) { s-=10; a--; } return s;
        }
        window.bjHit = () => { gameState.pCards.push(gameState.deck.pop()); renderBJ(); if(getBJScore(gameState.pCards)>21) bjStand(); };
        window.bjStand = () => {
            document.getElementById('bjControls').style.display = 'none';
            // èŠå®¶é‚è¼¯ï¼š17é»åœç‰Œ
            while(getBJScore(gameState.hCards) < 17) gameState.hCards.push(gameState.deck.pop()); 
            renderBJ(true);
            const ps = getBJScore(gameState.pCards), hs = getBJScore(gameState.hCards);
            if(ps > 21) handleLose("çˆ†ç‰Œï¼"); 
            else if(hs > 21 || ps > hs) handleWin(2, "ç²å‹ï¼"); 
            else if(ps === hs) handleWin(1, "å¹³æ‰‹"); 
            else handleLose();
        };

        // --- ğŸ² æ˜Ÿé‹éª° (Dice) ---
        function startDice() {
            const icon = document.getElementById('diceIcon'); icon.className += " dice-rolling";
            setTimeout(() => {
                icon.className = "fa-solid fa-dice-d6"; 
                
                // ğŸ”¥ é›£åº¦ä»‹å…¥
                let res = Math.floor(Math.random()*6)+1;
                if (res === selectedDice) {
                    // å¦‚æœä¸­çäº†ï¼Œæ ¹æ“šé›£åº¦æ±ºå®šæ˜¯å¦é‡éª° (æ®ºç‰Œ)
                    let rerollChance = roundDifficulty === 1 ? 0.5 : (roundDifficulty === 2 ? 0.8 : 0);
                    if (Math.random() < rerollChance) {
                        do { res = Math.floor(Math.random()*6)+1; } while(res === selectedDice);
                    }
                }

                const faces = ['one','two','three','four','five','six']; icon.classList.add('fa-dice-'+faces[res-1]);
                if(res === selectedDice) handleWin(3, "æ˜Ÿé‹çˆ†ç™¼ï¼"); else handleLose(`é–‹å‡º ${res}ï¼ŒæŒ‘æˆ°å¤±æ•—`);
            }, 1500);
        }

        // --- çµç®— ---
        function handleWin(mul, msg) {
            const win = gameState.bet * mul; gameState.pendingWinnings = win;
            document.getElementById('resultMsg').innerText = msg + " è´å¾— " + win; document.getElementById('resultMsg').className += " show win";
            document.getElementById('doubleUpPanel').style.display = 'flex';
            confettiFx();
        }
        function handleLose(msg="è¼¸äº†...") {
            document.getElementById('resultMsg').innerText = msg; document.getElementById('resultMsg').className += " show lose";
            document.getElementById('btnReset').style.display = 'block';
        }
        window.collectWinnings = async () => {
            try {
                await runTransaction(db, async (t) => {
                    const ref = doc(db, "users", currentUser.uid);
                    const snap = await t.get(ref);
                    t.update(ref, { stars: snap.data().stars + gameState.pendingWinnings });
                });
                updateBalanceDisplay(); resetTable();
            } catch(e) {}
        };
        window.doubleUp = () => { gameState.pendingWinnings = 0; startGame(true); };

        // ç²’å­ç‰¹æ•ˆ
        const canvasFx = document.getElementById('fxCanvas');
        const ctxFx = canvasFx.getContext('2d');
        canvasFx.width = window.innerWidth; canvasFx.height = window.innerHeight;
        function confettiFx() {
            for(let i=0; i<50; i++) {
                ctxFx.fillStyle = `hsl(${Math.random()*360}, 100%, 50%)`;
                ctxFx.fillRect(Math.random()*canvasFx.width, Math.random()*canvasFx.height, 5, 5);
            }
            setTimeout(() => ctxFx.clearRect(0,0,canvasFx.width,canvasFx.height), 1000);
        }

    </script>
</body>
</html>