<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æœƒå“¡è¨»å†Š - ç‰éœ²å¯¶åº«</title>
    
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/1828/1828884.png" type="image/png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* ğŸ¨ æ˜Ÿéš›å¥¢è¯é…è‰² */
            --main-gold: #FFD700;       
            --accent-amber: #FDB931;    
            --deep-space: #0f172a;      
            --nebula-blue: #00f3ff;     
            --danger-red: #ff4757;      
            --neon-green: #00ff9d;
            
            /* ç»ç’ƒæ“¬æ…‹ */
            --glass-bg: rgba(15, 23, 42, 0.75); 
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            color: #e2e8f0; font-family: 'Microsoft JhengHei', sans-serif;
            height: 100vh; display: flex; align-items: center; justify-content: center; margin: 0;
            overflow: hidden; position: relative;
        }

        /* --- âœ¨ èƒŒæ™¯ç‰¹æ•ˆ (åŒæ­¥æ˜Ÿç¶­åŠ æ–¯) --- */
        .space-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .star-field { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background-repeat: repeat; opacity: 0.5; animation-timing-function: linear; animation-iteration-count: infinite; }
        
        .stars-distant {
            background-image: radial-gradient(1px 1px at 10% 15%, #fff, transparent), radial-gradient(1px 1px at 30% 60%, #ddd, transparent), radial-gradient(1px 1px at 70% 20%, #eee, transparent);
            background-size: 300px 300px; animation-name: rotateSpace; animation-duration: 240s;
        }
        
        .stars-mid {
            background-image: radial-gradient(1.5px 1.5px at 25% 10%, #fff, transparent), radial-gradient(1.5px 1.5px at 60% 35%, #eef, transparent);
            background-size: 400px 400px; opacity: 0.6; animation-name: rotateSpace; animation-duration: 180s; animation-direction: reverse;
        }
        
        .gold-twinklers {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(2px 2px at 20% 30%, var(--main-gold), transparent), radial-gradient(3px 3px at 65% 25%, #fff59d, transparent);
            background-size: 100% 100%; opacity: 0; animation: occasionalFlash 12s ease-in-out infinite;
        }

        @keyframes rotateSpace { from { transform: rotate(0deg) translateZ(0); } to { transform: rotate(360deg) translateZ(0); } }
        @keyframes occasionalFlash { 0%, 40%, 100% { opacity: 0; } 55% { opacity: 1; filter: brightness(2) blur(1px); } 85% { opacity: 0; } }

        /* --- è¨»å†Šå¡ç‰‡ --- */
        .register-box {
            background: var(--glass-bg); 
            border: 1px solid var(--glass-border);
            padding: 40px 30px; border-radius: 20px; width: 90%; max-width: 380px;
            backdrop-filter: blur(12px); text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: fadeIn 0.8s ease-out;
        }
        @keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }

        h2 { 
            margin-bottom: 25px; color: var(--neon-green); letter-spacing: 3px; font-size: 1.8rem; 
            text-shadow: 0 0 20px rgba(0, 255, 157, 0.3); font-weight: 900;
        }

        .input-group { margin-bottom: 15px; }
        
        input {
            width: 100%; padding: 14px; background: rgba(0,0,0,0.3);
            border: 1px solid #475569; border-radius: 10px; color: #fff; box-sizing: border-box;
            font-size: 1rem; transition: 0.3s;
        }
        input:focus { border-color: var(--neon-green); outline: none; box-shadow: 0 0 10px rgba(0, 255, 157, 0.2); }

        /* ç‰¹æ®Šæ¨£å¼ï¼šé‚€è«‹ç¢¼ */
        #inviteCode {
            border-color: var(--accent-amber); color: var(--accent-amber); font-weight: bold; letter-spacing: 1px;
        }
        #inviteCode::placeholder { color: rgba(253, 185, 49, 0.7); }
        #inviteCode:focus { box-shadow: 0 0 15px rgba(253, 185, 49, 0.3); }

        /* æŒ‰éˆ•æ¨£å¼ */
        button {
            width: 100%; padding: 14px; background: linear-gradient(135deg, var(--neon-green), #059669);
            color: #000; border: none; border-radius: 10px; font-weight: 900; cursor: pointer;
            margin-top: 10px; font-size: 1.1rem; transition: 0.3s; letter-spacing: 1px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0, 255, 157, 0.3); }
        button:disabled { background: #475569; cursor: not-allowed; transform: none; box-shadow: none; }

        .error { color: var(--danger-red); font-size: 0.9rem; margin-top: 15px; min-height: 20px; font-weight: bold; }
        
        .links { margin-top: 25px; font-size: 0.9rem; color: #94a3b8; }
        .links a { color: #fff; text-decoration: none; border-bottom: 1px dashed rgba(255,255,255,0.5); transition: 0.3s; }
        .links a:hover { color: var(--neon-green); border-color: var(--neon-green); }

    </style>
</head>
<body>

    <div class="space-container">
        <div class="star-field stars-distant"></div>
        <div class="star-field stars-mid"></div>
        <div class="gold-twinklers"></div>
    </div>

    <div class="register-box">
        <h2><i class="fa-solid fa-user-plus"></i> æœƒå“¡è¨»å†Š</h2>
        
        <div class="input-group">
            <input type="text" id="nickname" placeholder="åç¨±">
        </div>
        <div class="input-group">
            <input type="email" id="email" placeholder="é›»å­ä¿¡ç®± (Email)">
        </div>
        <div class="input-group">
            <input type="password" id="password" placeholder="è¨­å®šå¯†ç¢¼ (6ä½ä»¥ä¸Š)">
        </div>
        
        <div class="input-group">
            <input type="text" id="inviteCode" placeholder="âš ï¸ è¼¸å…¥å…¥éšŠé‚€è«‹ç¢¼" style="text-transform:uppercase;">
        </div>
        
        <button onclick="handleRegister()" id="btnReg">ç¢ºèªè¨»å†Š</button>
        <div class="error" id="errorMsg"></div>

        <div class="links">
            å·²ç¶“æœ‰å¸³è™Ÿï¼Ÿ <a href="login.html">ç›´æ¥ç™»å…¥</a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, updateDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAo6on0f2QUbPaRfxpIEb2uvhKxDvPUvs",
            authDomain: "yulubox.firebaseapp.com",
            projectId: "yulubox",
            storageBucket: "yulubox.firebasestorage.app",
            messagingSenderId: "256466567852",
            appId: "1:256466567852:web:233b74668908ffcb9b9509",
            measurementId: "G-YPCY41EKWX"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.handleRegister = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const nickname = document.getElementById('nickname').value;
            const codeInput = document.getElementById('inviteCode').value.trim().toUpperCase();
            const btn = document.getElementById('btnReg');
            const errorDiv = document.getElementById('errorMsg');

            if(!email || !password || !nickname || !codeInput) {
                errorDiv.innerText = "è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½"; return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> é©—è­‰é‚€è«‹ç¢¼...';
            errorDiv.innerText = "";

            try {
                // 1. é©—è­‰é‚€è«‹ç¢¼
                // æ³¨æ„ï¼šé€™è£¡å‡è¨­æ‚¨çš„é‚€è«‹ç¢¼é›†åˆåç¨±ç‚º "invitation_codes" (èˆ‡æ‚¨ä¹‹å‰çš„ admin_invite.html ä¸€è‡´)
                // å¦‚æœæ˜¯ "invite_codes"ï¼Œè«‹è‡ªè¡Œä¿®æ­£ä¸‹æ–¹å­—ä¸²
                const codesRef = collection(db, "invitation_codes"); 
                const q = query(codesRef, where("code", "==", codeInput));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) { throw new Error("é‚€è«‹ç¢¼ç„¡æ•ˆ (ä¸å­˜åœ¨)"); }

                let codeDocId = null;
                let isUsed = false;
                let role = "member"; // é è¨­æ¬Šé™

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    codeDocId = doc.id;
                    isUsed = data.isUsed;
                    if(data.role) role = data.role; // è®€å–é‚€è«‹ç¢¼ç¶å®šçš„æ¬Šé™
                });

                if (isUsed) { throw new Error("æ­¤é‚€è«‹ç¢¼å·²è¢«ä½¿ç”¨"); }

                // 2. å»ºç«‹å¸³è™Ÿ
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> å»ºç«‹æª”æ¡ˆä¸­...';
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // 3. æ›´æ–°ä½¿ç”¨è€…æš±ç¨±
                await updateProfile(user, { displayName: nickname });
                
                // 4. ğŸ”¥ å¯«å…¥è³‡æ–™åº« ğŸ”¥
                await setDoc(doc(db, "users", user.uid), {
                    email: email,
                    displayName: nickname,
                    role: role, // ä½¿ç”¨é‚€è«‹ç¢¼æŒ‡å®šçš„æ¬Šé™
                    stars: 100, // åˆå§‹è´ˆé€
                    joinedAt: new Date()
                });

                // 5. æ¨™è¨˜é‚€è«‹ç¢¼ç‚ºå·²ä½¿ç”¨
                const codeDocRef = doc(db, "invitation_codes", codeDocId);
                await updateDoc(codeDocRef, {
                    isUsed: true,
                    usedBy: email 
                });

                alert("è¨»å†ŠæˆåŠŸï¼ç²å¾— 100 é»æ˜Ÿéš›èƒ½æºçå‹µï¼");
                window.location.href = "vip_area.html";

            } catch (error) {
                console.error(error);
                let msg = error.message;
                if(msg.includes("auth/email-already-in-use")) msg = "æ­¤ Email å·²è¢«è¨»å†Š";
                if(msg.includes("auth/weak-password")) msg = "å¯†ç¢¼å¼·åº¦ä¸è¶³ (éœ€6ä½ä»¥ä¸Š)";
                errorDiv.innerText = "éŒ¯èª¤: " + msg;
                btn.disabled = false;
                btn.innerText = "ç¢ºèªè¨»å†Š";
            }
        };
    </script>
</body>
</html>