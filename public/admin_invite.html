<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>邀請中心 - 指揮官後台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --main-gold: #FFD700;       
            --silver-metal: #E2E8F0;
            --copper-bronze: #CD7F32;
            --deep-space: #0f172a;      
            --nebula-blue: #00f3ff;     
            --danger-red: #ff4757;      
            --success-green: #10b981;
            --glass-bg: rgba(15, 23, 42, 0.85); 
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            color: #e2e8f0; font-family: 'Microsoft JhengHei', sans-serif;
            min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden; padding-bottom: 80px;
        }

        /* --- 簡化樣式 (保留原有的星空特效) --- */
        .header { width: 100%; padding: 15px 20px; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; }
        .back-btn { color: #94a3b8; text-decoration: none; display: flex; align-items: center; gap: 5px; }
        .back-btn:hover { color: #fff; }

        .control-panel {
            width: 90%; max-width: 600px; margin-top: 40px;
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; gap: 20px;
        }

        .form-row { display: flex; gap: 15px; align-items: flex-end; }
        .form-group { flex: 1; }
        .form-label { display: block; color: #94a3b8; margin-bottom: 8px; font-size: 0.9rem; }
        .form-input { width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.6); border: 1px solid #475569; border-radius: 10px; color: #fff; box-sizing: border-box; }
        
        .btn-gen {
            background: linear-gradient(135deg, var(--main-gold), #FDB931);
            color: #0f172a; border: none; padding: 12px 30px; border-radius: 30px;
            font-weight: 900; cursor: pointer; white-space: nowrap;
        }

        .code-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; width: 90%; max-width: 1000px; margin-top: 30px; }
        
        .ticket-card {
            background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 12px; padding: 20px; position: relative; overflow: hidden;
            display: flex; flex-direction: column; gap: 10px;
        }
        
        /* 權限顏色條 */
        .ticket-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; box-shadow: 0 0 10px currentColor; }
        .role-owner { color: var(--main-gold); }
        .role-admin { color: var(--silver-metal); }
        .role-member { color: var(--copper-bronze); }
        .ticket-card.role-owner::before { background: var(--main-gold); }
        .ticket-card.role-admin::before { background: var(--silver-metal); box-shadow: 0 0 10px rgba(226, 232, 240, 0.5); }
        .ticket-card.role-member::before { background: var(--copper-bronze); }

        .ticket-code { font-family: monospace; font-size: 1.8rem; font-weight: bold; color: #fff; cursor: pointer; }
        .ticket-info { display: flex; justify-content: space-between; font-size: 0.8rem; color: #94a3b8; text-transform: uppercase; }
        
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--success-green); color: #fff; padding: 10px 20px; border-radius: 30px; opacity: 0; pointer-events: none; transition: 0.3s; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
    </style>
</head>
<body>
    <div class="header">
        <a href="vip_area.html" class="back-btn"><i class="fa-solid fa-chevron-left"></i> 返回星員區</a>
        <div style="color:var(--main-gold); font-weight:bold;">INVITATION CENTER</div>
    </div>

    <div class="control-panel">
        <div style="color:var(--main-gold); font-weight:bold; margin-bottom:10px;"><i class="fa-solid fa-wand-magic-sparkles"></i> 生成通行證</div>
        <div class="form-row">
            <div class="form-group" style="flex:1;">
                <label class="form-label">權限等級</label>
                <select id="codeRole" class="form-input">
                    <option value="member">銅星會員 (General)</option>
                    <option value="admin">銀星會員 (Admin)</option>
                    <option value="owner">金星會員 (Owner)</option>
                </select>
            </div>
            <div class="form-group" style="flex:1;">
                <label class="form-label">數量</label>
                <input type="number" id="codeCount" class="form-input" value="1" min="1" max="10">
            </div>
            <button class="btn-gen" onclick="generateCode()">生成</button>
        </div>
    </div>

    <div class="code-grid" id="codeList"></div>
    <div id="toast" class="toast">已複製</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAo6on0f2QUbPaRfxpIEb2uvhKxDvPUvs",
            authDomain: "yulubox.firebaseapp.com",
            projectId: "yulubox",
            storageBucket: "yulubox.firebasestorage.app",
            messagingSenderId: "256466567852",
            appId: "1:256466567852:web:233b74668908ffcb9b9509"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, (user) => {
            if (user) loadCodes();
            else window.location.href = "login.html";
        });

        function loadCodes() {
            const q = query(collection(db, "invitation_codes"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const grid = document.getElementById('codeList');
                grid.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    let roleClass = 'role-member';
                    let roleName = '銅星 BRONZE';
                    if(data.role === 'admin') { roleClass = 'role-admin'; roleName = '銀星 SILVER'; }
                    if(data.role === 'owner') { roleClass = 'role-owner'; roleName = '金星 GOLD'; }
                    
                    if(!data.isUsed) {
                        grid.innerHTML += `
                            <div class="ticket-card ${roleClass}">
                                <div class="ticket-info"><span>${roleName}</span><span>VALID</span></div>
                                <div class="ticket-code" onclick="copyText('${data.code}')">${data.code} <i class="fa-regular fa-copy"></i></div>
                                <div class="ticket-info">
                                    <span>${data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString() : 'Just now'}</span>
                                    <i class="fa-solid fa-trash" style="cursor:pointer; color:#ff4757;" onclick="deleteCode('${docSnap.id}')"></i>
                                </div>
                            </div>`;
                    }
                });
            });
        }

        window.generateCode = async () => {
            const role = document.getElementById('codeRole').value;
            const count = parseInt(document.getElementById('codeCount').value);
            try {
                for(let i=0; i<count; i++) {
                    await addDoc(collection(db, "invitation_codes"), {
                        code: Math.random().toString(36).substring(2, 10).toUpperCase(),
                        role: role, isUsed: false, createdAt: serverTimestamp()
                    });
                }
            } catch(e) { alert("Error: " + e.message); }
        };

        window.deleteCode = async (id) => { if(confirm("刪除此碼？")) await deleteDoc(doc(db, "invitation_codes", id)); };
        window.copyText = (t) => { navigator.clipboard.writeText(t); document.getElementById('toast').classList.add('show'); setTimeout(()=>document.getElementById('toast').classList.remove('show'), 2000); };
    </script>
</body>
</html>