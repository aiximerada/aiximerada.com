<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>極限圖片壓縮 - 啊吧啊吧</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg-deep: #050811; --suisei-cyan: #3bc6e4; --card-bg: rgba(13, 27, 51, 0.85); --text-glow: 0 0 8px rgba(59, 198, 228, 0.8); }
        body { font-family: 'Microsoft JhengHei', 'Consolas', monospace; background: radial-gradient(circle at center, #1a2c4e 0%, #050811 100%); color: #ecf0f1; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding-bottom: 80px; margin: 0; -webkit-tap-highlight-color: transparent; }
        .grid-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(rgba(59, 198, 228, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(59, 198, 228, 0.05) 1px, transparent 1px); background-size: 30px 30px; z-index: -2; pointer-events: none; }
        .container { width: 95%; max-width: 1000px; padding: 40px 20px; box-sizing: border-box;}
        
        .header-area { margin-bottom: 30px; text-align: center; position: relative; }
        h1 { color: var(--suisei-cyan); text-shadow: var(--text-glow); font-size: 2.2rem; margin: 0 0 10px 0; letter-spacing: 3px; text-transform: uppercase; }
        .back-link { position: absolute; left: 0; top: 10px; color: #666; text-decoration: none; font-size: 0.9rem; border: 1px solid #666; padding: 5px 15px; border-radius: 4px; transition: 0.3s; }
        .back-link:hover { color: var(--suisei-cyan); border-color: var(--suisei-cyan); box-shadow: var(--text-glow); }

        /* 上傳區 */
        .upload-area {
            border: 2px dashed var(--suisei-cyan); background: rgba(59, 198, 228, 0.05);
            border-radius: 15px; padding: 40px; text-align: center; cursor: pointer;
            transition: 0.3s; margin-bottom: 30px;
        }
        .upload-area:hover { background: rgba(59, 198, 228, 0.1); }
        .upload-icon { font-size: 3rem; color: var(--suisei-cyan); margin-bottom: 15px; }
        
        /* 選項區 */
        .options { display: flex; gap: 20px; justify-content: center; margin-bottom: 30px; align-items: center; flex-wrap: wrap; }
        .range-group { display: flex; align-items: center; gap: 10px; }
        input[type=range] { accent-color: var(--suisei-cyan); }

        /* 結果畫廊 */
        .gallery-title { font-size: 1.5rem; color: #fff; margin-bottom: 10px; border-left: 4px solid var(--suisei-cyan); padding-left: 10px; display: none; }
        .gallery-tip { color: #888; font-size: 0.9rem; margin-bottom: 20px; display: none; }
        
        .gallery-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px; width: 100%;
        }
        
        .img-card {
            background: #fff; border-radius: 10px; overflow: hidden; position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: 0.3s;
        }
        .img-card img { width: 100%; height: 150px; object-fit: cover; display: block; }
        .img-info { padding: 8px; color: #333; font-size: 0.8rem; text-align: center; background: #f0f0f0; }
        .img-size-tag {
            position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: #fff;
            padding: 2px 6px; border-radius: 4px; font-size: 0.7rem;
        }
        .btn-single-down {
            display: block; width: 100%; border: none; background: var(--suisei-cyan); color: #000;
            padding: 8px; cursor: pointer; font-weight: bold; font-size: 0.8rem;
        }
        .btn-single-down:hover { background: #fff; }

        /* 總控制按鈕 */
        .action-bar { display: none; gap: 15px; justify-content: center; margin-bottom: 30px; flex-wrap: wrap; }
        .btn-main {
            padding: 12px 25px; background: transparent; border: 1px solid var(--suisei-cyan);
            color: var(--suisei-cyan); font-weight: bold; cursor: pointer; border-radius: 5px;
            transition: 0.3s; display: flex; align-items: center; gap: 8px;
        }
        .btn-main:hover { background: var(--suisei-cyan); color: #000; }
        .btn-main.zip { background: #333; border-color: #666; color: #ccc; } 

    </style>
</head>
<body>
    <div class="grid-bg"></div>
    <div class="container">
        <div class="header-area">
            <a href="index.html" class="back-link">&lt; 退出系統</a>
            <h1 data-i18n="compress.pageTitle">IMAGE COMPRESSOR</h1>
            <p style="color:#888" data-i18n="compress.desc"></p>
        </div>

        <div class="upload-area" id="dropZone" onclick="document.getElementById('fileInput').click()">
            <i class="fa-solid fa-cloud-arrow-up upload-icon"></i>
            <div data-i18n="compress.dropText">點擊選擇圖片</div>
            <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
        </div>

        <div class="options">
            <div class="range-group">
                <label>品質 (Quality): <span id="qualityVal">0.8</span></label>
                <input type="range" id="qualityRange" min="0.1" max="1.0" step="0.1" value="0.8">
            </div>
            <div class="range-group">
                <label>最大寬度: <span id="widthVal">1920</span>px</label>
                <input type="range" id="widthRange" min="500" max="4000" step="100" value="1920">
            </div>
        </div>

        <div class="action-bar" id="actionBar">
            <button class="btn-main" onclick="downloadAllFiles()">
                <i class="fa-solid fa-images"></i> <span data-i18n="compress.btnDownloadAll">逐張下載 (手機)</span>
            </button>
            <button class="btn-main zip" onclick="downloadAsZip()">
                <i class="fa-solid fa-file-zipper"></i> <span data-i18n="compress.btnDownloadZip">下載 ZIP (電腦)</span>
            </button>
        </div>

        <div class="gallery-title" id="galleryTitle" data-i18n="compress.galleryTitle"></div>
        <div class="gallery-tip" id="galleryTip" data-i18n="compress.saveTip"></div>
        <div class="gallery-grid" id="galleryGrid"></div>

    </div>

    <script src="js/content.js"></script>
    <script src="js/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const fileInput = document.getElementById('fileInput');
        const qualityRange = document.getElementById('qualityRange');
        const widthRange = document.getElementById('widthRange');
        const galleryGrid = document.getElementById('galleryGrid');
        
        let processedFiles = []; // 儲存處理好的 { blob, name, url }

        // 設定連動
        qualityRange.addEventListener('input', (e) => document.getElementById('qualityVal').innerText = e.target.value);
        widthRange.addEventListener('input', (e) => document.getElementById('widthVal').innerText = e.target.value);

        fileInput.addEventListener('change', async (e) => {
            if (e.target.files.length > 0) {
                await processImages(e.target.files);
            }
        });

        // 核心：壓縮邏輯 (Canvas)
        async function processImages(files) {
            // 重置介面
            processedFiles = [];
            galleryGrid.innerHTML = '';
            document.getElementById('actionBar').style.display = 'none';
            document.getElementById('galleryTitle').style.display = 'block';
            document.getElementById('galleryTip').style.display = 'block';
            
            const quality = parseFloat(qualityRange.value);
            const maxWidth = parseInt(widthRange.value);

            Swal.fire({
                title: '處理中...',
                text: '正在極限壓縮您的圖片',
                didOpen: () => Swal.showLoading(),
                background: '#0d1b33', color: '#fff'
            });

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                try {
                    const compressedBlob = await compressSingleImage(file, quality, maxWidth);
                    const url = URL.createObjectURL(compressedBlob);
                    
                    // 儲存資料
                    processedFiles.push({
                        name: file.name,
                        blob: compressedBlob,
                        url: url,
                        origSize: (file.size / 1024).toFixed(1),
                        newSize: (compressedBlob.size / 1024).toFixed(1)
                    });

                    // 即時渲染卡片
                    renderCard(processedFiles[processedFiles.length - 1]);

                } catch (err) {
                    console.error("壓縮失敗:", err);
                }
            }

            Swal.close();
            if (processedFiles.length > 0) {
                document.getElementById('actionBar').style.display = 'flex';
            }
        }

        function compressSingleImage(file, quality, maxWidth) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        // 計算尺寸
                        let w = img.width, h = img.height;
                        if (w > maxWidth) {
                            h = Math.round(h * (maxWidth / w));
                            w = maxWidth;
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = w;
                        canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);

                        // 輸出 Blob
                        canvas.toBlob((blob) => {
                            if (blob) resolve(blob);
                            else reject(new Error("Canvas to Blob failed"));
                        }, file.type, quality);
                    };
                    img.onerror = (err) => reject(err);
                };
            });
        }

        function renderCard(item) {
            const div = document.createElement('div');
            div.className = 'img-card';
            
            // 計算壓縮率
            const ratio = Math.round((1 - (item.newSize / item.origSize)) * 100);
            
            div.innerHTML = `
                <img src="${item.url}" onclick="showImage('${item.url}')">
                <div class="img-size-tag">-${ratio}%</div>
                <div class="img-info">
                    ${item.newSize} KB
                </div>
                <button class="btn-single-down" onclick="downloadOne('${item.url}', 'min_${item.name}')">
                    <i class="fa-solid fa-download"></i> 下載
                </button>
            `;
            galleryGrid.appendChild(div);
        }

        function downloadOne(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // 批次下載 (逐張)
        async function downloadAllFiles() {
            Swal.fire({
                icon: 'info',
                title: '開始下載',
                text: '若瀏覽器詢問「允許下載多個檔案」，請點擊「允許」。',
                background: '#0d1b33', color: '#fff',
                timer: 3000
            });

            for (let i = 0; i < processedFiles.length; i++) {
                const item = processedFiles[i];
                downloadOne(item.url, `min_${item.name}`);
                // 延遲 500ms 防止瀏覽器攔截
                await new Promise(r => setTimeout(r, 500));
            }
        }

        // 下載 ZIP (JSZip)
        async function downloadAsZip() {
            const zip = new JSZip();
            processedFiles.forEach(item => {
                zip.file(`min_${item.name}`, item.blob);
            });
            
            const content = await zip.generateAsync({type:"blob"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(content);
            a.download = "images_compressed.zip";
            a.click();
        }

        function showImage(url) {
            Swal.fire({
                imageUrl: url,
                imageAlt: 'Preview',
                showConfirmButton: false,
                background: '#0d1b33',
                showCloseButton: true
            });
        }
    </script>
</body>
</html>