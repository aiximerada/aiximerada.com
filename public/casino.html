<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ˜Ÿç¶­åŠ æ–¯ - ç‰éœ²å¯¶åº«</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --main-gold: #FFD700;       
            --accent-amber: #FDB931;    
            --danger-red: #ff4757;      
            --nebula-purple: #d946ef; 
            --glass-bg: rgba(15, 23, 42, 0.85); 
            --card-radius: 16px;
        }
        
        body {
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            color: #e2e8f0;
            font-family: 'Microsoft JhengHei', sans-serif;
            min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden; touch-action: manipulation; padding-bottom: 160px;
            position: relative;
        }

        /* --- æ˜Ÿç©ºèƒŒæ™¯ --- */
        .space-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .star-field { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background-repeat: repeat; opacity: 0.5; animation-timing-function: linear; animation-iteration-count: infinite; }
        .stars-distant {
            background-image: radial-gradient(1px 1px at 10% 15%, #fff, transparent), radial-gradient(1px 1px at 30% 60%, #ddd, transparent), radial-gradient(1px 1px at 70% 20%, #eee, transparent);
            background-size: 300px 300px; animation-name: rotateSpace; animation-duration: 240s;
        }
        .stars-mid {
            background-image: radial-gradient(1.5px 1.5px at 25% 10%, #fff, transparent), radial-gradient(1.5px 1.5px at 60% 35%, #eef, transparent);
            background-size: 400px 400px; opacity: 0.6; animation-name: rotateSpace; animation-duration: 180s; animation-direction: reverse;
        }
        .gold-twinklers {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(2px 2px at 20% 30%, var(--main-gold), transparent), radial-gradient(3px 3px at 65% 25%, #fff59d, transparent);
            background-size: 100% 100%; opacity: 0; animation: occasionalFlash 12s ease-in-out infinite;
        }
        @keyframes rotateSpace { from { transform: rotate(0deg) translateZ(0); } to { transform: rotate(360deg) translateZ(0); } }
        @keyframes occasionalFlash { 0%, 40%, 100% { opacity: 0; } 55% { opacity: 1; filter: brightness(2) blur(1px); } 85% { opacity: 0; } }

        #fxCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }

        /* --- é ‚éƒ¨å°èˆª --- */
        .header {
            width: 100%; padding: 15px 20px; background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center;
            box-sizing: border-box; position: sticky; top: 0; z-index: 100;
        }
        .back-btn { color: #94a3b8; text-decoration: none; font-size: 1rem; display: flex; align-items: center; gap: 5px; }
        .balance-badge {
            background: rgba(255, 215, 0, 0.1); border: 1px solid var(--accent-amber);
            color: var(--main-gold); padding: 6px 15px; border-radius: 20px; font-weight: bold;
            display: flex; align-items: center; gap: 8px; font-size: 1rem;
        }
        .balance-update { animation: popGold 0.5s ease; }
        @keyframes popGold { 50%{transform:scale(1.2); color:#000; background:var(--main-gold);} }

        .vegas-title { text-align: center; margin: 30px 0 20px 0; }
        .vegas-title h1 {
            margin: 0; font-size: 3rem; letter-spacing: 5px; font-weight: 900;
            background: linear-gradient(to bottom, #fff 0%, var(--main-gold) 100%);
            -webkit-background-clip: text; color: transparent;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
        }
        .vegas-title p { color: #64748b; margin-top: 5px; font-size: 0.95rem; letter-spacing: 3px; text-transform: uppercase; }

        /* --- éŠæˆ²èˆå° --- */
        .stage {
            width: 95%; max-width: 800px;
            background: var(--glass-bg); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px; padding: 30px 20px; text-align: center;
            position: relative; min-height: 460px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            backdrop-filter: blur(16px);
            display: flex; flex-direction: column; transition: 0.3s;
        }
        .stage.winner-glow { border-color: var(--main-gold); box-shadow: 0 0 60px rgba(255, 215, 0, 0.2); }
        .stage.loser-shake { animation: shake 0.4s ease-in-out; border-color: var(--danger-red); }
        @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-5px);} 75%{transform:translateX(5px);} }

        /* --- ğŸ¡ æ˜Ÿä¹‹è¼ªç›¤æ¨£å¼ --- */
        .wheel-container { position: relative; width: 300px; height: 300px; margin: 20px auto; }
        #wheelCanvas { width: 100%; height: 100%; transform-origin: 50% 50%; transition: transform 4s cubic-bezier(0.1, 0.99, 0.1, 0.99); }
        
        .wheel-pointer {
            position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; z-index: 10;
            border-left: 18px solid transparent;
            border-right: 18px solid transparent;
            border-top: 35px solid var(--main-gold); /* æŒ‡å‘ä¸‹æ–¹çš„ä¸‰è§’å½¢ */
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.6));
        }
        
        .wheel-center {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 60px; height: 60px; background: radial-gradient(circle, #fff, var(--main-gold));
            border-radius: 50%; box-shadow: 0 0 20px var(--main-gold);
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; color: #000; font-size: 1.2rem; cursor: pointer; z-index: 5;
            border: 4px solid #fff;
        }
        .wheel-center:active { transform: translate(-50%, -50%) scale(0.95); }

        .cooldown-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.9); border-radius: 50%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 20; backdrop-filter: blur(5px);
            color: var(--main-gold);
        }
        .timer-text { font-size: 1.5rem; font-family: monospace; font-weight: bold; margin-top: 10px; }

        /* --- ğŸƒ å¡ç‰Œå€åŸŸ --- */
        .card-area { 
            display: flex; justify-content: center; gap: 15px; 
            margin: 15px 0; perspective: 1000px; flex-wrap: wrap; min-height: 150px; align-items: center;
        }
        .poker-card {
            width: 100px; height: 145px; border-radius: var(--card-radius); 
            position: relative; font-family: 'Courier New', Courier, monospace; font-weight: bold; 
            background-color: transparent; box-shadow: none; opacity: 1; transform: none; 
        }
        .poker-card.card-red, .poker-card.card-black { background-color: #fff; box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 1px solid #ccc; }
        .card-corner { position: absolute; display: flex; flex-direction: column; align-items: center; line-height: 1; font-size: 1.3rem; }
        .top-left { top: 6px; left: 6px; }
        .bottom-right { bottom: 6px; right: 6px; transform: rotate(180deg); }
        .card-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3.5rem; }
        .card-red .card-corner, .card-red .card-center { color: #c0392b !important; }
        .card-black .card-corner, .card-black .card-center { color: #2c3e50 !important; }
        .card-back {
            background-color: #1e293b;
            background-image: radial-gradient(circle, #334155 2px, transparent 2.5px);
            background-size: 16px 16px;
            border: 3px solid #fff; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .card-back::after { content: 'âœ¦'; color: var(--main-gold); font-size: 3.5rem; text-shadow: 0 0 15px var(--main-gold); }
        .deal-anim { animation: dealSlide 0.4s cubic-bezier(0.19, 1, 0.22, 1) forwards; }
        @keyframes dealSlide { 0% { opacity: 0; transform: translateY(-40px); } 100% { opacity: 1; transform: translateY(0); } }

        /* --- ğŸ² éª°å­å€åŸŸ --- */
        .dice-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; position: relative; }
        .dice-glow { position: absolute; width: 150px; height: 150px; border-radius: 50%; background: radial-gradient(circle, rgba(217, 70, 239, 0.3), transparent 70%); animation: pulseGlow 2s infinite ease-in-out; pointer-events: none; }
        .dice-display { font-size: 8rem; color: #fff; text-shadow: 0 0 40px rgba(217, 70, 239, 0.8); z-index: 2; transition: 0.2s; }
        .dice-rolling { animation: rollShake 0.3s infinite linear; color: var(--nebula-purple); }
        @keyframes rollShake { 0% { transform: rotate(0deg) scale(1); } 25% { transform: rotate(15deg) scale(1.1); } 50% { transform: rotate(-15deg) scale(0.9); } 75% { transform: rotate(5deg) scale(1.05); } 100% { transform: rotate(0deg) scale(1); } }
        .dice-control-panel { background: rgba(217, 70, 239, 0.05); border: 1px solid rgba(217, 70, 239, 0.2); border-radius: 16px; padding: 15px; margin-top: 25px; display: flex; flex-direction: column; gap: 10px; }
        .dice-header { color: var(--nebula-purple); font-weight: bold; font-size: 1rem; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 8px; text-shadow: 0 0 10px rgba(217, 70, 239, 0.3); }
        .dice-selector { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; z-index: 2; position: relative; }
        .dice-btn { width: 50px; height: 50px; border-radius: 12px; border: 2px solid var(--nebula-purple); background: rgba(0,0,0,0.3); color: var(--nebula-purple); font-size: 1.5rem; font-weight: bold; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px rgba(217, 70, 239, 0.1); }
        .dice-btn:hover { background: rgba(217, 70, 239, 0.2); transform: translateY(-3px); }
        .dice-btn.selected { background: var(--nebula-purple); color: #fff; border-color: #fff; box-shadow: 0 0 25px var(--nebula-purple); transform: scale(1.1); }

        /* æŒ‰éˆ•èˆ‡é¢æ¿ */
        .game-tabs { display: flex; gap: 10px; margin-bottom: 25px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 50px; flex-wrap: wrap; justify-content: center; }
        .tab-btn { background: transparent; border: none; color: #64748b; padding: 10px 20px; border-radius: 40px; cursor: pointer; font-weight: bold; transition: 0.3s; white-space: nowrap; }
        .tab-btn.active { background: linear-gradient(135deg, var(--main-gold), var(--accent-amber)); color: #0f172a; box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }

        .bet-panel { margin-bottom: 25px; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); }
        .bet-input-group { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .bet-input { background: rgba(15, 23, 42, 0.8); border: 1px solid #475569; color: var(--main-gold); padding: 12px; border-radius: 12px; width: 140px; text-align: center; font-size: 1.5rem; font-weight: bold; }
        .btn-all-in { background: linear-gradient(135deg, #ef4444, #b91c1c); color: #fff; border: none; padding: 0 25px; border-radius: 12px; font-weight: bold; cursor: pointer; }

        .btn-action {
            background: linear-gradient(135deg, var(--main-gold), var(--accent-amber)); 
            color: #0f172a; border: none; padding: 16px 50px;
            border-radius: 50px; font-size: 1.3rem; cursor: pointer; margin-top: 25px;
            font-weight: 900; box-shadow: 0 10px 30px rgba(255, 215, 0, 0.25); width: 85%; max-width: 350px;
        }
        .btn-action:disabled { background: #334155; color:#64748b; cursor: not-allowed; box-shadow: none; }

        .result-msg { font-size: 1.6rem; margin-top: 25px; font-weight: bold; min-height: 40px; text-shadow: 0 2px 10px rgba(0,0,0,0.8); opacity: 0; transition: 0.5s; }
        .result-msg.show { opacity: 1; transform: scale(1.1); }
        .win { color: var(--main-gold); } .lose { color: var(--danger-red); }

        .bj-controls { display: none; gap: 20px; justify-content: center; margin-top: 30px; }
        .btn-bj { padding: 15px 35px; border-radius: 30px; font-size: 1.1rem; border: none; cursor: pointer; font-weight: bold; color: #fff; display: flex; align-items: center; gap: 8px; }
        .btn-hit { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .btn-stand { background: linear-gradient(135deg, #ef4444, #dc2626); }

        .score-box { background: rgba(0,0,0,0.6); padding: 4px 10px; border-radius: 6px; font-family: monospace; border: 1px solid rgba(255,255,255,0.2); }

        .bottom-float-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; z-index: 500; display: flex; flex-direction: column; gap: 15px; pointer-events: none; }
        .bottom-float-bar > * { pointer-events: auto; }

        #btnReset { width: 100%; background: rgba(30, 41, 59, 0.95); color:#fff; border:1px solid rgba(255,255,255,0.3); padding:16px; border-radius: 50px; font-size:1.1rem; font-weight:bold; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: none; }

        .double-up-panel { display: none; gap: 15px; width: 100%; }
        .btn-collect { background: linear-gradient(90deg, #10b981, #059669); flex: 1; padding: 15px; border-radius: 15px; font-weight:bold; border:none; font-size:1.1rem; color:#fff; }
        .btn-double { background: linear-gradient(90deg, var(--main-gold), #e17055); flex: 1; padding: 15px; border-radius: 15px; font-weight:bold; border:none; font-size:1.1rem; color:#fff; }

        .choice-panel { display: none; gap: 20px; justify-content: center; margin-top: 25px; }
        .btn-choice { padding: 20px 40px; border-radius: 20px; border: none; font-size: 1.3rem; font-weight: bold; color: #fff; cursor: pointer; }
        .btn-big { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .btn-small { background: linear-gradient(135deg, #06b6d4, #0891b2); }

        .terms-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(20px); }
        .terms-box { background: #0f172a; border: 1px solid var(--main-gold); padding: 30px; border-radius: 24px; width: 85%; max-width: 450px; text-align: center; box-shadow: 0 0 60px rgba(255, 215, 0, 0.15); }
        .terms-title { font-size: 1.5rem; color: var(--main-gold); margin-bottom: 25px; font-weight: bold; }
        .terms-list { text-align: left; margin-bottom: 30px; color: #94a3b8; font-size: 1rem; line-height: 1.8; background: rgba(255,255,255,0.03); padding: 20px; border-radius: 12px; list-style: none; }
        .terms-list li { margin-bottom: 10px; display: flex; gap: 10px; align-items: flex-start; }
        .terms-list i { color: var(--main-gold); margin-top: 5px; }
        
        .btn-agree { background: linear-gradient(90deg, #FFD700, #FDB931) !important; color: #000 !important; border: 2px solid #fff; padding: 15px 40px; border-radius: 50px; font-weight: 900; font-size: 1.1rem; cursor: pointer; width: 100%; box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); }
        .btn-agree:active { transform: scale(0.95); }

    </style>
</head>
<body>

    <div class="space-container">
        <div class="star-field stars-distant"></div>
        <div class="star-field stars-mid"></div>
        <div class="gold-twinklers"></div>
    </div>
    
    <canvas id="fxCanvas"></canvas>

    <div class="terms-overlay" id="termsOverlay">
        <div class="terms-box">
            <div class="terms-title"><i class="fa-solid fa-scale-balanced"></i> æ˜Ÿæ˜Ÿå…¬ç´„</div>
            <ul class="terms-list">
                <li><i class="fa-solid fa-coins"></i> é»æ•¸åƒ…ä¾›æœ¬ç«™å¨›æ¨‚ï¼Œåš´ç¦ç¾é‡‘äº¤æ˜“ã€‚</li>
                <li><i class="fa-solid fa-dice-d20"></i> è³­åšæœ‰è³ºæœ‰è³ ï¼Œè«‹è¡¡é‡è‡ªèº«èƒ½åŠ›ã€‚</li>
                <li><i class="fa-solid fa-gavel"></i> ä¸‹æ³¨å³è¦–ç‚ºåŒæ„äº¤æ˜“ï¼Œç³»çµ±å°‡ç«‹å³æ‰£æ¬¾ï¼Œç„¡æ³•é€€å›ã€‚</li>
            </ul>
            <button class="btn-agree" onclick="closeTerms()">æˆ‘åŒæ„ä¸¦å·²çŸ¥æ‚‰</button>
        </div>
    </div>

    <div class="header">
        <a href="vip_area.html" class="back-btn"><i class="fa-solid fa-chevron-left"></i> å¤§å»³</a>
        <div class="balance-badge" id="balanceBadge">
            <i class="fa-solid fa-star"></i> <span id="userStars">--</span>
        </div>
    </div>

    <div class="vegas-title">
        <h1>æ˜Ÿç¶­åŠ æ–¯</h1>
        <p>STAR VEGAS CASINO</p>
    </div>

    <div class="game-tabs">
        <button class="tab-btn active" onclick="switchGame('wheel')">æ˜Ÿä¹‹è¼ªç›¤</button>
        <button class="tab-btn" onclick="switchGame('highcard')">æ¯”å¤§å°</button>
        <button class="tab-btn" onclick="switchGame('blackjack')">21é»</button>
        <button class="tab-btn" onclick="switchGame('dice')">æ˜Ÿé‹éª°</button>
    </div>

    <div class="stage" id="gameStage">
        
        <div class="bet-panel" id="betPanel" style="display:none;">
            <div style="color:#94a3b8; margin-bottom:10px;">ä¸‹æ³¨ç±Œç¢¼</div>
            <div class="bet-input-group">
                <input type="number" id="betAmount" class="bet-input" value="100" min="1">
                <button class="btn-all-in" onclick="setAllIn()">å…¨æŠ¼</button>
            </div>
            
            <div id="diceSelector" class="dice-control-panel" style="display:none;">
                <div class="dice-header"><i class="fa-solid fa-meteor"></i> é¸æ“‡æ‚¨çš„å¹¸é‹æ˜Ÿæ•¸</div>
                <div class="dice-selector">
                    <button class="dice-btn" onclick="selectDiceNumber(1)">1</button>
                    <button class="dice-btn" onclick="selectDiceNumber(2)">2</button>
                    <button class="dice-btn" onclick="selectDiceNumber(3)">3</button>
                    <button class="dice-btn" onclick="selectDiceNumber(4)">4</button>
                    <button class="dice-btn" onclick="selectDiceNumber(5)">5</button>
                    <button class="dice-btn" onclick="selectDiceNumber(6)">6</button>
                </div>
            </div>

            <button class="btn-action" id="btnStart" onclick="startGame()">é–‹å§‹</button>
        </div>

        <div id="gameWheel" style="display:block;">
            <div style="text-align:center; color:#94a3b8; margin-bottom:20px;">
                <i class="fa-solid fa-gift"></i> æ¯æ—¥å…è²»ç¦åˆ©ï¼Œäººäººæœ‰ç
            </div>
            <div class="wheel-container">
                <div class="wheel-pointer"></div>
                
                <canvas id="wheelCanvas" width="300" height="300"></canvas>
                <button class="wheel-center" onclick="spinWheel()">GO</button>
                
                <div id="wheelCooldown" class="cooldown-overlay" style="display:none;">
                    <i class="fa-solid fa-hourglass-half" style="font-size:3rem; margin-bottom:10px;"></i>
                    <div>å†·å»ä¸­</div>
                    <div class="timer-text" id="cooldownTimer">00:00:00</div>
                </div>
            </div>
        </div>

        <div id="gameHighCard" style="display:none;">
            <div style="display:flex; justify-content:space-around; align-items: center; flex-wrap: wrap;">
                <div style="flex:1;">
                    <div style="margin-bottom:15px; color:#94a3b8; font-weight:bold; letter-spacing:1px;">èŠå®¶ (åŸºæº–)</div>
                    <div class="card-area" id="hcHouseCard"><div class="poker-card card-back"></div></div>
                </div>
                <div style="font-size:1.5rem; font-weight:bold; color:#64748b; padding:0 10px; font-style:italic;">VS</div>
                <div style="flex:1;">
                    <div style="margin-bottom:15px; color:#94a3b8; font-weight:bold; letter-spacing:1px;">æ‚¨ (çŒœä¸‹ä¸€å¼µ)</div>
                    <div class="card-area" id="hcPlayerCard"><div class="poker-card card-back" style="opacity:0.5;"></div></div>
                </div>
            </div>
            <div class="choice-panel" id="hcChoices">
                <button class="btn-choice btn-big" onclick="guessHighCard('big')"><i class="fa-solid fa-arrow-trend-up"></i> å¤§ BIG</button>
                <button class="btn-choice btn-small" onclick="guessHighCard('small')"><i class="fa-solid fa-arrow-trend-down"></i> å° SMALL</button>
            </div>
        </div>

        <div id="gameBlackjack" style="display:none;">
            <div style="margin-bottom:30px;">
                <div style="color:#94a3b8; margin-bottom:10px; letter-spacing:1px;">
                    <i class="fa-solid fa-user-secret"></i> èŠå®¶ <span id="bjHouseScore" class="score-box" style="color:#fff;">?</span>
                </div>
                <div class="card-area" id="bjHouseArea">
                    <div class="poker-card card-back" style="opacity:0.2; border:1px dashed #666; background:transparent;"></div>
                    <div class="poker-card card-back" style="opacity:0.2; border:1px dashed #666; background:transparent;"></div>
                </div>
            </div>
            <div>
                <div style="color:var(--main-gold); margin-bottom:10px; font-weight:bold; letter-spacing:1px;">
                    <i class="fa-solid fa-user"></i> æ‚¨ <span id="bjPlayerScore" class="score-box" style="color:var(--main-gold);">0</span>
                </div>
                <div class="card-area" id="bjPlayerArea">
                    <div class="poker-card card-back" style="opacity:0.2; border:1px dashed #666; background:transparent;"></div>
                    <div class="poker-card card-back" style="opacity:0.2; border:1px dashed #666; background:transparent;"></div>
                </div>
            </div>
            <div class="bj-controls" id="bjControls">
                <button class="btn-bj btn-hit" onclick="bjHit()"><i class="fa-solid fa-plus"></i> å«ç‰Œ</button>
                <button class="btn-bj btn-stand" onclick="bjStand()"><i class="fa-solid fa-hand"></i> åœç‰Œ</button>
            </div>
        </div>

        <div id="gameDice" style="display:none;">
            <div class="dice-container">
                <div class="dice-glow"></div>
                <div class="dice-display"><i class="fa-solid fa-dice-d6" id="diceIcon"></i></div>
            </div>
            <div id="diceStatus" style="color:#d946ef; margin-top:20px; font-weight:bold; letter-spacing:1px;">ç­‰å¾…æ˜Ÿé‹é™è‡¨...</div>
        </div>

        <div id="resultMsg" class="result-msg"></div>
    </div>

    <div class="bottom-float-bar">
        <div class="double-up-panel" id="doubleUpPanel">
            <button class="btn-collect" onclick="collectWinnings()"><i class="fa-solid fa-check"></i> æ”¶ä¸‹çé‡‘</button>
            <button class="btn-double" onclick="doubleUp()"><i class="fa-solid fa-bolt"></i> åŠ å€å†æˆ°</button>
        </div>
        <button id="btnReset" onclick="resetTable()">å†ä¾†ä¸€å±€</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, runTransaction, collection, serverTimestamp, setDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAo6on0f2QUbPaRfxpIEb2uvhKxDvPUvs",
            authDomain: "yulubox.firebaseapp.com",
            projectId: "yulubox",
            storageBucket: "yulubox.firebasestorage.app",
            messagingSenderId: "256466567852",
            appId: "1:256466567852:web:233b74668908ffcb9b9509",
            measurementId: "G-YPCY41EKWX"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentBalance = 0;
        let currentGame = 'wheel'; 
        let selectedDice = null;
        let gameState = { bet: 0, isAllIn: false, pendingWinnings: 0, dealerCard: null, bjPlayerCards: [], bjHouseCards: [], bjDeck: [], isPlayerTurn: true };

        const canvas = document.getElementById('fxCanvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function createConfetti() {
            particles = [];
            for(let i=0; i<120; i++) particles.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height - canvas.height, vx: Math.random()*4-2, vy: Math.random()*5+2, color: `hsl(${Math.random()*50+40},100%,60%)`, size: Math.random()*8+4 });
            animateConfetti();
        }
        function animateConfetti() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let active = false;
            particles.forEach(p => { p.x += p.vx; p.y += p.vy; if(p.y < canvas.height) { active = true; ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size); } });
            if(active) requestAnimationFrame(animateConfetti);
        }

        window.closeTerms = () => { document.getElementById('termsOverlay').style.display = 'none'; }

        onAuthStateChanged(auth, async (user) => {
            if (user) { 
                currentUser = user; 
                updateBalanceDisplay();
                initWheel(); 
                checkDailyStatus();
            } else { window.location.href = "login.html"; }
        });

        async function updateBalanceDisplay() {
            const docSnap = await getDoc(doc(db, "users", currentUser.uid));
            if(docSnap.exists()) {
                currentBalance = docSnap.data().stars || 0;
                document.getElementById('userStars').innerText = currentBalance;
                const c = document.getElementById('balanceBadge'); c.classList.remove('balance-update'); void c.offsetWidth; c.classList.add('balance-update');
            }
        }

        window.switchGame = (game) => {
            currentGame = game;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            // åˆ‡æ›é¡¯ç¤ºå€åŸŸ
            document.getElementById('gameHighCard').style.display = game === 'highcard' ? 'block' : 'none';
            document.getElementById('gameBlackjack').style.display = game === 'blackjack' ? 'block' : 'none';
            document.getElementById('gameDice').style.display = game === 'dice' ? 'block' : 'none';
            document.getElementById('gameWheel').style.display = game === 'wheel' ? 'block' : 'none';
            
            // ğŸ”¥ è¼ªç›¤æ¨¡å¼éš±è—ä¸‹æ³¨å€
            document.getElementById('betPanel').style.display = game === 'wheel' ? 'none' : 'block';
            
            // éª°å­æ¨¡å¼é¡¯ç¤ºé¸æ“‡å™¨
            document.getElementById('diceSelector').style.display = game === 'dice' ? 'flex' : 'none';
            
            resetTable();
        };

        // --- ğŸ¡ è¼ªç›¤çé …é…ç½® (12æ ¼) ---
        const prizes = [
            { text: "+100", value: 100, color: "#eab308" }, // 12é»é˜
            { text: "éŠ˜è¬", value: 0, color: "#64748b" },
            { text: "+1", value: 1, color: "#0ea5e9" },
            { text: "+10", value: 10, color: "#10b981" },
            { text: "+5", value: 5, color: "#0ea5e9" },
            { text: "å†è½‰", value: "spin", color: "#f97316" }, // 6é»é˜
            { text: "+50", value: 50, color: "#eab308" },
            { text: "+1", value: 1, color: "#0ea5e9" },
            { text: "+5", value: 5, color: "#10b981" },
            { text: "-10", value: -10, color: "#ef4444" },
            { text: "+20", value: 20, color: "#10b981" },
            { text: "+200", value: 200, color: "#8b5cf6" } // å¤§ç
        ];
        
        let wheelCtx;
        function initWheel() {
            const canvas = document.getElementById('wheelCanvas');
            if(!canvas) return;
            wheelCtx = canvas.getContext('2d');
            drawWheel(0);
        }

        function drawWheel(angleOffset) {
            const ctx = wheelCtx;
            const centerX = 150;
            const centerY = 150;
            const radius = 145;
            const step = (2 * Math.PI) / prizes.length;

            ctx.clearRect(0, 0, 300, 300);
            
            // å¤–æ¡†
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius + 2, 0, 2 * Math.PI);
            ctx.fillStyle = "#FFD700";
            ctx.fill();

            for (let i = 0; i < prizes.length; i++) {
                // èª¿æ•´èµ·å§‹è§’åº¦ (-90åº¦è®“ç¬¬ä¸€å€‹çé …åœ¨æ­£ä¸Šæ–¹)
                const angle = i * step + angleOffset - (Math.PI / 2);
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, angle, angle + step);
                ctx.fillStyle = prizes[i].color;
                ctx.fill();
                ctx.stroke();

                // æ–‡å­—
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(angle + step / 2);
                ctx.textAlign = "right";
                ctx.fillStyle = "#fff";
                ctx.font = "bold 14px Arial";
                ctx.shadowColor = "rgba(0,0,0,0.5)";
                ctx.shadowBlur = 2;
                ctx.fillText(prizes[i].text, radius - 15, 5);
                ctx.restore();
            }
        }

        async function checkDailyStatus() {
            const docSnap = await getDoc(doc(db, "users", currentUser.uid));
            if(docSnap.exists()) {
                const lastSpin = docSnap.data().lastDailySpin ? docSnap.data().lastDailySpin.toDate().getTime() : 0;
                const now = Date.now();
                // 24å°æ™‚å†·å»
                if (now - lastSpin < 24 * 60 * 60 * 1000) {
                    lockWheel(lastSpin + 24 * 60 * 60 * 1000);
                }
            }
        }

        function lockWheel(targetTime) {
            const overlay = document.getElementById('wheelCooldown');
            const timer = document.getElementById('cooldownTimer');
            overlay.style.display = 'flex';
            
            const updateTimer = () => {
                const now = Date.now();
                const diff = targetTime - now;
                if (diff <= 0) {
                    overlay.style.display = 'none';
                    return;
                }
                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                timer.innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                requestAnimationFrame(updateTimer);
            };
            updateTimer();
        }

        window.spinWheel = async () => {
            const resultIndex = Math.floor(Math.random() * prizes.length); // éš¨æ©Ÿçµæœ
            const spinDuration = 4500; // 4.5ç§’
            
            // è¨ˆç®—ç›®æ¨™è§’åº¦ (æŒ‡é‡å›ºå®šåœ¨ä¸Šæ–¹ 270åº¦/-90åº¦)
            const targetAngle = (360 * 5) + (360 - (resultIndex * (360/12))) - (360/24); 
            
            let startTime = null;

            function animate(time) {
                if (!startTime) startTime = time;
                const progress = (time - startTime) / spinDuration;
                
                if (progress < 1) {
                    // Cubic Ease Out
                    const ease = 1 - Math.pow(1 - progress, 3);
                    const currentAngle = targetAngle * ease;
                    const rad = (currentAngle * Math.PI) / 180;
                    drawWheel(rad);
                    requestAnimationFrame(animate);
                } else {
                    const rad = (targetAngle * Math.PI) / 180;
                    drawWheel(rad);
                    handleWheelResult(prizes[resultIndex]);
                }
            }
            requestAnimationFrame(animate);
        };

        async function handleWheelResult(prize) {
            let msg = "";
            let amount = 0;

            if (prize.value === "spin") {
                alert("é‹æ°£ä¸éŒ¯ï¼ç²å¾—ã€Œå†è½‰ä¸€æ¬¡ã€æ©Ÿæœƒï¼");
                return; // ä¸å¯«å…¥å†·å»
            } else {
                amount = prize.value;
                if (amount > 0) {
                    msg = `æ­å–œç²å¾— ${amount} æ˜Ÿæ˜Ÿï¼`;
                    createConfetti();
                } else if (amount < 0) {
                    msg = `å“å‘€ï¼æ‰£é™¤ ${Math.abs(amount)} æ˜Ÿæ˜Ÿ`;
                } else {
                    msg = "éŠ˜è¬æƒ é¡§ï¼Œæ˜å¤©å†ä¾†ï¼";
                }
            }

            alert(msg);

            // æ›´æ–°è³‡æ–™åº«
            try {
                const userRef = doc(db, "users", currentUser.uid);
                await runTransaction(db, async (t) => {
                    const docSnap = await t.get(userRef);
                    const current = docSnap.data().stars || 0;
                    t.update(userRef, { 
                        stars: current + amount,
                        lastDailySpin: serverTimestamp() // è¨­å®šå†·å»
                    });
                    
                    t.set(doc(collection(db, "transactions")), {
                        userId: currentUser.uid,
                        action: "daily_spin",
                        itemName: "æ˜Ÿä¹‹è¼ªç›¤",
                        amount: amount,
                        timestamp: serverTimestamp()
                    });
                });
                updateBalanceDisplay();
                lockWheel(Date.now() + 24 * 60 * 60 * 1000); // é–å®š
            } catch(e) { console.error(e); }
        }

        // --- å…±ç”¨é‚è¼¯ (ç¶­æŒä¸è®Š) ---
        window.selectDiceNumber = (num) => {
            selectedDice = num;
            document.querySelectorAll('.dice-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.dice-btn')[num-1].classList.add('selected');
        }

        window.setAllIn = () => { document.getElementById('betAmount').value = currentBalance; };

        window.resetTable = () => {
            document.getElementById('betPanel').style.display = 'block';
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnReset').style.display = 'none';
            document.getElementById('doubleUpPanel').style.display = 'none';
            document.getElementById('resultMsg').innerText = '';
            document.getElementById('resultMsg').className = 'result-msg';
            document.getElementById('betAmount').disabled = false;
            document.getElementById('gameStage').classList.remove('winner-glow', 'loser-shake');
            document.getElementById('hcChoices').style.display = 'none';

            // æ¸…ç©ºéª°å­
            document.getElementById('diceIcon').className = 'fa-solid fa-dice-d6';
            document.getElementById('diceStatus').innerText = 'ç­‰å¾…æ˜Ÿé‹é™è‡¨...';
            
            // æ¸…ç©ºç‰Œæ¡Œ
            document.getElementById('hcPlayerCard').innerHTML = '<div class="poker-card card-back" style="opacity:0.5;"></div>';
            document.getElementById('hcHouseCard').innerHTML = '<div class="poker-card card-back"></div>';
            document.getElementById('bjPlayerArea').innerHTML = '<div class="poker-card card-back" style="opacity:0.3; border:1px dashed #666; background:transparent;"></div><div class="poker-card card-back" style="opacity:0.3; border:1px dashed #666; background:transparent;"></div>';
            document.getElementById('bjHouseArea').innerHTML = '<div class="poker-card card-back" style="opacity:0.3; border:1px dashed #666; background:transparent;"></div><div class="poker-card card-back" style="opacity:0.3; border:1px dashed #666; background:transparent;"></div>';
            document.getElementById('bjControls').style.display = 'none';
            document.getElementById('bjPlayerScore').innerText = '0';
            document.getElementById('bjHouseScore').innerText = '?';

            gameState.pendingWinnings = 0;
        };

        const SUITS = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
        const VALUES = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        const DICE_ICONS = ['fa-dice-one', 'fa-dice-two', 'fa-dice-three', 'fa-dice-four', 'fa-dice-five', 'fa-dice-six'];

        function createDeck() {
            let deck = [];
            for(let s of SUITS) {
                for(let i=0; i<VALUES.length; i++) {
                    deck.push({ suit: s, text: VALUES[i], value: i + 2, bjValue: (i >= 8 && i <= 11) ? 10 : (i===12 ? 11 : i+2) });
                }
            }
            return deck.sort(() => Math.random() - 0.5);
        }

        function createCardElement(card) {
            const colorClass = (card.suit === 'â™¥' || card.suit === 'â™¦') ? 'card-red' : 'card-black';
            const div = document.createElement('div');
            div.className = `poker-card ${colorClass} deal-anim`;
            div.innerHTML = `
                <div class="card-corner top-left"><div>${card.text}</div><div>${card.suit}</div></div>
                <div class="card-center">${card.suit}</div>
                <div class="card-corner bottom-right"><div>${card.text}</div><div>${card.suit}</div></div>
            `;
            return div;
        }

        function createCardBack() {
            const div = document.createElement('div');
            div.className = 'poker-card card-back deal-anim';
            return div;
        }

        window.startGame = async (isDoubleUp = false) => {
            const betInput = document.getElementById('betAmount');
            let bet = parseInt(betInput.value);
            if(isDoubleUp && gameState.pendingWinnings > 0) bet = gameState.pendingWinnings;

            if(isNaN(bet) || bet <= 0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡");
            
            if(currentGame === 'dice' && !selectedDice && !isDoubleUp) return alert("è«‹å…ˆé æ¸¬æ˜Ÿé‹é»æ•¸ï¼");

            if(!isDoubleUp) {
                if(bet > currentBalance) return alert("é¤˜é¡ä¸è¶³ï¼");
                try {
                    await runTransaction(db, async (transaction) => {
                        const userRef = doc(db, "users", currentUser.uid);
                        const userDoc = await transaction.get(userRef);
                        const bal = userDoc.data().stars || 0;
                        if(bal < bet) throw "é¤˜é¡ä¸è¶³";
                        transaction.update(userRef, { stars: bal - bet });
                        transaction.set(doc(collection(db, "transactions")), { userId: currentUser.uid, action: "gamble_bet", itemName: currentGame, amount: -bet, timestamp: serverTimestamp() });
                    });
                    updateBalanceDisplay();
                } catch(e) { alert("äº¤æ˜“å¤±æ•—: " + e); return; }
            }

            gameState.bet = bet;
            gameState.isAllIn = (bet === currentBalance);
            gameState.isPlayerTurn = true;
            gameState.pendingWinnings = 0;

            document.getElementById('betPanel').style.display = 'none';
            document.getElementById('doubleUpPanel').style.display = 'none';
            document.getElementById('resultMsg').innerText = "éŠæˆ²é€²è¡Œä¸­...";
            document.getElementById('gameStage').classList.remove('winner-glow', 'loser-shake');

            if(currentGame === 'highcard') startHighCard();
            else if(currentGame === 'blackjack') startBlackjack();
            else startDiceGame();
        };

        function startDiceGame() {
            const diceIcon = document.getElementById('diceIcon');
            const status = document.getElementById('diceStatus');
            diceIcon.className = 'fa-solid fa-dice-d6 dice-rolling';
            status.innerText = 'æ˜Ÿé‹æµè½‰ä¸­...';
            let rollCount = 0;
            const rollAnim = setInterval(() => {
                const randomFace = Math.floor(Math.random() * 6);
                diceIcon.className = `fa-solid ${DICE_ICONS[randomFace]}`;
                rollCount++;
                if (rollCount > 15) { clearInterval(rollAnim); finalizeDice(); }
            }, 100);
        }

        function finalizeDice() {
            const isWin = Math.random() < 0.3; // 30%
            let result;
            if (isWin) { result = selectedDice; } 
            else { do { result = Math.floor(Math.random() * 6) + 1; } while (result === selectedDice); }

            const diceIcon = document.getElementById('diceIcon');
            diceIcon.className = `fa-solid ${DICE_ICONS[result-1]}`;
            
            setTimeout(() => {
                if (isWin) {
                    document.getElementById('diceStatus').innerText = `æ˜Ÿé‹é™è‡¨ï¼é–‹å‡º ${result}ï¼`;
                    handleWin(3, "æ˜Ÿé‹çˆ†ç™¼ï¼ç²å¾—3å€çé‡‘ï¼");
                } else {
                    document.getElementById('diceStatus').innerText = `é–‹å‡º ${result}ï¼Œæ˜Ÿé‹æœªåˆ°`;
                    handleLose(`é–‹å‡º ${result}ï¼ŒæŒ‘æˆ°å¤±æ•—`);
                }
            }, 500);
        }

        function startHighCard() {
            setTimeout(() => {
                const deck = createDeck();
                gameState.bjDeck = deck;
                gameState.dealerCard = deck.pop();
                const hArea = document.getElementById('hcHouseCard');
                hArea.innerHTML = '';
                hArea.appendChild(createCardElement(gameState.dealerCard));
                document.getElementById('resultMsg').innerText = "è«‹çŒœæ¸¬ä¸‹ä¸€å¼µç‰Œ...";
                document.getElementById('hcChoices').style.display = 'flex';
            }, 500);
        }

        window.guessHighCard = (choice) => {
            document.getElementById('hcChoices').style.display = 'none';
            let playerCard = gameState.bjDeck.pop();
            if (gameState.isAllIn && Math.random() > 0.001) {
                if (choice === 'big') { while(playerCard.value >= gameState.dealerCard.value && gameState.bjDeck.length > 0) playerCard = gameState.bjDeck.pop(); }
                else { while(playerCard.value <= gameState.dealerCard.value && gameState.bjDeck.length > 0) playerCard = gameState.bjDeck.pop(); }
            }
            const pArea = document.getElementById('hcPlayerCard');
            pArea.innerHTML = '';
            pArea.appendChild(createCardElement(playerCard));
            setTimeout(() => {
                let win = false; let tie = false;
                if (choice === 'big') { if (playerCard.value > gameState.dealerCard.value) win = true; else if (playerCard.value === gameState.dealerCard.value) tie = true; }
                else { if (playerCard.value < gameState.dealerCard.value) win = true; else if (playerCard.value === gameState.dealerCard.value) tie = true; }
                if (win) handleWin(2, "çŒœä¸­ï¼ç²å‹ï¼"); else if (tie) handleWin(1, "å¹³æ‰‹"); else handleLose();
            }, 600);
        }

        function startBlackjack() {
            gameState.bjDeck = createDeck();
            gameState.bjPlayerCards = [];
            gameState.bjHouseCards = [];
            document.getElementById('bjPlayerArea').innerHTML = ''; 
            document.getElementById('bjHouseArea').innerHTML = '';
            const dealSequence = async () => {
                gameState.bjPlayerCards.push(gameState.bjDeck.pop()); renderBJ(false); await new Promise(r => setTimeout(r, 400));
                gameState.bjHouseCards.push(gameState.bjDeck.pop()); renderBJ(false); await new Promise(r => setTimeout(r, 400));
                gameState.bjPlayerCards.push(gameState.bjDeck.pop()); renderBJ(false); await new Promise(r => setTimeout(r, 400));
                gameState.bjHouseCards.push(gameState.bjDeck.pop()); renderBJ(false);
                document.getElementById('bjControls').style.display = 'flex';
                document.getElementById('resultMsg').innerText = "è«‹é¸æ“‡è¡Œå‹•";
                if(getBJScore(gameState.bjPlayerCards) === 21) bjStand();
            };
            dealSequence();
        }

        function renderBJ(revealDealer = false) {
            const pDiv = document.getElementById('bjPlayerArea');
            const hDiv = document.getElementById('bjHouseArea');
            pDiv.innerHTML = '';
            gameState.bjPlayerCards.forEach(c => pDiv.appendChild(createCardElement(c)));
            document.getElementById('bjPlayerScore').innerText = getBJScore(gameState.bjPlayerCards);
            hDiv.innerHTML = '';
            if (gameState.bjHouseCards.length > 0) {
                if (!revealDealer && gameState.isPlayerTurn) {
                    hDiv.appendChild(createCardElement(gameState.bjHouseCards[0])); 
                    hDiv.appendChild(createCardBack()); 
                    document.getElementById('bjHouseScore').innerText = "?";
                } else {
                    gameState.bjHouseCards.forEach(c => hDiv.appendChild(createCardElement(c)));
                    document.getElementById('bjHouseScore').innerText = getBJScore(gameState.bjHouseCards);
                }
            }
        }

        function getBJScore(cards) {
            let score = 0; let aces = 0;
            for(let c of cards) { score += c.bjValue; if(c.text === 'A') aces++; }
            while(score > 21 && aces > 0) { score -= 10; aces--; }
            return score;
        }

        window.bjHit = () => {
            if(gameState.bjPlayerCards.length >= 3) return alert("å·²é”3å¼µä¸Šé™");
            gameState.bjPlayerCards.push(gameState.bjDeck.pop()); renderBJ(false);
            if(getBJScore(gameState.bjPlayerCards) > 21) {
                gameState.isPlayerTurn = false; renderBJ(true);
                handleLose("çˆ†ç‰Œï¼æ‚¨è¼¸äº†");
                document.getElementById('bjControls').style.display = 'none';
            } else if (gameState.bjPlayerCards.length === 3) bjStand();
        };

        window.bjStand = () => {
            document.getElementById('bjControls').style.display = 'none';
            gameState.isPlayerTurn = false;
            if(gameState.isAllIn && Math.random() > 0.001) {
                const pScore = getBJScore(gameState.bjPlayerCards);
                while(getBJScore(gameState.bjHouseCards) <= pScore && getBJScore(gameState.bjHouseCards) < 21 && gameState.bjHouseCards.length < 3) gameState.bjHouseCards.push(gameState.bjDeck.pop());
                if(getBJScore(gameState.bjHouseCards) < pScore) { let last = gameState.bjHouseCards[gameState.bjHouseCards.length-1]; last.bjValue = 10; last.text = "K"; }
            } else {
                while(getBJScore(gameState.bjHouseCards) < 17 && gameState.bjHouseCards.length < 3) gameState.bjHouseCards.push(gameState.bjDeck.pop());
            }
            renderBJ(true);
            const pScore = getBJScore(gameState.bjPlayerCards);
            const hScore = getBJScore(gameState.bjHouseCards);
            setTimeout(() => {
                if (hScore > 21) handleWin(2, "èŠå®¶çˆ†ç‰Œï¼æ‚¨è´äº†ï¼");
                else if (pScore > hScore) handleWin(2, "æ‚¨è´äº†ï¼");
                else if (pScore < hScore) handleLose("èŠå®¶ç²å‹");
                else handleWin(1, "å¹³æ‰‹ï¼Œé€€å›");
            }, 600);
        };

        function handleWin(multiplier, msg) {
            const resultDiv = document.getElementById('resultMsg');
            resultDiv.innerText = msg; resultDiv.className = "result-msg win";
            document.getElementById('gameStage').classList.add('winner-glow');
            if(multiplier > 1) createConfetti();
            const totalWin = Math.floor(gameState.bet * multiplier);
            gameState.pendingWinnings = totalWin;
            if(multiplier === 1 || currentGame === 'dice') { collectWinnings(); } 
            else {
                document.getElementById('doubleUpPanel').style.display = 'flex';
                document.querySelector('.btn-collect').innerHTML = `<i class="fa-solid fa-sack-dollar"></i> æ”¶ä¸‹ ${totalWin}`;
                document.querySelector('.btn-double').innerHTML = `<i class="fa-solid fa-bolt"></i> ${totalWin} åŠ å€å†æˆ°`;
            }

            // ğŸ”¥ è‡ªå‹•ç™¼å¸ƒæ¦®è­½æ¦œ (Auto Honor)
            if (totalWin >= 500) {
                try {
                    addDoc(collection(db, "bulletin_board"), {
                        type: 'honor',
                        content: `æ­å–œ ${currentUser.displayName} åœ¨ã€${currentGame === 'dice' ? 'æ˜Ÿé‹éª°' : (currentGame === 'highcard' ? 'æ¯”å¤§å°' : '21é»')}ã€‘è´å¾—äº† ${totalWin} æ˜Ÿæ˜Ÿï¼`,
                        authorId: 'system',
                        timestamp: serverTimestamp()
                    });
                } catch(e) { console.log("Honor post failed", e); }
            }
        }

        function handleLose(msg = "æŒ‘æˆ°å¤±æ•—") {
            document.getElementById('resultMsg').innerText = msg;
            document.getElementById('resultMsg').className = "result-msg lose";
            document.getElementById('gameStage').classList.add('loser-shake');
            document.getElementById('btnReset').style.display = 'block';
            gameState.pendingWinnings = 0;
        }

        window.collectWinnings = async () => {
            document.getElementById('doubleUpPanel').style.display = 'none';
            const winAmount = gameState.pendingWinnings;
            if (winAmount > 0) {
                try {
                    await runTransaction(db, async (transaction) => {
                        const userRef = doc(db, "users", currentUser.uid);
                        const userDoc = await transaction.get(userRef);
                        const bal = userDoc.data().stars || 0;
                        transaction.update(userRef, { stars: bal + winAmount });
                        transaction.set(doc(collection(db, "transactions")), { userId: currentUser.uid, action: "gamble_win", itemName: currentGame, amount: winAmount, timestamp: serverTimestamp() });
                    });
                    updateBalanceDisplay();
                    if(currentGame !== 'dice') alert(`å·²å°‡ ${winAmount} æ˜Ÿæ˜Ÿå­˜å…¥å¸³æˆ¶ï¼`);
                } catch(e) { console.error(e); }
            }
            if(currentGame === 'dice') document.getElementById('btnReset').style.display = 'block';
            else resetTable();
        };

        window.doubleUp = () => { startGame(true); };
    </script>
</body>
</html>