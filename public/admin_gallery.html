<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å“¡åœ–åº« (Pro) - ç‰éœ²å¯¶åº«</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg-dark: #050510; --neon-cyan: #00f3ff; --neon-green: #00ff9d; --neon-red: #ff4757; }
        body { background-color: var(--bg-dark); color: #fff; font-family: 'Microsoft JhengHei', sans-serif; margin: 0; padding: 20px; }
        
        /* é ‚éƒ¨å°èˆª */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        h1 { margin: 0; color: var(--neon-cyan); font-size: 1.5rem; }
        
        /* å·¥å…·åˆ— */
        .toolbar { display: flex; gap: 10px; }
        .tool-btn {
            background: #222; color: #fff; border: 1px solid #444; padding: 8px 15px; border-radius: 5px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 5px; font-weight: bold;
        }
        .tool-btn:hover { background: #333; border-color: #666; }
        
        /* åˆªé™¤æ¨¡å¼æŒ‰éˆ•ç‰¹æ•ˆ */
        .btn-select-mode.active { background: var(--neon-cyan); color: #000; border-color: var(--neon-cyan); }
        .btn-delete { background: var(--neon-red); color: #fff; border-color: var(--neon-red); display: none; }
        .btn-delete:hover { background: #ff6b81; box-shadow: 0 0 15px rgba(255, 71, 87, 0.4); }

        /* ç¶²æ ¼ä½ˆå±€ */
        .gallery-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px; 
        }
        
        /* åœ–ç‰‡å¡ç‰‡ */
        .img-card {
            background: #111; border: 1px solid #333; border-radius: 12px; overflow: hidden;
            transition: 0.2s; position: relative; display: flex; flex-direction: column;
        }
        
        /* âš ï¸ é¸ä¸­ç‹€æ…‹ (åˆªé™¤æ¨¡å¼) */
        .img-card.selected {
            border: 2px solid var(--neon-red);
            box-shadow: 0 0 15px rgba(255, 71, 87, 0.3);
            transform: scale(0.95);
        }
        .img-card.selected::after {
            content: "\f00c"; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; top: 10px; right: 10px;
            background: var(--neon-red); color: #fff; width: 30px; height: 30px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            z-index: 20; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .img-wrapper { width: 100%; height: 180px; background: #000; overflow: hidden; display: flex; align-items: center; justify-content: center; position: relative; }
        .img-thumb { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        
        /* åˆªé™¤æ¨¡å¼ä¸‹ï¼Œç¦æ­¢åœ–ç‰‡æ”¾å¤§ç‰¹æ•ˆï¼Œæ”¹æˆé»æ“Šæ‰‹å‹ */
        .gallery-grid.select-mode .img-card { cursor: pointer; }
        .gallery-grid:not(.select-mode) .img-card:hover .img-thumb { transform: scale(1.1); }
        
        .img-info { padding: 12px; font-size: 0.8rem; color: #aaa; border-bottom: 1px solid #222; pointer-events: none; /* é˜²æ­¢é»æ“Šæ–‡å­— */ }
        .user-tag { color: var(--neon-cyan); display: block; margin-bottom: 3px; font-weight: bold; }
        .filename { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; margin-bottom: 5px; color: #fff; }

        /* æ§åˆ¶é¢æ¿ */
        .controls { padding: 12px; background: rgba(255,255,255,0.03); transition: 0.3s; }
        
        /* ç•¶é€²å…¥é¸å–æ¨¡å¼æ™‚ï¼Œéš±è—æ§åˆ¶é¢æ¿ï¼Œé¿å…èª¤è§¸ */
        .gallery-grid.select-mode .controls { opacity: 0.2; pointer-events: none; filter: blur(2px); }

        .quality-group { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.8rem; }
        .quality-val { color: var(--neon-green); font-weight: bold; }
        input[type=range] { width: 100%; height: 5px; background: #333; outline: none; -webkit-appearance: none; border-radius: 5px; margin-bottom: 10px; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 15px; height: 15px; background: var(--neon-cyan); border-radius: 50%; cursor: pointer; }
        .btn-group { display: flex; gap: 8px; }
        .action-btn { flex: 1; padding: 8px 0; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-orig { background: transparent; border: 1px solid #555; color: #aaa; }
        .btn-orig:hover { border-color: #fff; color: #fff; background: rgba(255,255,255,0.1); }
        .btn-comp { background: linear-gradient(90deg, #0072ff, var(--neon-cyan)); color: #000; border: none; }
        .btn-comp:hover { filter: brightness(1.2); }
        .processing-mask { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; color: var(--neon-cyan); font-weight: bold; font-size: 0.9rem; z-index: 10; }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fa-solid fa-sliders"></i> é›²ç«¯åœ–åº«ç®¡ç† Pro</h1>
        
        <div class="toolbar">
            <button class="tool-btn btn-select-mode" id="btnSelectMode" onclick="toggleSelectMode()">
                <i class="fa-solid fa-check-double"></i> é¸å–æ¨¡å¼
            </button>
            <button class="tool-btn btn-delete" id="btnDelete" onclick="deleteSelectedItems()">
                <i class="fa-solid fa-trash-can"></i> åˆªé™¤ (<span id="selectCount">0</span>)
            </button>
            <a href="vip_area.html" class="tool-btn" style="text-decoration:none; background:#333;">
                <i class="fa-solid fa-arrow-left"></i> é›¢é–‹
            </a>
        </div>
    </div>

    <div class="gallery-grid" id="gallery">
        <p style="color:#aaa;">æ­£åœ¨é€£æ¥è³‡æ–™åº«...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, orderBy, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ğŸ”¥ è¨­å®šå€ (è«‹ç¢ºèªé€™æ˜¯æ‚¨æ­£ç¢ºçš„ Config)
        const firebaseConfig = {
            apiKey: "AIzaSyAAo6on0f2QUbPaRfxpIEb2uvhKxDvPUvs",
            authDomain: "yulubox.firebaseapp.com",
            projectId: "yulubox",
            storageBucket: "yulubox.firebasestorage.app",
            messagingSenderId: "256466567852",
            appId: "1:256466567852:web:233b74668908ffcb9b9509",
            measurementId: "G-YPCY41EKWX"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        // ç‹€æ…‹è®Šæ•¸
        let isSelectMode = false;
        let selectedItems = new Set(); // å„²å­˜è¢«é¸ä¸­çš„ Doc ID
        let allDocsData = {}; // æš«å­˜è³‡æ–™ï¼Œä»¥ä¾¿åˆªé™¤æ™‚æŸ¥æ‰¾ Storage URL

        onAuthStateChanged(auth, (user) => {
            if (user) loadGallery();
            else window.location.href = 'login.html';
        });

        async function loadGallery() {
            const galleryDiv = document.getElementById('gallery');
            galleryDiv.innerHTML = '<p style="color:#aaa;">è®€å–ä¸­...</p>';

            try {
                const q = query(collection(db, "gallery"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    galleryDiv.innerHTML = '<p>ç›®å‰æ²’æœ‰åœ–ç‰‡ã€‚</p>';
                    return;
                }

                galleryDiv.innerHTML = ''; 

                querySnapshot.forEach((doc, index) => {
                    const data = doc.data();
                    const docId = doc.id;
                    allDocsData[docId] = data; // å­˜èµ·ä¾†ï¼Œåˆªé™¤æ™‚è¦ç”¨

                    const dateStr = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString() : 'å‰›å‰›';
                    const uniqueId = `img-${index}`;
                    
                    const card = document.createElement('div');
                    card.className = 'img-card';
                    card.id = `card-${docId}`; // ç¶å®š ID æ–¹ä¾¿æ“ä½œ
                    
                    // ç¶å®šé»æ“Šäº‹ä»¶ (è™•ç†é¸å–)
                    card.onclick = () => handleCardClick(docId);

                    card.innerHTML = `
                        <div class="img-wrapper" id="wrapper-${uniqueId}">
                            <div class="processing-mask" id="mask-${uniqueId}"><i class="fa-solid fa-circle-notch fa-spin"></i> è™•ç†ä¸­...</div>
                            <img src="${data.imageUrl}" class="img-thumb" loading="lazy">
                        </div>
                        <div class="img-info">
                            <span class="user-tag"><i class="fa-solid fa-user"></i> ${data.uploadedBy.split('@')[0]}</span>
                            <span class="filename" title="${data.fileName}">${data.fileName}</span>
                            <span style="font-size:0.7rem; color:#666;">${dateStr}</span>
                        </div>
                        
                        <div class="controls">
                            <div class="quality-group">
                                <span>å£“ç¸®å¼·åº¦</span>
                                <span class="quality-val" id="val-${uniqueId}">80%</span>
                            </div>
                            <input type="range" min="10" max="100" value="80" 
                                oninput="updateQualityDisplay('${uniqueId}', this.value); event.stopPropagation();" 
                                onclick="event.stopPropagation()"
                                id="range-${uniqueId}">
                            
                            <div class="btn-group">
                                <button class="action-btn btn-orig" onclick="downloadOriginal('${data.imageUrl}', '${data.fileName}'); event.stopPropagation();">
                                    <i class="fa-regular fa-image"></i> åŸåœ–
                                </button>
                                <button class="action-btn btn-comp" onclick="downloadCompressed('${uniqueId}', '${data.imageUrl}', '${data.fileName}'); event.stopPropagation();">
                                    <i class="fa-solid fa-compress"></i> å£“ç¸®
                                </button>
                            </div>
                        </div>
                    `;
                    galleryDiv.appendChild(card);
                });

            } catch (error) {
                console.error("Error:", error);
                galleryDiv.innerHTML = `<p style="color:red">è®€å–å¤±æ•—ï¼š${error.message}</p>`;
            }
        }

        // --- ğŸ—‘ï¸ æ‰¹é‡åˆªé™¤é‚è¼¯ ---

        window.toggleSelectMode = function() {
            isSelectMode = !isSelectMode;
            const grid = document.getElementById('gallery');
            const btn = document.getElementById('btnSelectMode');
            const delBtn = document.getElementById('btnDelete');

            if(isSelectMode) {
                btn.classList.add('active');
                btn.innerHTML = '<i class="fa-solid fa-times"></i> é€€å‡ºæ¨¡å¼';
                grid.classList.add('select-mode');
                delBtn.style.display = 'flex';
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fa-solid fa-check-double"></i> é¸å–æ¨¡å¼';
                grid.classList.remove('select-mode');
                delBtn.style.display = 'none';
                
                // æ¸…é™¤é¸å–
                selectedItems.clear();
                updateSelectUI();
                document.querySelectorAll('.img-card.selected').forEach(el => el.classList.remove('selected'));
            }
        }

        window.handleCardClick = function(docId) {
            if (!isSelectMode) return; // å¦‚æœä¸æ˜¯é¸å–æ¨¡å¼ï¼Œä»€éº¼éƒ½ä¸åš (è®“æŒ‰éˆ•åŠŸèƒ½æ­£å¸¸)

            const card = document.getElementById(`card-${docId}`);
            if (selectedItems.has(docId)) {
                selectedItems.delete(docId);
                card.classList.remove('selected');
            } else {
                selectedItems.add(docId);
                card.classList.add('selected');
            }
            updateSelectUI();
        }

        function updateSelectUI() {
            document.getElementById('selectCount').innerText = selectedItems.size;
        }

        window.deleteSelectedItems = async function() {
            if (selectedItems.size === 0) return alert('è«‹å…ˆé¸å–è¦åˆªé™¤çš„åœ–ç‰‡ï¼');
            if (!confirm(`âš ï¸ è­¦å‘Šï¼šå³å°‡æ°¸ä¹…åˆªé™¤ ${selectedItems.size} å¼µåœ–ç‰‡ï¼Œæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚\n\nç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ`)) return;

            const btn = document.getElementById('btnDelete');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> åˆªé™¤ä¸­...';
            btn.disabled = true;

            let successCount = 0;
            const itemsToDelete = Array.from(selectedItems); // è½‰æˆé™£åˆ—æ–¹ä¾¿è·‘è¿´åœˆ

            for (const docId of itemsToDelete) {
                const card = document.getElementById(`card-${docId}`);
                const data = allDocsData[docId];

                try {
                    // 1. åˆªé™¤ Storage ä¸­çš„å¯¦é«”æª”æ¡ˆ
                    // æˆ‘å€‘é€é imageUrl ä¾†å»ºç«‹ reference (é€™æ˜¯æœ€æº–ç¢ºçš„æ–¹æ³•)
                    if (data.imageUrl) {
                        const fileRef = ref(storage, data.imageUrl);
                        await deleteObject(fileRef).catch(err => console.warn("Storage åˆªé™¤ç•¥é (å¯èƒ½æª”æ¡ˆå·²ä¸å­˜åœ¨):", err));
                    }

                    // 2. åˆªé™¤ Firestore ä¸­çš„ç´€éŒ„
                    await deleteDoc(doc(db, "gallery", docId));

                    // 3. ç§»é™¤ç•«é¢å…ƒç´ 
                    card.style.opacity = '0';
                    setTimeout(() => card.remove(), 300);
                    successCount++;
                } catch (error) {
                    console.error("åˆªé™¤å¤±æ•—:", docId, error);
                    alert(`åˆªé™¤éƒ¨åˆ†å¤±æ•—ï¼š${error.message}`);
                }
            }

            // é‡ç½®ç‹€æ…‹
            selectedItems.clear();
            updateSelectUI();
            btn.innerHTML = '<i class="fa-solid fa-trash-can"></i> åˆªé™¤ (0)';
            btn.disabled = false;
            
            // é€€å‡ºé¸å–æ¨¡å¼
            toggleSelectMode();
            alert(`æ¸…ç†å®Œæˆï¼å…±åˆªé™¤ ${successCount} å¼µåœ–ç‰‡ã€‚`);
        }

        // --- æ—¢æœ‰çš„ä¸‹è¼‰é‚è¼¯ (åŠ äº† event.stopPropagation é˜²æ­¢è§¸ç™¼é¸å–) ---
        
        window.updateQualityDisplay = function(id, val) {
            document.getElementById(`val-${id}`).innerText = val + '%';
        }

        window.downloadOriginal = async function(url, fileName) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                saveBlob(blob, fileName);
            } catch (err) {
                window.open(url, '_blank');
            }
        }

        window.downloadCompressed = async function(id, url, fileName) {
            const qualityVal = document.getElementById(`range-${id}`).value;
            const quality = qualityVal / 100;
            const mask = document.getElementById(`mask-${id}`);
            mask.style.display = "flex";

            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const imgBitmap = await createImageBitmap(blob);
                const canvas = document.createElement('canvas');
                canvas.width = imgBitmap.width;
                canvas.height = imgBitmap.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(imgBitmap, 0, 0);

                canvas.toBlob((compressedBlob) => {
                    const nameParts = fileName.split('.');
                    nameParts.pop();
                    const newName = nameParts.join('.') + `_min_${qualityVal}.jpg`;
                    saveBlob(compressedBlob, newName);
                    mask.style.display = "none";
                }, 'image/jpeg', quality);

            } catch (err) {
                console.error(err);
                alert("å£“ç¸®å¤±æ•—ï¼Œå¯èƒ½æ˜¯è·¨åŸŸå•é¡Œã€‚");
                mask.style.display = "none";
            }
        }

        function saveBlob(blob, fileName) {
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>