<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„é›²ç«¯åœ–åº« - ç‰éœ²å¯¶åº«</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg-dark: #050510; --neon-cyan: #00f3ff; --neon-green: #00ff9d; --neon-red: #ff4757; --neon-gold: #f2c94c; }
        body { 
            background-color: var(--bg-dark); color: #fff; font-family: 'Microsoft JhengHei', sans-serif; 
            margin: 0; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; 
        }
        
        /* --- âœ¨ èƒŒæ™¯ç‰¹æ•ˆ --- */
        .stars-bg { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; 
            background-image: radial-gradient(2px 2px at 20px 30px, #fff, rgba(0,0,0,0)), radial-gradient(2px 2px at 40px 70px, #fff, rgba(0,0,0,0)); 
            background-size: 200px 200px; opacity: 0.2; animation: moveStars 100s linear infinite; z-index: -2; 
        }
        @keyframes moveStars { from {transform: translateY(0);} to {transform: translateY(-1000px);} }
        #twinkling-stars-container { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; 
        }
        .t-star { 
            position: absolute; background-color: white; border-radius: 50%; opacity: 0; 
            box-shadow: 0 0 4px rgba(255,255,255,0.8); 
            animation-name: twinkle; animation-iteration-count: infinite; animation-timing-function: ease-in-out; 
        }
        @keyframes twinkle { 
            0% { opacity: 0; transform: scale(0.3); } 
            50% { opacity: 1; transform: scale(1); } 
            100% { opacity: 0; transform: scale(0.3); } 
        }

        /* --- ä»‹é¢æ¨£å¼ --- */
        .header { 
            background: rgba(0,0,0,0.6); backdrop-filter: blur(10px);
            padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; gap: 20px; margin-bottom: 20px;
            position: sticky; top: 20px; z-index: 50; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        h1 { margin: 0; color: var(--neon-cyan); font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        
        .batch-panel { 
            display: none; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);
            flex-wrap: wrap; gap: 15px; align-items: center; justify-content: space-between;
        }
        .header.select-mode .batch-panel { display: flex; animation: slideDown 0.3s; }
        @keyframes slideDown { from {opacity:0; transform:translateY(-10px);} to {opacity:1; transform:translateY(0);} }

        .tool-btn {
            background: #222; color: #fff; border: 1px solid #444; padding: 8px 15px; border-radius: 50px; 
            cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px; font-weight: bold; font-size: 0.9rem; white-space: nowrap;
        }
        .tool-btn:hover { background: #333; border-color: #666; transform: translateY(-2px); }
        
        .btn-select-mode.active { background: var(--neon-cyan); color: #000; border-color: var(--neon-cyan); }
        .btn-download-orig { background: rgba(0, 114, 255, 0.2); border-color: #0072ff; color: #4facfe; }
        .btn-download-comp { background: rgba(0, 243, 255, 0.2); border-color: var(--neon-cyan); color: var(--neon-cyan); }
        .btn-delete { background: rgba(255, 71, 87, 0.2); border-color: var(--neon-red); color: var(--neon-red); }
        
        .global-quality-wrapper {
            display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 50px; border: 1px solid #444;
        }
        input[type=range] { width: 100px; height: 4px; background: #555; outline: none; -webkit-appearance: none; border-radius: 2px; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: var(--neon-cyan); border-radius: 50%; cursor: pointer; }

        .gallery-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; 
            padding-bottom: 50px;
        }
        
        .img-card {
            background: rgba(20, 20, 30, 0.6); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; overflow: hidden;
            transition: 0.2s; position: relative; display: flex; flex-direction: column; backdrop-filter: blur(5px);
        }
        .img-card.selected {
            border: 2px solid var(--neon-gold);
            box-shadow: 0 0 15px rgba(242, 201, 76, 0.4);
            transform: scale(0.96);
        }
        .img-card.selected::after {
            content: "\f00c"; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; top: 10px; right: 10px;
            background: var(--neon-gold); color: #000; width: 25px; height: 25px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            z-index: 20; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .img-wrapper { width: 100%; height: 180px; background: #000; overflow: hidden; display: flex; align-items: center; justify-content: center; position: relative; }
        .img-thumb { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        .gallery-grid:not(.select-mode) .img-card:hover .img-thumb { transform: scale(1.1); }
        .gallery-grid.select-mode .img-card { cursor: pointer; } 

        .img-info { padding: 10px; font-size: 0.8rem; color: #aaa; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .user-tag { color: var(--neon-cyan); display: block; margin-bottom: 3px; font-weight: bold; }
        .filename { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; color: #fff; }

        .processing-mask { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; flex-direction: column; align-items: center; justify-content: center; color: var(--neon-cyan); font-weight: bold; font-size: 0.9rem; z-index: 30; }
        
        .batch-progress-overlay {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #111; border: 1px solid var(--neon-cyan); padding: 15px 25px;
            border-radius: 30px; display: none; align-items: center; gap: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.8); z-index: 100; min-width: 300px;
        }
        .mini-loader { width: 20px; height: 20px; border: 2px solid #333; border-top-color: var(--neon-cyan); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>
    <div class="stars-bg"></div>
    <div id="twinkling-stars-container"></div>

    <div class="header" id="header">
        <div class="header-top">
            <h1><i class="fa-solid fa-cloud-arrow-down"></i> æˆ‘çš„é›²ç«¯åœ–åº«</h1>
            <div style="display:flex; gap:10px;">
                <button class="tool-btn btn-select-mode" id="btnSelectMode" onclick="toggleSelectMode()">
                    <i class="fa-solid fa-check-double"></i> é¸å–æ¨¡å¼
                </button>
                <a href="vip_area.html" class="tool-btn" style="text-decoration:none;">
                    <i class="fa-solid fa-arrow-left"></i> é›¢é–‹
                </a>
            </div>
        </div>

        <div class="batch-panel">
            <div style="display:flex; gap:10px; align-items:center;">
                <button class="tool-btn" onclick="selectAll()">å…¨é¸</button>
                <button class="tool-btn" onclick="deselectAll()">å–æ¶ˆ</button>
                <span style="color:#888; margin-left:10px;">å·²é¸: <span id="selectCount" style="color:#fff; font-weight:bold;">0</span></span>
            </div>

            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <div class="global-quality-wrapper">
                    <span style="font-size:0.8rem; color:#aaa;">å£“ç¸®å“è³ª</span>
                    <input type="range" id="globalQuality" min="10" max="100" value="80" oninput="document.getElementById('qVal').innerText=this.value+'%'">
                    <span id="qVal" style="font-size:0.8rem; color:var(--neon-cyan); width:35px;">80%</span>
                </div>

                <button class="tool-btn btn-download-orig" onclick="batchDownloadOriginalZip()">
                    <i class="fa-solid fa-file-zipper"></i> åŸåœ–æ‰“åŒ…
                </button>
                <button class="tool-btn btn-download-comp" onclick="batchCompressAndDownloadZip()">
                    <i class="fa-solid fa-compress"></i> å£“ç¸®æ‰“åŒ…
                </button>
                <button class="tool-btn btn-delete" onclick="deleteSelectedItems()">
                    <i class="fa-solid fa-trash-can"></i> åˆªé™¤
                </button>
            </div>
        </div>
    </div>

    <div class="gallery-grid" id="gallery">
        <p style="color:#aaa;">é€£ç·šä¸­...</p>
    </div>

    <div class="batch-progress-overlay" id="batchProgress">
        <div class="mini-loader"></div>
        <span id="batchStatusText">æ­£åœ¨è™•ç†...</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, orderBy, getDocs, doc, deleteDoc, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ğŸ”¥ è¨­å®šå€
        const firebaseConfig = {
            apiKey: "AIzaSyAAo6on0f2QUbPaRfxpIEb2uvhKxDvPUvs",
            authDomain: "yulubox.firebaseapp.com",
            projectId: "yulubox",
            storageBucket: "yulubox.firebasestorage.app",
            messagingSenderId: "256466567852",
            appId: "1:256466567852:web:233b74668908ffcb9b9509",
            measurementId: "G-YPCY41EKWX"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);
        let currentUser = null;

        // æ˜Ÿç©ºç‰¹æ•ˆ
        function createTwinklingStars() {
            const container = document.getElementById('twinkling-stars-container');
            if(!container) return;
            for (let i = 0; i < 60; i++) {
                const star = document.createElement('div');
                star.className = 't-star';
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.width = `${Math.random() * 2 + 1}px`;
                star.style.height = star.style.width;
                star.style.animationDuration = `${Math.random() * 4 + 2}s`;
                star.style.animationDelay = `${Math.random() * 5}s`;
                container.appendChild(star);
            }
        }
        window.addEventListener('load', createTwinklingStars);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadGallery();
            } else {
                window.location.href = 'login.html';
            }
        });

        // ç‹€æ…‹è®Šæ•¸
        let isSelectMode = false;
        let selectedItems = new Set(); 
        let allDocsData = {}; 
        let docIdsList = []; 

        async function loadGallery() {
            const galleryDiv = document.getElementById('gallery');
            galleryDiv.innerHTML = '<p style="color:#aaa;">æ­£åœ¨è®€å–æ‚¨çš„å°ˆå±¬åœ–åº«...</p>';

            try {
                // åªæŸ¥è©¢ç•¶å‰ä½¿ç”¨è€…çš„åœ–ç‰‡
                const q = query(
                    collection(db, "gallery"), 
                    where("uploadedBy", "==", currentUser.email), 
                    orderBy("timestamp", "desc")
                );
                
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    galleryDiv.innerHTML = '<p>æ‚¨å°šæœªä¸Šå‚³ä»»ä½•åœ–ç‰‡ã€‚</p>';
                    return;
                }

                galleryDiv.innerHTML = ''; 
                docIdsList = [];

                querySnapshot.forEach((doc, index) => {
                    const data = doc.data();
                    const docId = doc.id;
                    allDocsData[docId] = data;
                    docIdsList.push(docId);

                    const uniqueId = `img-${docId}`; 
                    
                    const card = document.createElement('div');
                    card.className = 'img-card';
                    card.id = `card-${docId}`;
                    card.onclick = () => handleCardClick(docId);

                    card.innerHTML = `
                        <div class="img-wrapper">
                            <div class="processing-mask" id="mask-${uniqueId}"><i class="fa-solid fa-circle-notch fa-spin"></i></div>
                            <img src="${data.imageUrl}" class="img-thumb" loading="lazy">
                        </div>
                        <div class="img-info">
                            <span class="user-tag">æˆ‘çš„åœ–ç‰‡</span>
                            <span class="filename">${data.fileName}</span>
                        </div>
                    `;
                    galleryDiv.appendChild(card);
                });

            } catch (error) {
                console.error("Error:", error);
                if (error.message.includes("requires an index")) {
                    galleryDiv.innerHTML = `<p style="color:var(--neon-gold)">âš ï¸ é¦–æ¬¡ä½¿ç”¨éœ€å»ºç«‹è³‡æ–™åº«ç´¢å¼•ã€‚<br>è«‹æŒ‰ F12 æ‰“é–‹ Console é»æ“Šé€£çµå»ºç«‹ã€‚</p>`;
                } else {
                    galleryDiv.innerHTML = `<p style="color:red">è®€å–å¤±æ•—ï¼š${error.message}</p>`;
                }
            }
        }

        // --- æ‰¹é‡æ“ä½œ ---
        window.toggleSelectMode = function() {
            isSelectMode = !isSelectMode;
            const header = document.getElementById('header');
            const gallery = document.getElementById('gallery');
            const btn = document.getElementById('btnSelectMode');

            if(isSelectMode) {
                btn.classList.add('active');
                btn.innerHTML = '<i class="fa-solid fa-times"></i> é€€å‡ºæ¨¡å¼';
                header.classList.add('select-mode');
                gallery.classList.add('select-mode');
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fa-solid fa-check-double"></i> é¸å–æ¨¡å¼';
                header.classList.remove('select-mode');
                gallery.classList.remove('select-mode');
                deselectAll(); 
            }
        }

        window.handleCardClick = function(docId) {
            if (!isSelectMode) return; 
            const card = document.getElementById(`card-${docId}`);
            if (selectedItems.has(docId)) {
                selectedItems.delete(docId);
                card.classList.remove('selected');
            } else {
                selectedItems.add(docId);
                card.classList.add('selected');
            }
            updateSelectUI();
        }

        window.selectAll = function() {
            docIdsList.forEach(id => {
                selectedItems.add(id);
                document.getElementById(`card-${id}`).classList.add('selected');
            });
            updateSelectUI();
        }

        window.deselectAll = function() {
            selectedItems.clear();
            document.querySelectorAll('.img-card.selected').forEach(el => el.classList.remove('selected'));
            updateSelectUI();
        }

        function updateSelectUI() {
            document.getElementById('selectCount').innerText = selectedItems.size;
        }

        // --- ğŸš€ åŸåœ–æ‰“åŒ…ä¸‹è¼‰ (Zip) ---
        window.batchDownloadOriginalZip = async function() {
            if(selectedItems.size === 0) return alert('è«‹å…ˆé¸å–åœ–ç‰‡');
            
            showProgress(true, `æº–å‚™æ‰“åŒ… ${selectedItems.size} å¼µåŸåœ–...`);
            
            const zip = new JSZip();
            const items = Array.from(selectedItems);
            let processed = 0;

            const promises = items.map(async (docId) => {
                const data = allDocsData[docId];
                try {
                    // Fetch åœ–ç‰‡è½‰ç‚º Blob
                    const response = await fetch(data.imageUrl, { mode: 'cors' });
                    const blob = await response.blob();
                    
                    // åŠ å…¥ Zip (è§£æ±ºæª”åé‡è¤‡å•é¡Œ)
                    // å¦‚æœæª”åç›¸åŒï¼ŒJSZip æœƒè‡ªå‹•è™•ç†ï¼Œä½†æˆ‘å€‘åŠ ä¸Š timestamp ä¿éšª
                    const safeName = data.fileName; 
                    zip.file(safeName, blob);
                } catch(e) {
                    console.error("ä¸‹è¼‰å¤±æ•—:", data.fileName, e);
                } finally {
                    processed++;
                    updateProgress(`æŠ“å–ä¸­... ${processed}/${items.length}`);
                }
            });

            await Promise.all(promises);

            updateProgress("æ­£åœ¨ç”Ÿæˆå£“ç¸®æª” (Zip)...");
            
            // ç”¢ç”Ÿ Zip ä¸¦ä¸‹è¼‰
            zip.generateAsync({type:"blob"}).then(function(content) {
                const link = document.createElement("a");
                link.href = URL.createObjectURL(content);
                link.download = "original_images.zip"; // ä¸‹è¼‰æª”å
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showProgress(false);
            });
        }

        // --- ğŸš€ å£“ç¸®æ‰“åŒ…ä¸‹è¼‰ (Zip) ---
        window.batchCompressAndDownloadZip = async function() {
            if(selectedItems.size === 0) return alert('è«‹å…ˆé¸å–åœ–ç‰‡');
            const qualityVal = document.getElementById('globalQuality').value;
            const quality = qualityVal / 100;

            showProgress(true, `æ­£åœ¨å£“ç¸®ä¸¦æ‰“åŒ…...`);
            
            const zip = new JSZip();
            const items = Array.from(selectedItems);
            let processed = 0;
            
            // é™åˆ¶ä¸¦ç™¼æ•¸ (é¿å…ç•¶æ©Ÿ)
            const concurrencyLimit = 3;
            const chunks = [];
            for (let i = 0; i < items.length; i += concurrencyLimit) {
                chunks.push(items.slice(i, i + concurrencyLimit));
            }

            for (const chunk of chunks) {
                const promises = chunk.map(async (docId) => {
                    const data = allDocsData[docId];
                    const mask = document.getElementById(`mask-img-${docId}`);
                    if(mask) mask.style.display = 'flex';
                    
                    try {
                        const blob = await getCompressedBlob(data.imageUrl, quality);
                        if(blob) {
                            // ä¿®æ”¹æª”å
                            const nameParts = data.fileName.split('.');
                            nameParts.pop();
                            const newName = nameParts.join('.') + `_min_${Math.round(quality*100)}.jpg`;
                            zip.file(newName, blob);
                        }
                    } catch(e) { console.error(e); }
                    
                    if(mask) mask.style.display = 'none';
                    processed++;
                    updateProgress(`è™•ç†ä¸­... ${processed}/${items.length}`);
                });
                await Promise.all(promises);
            }
            
            updateProgress("æ­£åœ¨ç”Ÿæˆå£“ç¸®æª” (Zip)...");
            zip.generateAsync({type:"blob"}).then(function(content) {
                const link = document.createElement("a");
                link.href = URL.createObjectURL(content);
                link.download = `compressed_images_${qualityVal}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showProgress(false);
            });
        }

        // è¼”åŠ©ï¼šç”¢ç”Ÿå£“ç¸®å¾Œçš„ Blob
        async function getCompressedBlob(url, quality) {
            try {
                const response = await fetch(url, { mode: 'cors' });
                const blob = await response.blob();
                const imgBitmap = await createImageBitmap(blob);
                
                const canvas = document.createElement('canvas');
                canvas.width = imgBitmap.width;
                canvas.height = imgBitmap.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(imgBitmap, 0, 0);

                return new Promise((resolve) => {
                    canvas.toBlob((compressedBlob) => {
                        resolve(compressedBlob);
                    }, 'image/jpeg', quality);
                });
            } catch (err) {
                console.error("Compress fail", err);
                return null;
            }
        }

        window.deleteSelectedItems = async function() {
            if(selectedItems.size === 0) return alert('è«‹å…ˆé¸å–åœ–ç‰‡');
            if(!confirm(`ç¢ºå®šè¦åˆªé™¤é€™ ${selectedItems.size} å¼µåœ–ç‰‡å—ï¼Ÿ`)) return;

            showProgress(true, 'æ­£åœ¨åˆªé™¤...');
            const items = Array.from(selectedItems);
            
            for(let i=0; i<items.length; i++) {
                const docId = items[i];
                const data = allDocsData[docId];
                try {
                    if (data.imageUrl) {
                        const fileRef = ref(storage, data.imageUrl);
                        await deleteObject(fileRef).catch(e => console.log(e));
                    }
                    await deleteDoc(doc(db, "gallery", docId));
                    const card = document.getElementById(`card-${docId}`);
                    if(card) card.remove();
                } catch(e) { console.error(e); }
            }
            selectedItems.clear();
            updateSelectUI();
            showProgress(false);
            alert('åˆªé™¤å®Œæˆ');
        }

        function showProgress(show, text) {
            const el = document.getElementById('batchProgress');
            const txt = document.getElementById('batchStatusText');
            el.style.display = show ? 'flex' : 'none';
            if(text) txt.innerText = text;
        }

        function updateProgress(text) {
            const txt = document.getElementById('batchStatusText');
            txt.innerText = text;
        }
    </script>
</body>
</html>