<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿå…Œæ›å€‰åº« - æŒ‡æ®å®˜å¾Œå°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* ğŸ¨ æ˜Ÿéš›å¥¢è¯é…è‰² */
            --main-gold: #FFD700;       
            --accent-amber: #FDB931;    
            --deep-space: #0f172a;      
            --nebula-blue: #00f3ff;     
            --danger-red: #ff4757;      
            --success-green: #10b981;
            
            /* ç»ç’ƒæ“¬æ…‹ */
            --glass-bg: rgba(15, 23, 42, 0.85); 
            --glass-border: rgba(255, 255, 255, 0.1);
            --panel-bg: rgba(30, 41, 59, 0.6);
        }

        body {
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            color: #e2e8f0; font-family: 'Microsoft JhengHei', sans-serif;
            min-height: 100vh; margin: 0; display: flex; flex-direction: column;
            overflow-x: hidden;
        }

        /* --- èƒŒæ™¯æ˜Ÿç©º --- */
        .space-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .star-field { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background-repeat: repeat; opacity: 0.5; animation-timing-function: linear; animation-iteration-count: infinite; }
        .stars-distant {
            background-image: radial-gradient(1px 1px at 10% 15%, #fff, transparent), radial-gradient(1px 1px at 30% 60%, #ddd, transparent), radial-gradient(1px 1px at 70% 20%, #eee, transparent);
            background-size: 300px 300px; animation-name: rotateSpace; animation-duration: 240s;
        }
        .stars-mid {
            background-image: radial-gradient(1.5px 1.5px at 25% 10%, #fff, transparent), radial-gradient(1.5px 1.5px at 60% 35%, #eef, transparent);
            background-size: 400px 400px; opacity: 0.6; animation-name: rotateSpace; animation-duration: 180s; animation-direction: reverse;
        }
        .gold-twinklers {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(2px 2px at 20% 30%, var(--main-gold), transparent), radial-gradient(3px 3px at 65% 25%, #fff59d, transparent);
            background-size: 100% 100%; opacity: 0; animation: occasionalFlash 12s ease-in-out infinite;
        }
        @keyframes rotateSpace { from { transform: rotate(0deg) translateZ(0); } to { transform: rotate(360deg) translateZ(0); } }
        @keyframes occasionalFlash { 0%, 40%, 100% { opacity: 0; } 55% { opacity: 1; filter: brightness(2) blur(1px); } 85% { opacity: 0; } }

        /* --- é ‚éƒ¨å°èˆª --- */
        .header {
            width: 100%; padding: 15px 30px; 
            background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center; box-sizing: border-box;
        }
        .back-btn { color: #94a3b8; text-decoration: none; font-size: 1rem; display: flex; align-items: center; gap: 8px; transition:0.3s; }
        .back-btn:hover { color: #fff; }
        .header h1 { font-size: 1.5rem; margin: 0; color: var(--main-gold); letter-spacing: 2px; font-weight: 900; }

        /* --- Grid ä½ˆå±€ --- */
        .admin-container {
            display: grid; grid-template-columns: 3fr 1fr; 
            gap: 20px; padding: 20px; height: calc(100vh - 70px); box-sizing: border-box;
        }
        @media (max-width: 900px) { .admin-container { grid-template-columns: 1fr; height: auto; } }

        /* --- å·¦å´ï¼šåº«å­˜ç®¡ç† --- */
        .inventory-section {
            background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 20px;
            padding: 20px; display: flex; flex-direction: column; overflow: hidden;
        }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section-title { font-size: 1.2rem; color: #fff; font-weight: bold; border-left: 4px solid var(--nebula-blue); padding-left: 15px; }
        
        .btn-add {
            background: linear-gradient(135deg, var(--main-gold), var(--accent-amber));
            color: #000; border: none; padding: 10px 25px; border-radius: 30px; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2); transition: 0.3s;
        }
        .btn-add:hover { transform: translateY(-2px); box-shadow: 0 0 25px rgba(255, 215, 0, 0.4); }

        .product-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px;
            overflow-y: auto; padding-right: 10px; flex: 1;
        }
        
        /* å•†å“å¡ç‰‡ */
        .admin-card {
            background: var(--panel-bg); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px;
            overflow: hidden; position: relative; transition: 0.3s;
        }
        .admin-card:hover { border-color: var(--main-gold); transform: translateY(-3px); }
        
        .card-img { width: 100%; height: 150px; object-fit: cover; opacity: 0.8; }
        .card-body { padding: 15px; }
        .card-title { font-weight: bold; color: #fff; margin-bottom: 5px; font-size: 1.1rem; }
        .card-meta { font-size: 0.85rem; color: #94a3b8; display: flex; justify-content: space-between; margin-bottom: 10px; }
        .card-price { color: var(--main-gold); font-weight: bold; }
        
        .card-actions { display: flex; gap: 10px; }
        .btn-action { flex: 1; padding: 6px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: bold; color: #fff; }
        .btn-edit { background: #3b82f6; }
        .btn-delete { background: #ef4444; }

        /* --- å³å´ï¼šç´€éŒ„ --- */
        .log-section {
            background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 20px;
            padding: 20px; display: flex; flex-direction: column; overflow: hidden; max-height: 100%;
        }
        .log-list { overflow-y: auto; flex: 1; padding-right: 5px; }
        
        .log-item {
            background: var(--panel-bg); border-left: 3px solid #64748b;
            padding: 10px; margin-bottom: 10px; border-radius: 4px; font-size: 0.9rem;
            display: flex; flex-direction: column; gap: 5px;
        }
        .log-item.pending { border-left-color: var(--main-gold); background: rgba(255, 215, 0, 0.05); }
        .log-item.completed { border-left-color: var(--success-green); opacity: 0.7; }
        .log-item.rejected { border-left-color: var(--danger-red); opacity: 0.5; }

        .log-header { display: flex; justify-content: space-between; color: #fff; font-weight: bold; }
        .log-user { color: #94a3b8; font-size: 0.8rem; }
        .log-time { color: #64748b; font-size: 0.75rem; text-align: right; }
        
        .log-actions { display: flex; gap: 5px; margin-top: 5px; }
        .btn-log { flex: 1; padding: 4px; border: none; border-radius: 4px; cursor: pointer; color: #fff; font-size: 0.8rem; }
        .btn-approve { background: var(--success-green); }
        .btn-reject { background: var(--danger-red); }

        /* Modal & Upload */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-box {
            background: #1e293b; border: 1px solid var(--main-gold);
            padding: 30px; border-radius: 15px; width: 90%; max-width: 500px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.15); color: #fff;
            max-height: 90vh; overflow-y: auto;
        }
        
        /* ğŸ”¥ æ‹–æ›³ä¸Šå‚³å€æ¨£å¼ */
        .drop-zone {
            width: 100%; height: 150px; border: 2px dashed #475569; border-radius: 12px;
            background: rgba(0,0,0,0.2); display: flex; flex-direction: column;
            justify-content: center; align-items: center; cursor: pointer;
            margin-bottom: 20px; transition: 0.3s; position: relative; overflow: hidden;
        }
        .drop-zone:hover, .drop-zone.drag-active { border-color: var(--main-gold); background: rgba(255, 215, 0, 0.05); }
        .drop-zone img { width: 100%; height: 100%; object-fit: cover; position: absolute; top:0; left:0; opacity: 0.6; }
        .drop-zone i { font-size: 2rem; color: #94a3b8; margin-bottom: 10px; z-index: 2; }
        .drop-zone span { color: #94a3b8; font-size: 0.9rem; z-index: 2; }
        .upload-spinner { position: absolute; z-index:10; font-size:2rem; color:var(--main-gold); display:none; }

        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; color: #94a3b8; font-size: 0.9rem; }
        .form-input {
            width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid #475569;
            color: #fff; border-radius: 8px; box-sizing: border-box;
        }
        .modal-footer { margin-top: 20px; text-align: right; }
        .btn-submit { background: var(--main-gold); color: #000; padding: 10px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-close { background: transparent; color: #aaa; border: 1px solid #555; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-right: 10px; }

    </style>
</head>
<body>

    <div class="space-container">
        <div class="star-field stars-distant"></div>
        <div class="star-field stars-mid"></div>
        <div class="gold-twinklers"></div>
    </div>

    <div class="header">
        <h1><i class="fa-solid fa-warehouse"></i> æ˜Ÿå…Œæ›å€‰åº«</h1>
        <a href="vip_area.html" class="back-btn"><i class="fa-solid fa-chevron-left"></i> è¿”å›ç¸½éƒ¨</a>
    </div>

    <div class="admin-container">
        
        <div class="inventory-section">
            <div class="section-header">
                <div class="section-title">å…Œæ›å€‰åº« (Warehouse)</div>
                <button class="btn-add" onclick="openModal()"><i class="fa-solid fa-plus"></i> æ–°å¢ç‰©å“</button>
            </div>
            <div class="product-grid" id="productGrid">
                <div style="color:#64748b; text-align:center; grid-column:1/-1;">è®€å–ä¸­...</div>
            </div>
        </div>

        <div class="log-section">
            <div class="section-header">
                <div class="section-title">å…Œæ›è«‹æ±‚ (Logs)</div>
            </div>
            <div class="log-list" id="redemptionList">
                <div style="color:#64748b; text-align:center;">å°šç„¡å¾…è¾¦äº‹é …</div>
            </div>
        </div>

    </div>

    <div class="modal-overlay" id="productModal">
        <div class="modal-box">
            <h2 style="margin-top:0; color:var(--main-gold);" id="modalTitle">ç‰©è³‡è¨­å®š</h2>
            <input type="hidden" id="editId">
            <input type="hidden" id="uploadedImageUrl">
            <input type="file" id="fileInput" accept="image/*" style="display:none">

            <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                <img id="previewImg" style="display:none;">
                <i class="fa-solid fa-cloud-arrow-up"></i>
                <span>é»æ“Šæ‹ç…§æˆ–æ‹–æ›³åœ–ç‰‡è‡³æ­¤</span>
                <i class="fa-solid fa-spinner fa-spin upload-spinner" id="uploadSpinner"></i>
            </div>
            
            <div class="form-group">
                <label class="form-label">ç‰©å“åç¨±</label>
                <input type="text" id="pName" class="form-input" placeholder="ä¾‹å¦‚ï¼šæ˜Ÿéš›å’–å•¡åˆ¸">
            </div>
            
            <div class="form-group">
                <label class="form-label">åˆ†é¡æ¨™ç±¤ (è‡ªå®šç¾©)</label>
                <input type="text" id="pType" class="form-input" placeholder="ä¾‹å¦‚ï¼šå¯¦é«”ã€æ•¸ä½ã€é£Ÿå“...">
            </div>

            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1;">
                    <label class="form-label">å…Œæ›åƒ¹æ ¼ (æ˜Ÿæ˜Ÿ)</label>
                    <input type="number" id="pCost" class="form-input" value="100">
                </div>
                <div class="form-group" style="flex:1;">
                    <label class="form-label">åº«å­˜ (ç•™ç©ºç‚ºç„¡é™)</label>
                    <input type="number" id="pStock" class="form-input">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">æè¿°</label>
                <input type="text" id="pDesc" class="form-input" placeholder="ç°¡çŸ­ä»‹ç´¹...">
            </div>

            <div class="modal-footer">
                <button class="btn-close" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn-submit" id="btnSubmit" onclick="saveProduct()">ç¢ºèªå…¥åº«</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, query, orderBy, runTransaction, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAo6on0f2QUbPaRfxpIEb2uvhKxDvPUvs",
            authDomain: "yulubox.firebaseapp.com",
            projectId: "yulubox",
            storageBucket: "yulubox.firebasestorage.app",
            messagingSenderId: "256466567852",
            appId: "1:256466567852:web:233b74668908ffcb9b9509",
            measurementId: "G-YPCY41EKWX"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "login.html";
            else {
                loadProducts();
                loadRedemptions();
            }
        });

        function loadProducts() {
            const q = query(collection(db, "products"), orderBy("cost"));
            onSnapshot(q, (snapshot) => {
                const grid = document.getElementById('productGrid');
                grid.innerHTML = '';
                
                snapshot.forEach(docSnap => {
                    const p = docSnap.data();
                    const id = docSnap.id;
                    if(p.active === false) return; // å¿½ç•¥å·²åˆªé™¤

                    const stockText = p.stock ? `å‰©é¤˜: ${p.stock}` : 'ç„¡é™é‡';
                    
                    grid.innerHTML += `
                        <div class="admin-card">
                            <img src="${p.image || 'https://via.placeholder.com/200?text=No+Image'}" class="card-img">
                            <div class="card-body">
                                <div class="card-title">${p.name}</div>
                                <div class="card-meta">
                                    <span class="card-price"><i class="fa-solid fa-star"></i> ${p.cost}</span>
                                    <span>${stockText}</span>
                                </div>
                                <div style="font-size:0.8rem; color:#64748b; margin-bottom:10px;">åˆ†é¡: ${p.type || 'æœªåˆ†é¡'}</div>
                                <div class="card-actions">
                                    <button class="btn-action btn-edit" onclick="editProduct('${id}')">ç·¨è¼¯</button>
                                    <button class="btn-action btn-delete" onclick="deleteProduct('${id}')">ä¸‹æ¶</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
        }

        function loadRedemptions() {
            const q = query(collection(db, "redemptions"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('redemptionList');
                list.innerHTML = '';

                snapshot.forEach(docSnap => {
                    const r = docSnap.data();
                    const id = docSnap.id;
                    const time = r.timestamp ? new Date(r.timestamp.toDate()).toLocaleString() : 'å‰›å‰›';
                    
                    let actionsHtml = '';
                    if(r.status === 'pending') {
                        actionsHtml = `
                            <div class="log-actions">
                                <button class="btn-log btn-approve" onclick="handleRedemption('${id}', 'approve')">æ ¸éŠ·</button>
                                <button class="btn-log btn-reject" onclick="handleRedemption('${id}', 'reject', ${r.cost}, '${r.userId}')">é§å›</button>
                            </div>
                        `;
                    }

                    list.innerHTML += `
                        <div class="log-item ${r.status}">
                            <div class="log-header">
                                <span>${r.productName}</span>
                                <span style="color:var(--main-gold)">-${r.cost}</span>
                            </div>
                            <div class="log-user">${r.userEmail}</div>
                            <div class="log-time">${time} â€¢ ${r.status.toUpperCase()}</div>
                            ${actionsHtml}
                        </div>
                    `;
                });
            });
        }

        // --- åœ–ç‰‡ä¸Šå‚³é‚è¼¯ ---
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-active'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-active'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault(); dropZone.classList.remove('drag-active');
            if(e.dataTransfer.files.length) handleFileUpload(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', () => { if(fileInput.files.length) handleFileUpload(fileInput.files[0]); });

        async function handleFileUpload(file) {
            if(!file.type.startsWith('image/')) return alert("è«‹ä¸Šå‚³åœ–ç‰‡");
            document.getElementById('uploadSpinner').style.display = 'block';
            
            try {
                const compressedBlob = await compressImage(file);
                const storageRef = ref(storage, `products/${Date.now()}_${file.name}`);
                await uploadBytes(storageRef, compressedBlob);
                const url = await getDownloadURL(storageRef);
                
                document.getElementById('uploadedImageUrl').value = url;
                const img = document.getElementById('previewImg');
                img.src = url; img.style.display = 'block';
            } catch(e) { alert("ä¸Šå‚³å¤±æ•—: " + e.message); } 
            finally { document.getElementById('uploadSpinner').style.display = 'none'; }
        }

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = URL.createObjectURL(file);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX = 800; 
                    let w = img.width, h = img.height;
                    if(w>h){ if(w>MAX){ h*=MAX/w; w=MAX; } } else { if(h>MAX){ w*=MAX/h; h=MAX; } }
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.8);
                };
                img.onerror = reject;
            });
        }

        // --- å•†å“ CRUD ---
        window.openModal = (id = null) => {
            document.getElementById('productModal').style.display = 'flex';
            document.getElementById('btnSubmit').disabled = false;
            
            if(!id) {
                document.getElementById('modalTitle').innerText = "æ–°å¢ç‰©å“";
                document.getElementById('editId').value = "";
                document.getElementById('uploadedImageUrl').value = "";
                document.getElementById('previewImg').style.display = 'none';
                document.querySelectorAll('input:not([type=hidden])').forEach(i => i.value = "");
            }
        };

        window.editProduct = async (id) => {
            document.getElementById('productModal').style.display = 'flex';
            document.getElementById('modalTitle').innerText = "ç·¨è¼¯ç‰©å“";
            document.getElementById('editId').value = id;
            
            const docSnap = await getDoc(doc(db, "products", id));
            if(docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('pName').value = data.name;
                document.getElementById('pType').value = data.type || '';
                document.getElementById('pCost').value = data.cost;
                document.getElementById('pStock').value = data.stock || '';
                document.getElementById('pDesc').value = data.desc || '';
                
                if(data.image) {
                    document.getElementById('uploadedImageUrl').value = data.image;
                    const img = document.getElementById('previewImg');
                    img.src = data.image; img.style.display = 'block';
                } else {
                    document.getElementById('previewImg').style.display = 'none';
                }
            }
        };

        window.closeModal = () => document.getElementById('productModal').style.display = 'none';

        window.saveProduct = async () => {
            const id = document.getElementById('editId').value;
            const data = {
                name: document.getElementById('pName').value,
                image: document.getElementById('uploadedImageUrl').value,
                type: document.getElementById('pType').value, // è‡ªå®šç¾©åˆ†é¡
                cost: parseInt(document.getElementById('pCost').value),
                stock: document.getElementById('pStock').value ? parseInt(document.getElementById('pStock').value) : null,
                desc: document.getElementById('pDesc').value,
                active: true
            };

            if(!data.name || !data.cost) return alert("è«‹å¡«å¯«åç¨±èˆ‡åƒ¹æ ¼");

            try {
                if(id) await updateDoc(doc(db, "products", id), data);
                else await addDoc(collection(db, "products"), data);
                closeModal();
            } catch(e) { alert("å„²å­˜å¤±æ•—"); }
        };

        window.deleteProduct = async (id) => {
            if(confirm("ç¢ºå®šè¦ä¸‹æ¶æ­¤å•†å“å—ï¼Ÿ")) await updateDoc(doc(db, "products", id), { active: false });
        };

        window.handleRedemption = async (rid, action, cost, uid) => {
            if(!confirm(`ç¢ºå®šè¦${action==='approve'?'æ ¸éŠ·':'é§å›'}ï¼Ÿ`)) return;
            try {
                await runTransaction(db, async (t) => {
                    const rRef = doc(db, "redemptions", rid);
                    if(action === 'reject') {
                        const userRef = doc(db, "users", uid);
                        const userDoc = await t.get(userRef);
                        t.update(userRef, { stars: (userDoc.data().stars||0) + cost });
                        t.set(doc(collection(db, "transactions")), { userId: uid, action: "admin_adjust", itemName: "å…Œæ›é§å›é€€æ¬¾", amount: cost, timestamp: serverTimestamp() });
                    }
                    t.update(rRef, { status: action === 'approve' ? 'completed' : 'rejected' });
                });
                alert("æ“ä½œå®Œæˆ");
            } catch(e) { alert("æ“ä½œå¤±æ•—"); }
        };
    </script>
</body>
</html>