<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>星星兌獎 - 玉露寶庫</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 576 512'%3E%3Cpath fill='%23FFD700' d='M259.3 17.8L194 150.2 47.9 171.5c-26.2 3.8-36.7 36.1-17.7 54.6l105.7 103-25 145.5c-4.5 26.3 23.2 46 46.4 33.7L288 439.6l130.7 68.7c23.2 12.2 50.9-7.4 46.4-33.7l-25-145.5 105.7-103c19-18.5 8.5-50.8-17.7-54.6L382 150.2 316.7 17.8c-11.7-23.6-45.6-23.9-57.4 0z'/%3E%3C/svg%3E">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --main-gold: #FFD700;       
            --accent-amber: #FDB931;    
            --deep-space: #0f172a;      
            --nebula-blue: #00f3ff;     
            --danger-red: #ff4757;      
            --glass-bg: rgba(15, 23, 42, 0.75); 
            --glass-border: rgba(255, 255, 255, 0.1);
            --card-radius: 16px;
        }

        body {
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            color: #e2e8f0; font-family: 'Microsoft JhengHei', sans-serif;
            min-height: 100vh; margin: 0; display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden; padding-bottom: 100px; position: relative;
        }

        /* 背景星空特效 */
        .stars-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0.5; animation: twinkle 3s infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }

        /* 頂部導航 */
        .header {
            width: 100%; padding: 15px 20px; background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px); border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
            box-sizing: border-box; position: sticky; top: 0; z-index: 100;
        }
        .back-btn { color: #94a3b8; text-decoration: none; font-size: 1rem; display: flex; align-items: center; gap: 5px; font-weight: bold; }
        .balance-badge {
            background: rgba(255, 215, 0, 0.15); border: 1px solid var(--main-gold);
            color: var(--main-gold); padding: 6px 15px; border-radius: 20px; font-weight: bold;
            display: flex; align-items: center; gap: 8px; font-size: 1rem;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }

        .shop-title { text-align: center; margin: 30px 0 20px 0; }
        .shop-title h1 {
            margin: 0; font-size: 2.5rem; letter-spacing: 2px; font-weight: 900;
            background: linear-gradient(to bottom, #fff 0%, var(--main-gold) 100%);
            -webkit-background-clip: text; color: transparent;
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.4));
        }
        .shop-title p { color: #64748b; margin-top: 5px; font-size: 0.9rem; letter-spacing: 2px; text-transform: uppercase; }

        /* 商品列表 */
        .products-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px; width: 90%; max-width: 800px; padding: 10px;
        }

        .product-card {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: var(--card-radius); padding: 15px; text-align: center;
            backdrop-filter: blur(10px); transition: 0.3s; position: relative; overflow: hidden;
            display: flex; flex-direction: column; justify-content: space-between; height: 260px;
        }
        .product-card:hover { transform: translateY(-5px); border-color: var(--main-gold); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .product-card::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1), transparent 60%);
            opacity: 0; transition: 0.5s; pointer-events: none;
        }
        .product-card:hover::before { opacity: 1; }

        .prod-icon { font-size: 3.5rem; color: var(--nebula-blue); margin: 15px 0; text-shadow: 0 0 20px rgba(0, 243, 255, 0.4); }
        .prod-name { color: #fff; font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; line-height: 1.3; }
        .prod-desc { color: #94a3b8; font-size: 0.8rem; margin-bottom: 10px; flex-grow: 1; display: flex; align-items: center; justify-content: center; }
        
        .prod-price { color: var(--main-gold); font-size: 1.1rem; font-weight: bold; margin-bottom: 12px; }
        
        .btn-buy {
            background: linear-gradient(90deg, #3b82f6, #2563eb); border: none; color: white;
            padding: 10px 0; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer;
            transition: 0.2s; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
        }
        .btn-buy:hover { filter: brightness(1.2); transform: scale(1.02); }
        .btn-buy:disabled { background: #334155; cursor: not-allowed; filter: grayscale(1); }

        /* 模態框 */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: #1e293b; border: 1px solid var(--glass-border);
            width: 85%; max-width: 350px; padding: 25px; border-radius: 20px;
            text-align: center; box-shadow: 0 0 50px rgba(0,0,0,0.5);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }

        .modal-title { font-size: 1.3rem; color: #fff; font-weight: bold; margin-bottom: 15px; }
        .modal-info { color: #cbd5e1; margin-bottom: 25px; line-height: 1.6; font-size: 0.95rem; }
        .modal-btns { display: flex; gap: 10px; }
        .btn-confirm { flex: 1; padding: 12px; border-radius: 10px; border:none; font-weight:bold; cursor:pointer; background: var(--main-gold); color: #000; }
        .btn-cancel { flex: 1; padding: 12px; border-radius: 10px; border:1px solid #475569; font-weight:bold; cursor:pointer; background: transparent; color: #94a3b8; }

        /* 購買成功動畫 */
        .success-anim {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2000; pointer-events: none;
        }

    </style>
</head>
<body>

    <div class="stars-bg" id="starsBg"></div>

    <div class="header">
        <a href="vip_area.html" class="back-btn"><i class="fa-solid fa-chevron-left"></i> VIP 大廳</a>
        <div class="balance-badge">
            <i class="fa-solid fa-star"></i> <span id="userBalance">--</span>
        </div>
    </div>

    <div class="shop-title">
        <h1>星星兌獎</h1>
        <p>REDEEM CENTER</p>
    </div>

    <div class="products-grid" id="productsContainer">
        <div style="grid-column: 1/-1; text-align:center; color:#64748b; padding: 50px;">
            <i class="fa-solid fa-spinner fa-spin fa-2x"></i><br><br>載入寶庫中...
        </div>
    </div>

    <div class="modal-overlay" id="confirmModal">
        <div class="modal-box">
            <div class="modal-title">確認兌換</div>
            <div class="modal-info" id="modalContent"></div>
            <div class="modal-btns">
                <button class="btn-cancel" onclick="closeModal()">取消</button>
                <button class="btn-confirm" id="btnConfirmBuy" onclick="executePurchase()">確認兌換</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, serverTimestamp, runTransaction, getDocs, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { firebaseConfig } from './js/firebase-config.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let selectedProduct = null;
        let allProducts = [];

        // 背景星星特效
        const bg = document.getElementById('starsBg');
        for(let i=0; i<50; i++) {
            const s = document.createElement('div');
            s.className = 'star';
            s.style.top = Math.random()*100 + '%';
            s.style.left = Math.random()*100 + '%';
            s.style.width = Math.random()*3 + 'px';
            s.style.height = s.style.width;
            s.style.animationDelay = Math.random()*3 + 's';
            bg.appendChild(s);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadBalance();
                loadProducts();
            } else {
                window.location.href = "login.html";
            }
        });

        async function loadBalance() {
            if (!currentUser) return;
            const docRef = doc(db, "users", currentUser.uid);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const bal = docSnap.data().stars || 0;
                document.getElementById('userBalance').innerText = bal;
            }
        }

        async function loadProducts() {
            const container = document.getElementById('productsContainer');
            try {
                // 只抓取上架中 (active == true) 的商品，並按價格排序
                const q = query(collection(db, "products"), where("active", "==", true), orderBy("cost", "asc"));
                const querySnapshot = await getDocs(q);
                
                allProducts = [];
                querySnapshot.forEach((doc) => {
                    allProducts.push({ id: doc.id, ...doc.data() });
                });

                renderProducts(allProducts);

            } catch (error) {
                console.error("Error loading products:", error);
                container.innerHTML = `<div style="grid-column: 1/-1; text-align:center; color:#ef4444;">
                    <i class="fa-solid fa-triangle-exclamation"></i> 載入失敗，請稍後再試
                </div>`;
            }
        }

        function renderProducts(products) {
            const container = document.getElementById('productsContainer');
            if (products.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#64748b;">暫無商品上架</div>';
                return;
            }

            container.innerHTML = products.map(p => {
                // 根據商品類型顯示不同 Icon
                let iconClass = "fa-gift";
                if (p.name.includes("卡")) iconClass = "fa-ticket";
                if (p.name.includes("VIP")) iconClass = "fa-crown";
                if (p.name.includes("優惠")) iconClass = "fa-tags";

                return `
                <div class="product-card">
                    <div>
                        <i class="fa-solid ${iconClass} prod-icon"></i>
                        <div class="prod-name">${p.name}</div>
                        <div class="prod-desc">${p.description || "無描述"}</div>
                    </div>
                    <div>
                        <div class="prod-price"><i class="fa-solid fa-star"></i> ${p.cost}</div>
                        <button class="btn-buy" onclick="openBuyModal('${p.id}')">立即兌換</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        window.openBuyModal = (productId) => {
            selectedProduct = allProducts.find(p => p.id === productId);
            if (!selectedProduct) return;

            const bal = parseInt(document.getElementById('userBalance').innerText);
            const canAfford = bal >= selectedProduct.cost;

            document.getElementById('modalContent').innerHTML = `
                您即將兌換：<br>
                <span style="color:#fff; font-weight:bold; font-size:1.1rem;">${selectedProduct.name}</span><br>
                <br>
                花費：<span style="color:var(--main-gold);">${selectedProduct.cost} 星星</span><br>
                當前餘額：${bal}
                ${!canAfford ? '<br><br><span style="color:#ff4757; font-weight:bold;">⚠️ 餘額不足</span>' : ''}
            `;

            const confirmBtn = document.getElementById('btnConfirmBuy');
            if (canAfford) {
                confirmBtn.disabled = false;
                confirmBtn.style.opacity = "1";
                confirmBtn.innerText = "確認兌換";
            } else {
                confirmBtn.disabled = true;
                confirmBtn.style.opacity = "0.5";
                confirmBtn.innerText = "餘額不足";
            }

            document.getElementById('confirmModal').style.display = 'flex';
        };

        window.closeModal = () => {
            document.getElementById('confirmModal').style.display = 'none';
            selectedProduct = null;
        };

        window.executePurchase = async () => {
            if (!selectedProduct || !currentUser) return;

            const btn = document.getElementById('btnConfirmBuy');
            btn.disabled = true;
            btn.innerText = "處理中...";

            try {
                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, "users", currentUser.uid);
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists()) throw "用戶不存在";

                    const newBalance = (userDoc.data().stars || 0) - selectedProduct.cost;
                    if (newBalance < 0) throw "餘額不足";

                    transaction.update(userRef, { stars: newBalance });

                    // 1. 寫入兌換紀錄 (需人工審核或自動發放)
                    const recordRef = doc(collection(db, "redemptions"));
                    transaction.set(recordRef, {
                        userId: currentUser.uid,
                        userEmail: currentUser.email,
                        productId: selectedProduct.id,
                        productName: selectedProduct.name,
                        cost: selectedProduct.cost,
                        status: 'pending', // 待處理
                        timestamp: serverTimestamp()
                    });
                    
                    // 2. 寫入交易明細
                    const txRef = doc(collection(db, "transactions"));
                    transaction.set(txRef, {
                        userId: currentUser.uid,
                        action: "redeem",
                        itemName: selectedProduct.name,
                        amount: -selectedProduct.cost,
                        timestamp: serverTimestamp()
                    });
                });

                alert("兌換成功！請至「星存摺」或 Email 查看紀錄。");
                closeModal();
                loadBalance(); 
                renderProducts(allProducts); 

            } catch (e) {
                alert("兌換失敗: " + e);
            } finally {
                btn.disabled = false; btn.innerText = "確認兌換";
            }
        }
    </script>
</body>
</html>